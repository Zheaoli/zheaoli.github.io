<!DOCTYPE html><html lang=en data-theme=auto><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><title>Python 3.14: Python 世界的一大步 | Manjusaka</title><meta name=author content=Manjusaka><meta name=copyright content=Manjusaka><meta name=format-detection content="telephone=no"><meta name=theme-color content=ffffff><meta name=description content="Python 3.14 目前主要的一些主要的特性其实已经固定了，在我看来，Python 3.14 是一个未来很多年的一个核心版本。因为其确定了是时代的 Python调试生态的基准，这篇文章将会来聊聊这个 Python 世界中的史诗级改进"><meta property=og:type content=article><meta property=og:title content="Python 3.14: Python 世界的一大步"><meta property=og:url content=https://www.manjusaka.blog/posts/2025/04/26/3-14-is-one-of-the-best-python-version/index.html><meta property=og:site_name content=Manjusaka><meta property=og:description content="Python 3.14 目前主要的一些主要的特性其实已经固定了，在我看来，Python 3.14 是一个未来很多年的一个核心版本。因为其确定了是时代的 Python调试生态的基准，这篇文章将会来聊聊这个 Python 世界中的史诗级改进"><meta property=og:locale content=en_US><meta property=og:image content=https://cdn.pixabay.com/photo/2023/02/08/15/10/sculpture-7776861_1280.jpg><meta property=article:published_time content=2025-04-26T14:49:00.000Z><meta property=article:modified_time content=2025-07-27T19:26:02.694Z><meta property=article:author content=Manjusaka><meta property=article:tag content=编程><meta property=article:tag content=Linux><meta property=article:tag content=Python><meta property=article:tag content=笔记><meta property=article:tag content=水文><meta name=twitter:card content=summary><meta name=twitter:image content="https://avatars.githubusercontent.com/u/7054676?v=4"><meta name=twitter:creator content=@Manjusaka_Lee><meta name=twitter:site content=https://twitter.com/Manjusaka_Lee><script type=application/ld+json>{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Python 3.14: Python 世界的一大步",
  "url": "https://www.manjusaka.blog/posts/2025/04/26/3-14-is-one-of-the-best-python-version/",
  "image": "https://cdn.pixabay.com/photo/2023/02/08/15/10/sculpture-7776861_1280.jpg",
  "datePublished": "2025-04-26T14:49:00.000Z",
  "dateModified": "2025-07-27T19:26:02.694Z",
  "author": [
    {
      "@type": "Person",
      "name": "Manjusaka",
      "url": "https://github.com/Zheaoli"
    }
  ]
}</script><link rel="shortcut icon" href="https://avatars.githubusercontent.com/u/7054676?v=4"><link rel=canonical href=https://www.manjusaka.blog/posts/2025/04/26/3-14-is-one-of-the-best-python-version/index.html><link rel=preconnect href=//cdn.jsdelivr.net><link rel=preconnect href=//www.google-analytics.com crossorigin=""><link rel=preconnect href=//busuanzi.ibruce.info><link rel=stylesheet href=/css/index.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css media=print onload='this.media="all"'><script>(()=>{let t={set:(e,t,a)=>{a&&(a=Date.now()+864e5*a,localStorage.setItem(e,JSON.stringify({value:t,expiry:a})))},get:e=>{var t=localStorage.getItem(e);if(t){var{value:t,expiry:a}=JSON.parse(t);if(!(Date.now()>a))return t;localStorage.removeItem(e)}}},a=(window.btf={saveToLocal:t,getScript:(o,r={})=>new Promise((e,t)=>{let a=document.createElement("script");a.src=o,a.async=!0,Object.entries(r).forEach(([e,t])=>a.setAttribute(e,t)),a.onload=a.onreadystatechange=()=>{a.readyState&&!/loaded|complete/.test(a.readyState)||e()},a.onerror=t,document.head.appendChild(a)}),getCSS:(o,r)=>new Promise((e,t)=>{let a=document.createElement("link");a.rel="stylesheet",a.href=o,r&&(a.id=r),a.onload=a.onreadystatechange=()=>{a.readyState&&!/loaded|complete/.test(a.readyState)||e()},a.onerror=t,document.head.appendChild(a)}),addGlobalFn:(e,t,a=!1,o=window)=>{var r;e.startsWith("pjax")||((r=o.globalFn||{})[e]=r[e]||{},r[e][a||Object.keys(r[e]).length]=t,o.globalFn=r)}},()=>{document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")}),o=()=>{document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","ffffff")};btf.activateDarkMode=a,btf.activateLightMode=o;var r=t.get("theme"),n=window.matchMedia("(prefers-color-scheme: dark)"),d=window.matchMedia("(prefers-color-scheme: light)"),d=(void 0===r?((!d.matches&&(n.matches||(d=(new Date).getHours())<=6||18<=d)?a:o)(),n.addEventListener("change",()=>{void 0===t.get("theme")&&(e.matches?a:o)()})):("light"===r?o:a)(),t.get("aside-status"));void 0!==d&&document.documentElement.classList.toggle("hide-aside","hide"===d);/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})()</script><script async=async src="https://www.googletagmanager.com/gtag/js?id=UA-154407994-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-154407994-1"),btf.addGlobalFn("pjaxComplete",()=>{gtag("config","UA-154407994-1",{page_path:window.location.pathname})},"google_analytics")</script><script>let GLOBAL_CONFIG={root:"/",algolia:{appId:"DL1RURGHTB",indexName:"manjusaka.blog",hitsPerPage:6,languages:{input_placeholder:"Search",hits_empty:"No results found for: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localSearch:void 0,translate:{defaultEncoding:2,translateDelay:0,msgToTraditionalChinese:"繁",msgToSimplifiedChinese:"簡"},highlight:{plugin:"highlight.js",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:!1,highlightFullpage:!1,highlightMacStyle:!1},copy:{success:"Copy Successful",error:"Copy Failed",noSupport:"Browser Not Supported"},relativeDate:{homepage:!0,post:!0},runtime:"",dateSuffix:{just:"Just now",min:"minutes ago",hour:"hours ago",day:"days ago",month:"months ago"},copyright:{limitCount:100,languages:{author:"Author: Manjusaka",link:"Link: ",source:"Source: Manjusaka",info:"Copyright belongs to the author. For commercial use, please contact the author for authorization. For non-commercial use, please indicate the source."}},lightbox:"null",Snackbar:{chs_to_cht:"You have switched to Traditional Chinese",cht_to_chs:"You have switched to Simplified Chinese",day_to_night:"You have switched to Dark Mode",night_to_day:"You have switched to Light Mode",bgLight:"#59C173",bgDark:"#1f1f1f",position:"bottom-left"},infinitegrid:{js:"https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js",buttonText:"Load More"},isPhotoFigcaption:!0,islazyloadPlugin:!0,isAnchor:!0,percent:{toc:!0,rightside:!0},autoDarkmode:!0}</script><script id=config-diff>var GLOBAL_CONFIG_SITE={title:"Python 3.14: Python 世界的一大步",isHighlightShrink:!1,isToc:!0,pageType:"post"}</script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/hexo-butterfly-swiper@1.0.12/lib/swiper.min.css media=print onload='this.media="all"'><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/hexo-butterfly-swiper@1.0.12/lib/swiperstyle.css media=print onload='this.media="all"'><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/hexo-butterfly-tag-plugins-plus@1.0.18/lib/assets/font-awesome-animation.min.css media=defer onload='this.media="all"'><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/hexo-butterfly-tag-plugins-plus@1.0.18/lib/tag_plugins.css media=defer onload='this.media="all"'><script src=https://cdn.jsdelivr.net/npm/hexo-butterfly-tag-plugins-plus@1.0.18/lib/assets/carousel-touch.js></script><meta name=generator content="Hexo 7.3.0"><link rel=alternate href=/atom.xml title=Manjusaka type=application/atom+xml></head><body><div id=loading-box><div class=loading-left-bg></div><div class=loading-right-bg></div><div class=spinner-box><div class=configure-border-1><div class=configure-core></div></div><div class=configure-border-2><div class=configure-core></div></div><div class=loading-word>Loading...</div></div></div><script>(()=>{let e=document.getElementById("loading-box"),d=document.body;const o=()=>{d.style.overflow="",e.classList.add("loaded")},l=()=>{d.style.overflow="hidden",e.classList.remove("loaded")};l(),window.addEventListener("load",o)})()</script><div id=web_bg style="background-image:url('url(https://cdn.jsdelivr.net/gh/youngjuning/images@main/1680450445599.png)')"></div><div id=sidebar><div id=menu-mask></div><div id=sidebar-menus><div class="avatar-img text-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://avatars.githubusercontent.com/u/7054676?v=4" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt=avatar></div><div class="site-data text-center"><a href=/archives/ ><div class=headline>Articles</div><div class=length-num>104</div></a><a href=/tags/ ><div class=headline>Tags</div><div class=length-num>60</div></a><a href=/categories/ ><div class=headline>Categories</div><div class=length-num>41</div></a></div><div class=menus_items><div class=menus_item><a class=site-page href=/ ><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class=menus_item><span class="site-page group"><i class="fa-fw fa-fw fas fa-lines-leaning"></i><span> 文章</span><i class="fas fa-chevron-down"></i></span><ul class=menus_item_child><li><a class="site-page child" href=/categories/ ><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href=/tags/ ><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href=/archives/ ><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href=/random/ ><i class="fa-fw fas fa-random"></i><span> 随便逛逛</span></a></li></ul></div><div class=menus_item><a class=site-page href=/weekly/ ><i class="fa-fw fas fa-newspaper"></i><span> 周报</span></a></div><div class=menus_item><a class=site-page href=/leetcode/ ><i class="fa-fw fas fa-newspaper"></i><span> 刷题</span></a></div><div class=menus_item><span class="site-page group"><i class="fa-fw fas fa-heart"></i><span> 我的</span><i class="fas fa-chevron-down"></i></span><ul class=menus_item_child><li><a class="site-page child" href=/about/ ><i class="fa-fw fas fa-spa"></i><span> 关于</span></a></li><li><a class="site-page child" href=/weekly/ ><i class="fa-fw fas fa-newspaper"></i><span> 周报</span></a></li></ul></div></div></div></div><div class="post type-tags" id=body-wrap><header class=post-bg id=page-header style=background-image:url(https://cdn.pixabay.com/photo/2023/02/08/15/10/sculpture-7776861_1280.jpg)><nav id=nav><span id=blog-info><a class=nav-site-title href=/ ><img class=site-icon src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://avatars.githubusercontent.com/u/7054676?v=4# image" alt=Logo><span class=site-name>Manjusaka</span></a><a class=nav-page-title href=/ ><span class=site-name>Python 3.14: Python 世界的一大步</span></a></span><div id=menus><div id=search-button><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></span></div><div class=menus_items><div class=menus_item><a class=site-page href=/ ><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class=menus_item><span class="site-page group"><i class="fa-fw fa-fw fas fa-lines-leaning"></i><span> 文章</span><i class="fas fa-chevron-down"></i></span><ul class=menus_item_child><li><a class="site-page child" href=/categories/ ><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href=/tags/ ><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href=/archives/ ><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href=/random/ ><i class="fa-fw fas fa-random"></i><span> 随便逛逛</span></a></li></ul></div><div class=menus_item><a class=site-page href=/weekly/ ><i class="fa-fw fas fa-newspaper"></i><span> 周报</span></a></div><div class=menus_item><a class=site-page href=/leetcode/ ><i class="fa-fw fas fa-newspaper"></i><span> 刷题</span></a></div><div class=menus_item><span class="site-page group"><i class="fa-fw fas fa-heart"></i><span> 我的</span><i class="fas fa-chevron-down"></i></span><ul class=menus_item_child><li><a class="site-page child" href=/about/ ><i class="fa-fw fas fa-spa"></i><span> 关于</span></a></li><li><a class="site-page child" href=/weekly/ ><i class="fa-fw fas fa-newspaper"></i><span> 周报</span></a></li></ul></div></div><div id=toggle-menu><span class=site-page><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id=post-info><h1 class=post-title>Python 3.14: Python 世界的一大步<a class=post-edit-link href=https://github.com/Zheaoli/Zheaoli.github.io/edit/main/source/_posts/3-14-is-one-of-the-best-python-version.md rel="external nofollow noreferrer" title=Edit target=_blank><i class="fas fa-pencil-alt"></i></a></h1><div id=post-meta><div class=meta-firstline><span class=post-meta-date><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class=post-meta-label>Created</span><time datetime=2025-04-26T14:49:00.000Z title="Created 2025-04-26 22:49:00">2025-04-26</time></span><span class=post-meta-categories><span class=post-meta-separator>|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class=post-meta-categories href=/categories/%E7%BC%96%E7%A8%8B/ >编程</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class=post-meta-categories href=/categories/%E7%BC%96%E7%A8%8B/Python/ >Python</a></span></div><div class=meta-secondline><span class=post-meta-separator>|</span><span class=post-meta-wordcount><i class="far fa-file-word fa-fw post-meta-icon"></i><span class=post-meta-label>Word Count:</span><span class=word-count>4.8k</span><span class=post-meta-separator>|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class=post-meta-label>Reading Time:</span><span>23mins</span></span><span class=post-meta-separator>|</span><span class=post-meta-pv-cv id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class=post-meta-label>Post Views:</span><span id=busuanzi_value_page_pv><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class=layout id=content-inner><div id=post><article class="container post-content" id=article-container><div id=post-outdate-notice data="{&quot;limitDay&quot;:365,&quot;messagePrev&quot;:&quot;It has been&quot;,&quot;messageNext&quot;:&quot;days since the last update, the content of the article may be outdated.&quot;,&quot;postUpdate&quot;:&quot;2025-07-28 03:26:02&quot;}" hidden></div><p>Python 3.14 目前主要的一些主要的特性其实已经固定了，在我看来，Python 3.14 是一个未来很多年的一个核心版本。因为其确定了是时代的 Python<br>调试生态的基准，这篇文章将会来聊聊这个 Python 世界中的史诗级改进</p><span id=more></span><h2 id=正文><a href=#正文 class=headerlink title=正文></a>正文</h2><p>在我们日常调试 Python 代码的时候，我们经常会遇到这样一个问题，我们需要采样当前的 Python Runtime 的状态，进而进一步调试我们的 Python 进程</p><p>常见的手段莫过于两种</p><ol><li>通过 eBPF + UProbe 等手段来触发</li><li>通过 <code>process_vm_readv</code> 等 Syscall 来直接整块读取内存</li></ol><p>无论这两种方式都有一个核心的问题，我们怎么样来解析内存中的数据？</p><p>用 <a href=https://github.com/jschwinger233/perf-examples/blob/main/cpython310_backtrace/bpf.c rel="external nofollow noreferrer">https://github.com/jschwinger233/perf-examples/blob/main/cpython310_backtrace/bpf.c</a> 来做一个例子，在之前的很多年的时候，我们会怎么做</p><figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br><span class=line>65</span><br><span class=line>66</span><br><span class=line>67</span><br><span class=line>68</span><br><span class=line>69</span><br><span class=line>70</span><br><span class=line>71</span><br><span class=line>72</span><br><span class=line>73</span><br><span class=line>74</span><br><span class=line>75</span><br><span class=line>76</span><br><span class=line>77</span><br><span class=line>78</span><br><span class=line>79</span><br><span class=line>80</span><br><span class=line>81</span><br><span class=line>82</span><br><span class=line>83</span><br><span class=line>84</span><br><span class=line>85</span><br><span class=line>86</span><br><span class=line>87</span><br><span class=line>88</span><br><span class=line>89</span><br><span class=line>90</span><br><span class=line>91</span><br><span class=line>92</span><br><span class=line>93</span><br><span class=line>94</span><br><span class=line>95</span><br><span class=line>96</span><br><span class=line>97</span><br><span class=line>98</span><br><span class=line>99</span><br><span class=line>100</span><br><span class=line>101</span><br><span class=line>102</span><br><span class=line>103</span><br><span class=line>104</span><br><span class=line>105</span><br><span class=line>106</span><br><span class=line>107</span><br><span class=line>108</span><br><span class=line>109</span><br><span class=line>110</span><br><span class=line>111</span><br><span class=line>112</span><br><span class=line>113</span><br><span class=line>114</span><br><span class=line>115</span><br><span class=line>116</span><br><span class=line>117</span><br><span class=line>118</span><br><span class=line>119</span><br><span class=line>120</span><br><span class=line>121</span><br><span class=line>122</span><br><span class=line>123</span><br><span class=line>124</span><br><span class=line>125</span><br><span class=line>126</span><br><span class=line>127</span><br><span class=line>128</span><br><span class=line>129</span><br><span class=line>130</span><br><span class=line>131</span><br><span class=line>132</span><br><span class=line>133</span><br></pre></td><td class=code><pre><span class=line><span class=meta>#<span class=keyword>define</span> PAGE_SIZE (1&lt;&lt;12)</span></span><br><span class=line><span class=meta>#<span class=keyword>define</span> KASAN_STACK_ORDER 0</span></span><br><span class=line><span class=meta>#<span class=keyword>define</span> THREAD_SIZE_ORDER (2 + KASAN_STACK_ORDER)</span></span><br><span class=line><span class=meta>#<span class=keyword>define</span> THREAD_SIZE  ((__u64)(PAGE_SIZE &lt;&lt; THREAD_SIZE_ORDER))</span></span><br><span class=line><span class=meta>#<span class=keyword>define</span> TOP_OF_KERNEL_STACK_PADDING ((__u64)0)</span></span><br><span class=line></span><br><span class=line><span class=type>const</span> <span class=type>static</span> u32 ZERO = <span class=number>0</span>;</span><br><span class=line></span><br><span class=line><span class=class><span class=keyword>struct</span> <span class=title>PyTypeObject</span> &#123;</span></span><br><span class=line>    <span class=type>char</span> _[<span class=number>24</span>];</span><br><span class=line>    <span class=type>char</span> *tp_name;</span><br><span class=line>&#125;;</span><br><span class=line></span><br><span class=line><span class=class><span class=keyword>struct</span> <span class=title>PyObject</span> &#123;</span></span><br><span class=line>    <span class=type>char</span> _[<span class=number>8</span>];</span><br><span class=line>    <span class=class><span class=keyword>struct</span> <span class=title>PyTypeObject</span> *<span class=title>ob_type</span>;</span></span><br><span class=line>&#125;;</span><br><span class=line></span><br><span class=line><span class=class><span class=keyword>struct</span> <span class=title>PyVarObject</span> &#123;</span></span><br><span class=line>    <span class=class><span class=keyword>struct</span> <span class=title>PyObject</span> <span class=title>ob_base</span>;</span></span><br><span class=line>    <span class=type>char</span> _[<span class=number>8</span>];</span><br><span class=line>&#125;;</span><br><span class=line></span><br><span class=line><span class=class><span class=keyword>struct</span> <span class=title>PyASCIIObject</span> &#123;</span></span><br><span class=line>	__u8 _[<span class=number>16</span>];</span><br><span class=line>	__u64 length;</span><br><span class=line>	__u8 __[<span class=number>24</span>];</span><br><span class=line>&#125;;</span><br><span class=line></span><br><span class=line><span class=class><span class=keyword>struct</span> _<span class=title>PyStr</span> &#123;</span></span><br><span class=line>    <span class=class><span class=keyword>struct</span> <span class=title>PyASCIIObject</span> <span class=title>ascii</span>;</span></span><br><span class=line>    <span class=type>char</span> buf[<span class=number>100</span>];</span><br><span class=line>&#125;;</span><br><span class=line></span><br><span class=line><span class=class><span class=keyword>struct</span> <span class=title>PyCodeObject</span> &#123;</span></span><br><span class=line>    <span class=type>char</span> _[<span class=number>104</span>];</span><br><span class=line>    <span class=class><span class=keyword>struct</span> _<span class=title>PyStr</span> *<span class=title>co_filename</span>;</span></span><br><span class=line>    <span class=class><span class=keyword>struct</span> _<span class=title>PyStr</span> *<span class=title>co_name</span>;</span></span><br><span class=line>&#125;;</span><br><span class=line></span><br><span class=line><span class=class><span class=keyword>struct</span> <span class=title>PyFrameObject</span> &#123;</span></span><br><span class=line>    <span class=class><span class=keyword>struct</span> <span class=title>PyVarObject</span> <span class=title>ob_base</span>;</span></span><br><span class=line>    <span class=class><span class=keyword>struct</span> <span class=title>PyFrameObject</span> *<span class=title>f_back</span>;</span></span><br><span class=line>    <span class=class><span class=keyword>struct</span> <span class=title>PyCodeObject</span> *<span class=title>f_code</span>;</span></span><br><span class=line>    <span class=type>char</span> _[<span class=number>60</span>];</span><br><span class=line>    <span class=type>int</span> f_lineno;</span><br><span class=line>&#125;;</span><br><span class=line></span><br><span class=line><span class=class><span class=keyword>struct</span> <span class=title>event</span> &#123;</span></span><br><span class=line>	__u64 rip;</span><br><span class=line>	__u8 user_mode;</span><br><span class=line>	__s8 python_stack_depth;</span><br><span class=line>	__u64 filename_len[<span class=number>20</span>];</span><br><span class=line>	__u64 funcname_len[<span class=number>20</span>];</span><br><span class=line>	<span class=type>unsigned</span> <span class=type>char</span> filename[<span class=number>20</span>][<span class=number>100</span>];</span><br><span class=line>	<span class=type>unsigned</span> <span class=type>char</span> funcname[<span class=number>20</span>][<span class=number>100</span>];</span><br><span class=line>&#125;;</span><br><span class=line></span><br><span class=line><span class=class><span class=keyword>struct</span> &#123;</span></span><br><span class=line>	__uint(type, BPF_MAP_TYPE_PERCPU_ARRAY);</span><br><span class=line>	__uint(max_entries, <span class=number>1</span>);</span><br><span class=line>	__type(key, u32);</span><br><span class=line>	__type(value, <span class=keyword>struct</span> event);</span><br><span class=line>&#125; events <span class="title function_">SEC</span><span class=params>(<span class=string>&quot;.maps&quot;</span>)</span>;</span><br><span class=line></span><br><span class=line><span class=class><span class=keyword>struct</span> &#123;</span></span><br><span class=line>	__uint(type, BPF_MAP_TYPE_RINGBUF);</span><br><span class=line>	__uint(max_entries, <span class=number>1</span>&lt;&lt;<span class=number>29</span>);</span><br><span class=line>&#125; ringbuf <span class="title function_">SEC</span><span class=params>(<span class=string>&quot;.maps&quot;</span>)</span>;</span><br><span class=line></span><br><span class=line>SEC(<span class=string>&quot;perf_event/cpython310&quot;</span>)</span><br><span class=line><span class=type>int</span> <span class="title function_">perf_event_cpython310</span><span class=params>(<span class=keyword>struct</span> bpf_perf_event_data *ctx)</span></span><br><span class=line>&#123;</span><br><span class=line>	__u64 rsp;</span><br><span class=line>	<span class=class><span class=keyword>struct</span> <span class=title>event</span> *<span class=title>event</span>;</span></span><br><span class=line>	<span class=class><span class=keyword>struct</span> <span class=title>PyFrameObject</span> *<span class=title>frame</span>;</span></span><br><span class=line></span><br><span class=line>	event = bpf_map_lookup_elem(&amp;events, &amp;ZERO);</span><br><span class=line>	<span class=keyword>if</span> (!event)</span><br><span class=line>		<span class=keyword>return</span> <span class=number>0</span>;</span><br><span class=line></span><br><span class=line>	rsp = ctx-&gt;regs.sp;</span><br><span class=line>	event-&gt;rip = ctx-&gt;regs.ip;</span><br><span class=line>	event-&gt;user_mode = !!(ctx-&gt;regs.cs &amp; <span class=number>3</span>);</span><br><span class=line></span><br><span class=line>	<span class=keyword>if</span> (!event-&gt;user_mode) &#123;</span><br><span class=line>		<span class=class><span class=keyword>struct</span> <span class=title>task_struct</span> *<span class=title>task</span> =</span> (<span class=keyword>struct</span> task_struct *)bpf_get_current_task();</span><br><span class=line>		__u64 __ptr = (__u64)BPF_CORE_READ(task, <span class=built_in>stack</span>);</span><br><span class=line>		__ptr += THREAD_SIZE - TOP_OF_KERNEL_STACK_PADDING;</span><br><span class=line>		<span class=class><span class=keyword>struct</span> <span class=title>pt_regs</span> *<span class=title>pt_regs</span> =</span> ((<span class=keyword>struct</span> pt_regs *)__ptr) - <span class=number>1</span>;</span><br><span class=line></span><br><span class=line>		rsp = BPF_CORE_READ(pt_regs, sp);</span><br><span class=line>		event-&gt;rip = BPF_CORE_READ(pt_regs, ip);</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>	<span class=type>char</span> name[<span class=number>5</span>];</span><br><span class=line>	<span class=type>bool</span> found = <span class=literal>false</span>;</span><br><span class=line></span><br><span class=line>	<span class=keyword>for</span> (<span class=type>int</span> i = <span class=number>0</span>; i &lt; <span class=number>200</span>; i++) &#123;</span><br><span class=line>		bpf_probe_read_user(&amp;frame, <span class=keyword>sizeof</span>(frame), (<span class=type>void</span> *)rsp + <span class=number>8</span>*i);</span><br><span class=line>		<span class=keyword>if</span> (!frame)</span><br><span class=line>			<span class=keyword>continue</span>;</span><br><span class=line></span><br><span class=line>		<span class=type>char</span> *tp_name = BPF_PROBE_READ_USER(frame, ob_base.ob_base.ob_type, tp_name);</span><br><span class=line>		bpf_probe_read_user(&amp;name, <span class=keyword>sizeof</span>(name), (<span class=type>void</span> *)tp_name);</span><br><span class=line>		<span class=keyword>if</span> (bpf_strncmp(name, <span class=number>5</span>, <span class=string>&quot;frame&quot;</span>) == <span class=number>0</span>) &#123;</span><br><span class=line>			found = <span class=literal>true</span>;</span><br><span class=line>			<span class=keyword>break</span>;</span><br><span class=line>		&#125;</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>	<span class=keyword>if</span> (!found) &#123;</span><br><span class=line>		event-&gt;python_stack_depth = <span class=number>-1</span>;</span><br><span class=line>		bpf_ringbuf_output(&amp;ringbuf, event, <span class=keyword>sizeof</span>(*event), <span class=number>0</span>);</span><br><span class=line>		<span class=keyword>return</span> <span class=number>0</span>;</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>	<span class=keyword>for</span> (<span class=type>int</span> i = <span class=number>0</span>; i &lt; <span class=number>20</span>; i++) &#123;</span><br><span class=line>		event-&gt;python_stack_depth = i;</span><br><span class=line>		BPF_PROBE_READ_USER_INTO(&amp;event-&gt;filename_len[i], frame, f_code, co_filename, ascii.length);</span><br><span class=line>		BPF_PROBE_READ_USER_INTO(&amp;event-&gt;filename[i], frame, f_code, co_filename, buf);</span><br><span class=line>		BPF_PROBE_READ_USER_INTO(&amp;event-&gt;funcname_len[i], frame, f_code, co_name, ascii.length);</span><br><span class=line>		BPF_PROBE_READ_USER_INTO(&amp;event-&gt;funcname[i], frame, f_code, co_name, buf);</span><br><span class=line>		frame = BPF_PROBE_READ_USER(frame, f_back);</span><br><span class=line>		<span class=keyword>if</span> (!frame)</span><br><span class=line>			<span class=keyword>break</span>;</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>	bpf_ringbuf_output(&amp;ringbuf, event, <span class=keyword>sizeof</span>(*event), <span class=number>0</span>);</span><br><span class=line>	<span class=keyword>return</span> <span class=number>0</span>;</span><br><span class=line>&#125;</span><br><span class=line></span><br><span class=line><span class=type>char</span> __license[] SEC(<span class=string>&quot;license&quot;</span>) = <span class=string>&quot;Dual MIT/GPL&quot;</span>;</span><br></pre></td></tr></table></figure><p>上面的核心代码其实没多少，核心的逻辑就还是我们手动模拟 Python 中关键的 <code>PyFrameObject</code> 结构体，然后我们在内存中不断做一次搜索，暴力匹配到特征一致的内存</p><p>其余诸如 PySpy 这样的工具也是类似的思路</p><p>这个方式最核心的问题是在于说，Python 每个版本的 ABI 都可能发生变化，所以我们需要不断的根据不同的版本去做兼容（比如 PySpy 维护了从3.7到3.12的不同的 <code>PyFrameObject</code>。</p><p>那么我们有没有更好的方法来处理这个问题？或者说我们能不能更好的去定位？</p><p>可以的，写 Python 的同学肯定都知道我们 Python 中有一个全局的变量 <code>_PyRuntime</code>，其类型为 <code>pyruntimestate</code>，大致的布局如下</p><figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br><span class=line>65</span><br><span class=line>66</span><br><span class=line>67</span><br><span class=line>68</span><br><span class=line>69</span><br><span class=line>70</span><br><span class=line>71</span><br><span class=line>72</span><br><span class=line>73</span><br><span class=line>74</span><br><span class=line>75</span><br><span class=line>76</span><br><span class=line>77</span><br><span class=line>78</span><br><span class=line>79</span><br><span class=line>80</span><br><span class=line>81</span><br><span class=line>82</span><br><span class=line>83</span><br><span class=line>84</span><br><span class=line>85</span><br><span class=line>86</span><br><span class=line>87</span><br><span class=line>88</span><br><span class=line>89</span><br><span class=line>90</span><br><span class=line>91</span><br><span class=line>92</span><br><span class=line>93</span><br></pre></td><td class=code><pre><span class=line><span class=class><span class=keyword>struct</span> <span class=title>pyruntimestate</span> &#123;</span></span><br><span class=line></span><br><span class=line>    _Py_DebugOffsets debug_offsets;</span><br><span class=line></span><br><span class=line>    <span class=type>int</span> _initialized;</span><br><span class=line></span><br><span class=line>    <span class=type>int</span> preinitializing;</span><br><span class=line></span><br><span class=line>    <span class=type>int</span> preinitialized;</span><br><span class=line></span><br><span class=line>    <span class=type>int</span> core_initialized;</span><br><span class=line></span><br><span class=line>    <span class=type>int</span> initialized;</span><br><span class=line></span><br><span class=line>    PyThreadState *_finalizing;</span><br><span class=line></span><br><span class=line>    <span class=type>unsigned</span> <span class=type>long</span> _finalizing_id;</span><br><span class=line></span><br><span class=line>    <span class=class><span class=keyword>struct</span> <span class=title>pyinterpreters</span> &#123;</span></span><br><span class=line>        PyMutex mutex;</span><br><span class=line>        PyInterpreterState *head;</span><br><span class=line></span><br><span class=line>        PyInterpreterState *main;</span><br><span class=line></span><br><span class=line>        <span class=type>int64_t</span> next_id;</span><br><span class=line>    &#125; interpreters;</span><br><span class=line></span><br><span class=line></span><br><span class=line>    <span class=type>unsigned</span> <span class=type>long</span> main_thread;</span><br><span class=line>    PyThreadState *main_tstate;</span><br><span class=line></span><br><span class=line></span><br><span class=line>    _PyXI_global_state_t xi;</span><br><span class=line></span><br><span class=line>    <span class=class><span class=keyword>struct</span> _<span class=title>pymem_allocators</span> <span class=title>allocators</span>;</span></span><br><span class=line>    <span class=class><span class=keyword>struct</span> _<span class=title>obmalloc_global_state</span> <span class=title>obmalloc</span>;</span></span><br><span class=line>    <span class=class><span class=keyword>struct</span> <span class=title>pyhash_runtime_state</span> <span class=title>pyhash_state</span>;</span></span><br><span class=line>    <span class=class><span class=keyword>struct</span> _<span class=title>pythread_runtime_state</span> <span class=title>threads</span>;</span></span><br><span class=line>    <span class=class><span class=keyword>struct</span> _<span class=title>signals_runtime_state</span> <span class=title>signals</span>;</span></span><br><span class=line></span><br><span class=line>    Py_tss_t autoTSSkey;</span><br><span class=line></span><br><span class=line>    Py_tss_t trashTSSkey;</span><br><span class=line></span><br><span class=line>    PyWideStringList orig_argv;</span><br><span class=line></span><br><span class=line>    <span class=class><span class=keyword>struct</span> _<span class=title>parser_runtime_state</span> <span class=title>parser</span>;</span></span><br><span class=line></span><br><span class=line>    <span class=class><span class=keyword>struct</span> _<span class=title>atexit_runtime_state</span> <span class=title>atexit</span>;</span></span><br><span class=line></span><br><span class=line>    <span class=class><span class=keyword>struct</span> _<span class=title>import_runtime_state</span> <span class=title>imports</span>;</span></span><br><span class=line>    <span class=class><span class=keyword>struct</span> _<span class=title>ceval_runtime_state</span> <span class=title>ceval</span>;</span></span><br><span class=line>    <span class=class><span class=keyword>struct</span> _<span class=title>gilstate_runtime_state</span> &#123;</span></span><br><span class=line></span><br><span class=line>        <span class=type>int</span> check_enabled;</span><br><span class=line></span><br><span class=line>        PyInterpreterState *autoInterpreterState;</span><br><span class=line>    &#125; gilstate;</span><br><span class=line>    <span class=class><span class=keyword>struct</span> _<span class=title>getargs_runtime_state</span> &#123;</span></span><br><span class=line>        <span class=class><span class=keyword>struct</span> _<span class=title>PyArg_Parser</span> *<span class=title>static_parsers</span>;</span></span><br><span class=line>    &#125; getargs;</span><br><span class=line>    <span class=class><span class=keyword>struct</span> _<span class=title>fileutils_state</span> <span class=title>fileutils</span>;</span></span><br><span class=line>    <span class=class><span class=keyword>struct</span> _<span class=title>faulthandler_runtime_state</span> <span class=title>faulthandler</span>;</span></span><br><span class=line>    <span class=class><span class=keyword>struct</span> _<span class=title>tracemalloc_runtime_state</span> <span class=title>tracemalloc</span>;</span></span><br><span class=line>    <span class=class><span class=keyword>struct</span> _<span class=title>reftracer_runtime_state</span> <span class=title>ref_tracer</span>;</span></span><br><span class=line></span><br><span class=line>    _PyRWMutex stoptheworld_mutex;</span><br><span class=line>    <span class=class><span class=keyword>struct</span> _<span class=title>stoptheworld_state</span> <span class=title>stoptheworld</span>;</span></span><br><span class=line></span><br><span class=line>    PyPreConfig preconfig;</span><br><span class=line>    Py_OpenCodeHookFunction open_code_hook;</span><br><span class=line>    <span class=type>void</span> *open_code_userdata;</span><br><span class=line>    <span class=class><span class=keyword>struct</span> &#123;</span></span><br><span class=line>        PyMutex mutex;</span><br><span class=line>        <span class=class><span class=keyword>struct</span> _<span class=title>Py_AuditHookEntry</span> *<span class=title>head</span>;</span></span><br><span class=line>    &#125; audit_hooks;</span><br><span class=line></span><br><span class=line>    <span class=class><span class=keyword>struct</span> _<span class=title>py_object_runtime_state</span> <span class=title>object_state</span>;</span></span><br><span class=line>    <span class=class><span class=keyword>struct</span> _<span class=title>Py_float_runtime_state</span> <span class=title>float_state</span>;</span></span><br><span class=line>    <span class=class><span class=keyword>struct</span> _<span class=title>Py_unicode_runtime_state</span> <span class=title>unicode_state</span>;</span></span><br><span class=line>    <span class=class><span class=keyword>struct</span> _<span class=title>types_runtime_state</span> <span class=title>types</span>;</span></span><br><span class=line>    <span class=class><span class=keyword>struct</span> _<span class=title>Py_time_runtime_state</span> <span class=title>time</span>;</span></span><br><span class=line></span><br><span class=line><span class=meta>#<span class=keyword>if</span> defined(__EMSCRIPTEN__) &amp;&amp; defined(PY_CALL_TRAMPOLINE)</span></span><br><span class=line></span><br><span class=line>    <span class=type>int</span> (*emscripten_count_args_function)(PyCFunctionWithKeywords func);</span><br><span class=line><span class=meta>#<span class=keyword>endif</span></span></span><br><span class=line>    <span class=class><span class=keyword>struct</span> _<span class=title>Py_cached_objects</span> <span class=title>cached_objects</span>;</span></span><br><span class=line>    <span class=class><span class=keyword>struct</span> _<span class=title>Py_static_objects</span> <span class=title>static_objects</span>;</span></span><br><span class=line></span><br><span class=line>    PyInterpreterState _main_interpreter;</span><br><span class=line></span><br><span class=line>&#125;;</span><br></pre></td></tr></table></figure><p>眼尖的同学肯定看到了，我们其中有一段核心的代码</p><figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre></td><td class=code><pre><span class=line><span class=class><span class=keyword>struct</span> <span class=title>pyinterpreters</span> &#123;</span></span><br><span class=line>    PyMutex mutex;</span><br><span class=line>    PyInterpreterState *head;</span><br><span class=line></span><br><span class=line>    PyInterpreterState *main;</span><br><span class=line></span><br><span class=line>    <span class=type>int64_t</span> next_id;</span><br><span class=line>&#125; interpreters;</span><br></pre></td></tr></table></figure><p>维护了一个 <code>PyInterpreterState</code> 的链表，我们可以通过 <code>PyInterpreterState</code> 来获取当前的 Frame，<code>PyInterpreterState</code> 中的 TreadState 来获取当前的线程状态</p><figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br></pre></td><td class=code><pre><span class=line><span class=class><span class=keyword>struct</span> <span class=title>pythreads</span> &#123;</span></span><br><span class=line>    <span class=type>uint64_t</span> next_unique_id;</span><br><span class=line>    <span class=comment>/* The linked list of threads, newest first. */</span></span><br><span class=line>    PyThreadState *head;</span><br><span class=line>    _PyThreadStateImpl *preallocated;</span><br><span class=line>    <span class=comment>/* The thread currently executing in the __main__ module, if any. */</span></span><br><span class=line>    PyThreadState *main;</span><br><span class=line>    <span class=comment>/* Used in Modules/_threadmodule.c. */</span></span><br><span class=line>    Py_ssize_t count;</span><br><span class=line>    <span class=comment>/* Support for runtime thread stack size tuning.</span></span><br><span class=line><span class=comment>       A value of 0 means using the platform&#x27;s default stack size</span></span><br><span class=line><span class=comment>       or the size specified by the THREAD_STACK_SIZE macro. */</span></span><br><span class=line>    <span class=comment>/* Used in Python/thread.c. */</span></span><br><span class=line>    <span class=type>size_t</span> stacksize;</span><br><span class=line>&#125; threads;</span><br></pre></td></tr></table></figure><p>而 <code>PyThreadState</code> 中和核心的 <code>struct _PyInterpreterFrame *current_frame</code> 就是我们需要的 frame state，整个流程大概如下</p><pre><code class="highlight mermaid">graph TD
    PyRuntime[&quot;_PyRuntime (pyruntimestate)&quot;] --&gt; Interpreters[&quot;interpreters (pyinterpreters)&quot;]
    Interpreters --&gt;|head| InterpreterStateHead[&quot;PyInterpreterState *head&quot;]
    Interpreters --&gt;|main| InterpreterStateMain[&quot;PyInterpreterState *main&quot;]
    
    %% Define interpreter state structure
    subgraph PyInterpreterState
        InterpreterID[&quot;int64_t id&quot;] 
        ThreadsStruct[&quot;struct pythreads threads&quot;]
        NextInterpreter[&quot;PyInterpreterState *next&quot;]
    end
    
    InterpreterStateHead --- PyInterpreterState
    InterpreterStateMain --- PyInterpreterState
    
    %% Link to threads structure
    ThreadsStruct --&gt; ThreadHead[&quot;PyThreadState *head&quot;]
    ThreadsStruct --&gt; ThreadMain[&quot;PyThreadState *main&quot;]
    
    %% Define thread state structure
    subgraph PyThreadState
        ThreadID[&quot;uint64_t thread_id&quot;]
        InterpreterPtr[&quot;PyInterpreterState *interp&quot;]
        CurrentFrame[&quot;_PyInterpreterFrame *current_frame&quot;]
        NextThread[&quot;PyThreadState *next&quot;]
    end
    
    ThreadHead --- PyThreadState
    ThreadMain --- PyThreadState
    
    %% Frame structure
    CurrentFrame --&gt; Frame[&quot;_PyInterpreterFrame structure&quot;]
    
    subgraph _PyInterpreterFrame
        PreviousFrame[&quot;_PyInterpreterFrame *previous&quot;]
        CodeObject[&quot;PyCodeObject *f_code&quot;]
        Locals[&quot;PyObject **localsplus&quot;]
    end
    
    %% Connected paths in color
    PyRuntime ==&gt;|&quot;Main Path&quot;| Interpreters
    Interpreters ==&gt;|&quot;Main Path&quot;| InterpreterStateMain
    InterpreterStateMain ==&gt;|&quot;Main Path&quot;| ThreadsStruct
    ThreadsStruct ==&gt;|&quot;Main Path&quot;| ThreadMain
    ThreadMain ==&gt;|&quot;Main Path&quot;| CurrentFrame
    CurrentFrame ==&gt;|&quot;Main Path&quot;| Frame
    
    class PyRuntime,InterpreterStateMain,ThreadMain,CurrentFrame,Frame mainPath;
    classDef mainPath fill:#f96,stroke:#333,stroke-width:2px;
    classDef mainNodes fill:#f9f,stroke:#333,stroke-width:2px;</code></pre><p>那么我们现在来解决第一个问题，我们怎么样获取在内存中的 <code>_PyRuntime</code> 的地址呢？</p><p>我们把这个问题抽象成下面最简单一个 C 代码</p><figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre></td><td class=code><pre><span class=line><span class=meta>#<span class=keyword>include</span> <span class=string>&lt;stdio.h&gt;</span></span></span><br><span class=line></span><br><span class=line><span class=type>int</span> abc=<span class=number>3</span>;</span><br><span class=line></span><br><span class=line><span class=type>int</span> <span class="title function_">main</span><span class=params>()</span> &#123;</span><br><span class=line>    <span class=built_in>printf</span>(<span class=string>&quot;abc: %p\n&quot;</span>, &amp;abc);</span><br><span class=line>    <span class=keyword>return</span> <span class=number>0</span>;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>我们怎么样获取 abc 的地址呢？这里写过 C 的同学可能反应过来了，我们可以使用 <code>__attribute__((section()))</code> 的语法，来将其放到一个特定的段中</p><figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre></td><td class=code><pre><span class=line><span class=meta>#<span class=keyword>include</span> <span class=string>&lt;stdio.h&gt;</span></span></span><br><span class=line></span><br><span class=line><span class=type>int</span> abc __attribute__((section(<span class=string>&quot;.my_section&quot;</span>))) = <span class=number>3</span>;</span><br><span class=line></span><br><span class=line><span class=type>int</span> <span class="title function_">main</span><span class=params>()</span> &#123;</span><br><span class=line>    <span class=built_in>printf</span>(<span class=string>&quot;abc: %p\n&quot;</span>, &amp;abc);</span><br><span class=line>    <span class=keyword>return</span> <span class=number>0</span>;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>我们编译，并用 <code>readelf</code> 来解析一下二进制</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line>╰─ readelf -S ./a.out| grep my_section </span><br><span class=line>  [25] .my_section       PROGBITS         0000000000004018  00003018</span><br></pre></td></tr></table></figure><p>我们能看到这里我们得到了一个相对地址。后续我们就可以通过解析 ELF 来遍历寻找到 <code>abc</code> 变量的地址</p><p>那么在 Python 中同样如此，在代码中有这样一段代码</p><figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br></pre></td><td class=code><pre><span class=line><span class=meta>#<span class=keyword>define</span> GENERATE_DEBUG_SECTION(name, declaration)     \</span></span><br><span class=line><span class=meta>   _GENERATE_DEBUG_SECTION_WINDOWS(name)            \</span></span><br><span class=line><span class=meta>   _GENERATE_DEBUG_SECTION_APPLE(name)              \</span></span><br><span class=line><span class=meta>   declaration                                      \</span></span><br><span class=line><span class=meta>   _GENERATE_DEBUG_SECTION_LINUX(name)</span></span><br><span class=line></span><br><span class=line><span class=comment>// Please note that section names are truncated to eight bytes</span></span><br><span class=line><span class=comment>// on Windows!</span></span><br><span class=line><span class=meta>#<span class=keyword>if</span> defined(MS_WINDOWS)</span></span><br><span class=line><span class=meta>#<span class=keyword>define</span> _GENERATE_DEBUG_SECTION_WINDOWS(name)                       \</span></span><br><span class=line><span class=meta>   <span class=keyword>_Pragma</span>(Py_STRINGIFY(section(Py_STRINGIFY(name), read, write))) \</span></span><br><span class=line><span class=meta>   __declspec(allocate(Py_STRINGIFY(name)))</span></span><br><span class=line><span class=meta>#<span class=keyword>else</span></span></span><br><span class=line><span class=meta>#<span class=keyword>define</span> _GENERATE_DEBUG_SECTION_WINDOWS(name)</span></span><br><span class=line><span class=meta>#<span class=keyword>endif</span></span></span><br><span class=line></span><br><span class=line><span class=meta>#<span class=keyword>if</span> defined(__APPLE__)</span></span><br><span class=line><span class=meta>#<span class=keyword>define</span> _GENERATE_DEBUG_SECTION_APPLE(name) \</span></span><br><span class=line><span class=meta>   __attribute__((section(SEG_DATA <span class=string>&quot;,&quot;</span> Py_STRINGIFY(name))))      \</span></span><br><span class=line><span class=meta>   __attribute__((used))</span></span><br><span class=line><span class=meta>#<span class=keyword>else</span></span></span><br><span class=line><span class=meta>#<span class=keyword>define</span> _GENERATE_DEBUG_SECTION_APPLE(name)</span></span><br><span class=line><span class=meta>#<span class=keyword>endif</span></span></span><br><span class=line></span><br><span class=line><span class=meta>#<span class=keyword>if</span> defined(__linux__) &amp;&amp; (defined(__GNUC__) || defined(__clang__))</span></span><br><span class=line><span class=meta>#<span class=keyword>define</span> _GENERATE_DEBUG_SECTION_LINUX(name) \</span></span><br><span class=line><span class=meta>   __attribute__((section(<span class=string>&quot;.&quot;</span> Py_STRINGIFY(name))))               \</span></span><br><span class=line><span class=meta>   __attribute__((used))</span></span><br><span class=line><span class=meta>#<span class=keyword>else</span></span></span><br><span class=line><span class=meta>#<span class=keyword>define</span> _GENERATE_DEBUG_SECTION_LINUX(name)</span></span><br><span class=line><span class=meta>#<span class=keyword>endif</span></span></span><br><span class=line></span><br><span class=line>GENERATE_DEBUG_SECTION(PyRuntime, _PyRuntimeState _PyRuntime)</span><br><span class=line>= _PyRuntimeState_INIT(_PyRuntime, _Py_Debug_Cookie);</span><br><span class=line>_Py_COMP_DIAG_POP</span><br></pre></td></tr></table></figure><p>这样我们就能比较方便的获取到 PyRuntime 在内存中的地址。</p><p>那么现在第二个问题是，我们怎么样通过我们前面介绍的调用链获取到地址？</p><p>大家可能第一反应还是想通过维护不同版本的数据结构来获取具体的地址。不过这里我们有没有办法可以用更简单的方法来处理呢？答案是有的</p><p>眼尖的同学可能看到了我们在 <code>pyruntimestate</code> 中有一个字段叫 <code>debug_offsets</code>，我们来看下我们怎么初始化这个字段的吧</p><figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br><span class=line>65</span><br><span class=line>66</span><br><span class=line>67</span><br><span class=line>68</span><br><span class=line>69</span><br><span class=line>70</span><br><span class=line>71</span><br><span class=line>72</span><br><span class=line>73</span><br><span class=line>74</span><br><span class=line>75</span><br><span class=line>76</span><br><span class=line>77</span><br><span class=line>78</span><br><span class=line>79</span><br><span class=line>80</span><br><span class=line>81</span><br><span class=line>82</span><br><span class=line>83</span><br><span class=line>84</span><br><span class=line>85</span><br><span class=line>86</span><br><span class=line>87</span><br><span class=line>88</span><br><span class=line>89</span><br><span class=line>90</span><br><span class=line>91</span><br><span class=line>92</span><br><span class=line>93</span><br><span class=line>94</span><br><span class=line>95</span><br><span class=line>96</span><br><span class=line>97</span><br><span class=line>98</span><br><span class=line>99</span><br><span class=line>100</span><br><span class=line>101</span><br><span class=line>102</span><br><span class=line>103</span><br><span class=line>104</span><br><span class=line>105</span><br><span class=line>106</span><br><span class=line>107</span><br><span class=line>108</span><br><span class=line>109</span><br><span class=line>110</span><br><span class=line>111</span><br><span class=line>112</span><br><span class=line>113</span><br><span class=line>114</span><br><span class=line>115</span><br><span class=line>116</span><br><span class=line>117</span><br><span class=line>118</span><br><span class=line>119</span><br><span class=line>120</span><br><span class=line>121</span><br><span class=line>122</span><br><span class=line>123</span><br><span class=line>124</span><br><span class=line>125</span><br><span class=line>126</span><br><span class=line>127</span><br></pre></td><td class=code><pre><span class=line><span class=meta>#<span class=keyword>define</span> _Py_DebugOffsets_INIT(debug_cookie) &#123; \</span></span><br><span class=line><span class=meta>    .cookie = debug_cookie, \</span></span><br><span class=line><span class=meta>    .version = PY_VERSION_HEX, \</span></span><br><span class=line><span class=meta>    .free_threaded = _Py_Debug_Free_Threaded, \</span></span><br><span class=line><span class=meta>    .runtime_state = &#123; \</span></span><br><span class=line><span class=meta>        .size = sizeof(_PyRuntimeState), \</span></span><br><span class=line><span class=meta>        .finalizing = offsetof(_PyRuntimeState, _finalizing), \</span></span><br><span class=line><span class=meta>        .interpreters_head = offsetof(_PyRuntimeState, interpreters.head), \</span></span><br><span class=line><span class=meta>    &#125;, \</span></span><br><span class=line><span class=meta>    .interpreter_state = &#123; \</span></span><br><span class=line><span class=meta>        .size = sizeof(PyInterpreterState), \</span></span><br><span class=line><span class=meta>        .id = offsetof(PyInterpreterState, id), \</span></span><br><span class=line><span class=meta>        .next = offsetof(PyInterpreterState, next), \</span></span><br><span class=line><span class=meta>        .threads_head = offsetof(PyInterpreterState, threads.head), \</span></span><br><span class=line><span class=meta>        .threads_main = offsetof(PyInterpreterState, threads.main), \</span></span><br><span class=line><span class=meta>        .gc = offsetof(PyInterpreterState, gc), \</span></span><br><span class=line><span class=meta>        .imports_modules = offsetof(PyInterpreterState, imports.modules), \</span></span><br><span class=line><span class=meta>        .sysdict = offsetof(PyInterpreterState, sysdict), \</span></span><br><span class=line><span class=meta>        .builtins = offsetof(PyInterpreterState, builtins), \</span></span><br><span class=line><span class=meta>        .ceval_gil = offsetof(PyInterpreterState, ceval.gil), \</span></span><br><span class=line><span class=meta>        .gil_runtime_state = offsetof(PyInterpreterState, _gil), \</span></span><br><span class=line><span class=meta>        .gil_runtime_state_enabled = _Py_Debug_gilruntimestate_enabled, \</span></span><br><span class=line><span class=meta>        .gil_runtime_state_locked = offsetof(PyInterpreterState, _gil.locked), \</span></span><br><span class=line><span class=meta>        .gil_runtime_state_holder = offsetof(PyInterpreterState, _gil.last_holder), \</span></span><br><span class=line><span class=meta>    &#125;, \</span></span><br><span class=line><span class=meta>    .thread_state = &#123; \</span></span><br><span class=line><span class=meta>        .size = sizeof(PyThreadState), \</span></span><br><span class=line><span class=meta>        .prev = offsetof(PyThreadState, prev), \</span></span><br><span class=line><span class=meta>        .next = offsetof(PyThreadState, next), \</span></span><br><span class=line><span class=meta>        .interp = offsetof(PyThreadState, interp), \</span></span><br><span class=line><span class=meta>        .current_frame = offsetof(PyThreadState, current_frame), \</span></span><br><span class=line><span class=meta>        .thread_id = offsetof(PyThreadState, thread_id), \</span></span><br><span class=line><span class=meta>        .native_thread_id = offsetof(PyThreadState, native_thread_id), \</span></span><br><span class=line><span class=meta>        .datastack_chunk = offsetof(PyThreadState, datastack_chunk), \</span></span><br><span class=line><span class=meta>        .status = offsetof(PyThreadState, _status), \</span></span><br><span class=line><span class=meta>    &#125;, \</span></span><br><span class=line><span class=meta>    .interpreter_frame = &#123; \</span></span><br><span class=line><span class=meta>        .size = sizeof(_PyInterpreterFrame), \</span></span><br><span class=line><span class=meta>        .previous = offsetof(_PyInterpreterFrame, previous), \</span></span><br><span class=line><span class=meta>        .executable = offsetof(_PyInterpreterFrame, f_executable), \</span></span><br><span class=line><span class=meta>        .instr_ptr = offsetof(_PyInterpreterFrame, instr_ptr), \</span></span><br><span class=line><span class=meta>        .localsplus = offsetof(_PyInterpreterFrame, localsplus), \</span></span><br><span class=line><span class=meta>        .owner = offsetof(_PyInterpreterFrame, owner), \</span></span><br><span class=line><span class=meta>        .stackpointer = offsetof(_PyInterpreterFrame, stackpointer), \</span></span><br><span class=line><span class=meta>    &#125;, \</span></span><br><span class=line><span class=meta>    .code_object = &#123; \</span></span><br><span class=line><span class=meta>        .size = sizeof(PyCodeObject), \</span></span><br><span class=line><span class=meta>        .filename = offsetof(PyCodeObject, co_filename), \</span></span><br><span class=line><span class=meta>        .name = offsetof(PyCodeObject, co_name), \</span></span><br><span class=line><span class=meta>        .qualname = offsetof(PyCodeObject, co_qualname), \</span></span><br><span class=line><span class=meta>        .linetable = offsetof(PyCodeObject, co_linetable), \</span></span><br><span class=line><span class=meta>        .firstlineno = offsetof(PyCodeObject, co_firstlineno), \</span></span><br><span class=line><span class=meta>        .argcount = offsetof(PyCodeObject, co_argcount), \</span></span><br><span class=line><span class=meta>        .localsplusnames = offsetof(PyCodeObject, co_localsplusnames), \</span></span><br><span class=line><span class=meta>        .localspluskinds = offsetof(PyCodeObject, co_localspluskinds), \</span></span><br><span class=line><span class=meta>        .co_code_adaptive = offsetof(PyCodeObject, co_code_adaptive), \</span></span><br><span class=line><span class=meta>    &#125;, \</span></span><br><span class=line><span class=meta>    .pyobject = &#123; \</span></span><br><span class=line><span class=meta>        .size = sizeof(PyObject), \</span></span><br><span class=line><span class=meta>        .ob_type = offsetof(PyObject, ob_type), \</span></span><br><span class=line><span class=meta>    &#125;, \</span></span><br><span class=line><span class=meta>    .type_object = &#123; \</span></span><br><span class=line><span class=meta>        .size = sizeof(PyTypeObject), \</span></span><br><span class=line><span class=meta>        .tp_name = offsetof(PyTypeObject, tp_name), \</span></span><br><span class=line><span class=meta>        .tp_repr = offsetof(PyTypeObject, tp_repr), \</span></span><br><span class=line><span class=meta>        .tp_flags = offsetof(PyTypeObject, tp_flags), \</span></span><br><span class=line><span class=meta>    &#125;, \</span></span><br><span class=line><span class=meta>    .tuple_object = &#123; \</span></span><br><span class=line><span class=meta>        .size = sizeof(PyTupleObject), \</span></span><br><span class=line><span class=meta>        .ob_item = offsetof(PyTupleObject, ob_item), \</span></span><br><span class=line><span class=meta>        .ob_size = offsetof(PyTupleObject, ob_base.ob_size), \</span></span><br><span class=line><span class=meta>    &#125;, \</span></span><br><span class=line><span class=meta>    .list_object = &#123; \</span></span><br><span class=line><span class=meta>        .size = sizeof(PyListObject), \</span></span><br><span class=line><span class=meta>        .ob_item = offsetof(PyListObject, ob_item), \</span></span><br><span class=line><span class=meta>        .ob_size = offsetof(PyListObject, ob_base.ob_size), \</span></span><br><span class=line><span class=meta>    &#125;, \</span></span><br><span class=line><span class=meta>    .set_object = &#123; \</span></span><br><span class=line><span class=meta>        .size = sizeof(PySetObject), \</span></span><br><span class=line><span class=meta>        .used = offsetof(PySetObject, used), \</span></span><br><span class=line><span class=meta>        .table = offsetof(PySetObject, table), \</span></span><br><span class=line><span class=meta>        .mask = offsetof(PySetObject, mask), \</span></span><br><span class=line><span class=meta>    &#125;, \</span></span><br><span class=line><span class=meta>    .dict_object = &#123; \</span></span><br><span class=line><span class=meta>        .size = sizeof(PyDictObject), \</span></span><br><span class=line><span class=meta>        .ma_keys = offsetof(PyDictObject, ma_keys), \</span></span><br><span class=line><span class=meta>        .ma_values = offsetof(PyDictObject, ma_values), \</span></span><br><span class=line><span class=meta>    &#125;, \</span></span><br><span class=line><span class=meta>    .float_object = &#123; \</span></span><br><span class=line><span class=meta>        .size = sizeof(PyFloatObject), \</span></span><br><span class=line><span class=meta>        .ob_fval = offsetof(PyFloatObject, ob_fval), \</span></span><br><span class=line><span class=meta>    &#125;, \</span></span><br><span class=line><span class=meta>    .long_object = &#123; \</span></span><br><span class=line><span class=meta>        .size = sizeof(PyLongObject), \</span></span><br><span class=line><span class=meta>        .lv_tag = offsetof(PyLongObject, long_value.lv_tag), \</span></span><br><span class=line><span class=meta>        .ob_digit = offsetof(PyLongObject, long_value.ob_digit), \</span></span><br><span class=line><span class=meta>    &#125;, \</span></span><br><span class=line><span class=meta>    .bytes_object = &#123; \</span></span><br><span class=line><span class=meta>        .size = sizeof(PyBytesObject), \</span></span><br><span class=line><span class=meta>        .ob_size = offsetof(PyBytesObject, ob_base.ob_size), \</span></span><br><span class=line><span class=meta>        .ob_sval = offsetof(PyBytesObject, ob_sval), \</span></span><br><span class=line><span class=meta>    &#125;, \</span></span><br><span class=line><span class=meta>    .unicode_object = &#123; \</span></span><br><span class=line><span class=meta>        .size = sizeof(PyUnicodeObject), \</span></span><br><span class=line><span class=meta>        .state = offsetof(PyUnicodeObject, _base._base.state), \</span></span><br><span class=line><span class=meta>        .length = offsetof(PyUnicodeObject, _base._base.length), \</span></span><br><span class=line><span class=meta>        .asciiobject_size = sizeof(PyASCIIObject), \</span></span><br><span class=line><span class=meta>    &#125;, \</span></span><br><span class=line><span class=meta>    .gc = &#123; \</span></span><br><span class=line><span class=meta>        .size = sizeof(struct _gc_runtime_state), \</span></span><br><span class=line><span class=meta>        .collecting = offsetof(struct _gc_runtime_state, collecting), \</span></span><br><span class=line><span class=meta>    &#125;, \</span></span><br><span class=line><span class=meta>    .gen_object = &#123; \</span></span><br><span class=line><span class=meta>        .size = sizeof(PyGenObject), \</span></span><br><span class=line><span class=meta>        .gi_name = offsetof(PyGenObject, gi_name), \</span></span><br><span class=line><span class=meta>        .gi_iframe = offsetof(PyGenObject, gi_iframe), \</span></span><br><span class=line><span class=meta>        .gi_frame_state = offsetof(PyGenObject, gi_frame_state), \</span></span><br><span class=line><span class=meta>    &#125;, \</span></span><br><span class=line><span class=meta>    .debugger_support = &#123; \</span></span><br><span class=line><span class=meta>        .eval_breaker = offsetof(PyThreadState, eval_breaker), \</span></span><br><span class=line><span class=meta>        .remote_debugger_support = offsetof(PyThreadState, remote_debugger_support),  \</span></span><br><span class=line><span class=meta>        .remote_debugging_enabled = offsetof(PyInterpreterState, config.remote_debug),  \</span></span><br><span class=line><span class=meta>        .debugger_pending_call = offsetof(_PyRemoteDebuggerSupport, debugger_pending_call),  \</span></span><br><span class=line><span class=meta>        .debugger_script_path = offsetof(_PyRemoteDebuggerSupport, debugger_script_path),  \</span></span><br><span class=line><span class=meta>        .debugger_script_path_size = MAX_SCRIPT_PATH_SIZE, \</span></span><br><span class=line><span class=meta>    &#125;, \</span></span><br><span class=line><span class=meta>&#125;</span></span><br></pre></td></tr></table></figure><p>我们能看到我们使用了 <code>offsetof</code> 这个非常经典的宏来将一下我们常用的字段相较于结构体的偏移写入到 <code>debug_offsets</code> 中去。而 <code>debug_offsets</code> 将固定存在于 <code>pyruntimestate</code> 的第一个字段，同时起改变频率相对较低，所以我们就可以通过 <code>debugger_support</code> 获取不同地址的偏移量来获取最终我们想要的数据。</p><p>通过这样的做法，我们实际上就有很多很好玩的事情可以做了。实际上官方也是基于这样一套机制提出了 PEP 768 – Safe external debugger interface for CPython <a href=https://peps.python.org/pep-0768/ rel="external nofollow noreferrer">https://peps.python.org/pep-0768/</a>。可以允许用户远程的为一个 Python 进程注入一段调试代码</p><p>我们来看一下这个 PEP 的核心实现</p><p>在前面介绍过的 ThreadState 中新增了一组结构</p><figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre></td><td class=code><pre><span class=line><span class=keyword>typedef</span> <span class=class><span class=keyword>struct</span> _<span class=title>remote_debugger_support</span> &#123;</span></span><br><span class=line>    <span class=type>int32_t</span> debugger_pending_call;</span><br><span class=line>    <span class=type>char</span> debugger_script_path[MAX_SCRIPT_PATH_SIZE];</span><br><span class=line>&#125; _PyRemoteDebuggerSupport;</span><br></pre></td></tr></table></figure><p>在执行过程中，如果 <code>debugger_pending_call</code> 为 1 的时候，我们就会去执行 <code>debugger_script_path</code> 中的脚本</p><figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br></pre></td><td class=code><pre><span class=line><span class=type>int</span> _PyRunRemoteDebugger(PyThreadState *tstate)</span><br><span class=line>&#123;</span><br><span class=line>    <span class=type>const</span> PyConfig *config = _PyInterpreterState_GetConfig(tstate-&gt;interp);</span><br><span class=line>    <span class=keyword>if</span> (config-&gt;remote_debug == <span class=number>1</span></span><br><span class=line>         &amp;&amp; tstate-&gt;remote_debugger_support.debugger_pending_call == <span class=number>1</span>)</span><br><span class=line>    &#123;</span><br><span class=line>        tstate-&gt;remote_debugger_support.debugger_pending_call = <span class=number>0</span>;</span><br><span class=line></span><br><span class=line>        <span class=comment>// Immediately make a copy in case of a race with another debugger</span></span><br><span class=line>        <span class=comment>// process that&#x27;s trying to write to the buffer. At least this way</span></span><br><span class=line>        <span class=comment>// we&#x27;ll be internally consistent: what we audit is what we run.</span></span><br><span class=line>        <span class=type>const</span> <span class=type>size_t</span> pathsz</span><br><span class=line>            = <span class=keyword>sizeof</span>(tstate-&gt;remote_debugger_support.debugger_script_path);</span><br><span class=line></span><br><span class=line>        <span class=type>char</span> *path = PyMem_Malloc(pathsz);</span><br><span class=line>        <span class=keyword>if</span> (path) &#123;</span><br><span class=line>            <span class=comment>// And don&#x27;t assume the debugger correctly null terminated it.</span></span><br><span class=line>            <span class=built_in>memcpy</span>(</span><br><span class=line>                path,</span><br><span class=line>                tstate-&gt;remote_debugger_support.debugger_script_path,</span><br><span class=line>                pathsz);</span><br><span class=line>            path[pathsz - <span class=number>1</span>] = <span class=string>&#x27;\0&#x27;</span>;</span><br><span class=line>            <span class=keyword>if</span> (*path) &#123;</span><br><span class=line>                run_remote_debugger_script(path);</span><br><span class=line>            &#125;</span><br><span class=line>            PyMem_Free(path);</span><br><span class=line>        &#125;</span><br><span class=line>    &#125;</span><br><span class=line>    <span class=keyword>return</span> <span class=number>0</span>;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>那么问题来了，我们现在怎么样给目标 Python 进程注入对应的值呢？我们来看看 remote_debugging.c 中的实现</p><p>首先入口函数为 <code>_PySysRemoteDebug_SendExec</code></p><figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br></pre></td><td class=code><pre><span class=line><span class=type>int</span></span><br><span class=line>_PySysRemoteDebug_SendExec(<span class=type>int</span> pid, <span class=type>int</span> tid, <span class=type>const</span> <span class=type>char</span> *debugger_script_path)</span><br><span class=line>&#123;</span><br><span class=line><span class=meta>#<span class=keyword>if</span> !defined(Py_SUPPORTS_REMOTE_DEBUG)</span></span><br><span class=line>    PyErr_SetString(PyExc_RuntimeError, <span class=string>&quot;Remote debugging is not supported on this platform&quot;</span>);</span><br><span class=line>    <span class=keyword>return</span> <span class=number>-1</span>;</span><br><span class=line><span class=meta>#<span class=keyword>elif</span> !defined(Py_REMOTE_DEBUG)</span></span><br><span class=line>    PyErr_SetString(PyExc_RuntimeError, <span class=string>&quot;Remote debugging support has not been compiled in&quot;</span>);</span><br><span class=line>    <span class=keyword>return</span> <span class=number>-1</span>;</span><br><span class=line><span class=meta>#<span class=keyword>else</span></span></span><br><span class=line></span><br><span class=line>    PyThreadState *tstate = _PyThreadState_GET();</span><br><span class=line>    <span class=type>const</span> PyConfig *config = _PyInterpreterState_GetConfig(tstate-&gt;interp);</span><br><span class=line>    <span class=keyword>if</span> (config-&gt;remote_debug != <span class=number>1</span>) &#123;</span><br><span class=line>        PyErr_SetString(PyExc_RuntimeError, <span class=string>&quot;Remote debugging is not enabled&quot;</span>);</span><br><span class=line>        <span class=keyword>return</span> <span class=number>-1</span>;</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    <span class=type>proc_handle_t</span> handle;</span><br><span class=line>    <span class=keyword>if</span> (init_proc_handle(&amp;handle, pid) &lt; <span class=number>0</span>) &#123;</span><br><span class=line>        <span class=keyword>return</span> <span class=number>-1</span>;</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    <span class=type>int</span> rc = send_exec_to_proc_handle(&amp;handle, tid, debugger_script_path);</span><br><span class=line>    cleanup_proc_handle(&amp;handle);</span><br><span class=line>    <span class=keyword>return</span> rc;</span><br><span class=line><span class=meta>#<span class=keyword>endif</span></span></span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>前面都是一些例行的检查，我们来看看 <code>send_exec_to_proc_handle</code> 这个函数</p><figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br><span class=line>65</span><br><span class=line>66</span><br><span class=line>67</span><br><span class=line>68</span><br><span class=line>69</span><br><span class=line>70</span><br><span class=line>71</span><br><span class=line>72</span><br><span class=line>73</span><br><span class=line>74</span><br><span class=line>75</span><br><span class=line>76</span><br><span class=line>77</span><br><span class=line>78</span><br><span class=line>79</span><br><span class=line>80</span><br><span class=line>81</span><br><span class=line>82</span><br><span class=line>83</span><br><span class=line>84</span><br><span class=line>85</span><br><span class=line>86</span><br><span class=line>87</span><br><span class=line>88</span><br><span class=line>89</span><br><span class=line>90</span><br><span class=line>91</span><br><span class=line>92</span><br><span class=line>93</span><br><span class=line>94</span><br><span class=line>95</span><br><span class=line>96</span><br><span class=line>97</span><br><span class=line>98</span><br><span class=line>99</span><br><span class=line>100</span><br><span class=line>101</span><br><span class=line>102</span><br><span class=line>103</span><br><span class=line>104</span><br><span class=line>105</span><br><span class=line>106</span><br><span class=line>107</span><br><span class=line>108</span><br><span class=line>109</span><br><span class=line>110</span><br><span class=line>111</span><br><span class=line>112</span><br><span class=line>113</span><br><span class=line>114</span><br><span class=line>115</span><br><span class=line>116</span><br><span class=line>117</span><br><span class=line>118</span><br><span class=line>119</span><br><span class=line>120</span><br><span class=line>121</span><br><span class=line>122</span><br><span class=line>123</span><br><span class=line>124</span><br><span class=line>125</span><br><span class=line>126</span><br><span class=line>127</span><br><span class=line>128</span><br><span class=line>129</span><br><span class=line>130</span><br><span class=line>131</span><br><span class=line>132</span><br><span class=line>133</span><br><span class=line>134</span><br><span class=line>135</span><br><span class=line>136</span><br><span class=line>137</span><br><span class=line>138</span><br><span class=line>139</span><br><span class=line>140</span><br><span class=line>141</span><br><span class=line>142</span><br><span class=line>143</span><br><span class=line>144</span><br><span class=line>145</span><br><span class=line>146</span><br><span class=line>147</span><br><span class=line>148</span><br><span class=line>149</span><br><span class=line>150</span><br><span class=line>151</span><br><span class=line>152</span><br><span class=line>153</span><br><span class=line>154</span><br><span class=line>155</span><br><span class=line>156</span><br><span class=line>157</span><br><span class=line>158</span><br><span class=line>159</span><br><span class=line>160</span><br><span class=line>161</span><br><span class=line>162</span><br></pre></td><td class=code><pre><span class=line><span class=type>static</span> <span class=type>int</span></span><br><span class=line><span class="title function_">send_exec_to_proc_handle</span><span class=params>(<span class=type>proc_handle_t</span> *handle, <span class=type>int</span> tid, <span class=type>const</span> <span class=type>char</span> *debugger_script_path)</span></span><br><span class=line>&#123;</span><br><span class=line>    <span class=type>uintptr_t</span> runtime_start_address;</span><br><span class=line>    <span class=class><span class=keyword>struct</span> _<span class=title>Py_DebugOffsets</span> <span class=title>debug_offsets</span>;</span></span><br><span class=line></span><br><span class=line>    <span class=keyword>if</span> (read_offsets(handle, &amp;runtime_start_address, &amp;debug_offsets)) &#123;</span><br><span class=line>        <span class=keyword>return</span> <span class=number>-1</span>;</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    <span class=type>uintptr_t</span> interpreter_state_list_head = (<span class=type>uintptr_t</span>)debug_offsets.runtime_state.interpreters_head;</span><br><span class=line></span><br><span class=line>    <span class=type>uintptr_t</span> interpreter_state_addr;</span><br><span class=line>    <span class=keyword>if</span> (<span class=number>0</span> != read_memory(</span><br><span class=line>            handle,</span><br><span class=line>            runtime_start_address + interpreter_state_list_head,</span><br><span class=line>            <span class=keyword>sizeof</span>(<span class=type>void</span>*),</span><br><span class=line>            &amp;interpreter_state_addr))</span><br><span class=line>    &#123;</span><br><span class=line>        <span class=keyword>return</span> <span class=number>-1</span>;</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    <span class=keyword>if</span> (interpreter_state_addr == <span class=number>0</span>) &#123;</span><br><span class=line>        PyErr_SetString(PyExc_RuntimeError, <span class=string>&quot;Can&#x27;t find a running interpreter in the remote process&quot;</span>);</span><br><span class=line>        <span class=keyword>return</span> <span class=number>-1</span>;</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    <span class=type>int</span> is_remote_debugging_enabled = <span class=number>0</span>;</span><br><span class=line>    <span class=keyword>if</span> (<span class=number>0</span> != read_memory(</span><br><span class=line>            handle,</span><br><span class=line>            interpreter_state_addr + debug_offsets.debugger_support.remote_debugging_enabled,</span><br><span class=line>            <span class=keyword>sizeof</span>(<span class=type>int</span>),</span><br><span class=line>            &amp;is_remote_debugging_enabled))</span><br><span class=line>    &#123;</span><br><span class=line>        <span class=keyword>return</span> <span class=number>-1</span>;</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    <span class=keyword>if</span> (is_remote_debugging_enabled != <span class=number>1</span>) &#123;</span><br><span class=line>        PyErr_SetString(</span><br><span class=line>            PyExc_RuntimeError,</span><br><span class=line>            <span class=string>&quot;Remote debugging is not enabled in the remote process&quot;</span>);</span><br><span class=line>        <span class=keyword>return</span> <span class=number>-1</span>;</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    <span class=type>uintptr_t</span> thread_state_addr;</span><br><span class=line>    <span class=type>unsigned</span> <span class=type>long</span> this_tid = <span class=number>0</span>;</span><br><span class=line></span><br><span class=line>    <span class=keyword>if</span> (tid != <span class=number>0</span>) &#123;</span><br><span class=line>        <span class=keyword>if</span> (<span class=number>0</span> != read_memory(</span><br><span class=line>                handle,</span><br><span class=line>                interpreter_state_addr + debug_offsets.interpreter_state.threads_head,</span><br><span class=line>                <span class=keyword>sizeof</span>(<span class=type>void</span>*),</span><br><span class=line>                &amp;thread_state_addr))</span><br><span class=line>        &#123;</span><br><span class=line>            <span class=keyword>return</span> <span class=number>-1</span>;</span><br><span class=line>        &#125;</span><br><span class=line>        <span class=keyword>while</span> (thread_state_addr != <span class=number>0</span>) &#123;</span><br><span class=line>            <span class=keyword>if</span> (<span class=number>0</span> != read_memory(</span><br><span class=line>                    handle,</span><br><span class=line>                    thread_state_addr + debug_offsets.thread_state.native_thread_id,</span><br><span class=line>                    <span class=keyword>sizeof</span>(this_tid),</span><br><span class=line>                    &amp;this_tid))</span><br><span class=line>            &#123;</span><br><span class=line>                <span class=keyword>return</span> <span class=number>-1</span>;</span><br><span class=line>            &#125;</span><br><span class=line></span><br><span class=line>            <span class=keyword>if</span> (this_tid == (<span class=type>unsigned</span> <span class=type>long</span>)tid) &#123;</span><br><span class=line>                <span class=keyword>break</span>;</span><br><span class=line>            &#125;</span><br><span class=line></span><br><span class=line>            <span class=keyword>if</span> (<span class=number>0</span> != read_memory(</span><br><span class=line>                    handle,</span><br><span class=line>                    thread_state_addr + debug_offsets.thread_state.next,</span><br><span class=line>                    <span class=keyword>sizeof</span>(<span class=type>void</span>*),</span><br><span class=line>                    &amp;thread_state_addr))</span><br><span class=line>            &#123;</span><br><span class=line>                <span class=keyword>return</span> <span class=number>-1</span>;</span><br><span class=line>            &#125;</span><br><span class=line>        &#125;</span><br><span class=line></span><br><span class=line>        <span class=keyword>if</span> (thread_state_addr == <span class=number>0</span>) &#123;</span><br><span class=line>            PyErr_SetString(</span><br><span class=line>                PyExc_RuntimeError,</span><br><span class=line>                <span class=string>&quot;Can&#x27;t find the specified thread in the remote process&quot;</span>);</span><br><span class=line>            <span class=keyword>return</span> <span class=number>-1</span>;</span><br><span class=line>        &#125;</span><br><span class=line>    &#125; <span class=keyword>else</span> &#123;</span><br><span class=line>        <span class=keyword>if</span> (<span class=number>0</span> != read_memory(</span><br><span class=line>                handle,</span><br><span class=line>                interpreter_state_addr + debug_offsets.interpreter_state.threads_main,</span><br><span class=line>                <span class=keyword>sizeof</span>(<span class=type>void</span>*),</span><br><span class=line>                &amp;thread_state_addr))</span><br><span class=line>        &#123;</span><br><span class=line>            <span class=keyword>return</span> <span class=number>-1</span>;</span><br><span class=line>        &#125;</span><br><span class=line></span><br><span class=line>        <span class=keyword>if</span> (thread_state_addr == <span class=number>0</span>) &#123;</span><br><span class=line>            PyErr_SetString(</span><br><span class=line>                PyExc_RuntimeError,</span><br><span class=line>                <span class=string>&quot;Can&#x27;t find the main thread in the remote process&quot;</span>);</span><br><span class=line>            <span class=keyword>return</span> <span class=number>-1</span>;</span><br><span class=line>        &#125;</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    <span class=comment>// Ensure our path is not too long</span></span><br><span class=line>    <span class=keyword>if</span> (debug_offsets.debugger_support.debugger_script_path_size &lt;= <span class=built_in>strlen</span>(debugger_script_path)) &#123;</span><br><span class=line>        PyErr_SetString(PyExc_ValueError, <span class=string>&quot;Debugger script path is too long&quot;</span>);</span><br><span class=line>        <span class=keyword>return</span> <span class=number>-1</span>;</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    <span class=type>uintptr_t</span> debugger_script_path_addr = (<span class=type>uintptr_t</span>)(</span><br><span class=line>        thread_state_addr +</span><br><span class=line>        debug_offsets.debugger_support.remote_debugger_support +</span><br><span class=line>        debug_offsets.debugger_support.debugger_script_path);</span><br><span class=line>    <span class=keyword>if</span> (<span class=number>0</span> != write_memory(</span><br><span class=line>            handle,</span><br><span class=line>            debugger_script_path_addr,</span><br><span class=line>            <span class=built_in>strlen</span>(debugger_script_path) + <span class=number>1</span>,</span><br><span class=line>            debugger_script_path))</span><br><span class=line>    &#123;</span><br><span class=line>        <span class=keyword>return</span> <span class=number>-1</span>;</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    <span class=type>int</span> pending_call = <span class=number>1</span>;</span><br><span class=line>    <span class=type>uintptr_t</span> debugger_pending_call_addr = (<span class=type>uintptr_t</span>)(</span><br><span class=line>        thread_state_addr +</span><br><span class=line>        debug_offsets.debugger_support.remote_debugger_support +</span><br><span class=line>        debug_offsets.debugger_support.debugger_pending_call);</span><br><span class=line>    <span class=keyword>if</span> (<span class=number>0</span> != write_memory(</span><br><span class=line>            handle,</span><br><span class=line>            debugger_pending_call_addr,</span><br><span class=line>            <span class=keyword>sizeof</span>(<span class=type>int</span>),</span><br><span class=line>            &amp;pending_call))</span><br><span class=line></span><br><span class=line>    &#123;</span><br><span class=line>        <span class=keyword>return</span> <span class=number>-1</span>;</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    <span class=type>uintptr_t</span> eval_breaker;</span><br><span class=line>    <span class=keyword>if</span> (<span class=number>0</span> != read_memory(</span><br><span class=line>            handle,</span><br><span class=line>            thread_state_addr + debug_offsets.debugger_support.eval_breaker,</span><br><span class=line>            <span class=keyword>sizeof</span>(<span class=type>uintptr_t</span>),</span><br><span class=line>            &amp;eval_breaker))</span><br><span class=line>    &#123;</span><br><span class=line>        <span class=keyword>return</span> <span class=number>-1</span>;</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    eval_breaker |= _PY_EVAL_PLEASE_STOP_BIT;</span><br><span class=line></span><br><span class=line>    <span class=keyword>if</span> (<span class=number>0</span> != write_memory(</span><br><span class=line>            handle,</span><br><span class=line>            thread_state_addr + (<span class=type>uintptr_t</span>)debug_offsets.debugger_support.eval_breaker,</span><br><span class=line>            <span class=keyword>sizeof</span>(<span class=type>uintptr_t</span>),</span><br><span class=line>            &amp;eval_breaker))</span><br><span class=line></span><br><span class=line>    &#123;</span><br><span class=line>        <span class=keyword>return</span> <span class=number>-1</span>;</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    <span class=keyword>return</span> <span class=number>0</span>;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>我们先不考虑具体的细节的话，这段函数的逻辑还是非常明确的，通过 <code>read_offsets</code> 获取目标的地址偏移，通过 <code>read_memory</code> 这个函数读取不同地址，然后做一些处理后，通过 <code>write_memory</code> 来写入到目标进程中去</p><p>而 <code>read_offsets</code> 这个函数就是我们前面核心提到过的怎么样使用目前 Python 给出的调试信息的例子，我们来看一下其在 Linux 下的实现</p><figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br></pre></td><td class=code><pre><span class=line><span class=type>static</span> <span class=type>int</span></span><br><span class=line><span class="title function_">read_offsets</span><span class=params>(</span></span><br><span class=line><span class=params>    <span class=type>proc_handle_t</span> *handle,</span></span><br><span class=line><span class=params>    <span class=type>uintptr_t</span> *runtime_start_address,</span></span><br><span class=line><span class=params>    _Py_DebugOffsets* debug_offsets</span></span><br><span class=line><span class=params>)</span> &#123;</span><br><span class=line>    <span class=keyword>if</span> (_Py_RemoteDebug_ReadDebugOffsets(handle, runtime_start_address, debug_offsets)) &#123;</span><br><span class=line>        <span class=keyword>return</span> <span class=number>-1</span>;</span><br><span class=line>    &#125;</span><br><span class=line>    <span class=keyword>if</span> (ensure_debug_offset_compatibility(debug_offsets)) &#123;</span><br><span class=line>        <span class=keyword>return</span> <span class=number>-1</span>;</span><br><span class=line>    &#125;</span><br><span class=line>    <span class=keyword>return</span> <span class=number>0</span>;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>这里的核心函数是 <code>_Py_RemoteDebug_ReadDebugOffsets</code>， 我们接着来看这个的实现</p><figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br></pre></td><td class=code><pre><span class=line><span class=type>static</span> <span class=type>int</span></span><br><span class=line>_Py_RemoteDebug_ReadDebugOffsets(</span><br><span class=line>    <span class=type>proc_handle_t</span> *handle,</span><br><span class=line>    <span class=type>uintptr_t</span> *runtime_start_address,</span><br><span class=line>    _Py_DebugOffsets* debug_offsets</span><br><span class=line>) &#123;</span><br><span class=line>    *runtime_start_address = _Py_RemoteDebug_GetPyRuntimeAddress(handle);</span><br><span class=line>    <span class=keyword>if</span> (!*runtime_start_address) &#123;</span><br><span class=line>        <span class=keyword>if</span> (!PyErr_Occurred()) &#123;</span><br><span class=line>            PyErr_SetString(</span><br><span class=line>                PyExc_RuntimeError, <span class=string>&quot;Failed to get PyRuntime address&quot;</span>);</span><br><span class=line>        &#125;</span><br><span class=line>        <span class=keyword>return</span> <span class=number>-1</span>;</span><br><span class=line>    &#125;</span><br><span class=line>    <span class=type>size_t</span> size = <span class=keyword>sizeof</span>(<span class=keyword>struct</span> _Py_DebugOffsets);</span><br><span class=line>    <span class=keyword>if</span> (<span class=number>0</span> != _Py_RemoteDebug_ReadRemoteMemory(handle, *runtime_start_address, size, debug_offsets)) &#123;</span><br><span class=line>        <span class=keyword>return</span> <span class=number>-1</span>;</span><br><span class=line>    &#125;</span><br><span class=line>    <span class=keyword>return</span> <span class=number>0</span>;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>我们注意到，这里的核心还是我们先要获取到 <code>PyRuntime</code> 的地址，那么我们来看看 <code>_Py_RemoteDebug_GetPyRuntimeAddress</code> 的实现</p><figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br><span class=line>65</span><br><span class=line>66</span><br><span class=line>67</span><br><span class=line>68</span><br><span class=line>69</span><br><span class=line>70</span><br><span class=line>71</span><br><span class=line>72</span><br><span class=line>73</span><br><span class=line>74</span><br><span class=line>75</span><br><span class=line>76</span><br><span class=line>77</span><br><span class=line>78</span><br><span class=line>79</span><br><span class=line>80</span><br><span class=line>81</span><br><span class=line>82</span><br><span class=line>83</span><br><span class=line>84</span><br><span class=line>85</span><br><span class=line>86</span><br><span class=line>87</span><br></pre></td><td class=code><pre><span class=line><span class=type>static</span> <span class=type>uintptr_t</span></span><br><span class=line>_Py_RemoteDebug_GetPyRuntimeAddress(<span class=type>proc_handle_t</span>* handle)</span><br><span class=line>&#123;</span><br><span class=line>    <span class=type>uintptr_t</span> address;</span><br><span class=line>    address = search_linux_map_for_section(handle, <span class=string>&quot;PyRuntime&quot;</span>, <span class=string>&quot;python&quot;</span>);</span><br><span class=line>    <span class=keyword>if</span> (address == <span class=number>0</span>) &#123;</span><br><span class=line>        <span class=comment>// Error out: &#x27;python&#x27; substring covers both executable and DLL</span></span><br><span class=line>        PyErr_SetString(PyExc_RuntimeError, <span class=string>&quot;Failed to find the PyRuntime section in the process.&quot;</span>);</span><br><span class=line>    &#125;</span><br><span class=line>    <span class=keyword>return</span> address;</span><br><span class=line>&#125;</span><br><span class=line></span><br><span class=line><span class=type>static</span> <span class=type>uintptr_t</span></span><br><span class=line><span class="title function_">search_linux_map_for_section</span><span class=params>(<span class=type>proc_handle_t</span> *handle, <span class=type>const</span> <span class=type>char</span>* secname, <span class=type>const</span> <span class=type>char</span>* substr)</span></span><br><span class=line>&#123;</span><br><span class=line>    <span class=type>char</span> maps_file_path[<span class=number>64</span>];</span><br><span class=line>    <span class=built_in>sprintf</span>(maps_file_path, <span class=string>&quot;/proc/%d/maps&quot;</span>, handle-&gt;pid);</span><br><span class=line></span><br><span class=line>    FILE* maps_file = fopen(maps_file_path, <span class=string>&quot;r&quot;</span>);</span><br><span class=line>    <span class=keyword>if</span> (maps_file == <span class=literal>NULL</span>) &#123;</span><br><span class=line>        PyErr_SetFromErrno(PyExc_OSError);</span><br><span class=line>        <span class=keyword>return</span> <span class=number>0</span>;</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    <span class=type>size_t</span> linelen = <span class=number>0</span>;</span><br><span class=line>    <span class=type>size_t</span> linesz = PATH_MAX;</span><br><span class=line>    <span class=type>char</span> *line = PyMem_Malloc(linesz);</span><br><span class=line>    <span class=keyword>if</span> (!line) &#123;</span><br><span class=line>        fclose(maps_file);</span><br><span class=line>        PyErr_NoMemory();</span><br><span class=line>        <span class=keyword>return</span> <span class=number>0</span>;</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    <span class=type>uintptr_t</span> retval = <span class=number>0</span>;</span><br><span class=line>    <span class=keyword>while</span> (fgets(line + linelen, linesz - linelen, maps_file) != <span class=literal>NULL</span>) &#123;</span><br><span class=line>        linelen = <span class=built_in>strlen</span>(line);</span><br><span class=line>        <span class=keyword>if</span> (line[linelen - <span class=number>1</span>] != <span class=string>&#x27;\n&#x27;</span>) &#123;</span><br><span class=line>            <span class=comment>// Read a partial line: realloc and keep reading where we left off.</span></span><br><span class=line>            <span class=comment>// Note that even the last line will be terminated by a newline.</span></span><br><span class=line>            linesz *= <span class=number>2</span>;</span><br><span class=line>            <span class=type>char</span> *biggerline = PyMem_Realloc(line, linesz);</span><br><span class=line>            <span class=keyword>if</span> (!biggerline) &#123;</span><br><span class=line>                PyMem_Free(line);</span><br><span class=line>                fclose(maps_file);</span><br><span class=line>                PyErr_NoMemory();</span><br><span class=line>                <span class=keyword>return</span> <span class=number>0</span>;</span><br><span class=line>            &#125;</span><br><span class=line>            line = biggerline;</span><br><span class=line>            <span class=keyword>continue</span>;</span><br><span class=line>        &#125;</span><br><span class=line></span><br><span class=line>        <span class=comment>// Read a full line: strip the newline</span></span><br><span class=line>        line[linelen - <span class=number>1</span>] = <span class=string>&#x27;\0&#x27;</span>;</span><br><span class=line>        <span class=comment>// and prepare to read the next line into the start of the buffer.</span></span><br><span class=line>        linelen = <span class=number>0</span>;</span><br><span class=line></span><br><span class=line>        <span class=type>unsigned</span> <span class=type>long</span> start = <span class=number>0</span>;</span><br><span class=line>        <span class=type>unsigned</span> <span class=type>long</span> path_pos = <span class=number>0</span>;</span><br><span class=line>        <span class=built_in>sscanf</span>(line, <span class=string>&quot;%lx-%*x %*s %*s %*s %*s %ln&quot;</span>, &amp;start, &amp;path_pos);</span><br><span class=line></span><br><span class=line>        <span class=keyword>if</span> (!path_pos) &#123;</span><br><span class=line>            <span class=comment>// Line didn&#x27;t match our format string.  This shouldn&#x27;t be</span></span><br><span class=line>            <span class=comment>// possible, but let&#x27;s be defensive and skip the line.</span></span><br><span class=line>            <span class=keyword>continue</span>;</span><br><span class=line>        &#125;</span><br><span class=line></span><br><span class=line>        <span class=type>const</span> <span class=type>char</span> *path = line + path_pos;</span><br><span class=line>        <span class=type>const</span> <span class=type>char</span> *filename = <span class=built_in>strrchr</span>(path, <span class=string>&#x27;/&#x27;</span>);</span><br><span class=line>        <span class=keyword>if</span> (filename) &#123;</span><br><span class=line>            filename++;  <span class=comment>// Move past the &#x27;/&#x27;</span></span><br><span class=line>        &#125; <span class=keyword>else</span> &#123;</span><br><span class=line>            filename = path;  <span class=comment>// No directories, or an empty string</span></span><br><span class=line>        &#125;</span><br><span class=line></span><br><span class=line>        <span class=keyword>if</span> (<span class=built_in>strstr</span>(filename, substr)) &#123;</span><br><span class=line>            retval = search_elf_file_for_section(handle, secname, start, path);</span><br><span class=line>            <span class=keyword>if</span> (retval) &#123;</span><br><span class=line>                <span class=keyword>break</span>;</span><br><span class=line>            &#125;</span><br><span class=line>        &#125;</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    PyMem_Free(line);</span><br><span class=line>    fclose(maps_file);</span><br><span class=line></span><br><span class=line>    <span class=keyword>return</span> retval;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>我们这里能看到 <code>_Py_RemoteDebug_GetPyRuntimeAddress</code> 调用了 <code>search_linux_map_for_section</code> 来获取当前的 <code>PyRuntime</code> 的地址，而 <code>search_linux_map_for_section</code> 则是通过 <code>/proc/$&#123;pid&#125;/maps</code> ，暴力遍历 <code>maps</code> 中的内存段来获取具体的地址。</p><p>我们来看看 <code>search_elf_file_for_section</code> 的实现</p><figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br><span class=line>65</span><br><span class=line>66</span><br><span class=line>67</span><br><span class=line>68</span><br><span class=line>69</span><br><span class=line>70</span><br><span class=line>71</span><br><span class=line>72</span><br><span class=line>73</span><br><span class=line>74</span><br></pre></td><td class=code><pre><span class=line>search_elf_file_for_section(</span><br><span class=line>        <span class=type>proc_handle_t</span> *handle,</span><br><span class=line>        <span class=type>const</span> <span class=type>char</span>* secname,</span><br><span class=line>        <span class=type>uintptr_t</span> start_address,</span><br><span class=line>        <span class=type>const</span> <span class=type>char</span> *elf_file)</span><br><span class=line>&#123;</span><br><span class=line>    <span class=keyword>if</span> (start_address == <span class=number>0</span>) &#123;</span><br><span class=line>        <span class=keyword>return</span> <span class=number>0</span>;</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    <span class=type>uintptr_t</span> result = <span class=number>0</span>;</span><br><span class=line>    <span class=type>void</span>* file_memory = <span class=literal>NULL</span>;</span><br><span class=line></span><br><span class=line>    <span class=type>int</span> fd = open(elf_file, O_RDONLY);</span><br><span class=line>    <span class=keyword>if</span> (fd &lt; <span class=number>0</span>) &#123;</span><br><span class=line>        PyErr_SetFromErrno(PyExc_OSError);</span><br><span class=line>        <span class=keyword>goto</span> <span class=built_in>exit</span>;</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    <span class=class><span class=keyword>struct</span> <span class=title>stat</span> <span class=title>file_stats</span>;</span></span><br><span class=line>    <span class=keyword>if</span> (fstat(fd, &amp;file_stats) != <span class=number>0</span>) &#123;</span><br><span class=line>        PyErr_SetFromErrno(PyExc_OSError);</span><br><span class=line>        <span class=keyword>goto</span> <span class=built_in>exit</span>;</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    file_memory = mmap(<span class=literal>NULL</span>, file_stats.st_size, PROT_READ, MAP_PRIVATE, fd, <span class=number>0</span>);</span><br><span class=line>    <span class=keyword>if</span> (file_memory == MAP_FAILED) &#123;</span><br><span class=line>        PyErr_SetFromErrno(PyExc_OSError);</span><br><span class=line>        <span class=keyword>goto</span> <span class=built_in>exit</span>;</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    Elf_Ehdr* elf_header = (Elf_Ehdr*)file_memory;</span><br><span class=line></span><br><span class=line>    Elf_Shdr* section_header_table = (Elf_Shdr*)(file_memory + elf_header-&gt;e_shoff);</span><br><span class=line></span><br><span class=line>    Elf_Shdr* shstrtab_section = &amp;section_header_table[elf_header-&gt;e_shstrndx];</span><br><span class=line>    <span class=type>char</span>* shstrtab = (<span class=type>char</span>*)(file_memory + shstrtab_section-&gt;sh_offset);</span><br><span class=line></span><br><span class=line>    Elf_Shdr* section = <span class=literal>NULL</span>;</span><br><span class=line>    <span class=keyword>for</span> (<span class=type>int</span> i = <span class=number>0</span>; i &lt; elf_header-&gt;e_shnum; i++) &#123;</span><br><span class=line>        <span class=type>char</span>* this_sec_name = shstrtab + section_header_table[i].sh_name;</span><br><span class=line>        <span class=comment>// Move 1 character to account for the leading &quot;.&quot;</span></span><br><span class=line>        this_sec_name += <span class=number>1</span>;</span><br><span class=line>        <span class=keyword>if</span> (<span class=built_in>strcmp</span>(secname, this_sec_name) == <span class=number>0</span>) &#123;</span><br><span class=line>            section = &amp;section_header_table[i];</span><br><span class=line>            <span class=keyword>break</span>;</span><br><span class=line>        &#125;</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    Elf_Phdr* program_header_table = (Elf_Phdr*)(file_memory + elf_header-&gt;e_phoff);</span><br><span class=line>    <span class=comment>// Find the first PT_LOAD segment</span></span><br><span class=line>    Elf_Phdr* first_load_segment = <span class=literal>NULL</span>;</span><br><span class=line>    <span class=keyword>for</span> (<span class=type>int</span> i = <span class=number>0</span>; i &lt; elf_header-&gt;e_phnum; i++) &#123;</span><br><span class=line>        <span class=keyword>if</span> (program_header_table[i].p_type == PT_LOAD) &#123;</span><br><span class=line>            first_load_segment = &amp;program_header_table[i];</span><br><span class=line>            <span class=keyword>break</span>;</span><br><span class=line>        &#125;</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    <span class=keyword>if</span> (section != <span class=literal>NULL</span> &amp;&amp; first_load_segment != <span class=literal>NULL</span>) &#123;</span><br><span class=line>        <span class=type>uintptr_t</span> elf_load_addr = first_load_segment-&gt;p_vaddr</span><br><span class=line>            - (first_load_segment-&gt;p_vaddr % first_load_segment-&gt;p_align);</span><br><span class=line>        result = start_address + (<span class=type>uintptr_t</span>)section-&gt;sh_addr - elf_load_addr;</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line><span class=built_in>exit</span>:</span><br><span class=line>    <span class=keyword>if</span> (file_memory != <span class=literal>NULL</span>) &#123;</span><br><span class=line>        munmap(file_memory, file_stats.st_size);</span><br><span class=line>    &#125;</span><br><span class=line>    <span class=keyword>if</span> (fd &gt;= <span class=number>0</span> &amp;&amp; close(fd) != <span class=number>0</span>) &#123;</span><br><span class=line>        PyErr_SetFromErrno(PyExc_OSError);</span><br><span class=line>    &#125;</span><br><span class=line>    <span class=keyword>return</span> result;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>这段代码稍微有点复杂，我们来拆分看一下</p><p>首先函数的声明</p><figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre></td><td class=code><pre><span class=line>search_elf_file_for_section(</span><br><span class=line>        <span class=type>proc_handle_t</span> *handle,</span><br><span class=line>        <span class=type>const</span> <span class=type>char</span>* secname,</span><br><span class=line>        <span class=type>uintptr_t</span> start_address,</span><br><span class=line>        <span class=type>const</span> <span class=type>char</span> *elf_file)</span><br></pre></td></tr></table></figure><p>用于在ELF文件中搜索特定的section。参数包括：进程句柄、要查找的section名称、起始地址（文件在进程空间的映射位置）、ELF文件路径。</p><figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre></td><td class=code><pre><span class=line><span class=type>int</span> fd = open(elf_file, O_RDONLY);</span><br><span class=line><span class=keyword>if</span> (fd &lt; <span class=number>0</span>) &#123;</span><br><span class=line>    PyErr_SetFromErrno(PyExc_OSError);</span><br><span class=line>    <span class=keyword>goto</span> <span class=built_in>exit</span>;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>以只读方式打开ELF文件，如果失败则设置Python异常并跳转到退出处理。</p><figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre></td><td class=code><pre><span class=line>file_memory = mmap(<span class=literal>NULL</span>, file_stats.st_size, PROT_READ, MAP_PRIVATE, fd, <span class=number>0</span>);</span><br><span class=line><span class=keyword>if</span> (file_memory == MAP_FAILED) &#123;</span><br><span class=line>    PyErr_SetFromErrno(PyExc_OSError);</span><br><span class=line>    <span class=keyword>goto</span> <span class=built_in>exit</span>;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>将文件内容映射到内存，以只读和私有方式，从文件头开始。失败则设置异常并退出。</p><figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line>Elf_Ehdr* elf_header = (Elf_Ehdr*)file_memory;</span><br><span class=line>Elf_Shdr* section_header_table = (Elf_Shdr*)(file_memory + elf_header-&gt;e_shoff);</span><br></pre></td></tr></table></figure><p>将文件开头 cast 为ELF文件头结构，并找到section header表的位置，它在文件偏移e_shoff处。</p><figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br></pre></td><td class=code><pre><span class=line>Elf_Shdr* shstrtab_section = &amp;section_header_table[elf_header-&gt;e_shstrndx];</span><br><span class=line><span class=type>char</span>* shstrtab = (<span class=type>char</span>*)(file_memory + shstrtab_section-&gt;sh_offset);</span><br><span class=line>Elf_Shdr* section = <span class=literal>NULL</span>;</span><br><span class=line><span class=keyword>for</span> (<span class=type>int</span> i = <span class=number>0</span>; i &lt; elf_header-&gt;e_shnum; i++) &#123;</span><br><span class=line>    <span class=type>char</span>* this_sec_name = shstrtab + section_header_table[i].sh_name;</span><br><span class=line>    <span class=comment>// Move 1 character to account for the leading &quot;.&quot;</span></span><br><span class=line>    this_sec_name += <span class=number>1</span>;</span><br><span class=line>    <span class=keyword>if</span> (<span class=built_in>strcmp</span>(secname, this_sec_name) == <span class=number>0</span>) &#123;</span><br><span class=line>        section = &amp;section_header_table[i];</span><br><span class=line>        <span class=keyword>break</span>;</span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>获取section字符串表（包含所有section名称的表），通过e_shstrndx索引定位。同时遍历所有section，查找匹配的section名称。注意需要跳过section名字的”.”前缀。</p><figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre></td><td class=code><pre><span class=line>Elf_Phdr* program_header_table = (Elf_Phdr*)(file_memory + elf_header-&gt;e_phoff);</span><br><span class=line><span class=comment>// Find the first PT_LOAD segment</span></span><br><span class=line>Elf_Phdr* first_load_segment = <span class=literal>NULL</span>;</span><br><span class=line><span class=keyword>for</span> (<span class=type>int</span> i = <span class=number>0</span>; i &lt; elf_header-&gt;e_phnum; i++) &#123;</span><br><span class=line>    <span class=keyword>if</span> (program_header_table[i].p_type == PT_LOAD) &#123;</span><br><span class=line>        first_load_segment = &amp;program_header_table[i];</span><br><span class=line>        <span class=keyword>break</span>;</span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>找到program header表，然后搜索第一个PT_LOAD类型的segment，它定义了程序加载时的基地址。</p><figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre></td><td class=code><pre><span class=line><span class=keyword>if</span> (section != <span class=literal>NULL</span> &amp;&amp; first_load_segment != <span class=literal>NULL</span>) &#123;</span><br><span class=line>    <span class=type>uintptr_t</span> elf_load_addr = first_load_segment-&gt;p_vaddr</span><br><span class=line>        - (first_load_segment-&gt;p_vaddr % first_load_segment-&gt;p_align);</span><br><span class=line>    result = start_address + (<span class=type>uintptr_t</span>)section-&gt;sh_addr - elf_load_addr;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>如果找到了目标section和第一个LOAD segment，计算目标section的运行时地址：</p><ol><li>计算ELF文件的加载基地址（考虑对齐）</li><li>目标地址 = 进程中映射的起始地址 + section的虚拟地址 - ELF加载基地址</li></ol><p>经过这样一个流程，我们就能最终的获取到 <code>_PyRuntime</code> 中的地址，然后基于此做一些包括 PEP 768 在内很有趣的工作。</p><h2 id=总结><a href=#总结 class=headerlink title=总结></a>总结</h2><p>Python 3.14 官方其实将进程信息以半正式化的形式形成了一组相对稳定的 ABI，这样可以使我们调试工具能以更好的方式对 Python 进程进行无侵入的调试与观测。PEP 768 其实是这个过程中一个的有效产物。而基于 PEP768 处理的比如 Remote PDB debug，目前也已合入分支。</p><p>可以说从 Python 3.14 起，Python 的调试工具和手段将得到极大的丰富与增强。建议大家在出来后的第一时间进行升级（</p><p>差不多就这样（</p></article><div class=post-copyright><div class=post-copyright__author><span class=post-copyright-meta><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class=post-copyright-info><a href=https://github.com/Zheaoli rel="external nofollow noreferrer">Manjusaka</a></span></div><div class=post-copyright__type><span class=post-copyright-meta><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class=post-copyright-info><a href=https://www.manjusaka.blog/posts/2025/04/26/3-14-is-one-of-the-best-python-version/ >https://www.manjusaka.blog/posts/2025/04/26/3-14-is-one-of-the-best-python-version/</a></span></div><div class=post-copyright__notice><span class=post-copyright-meta><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class=post-copyright-info>All articles on this blog are licensed under <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ rel="external nofollow noreferrer">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class=tag_share><div class=post-meta__tag-list><a class=post-meta__tags href=/tags/%E7%BC%96%E7%A8%8B/ >编程</a><a class=post-meta__tags href=/tags/Linux/ >Linux</a><a class=post-meta__tags href=/tags/Python/ >Python</a><a class=post-meta__tags href=/tags/%E7%AC%94%E8%AE%B0/ >笔记</a><a class=post-meta__tags href=/tags/%E6%B0%B4%E6%96%87/ >水文</a></div><div class=post-share><div class=social-share data-image=https://cdn.pixabay.com/photo/2023/02/08/15/10/sculpture-7776861_1280.jpg data-sites=facebook,twitter,wechat,weibo,qq></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css media=print onload='this.media="all"'><script src=https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js defer=defer></script></div></div><div class=ads-wrap><ins class=adsbygoogle style=display:block;text-align:center data-ad-layout=in-article data-ad-format=fluid data-ad-client=ca-pub-7962287588031867 data-ad-slot=2542544532></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><nav class=pagination-post id=pagination><a class=pagination-related href=/posts/2025/03/23/a-simple-introduction-about-load-balance-algorithm/ title=简单聊聊常见的负载均衡算法><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=/images/pixai-1860500966642493859-3.png onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class=info><div class=info-1><div class=info-item-1>Previous</div><div class=info-item-2>简单聊聊常见的负载均衡算法</div></div><div class=info-2><div class=info-item-1>这篇文章鸽了很久，最终决定还是老老实实写完，来介绍一下常见的一些负载均衡算法实现。本文的代码最终都会放在 load-balancer-algorithm1 这个 repo 中 我从来没有觉得写博客快乐过 正文先行准备既然是讲 LoadBalancer 中常用的一些负载均衡算法，我们先来对一些前置准备做一些讨论 我们目前需要两个基础的数据结构 代表着 Backend 节点的结构 代表着请求上下文的结构 那么我们可以得出下面一些基础代码 1234567891011121314151617181920import dataclasses@dataclasses.dataclassclass Node: host: str = &quot;&quot; port: int = 0 node_available: bool = True @property def available(self) -&gt; bool: return self.node_availableimport...</div></div></div></a><a class=pagination-related href=/posts/2025/07/02/tail-call-in-3-14-interpreter-en/ title="Further Performance Evolution in Python 3.14: Tail Call Interpreter"><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/01/14/19/50/flower-7718952_1280.jpg onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="info text-right"><div class=info-1><div class=info-item-1>Next</div><div class=info-item-2>Further Performance Evolution in Python 3.14: Tail Call Interpreter</div></div><div class=info-2><div class=info-item-1>I’ve been overwhelmed by security work lately, so let me switch to something lighter to relax my mind. Python 3.14 has officially introduced a new mechanism called Tail Call Interpreter (Made by Ken Jin), which is undoubtedly another major milestone that lays the foundation for the future. Main ContentBefore discussing Python 3.14’s Tail Call Interpreter, we need to talk about the most basic syntax in C - switch-case. 12345678910switch (x) &#123; case 1: // do something ...</div></div></div></a></nav><div class=relatedPosts><div class=headline><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class=relatedPosts-list><a class=pagination-related href=/posts/2024/01/03/a-simple-introduction-about-python-jit/ title="简单聊聊 Python 3.13 的 JIT 方案"><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/04/07/50/flower-7766608_1280.jpg alt=cover><div class="info text-center"><div class=info-1><div class=info-item-1><i class="far fa-calendar-alt fa-fw"></i> 2024-01-04</div><div class=info-item-2>简单聊聊 Python 3.13 的 JIT 方案</div></div><div class=info-2><div class=info-item-1>Python 3.13 的 JIT 方案最终确定了，我觉得可以说又新又好。所以深夜水一篇水文，来聊聊这个 JIT 方案 这篇文章可能会有些枯燥，所以如果对此不感兴趣的同学可以直接 x 掉 基础知识在聊 Python 3.13 具体的实现之前，我们需要来了解下它所采用的 JIT 方案的基础知识 JIT 本身的定义我相信阅读这篇文章的同学已经非常了解了，所以此处不再赘述。JIT 核心分为两大块 代码的 profile，以确定热点路径，尽可能的减少 JIT 的 fallback 汇编代码的生成 本文主要会聊代码的生成部分 在此之前，Python 生态里一个 JIT 的实现，Pyston/Pypy，他们所采取的方案其实是和 LuaJIT 的方式类似，开发者手写汇编来完成代码的特化，然后依赖 DynASM 执行相关的代码 这种方式主要的缺陷在于 手写汇编带来的心智负担 对于平台的兼容性 为了给大家一个直观的感受，我给出一个我之前写过的汇编的例子来作为演示 首先，我需要实现的功能很简单，用 C 来描述应该是这样的 123456int main(int argc, char...</div></div></div></a><a class=pagination-related href=/posts/2025/07/02/tail-call-in-3-14-interpreter/ title="Python 3.14 的进一步性能进化: Tail Call Interpreter"><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/04/07/38/cherry-blossoms-7766588_1280.jpg alt=cover><div class="info text-center"><div class=info-1><div class=info-item-1><i class="far fa-calendar-alt fa-fw"></i> 2025-07-02</div><div class=info-item-2>Python 3.14 的进一步性能进化: Tail Call Interpreter</div></div><div class=info-2><div class=info-item-1>最近做安全做的我头晕脑胀，来点轻松的换换脑子，让自己放松下 Python 3.14 正式引入了一个新的机制叫作 Tail Call Interpreter（Made by Ken Jin），这无疑又是一个奠定未来基础的重大工作 正文在聊 Python 3.14 的 Tail Call Interpreter 之前，我们先要来聊 C 语言中最基本的语法 switch-case 12345678910switch (x) &#123; case 1: // do something break; case 2: // do something else break; default: // do default thing&#125; 对于这样的代码我们最终的汇编会是什么样的呢？可能大家第一反应是先 cmp 然后 je ，不等式秒了，我们编译一个版本来看看 对于这样一段代码 12345678void small_switch(int x) &#123; switch(x) &#123; ...</div></div></div></a><a class=pagination-related href=/posts/2023/10/29/the-most-important-thing-in-python-3-12/ title="Python 3.12：一个被人忽略的史诗级版本"><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/01/14/19/50/flower-7718952_1280.jpg alt=cover><div class="info text-center"><div class=info-1><div class=info-item-1><i class="far fa-calendar-alt fa-fw"></i> 2023-10-30</div><div class=info-item-2>Python 3.12：一个被人忽略的史诗级版本</div></div><div class=info-2><div class=info-item-1>Python 3.12 已经发布了一段时间，所以写篇水文来聊一聊这个常常被人忽略的史诗级版本。 正文Python 3.12 绝对是一个史诗级版本，在我心目中，它对于 Python 的意义，大于 “async/await” 的 Python 3.5 和 “Type Hint” 的 Python 3.6 对于 Python 的意义。 或者我们可以这么说在未来数年的时间里，Python 后续的很多意义重大的变更，其都能上溯到 Python 3.12。 理解我这一个观点，我们来说一下 Python 的几大痛点： Python 的可调试性，可观测性问题。历史上 Python 中做 Cost 的消耗极大，同时没有足够的手段可以从旁路去观察 Python 的运行时行为 Python GIL 问题，这个老生长谈了，不多说 Python 的 C API/ABI 问题，之前暴露的 C API/ABI 通常和 CPython VM 实现细节耦合，导致跨版本兼容性会是一个问题 而这样一些问题，Python 3.12 上都有了极大的进步 PEP 669， GH-96143 极大提升了 Python...</div></div></div></a><a class=pagination-related href=/posts/2023/10/05/the-perf-feature-python-312/ title="聊聊 Python 3.12 中 perf 的原生支持"><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/08/15/10/sculpture-7776861_1280.jpg alt=cover><div class="info text-center"><div class=info-1><div class=info-item-1><i class="far fa-calendar-alt fa-fw"></i> 2023-10-05</div><div class=info-item-2>聊聊 Python 3.12 中 perf 的原生支持</div></div><div class=info-2><div class=info-item-1>好久没写 Python 相关的文章了，但是 Python 3.12 perf 原生支持的这个特性非常的棒，思路又新又好了属于是，所以写篇水文来聊聊这个特性 正文先聊聊 Python 的栈帧在聊今天的正式内容之前我们需要理解 Python 在内存中的布局 对于传统的 native application 而言，大家对于其内存布局应该是比较熟悉的，这里以 x86-64 的一张图来说明其栈帧结构 但是对于 CPython 来说，其 Native Code 执行的只是 VM 一层的代码。其在 VM 内单独抽象了一套类似 native 的栈帧结构。 其核心结构如下 1234567891011121314151617181920212223242526272829303132333435363738struct _frame &#123; PyObject_HEAD PyFrameObject *f_back; /* previous frame, or NULL */ struct _PyInterpreterFrame *f_frame; /*...</div></div></div></a><a class=pagination-related href=/posts/2024/02/10/CVE-2024-21626/ title="简单聊聊 CVE-2024-21626"><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/06/01/14/superb-fairywren-7770904_1280.jpg alt=cover><div class="info text-center"><div class=info-1><div class=info-item-1><i class="far fa-calendar-alt fa-fw"></i> 2024-02-11</div><div class=info-item-2>简单聊聊 CVE-2024-21626</div></div><div class=info-2><div class=info-item-1>本来这篇文章应该在初一凌晨发的，但是拖延癌晚期，所以到现在才发，得反思下了 背景众所周知，容器逃逸并不是什么令人稀奇的问题了（不被逃逸的容器才是稀奇），2月初，runc 社区正式公布了一个船新的逃逸 CVE，参见 https://github.com/opencontainers/runc/security/advisories/GHSA-xr7r-f8xq-vfvv，版本横跨 1.0 到 1.1.11 这个 CVE 的核心特性在于“可以通过镜像分发的方式，成本很低的进行逃逸” 我们先来复现一下这个问题 我自己的环境是这样 看这篇博客的同学可以参考下面方式进行环境准备， 按照自己的发行版确保安装了，Docker, libseccomp, golang 按照下面方式进行环境安装 1234567891011git clone https://github.com/opencontainers/runcgit checkout v1.1.0-rc.1makesudo rm -rf $(which runc)sudo make installsudo systemctl...</div></div></div></a><a class=pagination-related href=/posts/2023/08/26/a-little-bit-design-about-cpu-burst-in-k8s/ title="关于 CPU Burst 在 K8s 中的一些设计想法"><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/06/16/46/sea-7772372_1280.jpg alt=cover><div class="info text-center"><div class=info-1><div class=info-item-1><i class="far fa-calendar-alt fa-fw"></i> 2023-08-27</div><div class=info-item-2>关于 CPU Burst 在 K8s 中的一些设计想法</div></div><div class=info-2><div class=info-item-1>深夜看群友聊的我实在焦虑，起来随便写个水文压压惊 正文写这篇文章的原因是之前给 runc 提的 CPU Burst 支持的 PR [Carry #3205] libct/cg: add CFS bandwidth burst for CPU 终于开始有了新的动静了，这次换了一个国人的 reviewer，感觉要是运气好能在9月开始合并这个 PR。 如果这个 PR 被合并了，那么在 containerd/nerdctl 等其余项目上支持 CPU Burst 的工作就可以开始了。所以这篇文章就是想记录下我对于 CPU Burst 在 Kubernetes 内实现的一些想法，差不多可以当作自己写正式的 KEP(Kubernetes Enhancement Proposal) 草稿 主要分为两个部分来聊一下 CPU Burst 的一些背景 目前 Kubernetes 对于 CPU 资源切分的设计概要 CPU Burst 在 Kubernetes 中的一些设计想法 CPU Burst 的一些背景聊 CPU Burst 之前必须要先聊一下 Linux 里面关于 CGroup...</div></div></div></a></div></div><hr class=custom-hr><div id=post-comment><div class=comment-head><div class=comment-headline><i class="fas fa-comments fa-fw"></i><span> Comments</span></div></div><div class=comment-wrap><div><div id=disqus_thread></div></div></div></div></div><div class=aside-content id=aside-content><div class="card-widget card-info text-center"><div class=avatar-img><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://avatars.githubusercontent.com/u/7054676?v=4" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt=avatar></div><div class=author-info-name>Manjusaka</div><div class=author-info-description>热忱之心不可磨灭</div><div class=site-data><a href=/archives/ ><div class=headline>Articles</div><div class=length-num>104</div></a><a href=/tags/ ><div class=headline>Tags</div><div class=length-num>60</div></a><a href=/categories/ ><div class=headline>Categories</div><div class=length-num>41</div></a></div><a id=card-info-btn href=https://github.com/Zheaoli rel="external nofollow noreferrer"><i class="fab fa-github"></i><span>Follow Me</span></a><div class=card-info-social-icons><a class=social-icon href=https://github.com/ZheaoLi rel="external nofollow noreferrer" target=_blank title=Github><i class="fab fa-github"></i></a><a class=social-icon href=mailto:me@manjusaka.me rel="external nofollow noreferrer" target=_blank title=Email><i class="fas fa-envelope"></i></a><a class=social-icon href=https://twitter.com/Manjusaka_Lee rel="external nofollow noreferrer" target=_blank title=推特><i class="fab fa-twitter"></i></a><a class=social-icon href=/atom.xml target=_blank title=RSS><i class="fa-solid fa-feed"></i></a></div></div><div class="card-widget card-announcement"><div class=item-headline><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class=announcement_content>This is my Blog</div></div><div class=sticky_layout><div class=card-widget id=card-toc><div class=item-headline><i class="fas fa-stream"></i><span>Contents</span><span class=toc-percentage></span></div><div class="toc-content is-expand"><ol class=toc><li class="toc-item toc-level-2"><a class=toc-link href=#%E6%AD%A3%E6%96%87><span class=toc-number>1.</span> <span class=toc-text>正文</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E6%80%BB%E7%BB%93><span class=toc-number>2.</span> <span class=toc-text>总结</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class=item-headline><i class="fas fa-history"></i><span>Recent Posts</span></div><div class=aside-list><div class=aside-list-item><a class=thumbnail href=/posts/2025/07/02/tail-call-in-3-14-interpreter-en/ title="Further Performance Evolution in Python 3.14: Tail Call Interpreter"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/01/14/19/50/flower-7718952_1280.jpg onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Further Performance Evolution in Python 3.14: Tail Call Interpreter"></a><div class=content><a class=title href=/posts/2025/07/02/tail-call-in-3-14-interpreter-en/ title="Further Performance Evolution in Python 3.14: Tail Call Interpreter">Further Performance Evolution in Python 3.14: Tail Call Interpreter</a><time datetime=2025-07-02T15:49:00.000Z title="Created 2025-07-02 23:49:00">2025-07-02</time></div></div><div class=aside-list-item><a class=thumbnail href=/posts/2025/07/02/tail-call-in-3-14-interpreter/ title="Python 3.14 的进一步性能进化: Tail Call Interpreter"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/04/07/38/cherry-blossoms-7766588_1280.jpg onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Python 3.14 的进一步性能进化: Tail Call Interpreter"></a><div class=content><a class=title href=/posts/2025/07/02/tail-call-in-3-14-interpreter/ title="Python 3.14 的进一步性能进化: Tail Call Interpreter">Python 3.14 的进一步性能进化: Tail Call Interpreter</a><time datetime=2025-07-02T15:49:00.000Z title="Created 2025-07-02 23:49:00">2025-07-02</time></div></div><div class=aside-list-item><a class=thumbnail href=/posts/2025/04/26/3-14-is-one-of-the-best-python-version/ title="Python 3.14: Python 世界的一大步"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/08/15/10/sculpture-7776861_1280.jpg onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Python 3.14: Python 世界的一大步"></a><div class=content><a class=title href=/posts/2025/04/26/3-14-is-one-of-the-best-python-version/ title="Python 3.14: Python 世界的一大步">Python 3.14: Python 世界的一大步</a><time datetime=2025-04-26T14:49:00.000Z title="Created 2025-04-26 22:49:00">2025-04-26</time></div></div><div class=aside-list-item><a class=thumbnail href=/posts/2025/03/23/a-simple-introduction-about-load-balance-algorithm/ title=简单聊聊常见的负载均衡算法><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=/images/pixai-1860500966642493859-3.png onerror='this.onerror=null,this.src="/img/404.jpg"' alt=简单聊聊常见的负载均衡算法></a><div class=content><a class=title href=/posts/2025/03/23/a-simple-introduction-about-load-balance-algorithm/ title=简单聊聊常见的负载均衡算法>简单聊聊常见的负载均衡算法</a><time datetime=2025-03-23T12:00:00.000Z title="Created 2025-03-23 20:00:00">2025-03-23</time></div></div><div class=aside-list-item><a class=thumbnail href=/posts/2025/02/03/a-little-thought-about-translation-about-yuru-camp/ title=简单吐槽一下摇曳露营的台配><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/07/14/45/snow-7774312_1280.jpg onerror='this.onerror=null,this.src="/img/404.jpg"' alt=简单吐槽一下摇曳露营的台配></a><div class=content><a class=title href=/posts/2025/02/03/a-little-thought-about-translation-about-yuru-camp/ title=简单吐槽一下摇曳露营的台配>简单吐槽一下摇曳露营的台配</a><time datetime=2025-02-03T18:00:00.000Z title="Created 2025-02-04 02:00:00">2025-02-04</time></div></div></div></div><div class="card-widget ads-wrap"><ins class=adsbygoogle style=display:block data-ad-client=ca-pub-7962287588031867 data-ad-slot=1257383027 data-ad-format=auto data-full-width-responsive=true></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div></div></div></main><footer id=footer><div id=footer-wrap><div class=copyright>&copy;2020 - 2025 By Manjusaka</div><div class=framework-info><span>Framework </span><a href=https://hexo.io rel="external nofollow noreferrer">Hexo 7.3.0</a><span class=footer-separator>|</span><span>Theme </span><a href=https://github.com/jerryc127/hexo-theme-butterfly rel="external nofollow noreferrer">Butterfly 5.3.5</a></div></div></footer></div><div id=rightside><div id=rightside-config-hide></div><div id=rightside-config-show><button id=darkmode type=button title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id=translateLink type=button title="Toggle Between Traditional and Simplified Chinese">简</button><button id=readmode type=button title="Reading Mode"><i class="fas fa-book-open"></i></button><button id=go-up type=button title="Back to Top"><span class=scroll-percent></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src=https://www.manjusaka.blog/js/utils.js></script><script src=https://www.manjusaka.blog/js/main.js></script><script src=https://www.manjusaka.blog/js/tw_cn.js></script><script src=https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js></script><script src=https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js></script><div class=js-pjax><script>(()=>{var e=()=>{var e;0!==(e=document.querySelectorAll("pre > code.mermaid")).length&&e.forEach(e=>{var t=document.createElement("pre"),d=(t.className="mermaid-src",t.hidden=!0,t.textContent=e.textContent,document.createElement("div"));d.className="mermaid-wrap",d.appendChild(t),e.parentNode.replaceWith(d)});let t=document.querySelectorAll("#article-container .mermaid-wrap");0!==t.length&&(e=()=>(e=>{window.loadMermaid=!0;document.documentElement.getAttribute("data-theme");e.forEach((e,t)=>{let d=e.firstElementChild;e=`%%{init:{ 'theme':'default'}}%%
`+d.textContent,t=mermaid.render("mermaid-"+t,e);let n=e=>{d.insertAdjacentHTML("afterend",e)};"string"==typeof t?n(t):t.then(({svg:e})=>n(e))})})(t),btf.addGlobalFn("themeChange",e,"mermaid"),window.loadMermaid?e():btf.getScript("https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js").then(e))};btf.addGlobalFn("encrypt",e,"mermaid"),window.pjax?e():document.addEventListener("DOMContentLoaded",e)})()</script><script>(()=>{let o="shuoshuo"===GLOBAL_CONFIG_SITE.pageType,i=e=>{window.DISQUS&&window.DISQUS.reset({reload:!0,config:e})};var e=(e,t)=>{o&&(window.shuoshuoComment.destroyDisqus=()=>{e.children.length&&(e.innerHTML="",e.classList.add("no-comment"))}),window.disqus_identifier=o?t:"/posts/2025/04/26/3-14-is-one-of-the-best-python-version/",window.disqus_url=o?location.origin+t:"https://www.manjusaka.blog/posts/2025/04/26/3-14-is-one-of-the-best-python-version/";function s(){this.page.url=disqus_url,this.page.identifier=disqus_identifier,this.page.title="Python 3.14: Python 世界的一大步"}window.DISQUS?i(s):((t=document.createElement("script")).src="https://manjusakablog.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),document.head.appendChild(t)),btf.addGlobalFn("themeChange",()=>i(s),"disqus")};o?window.shuoshuoComment={loadComment:e}:e()})()</script></div><script defer=defer id=fluttering_ribbon mobile=false src=https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js></script><script src=https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!0,POWERMODE.mobile=!1,document.body.addEventListener("input",POWERMODE)</script><script async data-pjax src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><div id=algolia-search><div class=search-dialog><nav class=search-nav><span class=search-dialog-title>Search</span><button class=search-close-button><i class="fas fa-times"></i></button></nav><div class=search-wrap><div id=algolia-search-input></div><hr><div id=algolia-search-results><div id=algolia-hits></div><div id=algolia-pagination></div><div id=algolia-info><div class=algolia-stats></div><div class=algolia-poweredBy></div></div></div></div></div><div id=search-mask></div><script src=https://cdn.jsdelivr.net/npm/algoliasearch/dist/lite/builds/browser.umd.min.js></script><script src=https://cdn.jsdelivr.net/npm/instantsearch.js/dist/instantsearch.production.min.js></script><script src=https://www.manjusaka.blog/js/search/algolia.js></script></div></div><script data-pjax>function butterfly_swiper_injector_config(){var s=document.getElementById("recent-posts");console.log("已挂载butterfly_swiper"),s.insertAdjacentHTML("afterbegin",'<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="/posts/2024/12/31/at-the-end-of-2024/" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.pixabay.com/photo/2023/02/04/07/38/cherry-blossoms-7766588_1280.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2024-12-31</span><a class="blog-slider__title" href="/posts/2024/12/31/at-the-end-of-2024/" alt="">本当の僕らをありがとう</a><div class="blog-slider__text">再怎么看我也不知道怎么描述它的啦！</div><a class="blog-slider__button" href="/posts/2024/12/31/at-the-end-of-2024/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="/posts/2024/02/20/a-simple-discussion-about-the-ultraman/" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.pixabay.com/photo/2023/02/06/16/46/sea-7772372_1280.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2024-02-20</span><a class="blog-slider__title" href="/posts/2024/02/20/a-simple-discussion-about-the-ultraman/" alt="">简单聊聊奥特曼中很有趣的细节</a><div class="blog-slider__text">ヒーロが必要なんだよ，金城君。ヒーローが必要なんだ！</div><a class="blog-slider__button" href="/posts/2024/02/20/a-simple-discussion-about-the-ultraman/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="/posts/2023/12/29/per-aspera-ad-astra/" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.pixabay.com/photo/2023/01/30/19/40/gulls-7756481_1280.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-12-29</span><a class="blog-slider__title" href="/posts/2023/12/29/per-aspera-ad-astra/" alt="">Per aspera, Ad astra</a><div class="blog-slider__text">再怎么看我也不知道怎么描述它的啦！</div><a class="blog-slider__button" href="/posts/2023/12/29/per-aspera-ad-astra/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="/posts/2023/10/24/open-source-is-simple-than-you-think/" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.pixabay.com/photo/2023/02/04/07/38/cherry-blossoms-7766587_1280.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-10-24</span><a class="blog-slider__title" href="/posts/2023/10/24/open-source-is-simple-than-you-think/" alt="">开源可能没你想的那么难</a><div class="blog-slider__text">再怎么看我也不知道怎么描述它的啦！</div><a class="blog-slider__button" href="/posts/2023/10/24/open-source-is-simple-than-you-think/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="/posts/2023/06/25/love-and-hope-is-all-we-need/" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://github.com/Zheaoli/yuque-py/assets/7054676/ea9460a2-e351-4b73-9f82-7aef6cd20c33" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-06-25</span><a class="blog-slider__title" href="/posts/2023/06/25/love-and-hope-is-all-we-need/" alt="">聊聊公益和助学</a><div class="blog-slider__text">很多时候，帮助人不需要那么多理由</div><a class="blog-slider__button" href="/posts/2023/06/25/love-and-hope-is-all-we-need/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="/posts/2023/12/28/how-do-I-build-homelab-part2/" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.pixabay.com/photo/2023/02/04/07/38/cherry-blossoms-7766588_1280.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-12-28</span><a class="blog-slider__title" href="/posts/2023/12/28/how-do-I-build-homelab-part2/" alt="">家庭 Homelab 升级计划: v2</a><div class="blog-slider__text">人生嘛，Homelab 图个乐子</div><a class="blog-slider__button" href="/posts/2023/12/28/how-do-I-build-homelab-part2/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="/posts/2023/06/19/why-do-I-love-ultraman/" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://user-images.githubusercontent.com/7054676/228287041-c86e7928-0da8-4097-b7ff-e575faa8cf8c.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-06-19</span><a class="blog-slider__title" href="/posts/2023/06/19/why-do-I-love-ultraman/" alt="">为什么奥特曼是我的信仰</a><div class="blog-slider__text">優しさを失わないでくれ。弱い者を労り互いに助け合い。</div><a class="blog-slider__button" href="/posts/2023/06/19/why-do-I-love-ultraman/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="/posts/2023/06/16/how-do-I-build-homelab/" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.pixabay.com/photo/2023/02/06/01/14/superb-fairywren-7770904_1280.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-06-16</span><a class="blog-slider__title" href="/posts/2023/06/16/how-do-I-build-homelab/" alt="">家庭 Homelab 升级计划</a><div class="blog-slider__text">人生嘛，Homelab 图个乐子</div><a class="blog-slider__button" href="/posts/2023/06/16/how-do-I-build-homelab/" alt="">详情   </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>')}for(var elist="undefined".split(","),cpage=location.pathname,epage="all",flag=0,i=0;i<elist.length;i++)cpage.includes(elist[i])&&flag++;("all"===epage&&0==flag||epage===cpage)&&butterfly_swiper_injector_config()</script><script defer=defer src=https://cdn.jsdelivr.net/npm/hexo-butterfly-swiper@1.0.12/lib/swiper.min.js></script><script defer=defer data-pjax src=https://cdn.jsdelivr.net/npm/hexo-butterfly-swiper@1.0.12/lib/swiper_init.js></script><script async src=//at.alicdn.com/t/font_2032782_8d5kxvn09md.js></script></body></html>