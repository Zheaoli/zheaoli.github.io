<!DOCTYPE html><html lang=en data-theme=auto><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><title>关于 Node.js 中 execSync 的一点问题 | Manjusaka</title><meta name=author content=Manjusaka><meta name=copyright content=Manjusaka><meta name=format-detection content="telephone=no"><meta name=theme-color content=ffffff><meta name=description content="很久没写水文了，昨天帮人查了一个 Node.js 中 execSync 这个函数特殊行为的问题，很有趣，所以大概记录下来水一篇文章"><meta property=og:type content=article><meta property=og:title content="关于 Node.js 中 execSync 的一点问题"><meta property=og:url content=https://manjusaka.blog/posts/2021/08/24/a-little-problem-about-posix-node-js-execsync/index.html><meta property=og:site_name content=Manjusaka><meta property=og:description content="很久没写水文了，昨天帮人查了一个 Node.js 中 execSync 这个函数特殊行为的问题，很有趣，所以大概记录下来水一篇文章"><meta property=og:locale content=en_US><meta property=og:image content=https://cdn.pixabay.com/photo/2023/02/06/01/14/superb-fairywren-7770904_1280.jpg><meta property=article:published_time content=2021-08-24T13:00:00.000Z><meta property=article:modified_time content=2023-06-19T18:54:43.697Z><meta property=article:author content=Manjusaka><meta property=article:tag content=编程><meta property=article:tag content=Linux><meta property=article:tag content=笔记><meta property=article:tag content=水文><meta property=article:tag content=Node.js><meta name=twitter:card content=summary><meta name=twitter:image content="https://avatars.githubusercontent.com/u/7054676?v=4"><meta name=twitter:creator content=@Manjusaka_Lee><meta name=twitter:site content=https://twitter.com/Manjusaka_Lee><link rel="shortcut icon" href="https://avatars.githubusercontent.com/u/7054676?v=4"><link rel=canonical href=https://manjusaka.blog/posts/2021/08/24/a-little-problem-about-posix-node-js-execsync/index.html><link rel=preconnect href=//cdn.jsdelivr.net><link rel=preconnect href=//www.google-analytics.com crossorigin=""><link rel=preconnect href=//busuanzi.ibruce.info><meta name=google-site-verification content=ohZ0A8YKJu755suq7WOIJkLGDfj3BGU4isb8RKI5Cj8><meta name=baidu-site-verification content=codeva-seFAiiGXVd><link rel=stylesheet href=/css/index.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css media=print onload='this.media="all"'><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css media=print onload='this.media="all"'><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css media=print onload='this.media="all"'><script async=async src="https://www.googletagmanager.com/gtag/js?id=UA-154407994-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-154407994-1")</script><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"/search.xml",preload:!1,languages:{hits_empty:"We didn't find any results for the search: ${query}"}},translate:{defaultEncoding:2,translateDelay:0,msgToTraditionalChinese:"繁",msgToSimplifiedChinese:"簡"},noticeOutdate:{limitDay:365,position:"top",messagePrev:"It has been",messageNext:"days since the last update, the content of the article may be outdated."},highlight:{plugin:"highlighjs",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:400},copy:{success:"Copy successfully",error:"Copy error",noSupport:"The browser does not support"},relativeDate:{homepage:!0,post:!0},runtime:"days",date_suffix:{just:"Just",min:"minutes ago",hour:"hours ago",day:"days ago",month:"months ago"},copyright:{limitCount:100,languages:{author:"Author: Manjusaka",link:"Link: ",source:"Source: Manjusaka",info:"Copyright is owned by the author. For commercial reprints, please contact the author for authorization. For non-commercial reprints, please indicate the source."}},lightbox:"fancybox",Snackbar:{chs_to_cht:"Traditional Chinese Activated Manually",cht_to_chs:"Simplified Chinese Activated Manually",day_to_night:"Dark Mode Activated Manually",night_to_day:"Light Mode Activated Manually",bgLight:"#59C173",bgDark:"#1f1f1f",position:"bottom-left"},source:{justifiedGallery:{js:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js",css:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css"}},isPhotoFigcaption:!0,islazyload:!0,isAnchor:!0,percent:{toc:!0,rightside:!0}}</script><script id=config-diff>var GLOBAL_CONFIG_SITE={title:"关于 Node.js 中 execSync 的一点问题",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2023-06-20 02:54:43"}</script><noscript><style type=text/css>#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:function(e,t,a){0!==a&&(a=864e5*a,t={value:t,expiry:(new Date).getTime()+a},localStorage.setItem(e,JSON.stringify(t)))},get:function(e){var t=localStorage.getItem(e);if(t){t=JSON.parse(t);if(!((new Date).getTime()>t.expiry))return t.value;localStorage.removeItem(e)}}},e.getScript=o=>new Promise((t,e)=>{const a=document.createElement("script");a.src=o,a.async=!0,a.onerror=e,a.onload=a.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},document.head.appendChild(a)}),e.getCSS=(o,n=!1)=>new Promise((t,e)=>{const a=document.createElement("link");a.rel="stylesheet",a.href=o,n&&(a.id=n),a.onerror=e,a.onload=a.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},document.head.appendChild(a)}),e.activateDarkMode=function(){document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},e.activateLightMode=function(){document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","ffffff")};var e=saveToLocal.get("theme"),t=window.matchMedia("(prefers-color-scheme: dark)").matches,a=window.matchMedia("(prefers-color-scheme: light)").matches,o=window.matchMedia("(prefers-color-scheme: no-preference)").matches,n=!t&&!a&&!o,t=(void 0===e?(a?activateLightMode():t?activateDarkMode():(o||n)&&((a=(new Date).getHours())<=6||18<=a?activateDarkMode:activateLightMode)(),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){void 0===saveToLocal.get("theme")&&(e.matches?activateDarkMode:activateLightMode)()})):("light"===e?activateLightMode:activateDarkMode)(),saveToLocal.get("aside-status"));void 0!==t&&("hide"===t?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})(window)</script><link rel=stylesheet href=https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.css media=print onload='this.media="all"'><link rel=stylesheet href=https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiperstyle.css media=print onload='this.media="all"'><link rel=stylesheet href=https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css media=defer onload='this.media="all"'><link rel=stylesheet href=https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css media=defer onload='this.media="all"'><script src=https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js></script><meta name=generator content="Hexo 6.3.0"><link rel=alternate href=/atom.xml title=Manjusaka type=application/atom+xml></head><body><div id=web_bg></div><div id=sidebar><div id=menu-mask></div><div id=sidebar-menus><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://avatars.githubusercontent.com/u/7054676?v=4" onerror='onerror=null,src="/img/friend_404.gif"' alt=avatar></div><div class="sidebar-site-data site-data is-center"><a href=/archives/ ><div class=headline>Articles</div><div class=length-num>74</div></a><a href=/tags/ ><div class=headline>Tags</div><div class=length-num>51</div></a><a href=/categories/ ><div class=headline>Categories</div><div class=length-num>32</div></a></div><hr><div class=menus_items><div class=menus_item><a class=site-page href=/ ><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class=menus_item><a class="site-page group" href=javascript:void(0); rel="external nofollow noreferrer"><i class="fa-fw fa-fw fas fa-lines-leaning"></i><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class=menus_item_child><li><a class="site-page child" href=/categories/ ><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href=/tags/ ><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href=/archives/ ><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href=/random/ ><i class="fa-fw fas fa-random"></i><span> 随便逛逛</span></a></li></ul></div><div class=menus_item><a class=site-page href=/weekly/ ><i class="fa-fw fas fa-newspaper"></i><span> 周报</span></a></div><div class=menus_item><a class="site-page group" href=javascript:void(0); rel="external nofollow noreferrer"><i class="fa-fw fas fa-heart"></i><span> 我的</span><i class="fas fa-chevron-down"></i></a><ul class=menus_item_child><li><a class="site-page child" href=/about/ ><i class="fa-fw fas fa-spa"></i><span> 关于</span></a></li><li><a class="site-page child" href=/weekly/ ><i class="fa-fw fas fa-newspaper"></i><span> 周报</span></a></li></ul></div></div></div></div><div class=post id=body-wrap><header class=post-bg id=page-header style=background-image:url(https://cdn.pixabay.com/photo/2023/02/06/01/14/superb-fairywren-7770904_1280.jpg)><nav id=nav><span id=blog-info><a href=/ title=Manjusaka><img class=site-icon src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://avatars.githubusercontent.com/u/7054676?v=4# image"><span class=site-name>Manjusaka</span></a></span><div id=menus><div id=search-button><a class="site-page social-icon search" href=javascript:void(0); rel="external nofollow noreferrer"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class=menus_items><div class=menus_item><a class=site-page href=/ ><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class=menus_item><a class="site-page group" href=javascript:void(0); rel="external nofollow noreferrer"><i class="fa-fw fa-fw fas fa-lines-leaning"></i><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class=menus_item_child><li><a class="site-page child" href=/categories/ ><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href=/tags/ ><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href=/archives/ ><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href=/random/ ><i class="fa-fw fas fa-random"></i><span> 随便逛逛</span></a></li></ul></div><div class=menus_item><a class=site-page href=/weekly/ ><i class="fa-fw fas fa-newspaper"></i><span> 周报</span></a></div><div class=menus_item><a class="site-page group" href=javascript:void(0); rel="external nofollow noreferrer"><i class="fa-fw fas fa-heart"></i><span> 我的</span><i class="fas fa-chevron-down"></i></a><ul class=menus_item_child><li><a class="site-page child" href=/about/ ><i class="fa-fw fas fa-spa"></i><span> 关于</span></a></li><li><a class="site-page child" href=/weekly/ ><i class="fa-fw fas fa-newspaper"></i><span> 周报</span></a></li></ul></div></div><div id=toggle-menu><a class=site-page href=javascript:void(0); rel="external nofollow noreferrer"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id=post-info><h1 class=post-title>关于 Node.js 中 execSync 的一点问题<a class=post-edit-link href=https://github.com/Zheaoli/Zheaoli.github.io/edit/main/source/_posts/a-little-problem-about-posix-node-js-execsync.md rel="external nofollow noreferrer" title="Edited on" target=_blank><i class="fas fa-pencil-alt"></i></a></h1><div id=post-meta><div class=meta-firstline><span class=post-meta-date><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class=post-meta-label>Created</span><time datetime=2021-08-24T13:00:00.000Z title="Created 2021-08-24 21:00:00">2021-08-24</time></span><span class=post-meta-categories><span class=post-meta-separator>|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class=post-meta-categories href=/categories/%E7%BC%96%E7%A8%8B/ >编程</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class=post-meta-categories href=/categories/%E7%BC%96%E7%A8%8B/Linux/ >Linux</a></span></div><div class=meta-secondline><span class=post-meta-separator>|</span><span class=post-meta-wordcount><i class="far fa-file-word fa-fw post-meta-icon"></i><span class=post-meta-label>Word count:</span><span class=word-count>1.9k</span><span class=post-meta-separator>|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class=post-meta-label>Reading time:</span><span>8min</span></span><span class=post-meta-separator>|</span><span class=post-meta-pv-cv id="" data-flag-title="关于 Node.js 中 execSync 的一点问题"><i class="far fa-eye fa-fw post-meta-icon"></i><span class=post-meta-label>Post View:</span><span id=busuanzi_value_page_pv><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class=layout id=content-inner><div id=post><article class=post-content id=article-container><p>很久没写水文了，昨天帮人查了一个 Node.js 中 <code>execSync</code> 这个函数特殊行为的问题，很有趣，所以大概记录下来水一篇文章</p><span id=more></span><h2 id=背景><a href=#背景 class=headerlink title=背景></a>背景</h2><p>首先老哥给了一张截图</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://user-images.githubusercontent.com/7054676/130622339-57e6a954-926e-4741-93a9-bc1ba0d155d8.png alt=问题截图></p><p>首先基本问题可以抽象为在 Node.js 中利用 <code>execSync</code> 这个函数执行 <code>ps -Af | grep -q -E -c &quot;\\-\\-user-data-dir=\\.+App&quot;</code> 这样一条命令的时候，Node.js 时不时会报错。具体堆栈大概为</p><figure class="highlight text"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br></pre></td><td class=code><pre><span class=line>Uncaught Error: Command failed: ps -Af | grep -q -E -c &quot;\-\-user-data-dir=\.+App&quot;</span><br><span class=line>    at checkExecSyncError (child_process.js:616:11)</span><br><span class=line>    at Object.execSync (child_process.js:652:15) &#123;</span><br><span class=line>  status: 1,</span><br><span class=line>  signal: null,</span><br><span class=line>  output: [ null, &lt;Buffer &gt;, &lt;Buffer &gt; ],</span><br><span class=line>  pid: 89073,</span><br><span class=line>  stdout: &lt;Buffer &gt;,</span><br><span class=line>  stderr: &lt;Buffer &gt;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>但是同样的命令在终端上并不会有类似的现象。所以这个问题有点困扰人</p><h2 id=分析><a href=#分析 class=headerlink title=分析></a>分析</h2><p>首先先看一下 Node.js 文档中对 <code>execSync</code> 的描述</p><blockquote><p>The child_process.execSync() method is generally identical to child_process.exec() with the exception that the method will not return until the child process has fully closed. When a timeout has been encountered and killSignal is sent, the method won’t return until the process has completely exited. If the child process intercepts and handles the SIGTERM signal and doesn’t exit, the parent process will wait until the child process has exited.<br>If the process times out or has a non-zero exit code, this method will throw. The Error object will contain the entire result from child_process.spawnSync().<br>Never pass unsanitized user input to this function. Any input containing shell metacharacters may be used to trigger arbitrary command execution.</p></blockquote><p>大意就是，这个函数通过子进程来执行一个命令，在命令执行超时之前会一直等待。OK 没有问题。那接下来，我们先来看一下上面提到的报错堆栈以及 <code>execSync</code> 的实现代码</p><figure class="highlight javascript"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br></pre></td><td class=code><pre><span class=line><span class=keyword>function</span> <span class="title function_">execSync</span>(<span class=params>command, options</span>) &#123;</span><br><span class=line>  <span class=keyword>const</span> opts = <span class="title function_">normalizeExecArgs</span>(command, options, <span class=literal>null</span>);</span><br><span class=line>  <span class=keyword>const</span> inheritStderr = !opts.<span class=property>options</span>.<span class=property>stdio</span>;</span><br><span class=line></span><br><span class=line>  <span class=keyword>const</span> ret = <span class="title function_">spawnSync</span>(opts.<span class=property>file</span>, opts.<span class=property>options</span>);</span><br><span class=line></span><br><span class=line>  <span class=keyword>if</span> (inheritStderr &amp;&amp; ret.<span class=property>stderr</span>)</span><br><span class=line>    process.<span class=property>stderr</span>.<span class="title function_">write</span>(ret.<span class=property>stderr</span>);</span><br><span class=line></span><br><span class=line>  <span class=keyword>const</span> err = <span class="title function_">checkExecSyncError</span>(ret, opts.<span class=property>args</span>, command);</span><br><span class=line></span><br><span class=line>  <span class=keyword>if</span> (err)</span><br><span class=line>    <span class=keyword>throw</span> err;</span><br><span class=line></span><br><span class=line>  <span class=keyword>return</span> ret.<span class=property>stdout</span>;</span><br><span class=line>&#125;</span><br><span class=line></span><br><span class=line><span class=keyword>function</span> <span class="title function_">checkExecSyncError</span>(<span class=params>ret, args, cmd</span>) &#123;</span><br><span class=line>  <span class=keyword>let</span> err;</span><br><span class=line>  <span class=keyword>if</span> (ret.<span class=property>error</span>) &#123;</span><br><span class=line>    err = ret.<span class=property>error</span>;</span><br><span class=line>  &#125; <span class=keyword>else</span> <span class=keyword>if</span> (ret.<span class=property>status</span> !== <span class=number>0</span>) &#123;</span><br><span class=line>    <span class=keyword>let</span> msg = <span class=string>&#x27;Command failed: &#x27;</span>;</span><br><span class=line>    msg += cmd || <span class="title class_">ArrayPrototypeJoin</span>(args, <span class=string>&#x27; &#x27;</span>);</span><br><span class=line>    <span class=keyword>if</span> (ret.<span class=property>stderr</span> &amp;&amp; ret.<span class=property>stderr</span>.<span class=property>length</span> &gt; <span class=number>0</span>)</span><br><span class=line>      msg += <span class=string>`\n<span class=subst>$&#123;ret.stderr.toString()&#125;</span>`</span>;</span><br><span class=line>    <span class=comment>// eslint-disable-next-line no-restricted-syntax</span></span><br><span class=line>    err = <span class=keyword>new</span> <span class="title class_">Error</span>(msg);</span><br><span class=line>  &#125;</span><br><span class=line>  <span class=keyword>if</span> (err) &#123;</span><br><span class=line>    <span class="title class_">ObjectAssign</span>(err, ret);</span><br><span class=line>  &#125;</span><br><span class=line>  <span class=keyword>return</span> err;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>我们能看到，这里 <code>execSync</code> 在执行完命令执行代码后，会进入 <code>checkExecSyncError</code> 来检查子进程的 <code>Exit Status Code</code> 是否为0，不为0则认为命令执行出错，然后抛出异常。</p><p>看起来没有问题，那么也就是我们执行命令的时候出错了？那我们验证下吧</p><p>对于这种涉及 Linux 下 Syscall 问题排查的工具（这个问题在 Mac 等环境下也存在，不过我为了方便排查，跑去 Linux 上复现了），除了 <code>strace</code> 好像也暂时找不到更成熟方便的工具了（虽然基于 eBPF 也能做，但是说实话自己现撸绝对没 <code>strace</code> 的效果好。</p><p>那么上命令</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>sudo strace -t -f -p <span class=variable>$PID</span> -o error_trace.txt</span><br></pre></td></tr></table></figure><blockquote><p>tips: 在使用 strace 的时候可以利用 -f 参数，可以 trace 被 trace 进程创建的子进程</p></blockquote><p>好了执行命令，成功拿到整个 syscall 的调用链路，OK 开始分析</p><p>首先我们将目光很快定位到了最关键的部分（因为整个文件太长，有将近 4K 行，我就直接挑重点部分分析了）</p><figure class="highlight text"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br></pre></td><td class=code><pre><span class=line>...</span><br><span class=line>894259 13:21:23 clone(child_stack=NULL, flags=CLONE_CHILD_CLEARTID|CLONE_CHILD_SETTID|SIGCHLD, child_tidptr=0x7f12d9465a50) = 896940</span><br><span class=line>...</span><br><span class=line>896940 13:21:23 execve(&quot;/bin/sh&quot;, [&quot;/bin/sh&quot;, &quot;-c&quot;, &quot;ps -Af | grep -E -c \&quot;\\-\\-user-da&quot;...], 0x4aae230 /* 40 vars */ &lt;unfinished ...&gt;</span><br><span class=line>...</span><br><span class=line>896940 13:21:24 &lt;... wait4 resumed&gt;[&#123;WIFEXITED(s) &amp;&amp; WEXITSTATUS(s) == 1&#125;], 0, NULL) = 896942</span><br><span class=line>896940 13:21:24 --- SIGCHLD &#123;si_signo=SIGCHLD, si_code=CLD_EXITED, si_pid=896942, si_uid=1000, si_status=1, si_utime=0, si_stime=0&#125; ---</span><br><span class=line>896940 13:21:24 rt_sigreturn(&#123;mask=[]&#125;) = 896942</span><br><span class=line>896940 13:21:24 exit_group(1)           = ?</span><br><span class=line>896940 13:21:24 +++ exited with 1 +++</span><br></pre></td></tr></table></figure><p>首先这里科普一下，Node.js 中没有直接使用 <code>fork</code> 来创建新的进程，而是使用 <code>clone</code> 来创建新的进程，至于两者之间的差别，要详细说的话，可以单独水一篇超长文了（我先立个 flag）这里先用官方的说法大概描述下</p><blockquote><p>These system calls create a new (“child”) process, in a manner similar to fork(2).<br>By contrast with fork(2), these system calls provide more precise control over what pieces of execution context are shared between the calling process and the child process. For example, using these system calls, the caller can control whether or not the two processes share the virtual address space, the table of file descriptors, and the table of signal handlers. These system calls also allow the new child process to be placed in separate namespaces(7).</p></blockquote><p>用简短的概括性的话来描述就是,<code>clone</code> 提供了 <code>fork</code> 近似的语义,不过通过 <code>clone</code> ,开发者能更细粒度的控制进程/线程创建过程中的细节</p><p>OK, 这里我们看到 <code>894259</code> 这个主进程通过 <code>clone</code> 创建了 <code>896940</code> 这个进程。在执行过程中, <code>896940</code> 这个进程利用 <code>execve</code> 这个 syscall 通过 sh (这是 <code>execSync</code> 的默认行为)我们的命令 <code>ps -Af | grep -q -E -c &quot;\\-\\-user-data-dir=\\.+App&quot;</code>。 OK，我们也看到了，<code>896940</code> 在退出的时候，的确是以 1 的 exit code 退出的，和我们之前的分析一致。那么换句话说，在我们执行命令的时候，有 error 的出现。那么这里的 error 出现在哪呢？</p><p>我们分析一下命令，如果熟悉常见 shell 的同学可能发现了，我们的命令中实际上使用了管道操作符 | ，不精确的来说，当这个操作符出现的时候，前后两个命令将分别在两个进程执行，然后通过 pipe 进行 IPC。那么换句话说，我们可以很快定位这两个进程，直接快速搜了一下文本</p><figure class="highlight text"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br></pre></td><td class=code><pre><span class=line>...</span><br><span class=line>896941 13:21:23 execve(&quot;/bin/ps&quot;, [&quot;ps&quot;, &quot;-Af&quot;], 0x564c16f6ec38 /* 40 vars */) = 0</span><br><span class=line>...</span><br><span class=line>896942 13:21:23 execve(&quot;/bin/grep&quot;, [&quot;grep&quot;, &quot;-E&quot;, &quot;-c&quot;, &quot;\\-\\-user-data-dir=\\.*&quot;], 0x564c16f6ecb0 /* 40 vars */ &lt;unfinished ...&gt;</span><br><span class=line>...</span><br><span class=line>896941 13:21:24 &lt;... exit_group resumed&gt;) = ?</span><br><span class=line>896941 13:21:24 +++ exited with 0 +++</span><br><span class=line>...</span><br><span class=line>896942 13:21:24 exit_group(1)           = ?</span><br><span class=line>896942 13:21:24 +++ exited with 1 +++</span><br></pre></td></tr></table></figure><p>OK，我们发现 <code>896942</code> 即执行 <code>grep</code> 的进程直接以 exit code 1 退出了。那么这是为什么呢？？看了下 <code>grep</code> 的官方文档，，卧操，差点吐血</p><blockquote><p>Normally, the exit status is 0 if selected lines are found and 1 otherwise. But the exit status is 2 if an error occurred, unless the -q or —quiet or —silent option is used and a selected line is found. Note, however, that POSIX only mandates, for programs such as grep, cmp, and diff, that the exit status in case of error be greater than 1; it is therefore advisable, for the sake of portability, to use logic that tests for this general condition instead of strict equality with 2.</p></blockquote><p>如果 grep 没有匹配到数据，那么会以 1 作为 exit code 退出进程。。如果匹配到了，则0退出。。但是，但是，卧操，卧操。。按照标准语义，exit code 1 的含义难道不是 <code>Operation not permitted</code> 吗？？完全不按基本法出牌！</p><h2 id=总结><a href=#总结 class=headerlink title=总结></a>总结</h2><p>实际上通篇看了下来，我们可以总结出两个原因</p><ol><li>Node.js 在对 POSIX 相关 API 进行抽象封装的时候，直接按照了标准语义，给用户兜底了。虽然从理论上讲这应该是个应用自决的行为</li><li>grep 没有按照基本法办事</li></ol><p>说实话我也不知道怎么去评价这两方面谁更坑一点。按照前面所说么处理子进程的 exit code 从理论上讲这应该是个应用自决的行为，但是 Node.js 自己做了一层封装，在节省用户心智的同时，遇到一些非标场景，也会有不小的隐患了。。</p><p>只能说不断根据不同的场景做 trade-off 吧</p><p>好了，这篇文章就到这里了，因为是临时起义，所以我就懒得将相关 Reference 列在文里了。差不多这样吧，水文目标达成.jpg</p></article><div class=post-copyright><div class=post-copyright__author><span class=post-copyright-meta>Author: </span><span class=post-copyright-info><a target=_blank rel="noopener external nofollow noreferrer" href=https://github.com/Zheaoli>Manjusaka</a></span></div><div class=post-copyright__type><span class=post-copyright-meta>Link: </span><span class=post-copyright-info><a href=https://manjusaka.blog/posts/2021/08/24/a-little-problem-about-posix-node-js-execsync/ >https://manjusaka.blog/posts/2021/08/24/a-little-problem-about-posix-node-js-execsync/</a></span></div><div class=post-copyright__notice><span class=post-copyright-meta>Copyright Notice: </span><span class=post-copyright-info>All articles in this blog are licensed under <a target=_blank rel="noopener external nofollow noreferrer" href=https://creativecommons.org/licenses/by-nc-sa/4.0/ >CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class=tag_share><div class=post-meta__tag-list><a class=post-meta__tags href=/tags/%E7%BC%96%E7%A8%8B/ >编程</a><a class=post-meta__tags href=/tags/Linux/ >Linux</a><a class=post-meta__tags href=/tags/%E7%AC%94%E8%AE%B0/ >笔记</a><a class=post-meta__tags href=/tags/%E6%B0%B4%E6%96%87/ >水文</a><a class=post-meta__tags href=/tags/Node-js/ >Node.js</a></div><div class=post_share><div class=social-share data-image=https://cdn.pixabay.com/photo/2023/02/06/01/14/superb-fairywren-7770904_1280.jpg data-sites=facebook,twitter,wechat,weibo,qq></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css media=print onload='this.media="all"'><script src=https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js defer=defer></script></div></div><div class=ads-wrap><ins class=adsbygoogle style=display:block;text-align:center data-ad-layout=in-article data-ad-format=fluid data-ad-client=ca-pub-7962287588031867 data-ad-slot=2542544532></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><nav class=pagination-post id=pagination><div class="prev-post pull-left"><a href=/posts/2021/11/22/a-litte-introduction-about-nohdr-filed-in-skbuff/ title="聊聊 sk_buff 中一个冷门字段: nohdr"><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/08/15/10/sculpture-7776861_1280.jpg onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class=pagination-info><div class=label>Previous Post</div><div class=prev_info>聊聊 sk_buff 中一个冷门字段: nohdr</div></div></a></div><div class="next-post pull-right"><a href=/posts/2021/05/07/something-I-want-to-share-about-sex-assault1/ title=关于我自己被性侵经历的访谈记录><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/06/16/46/sea-7772372_1280.jpg onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class=pagination-info><div class=label>Next Post</div><div class=next_info>关于我自己被性侵经历的访谈记录</div></div></a></div></nav><div class=relatedPosts><div class=headline><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class=relatedPosts-list><div><a href=/posts/2021/11/22/a-litte-introduction-about-nohdr-filed-in-skbuff/ title="聊聊 sk_buff 中一个冷门字段: nohdr"><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/08/15/10/sculpture-7776861_1280.jpg alt=cover><div class="content is-center"><div class=date><i class="far fa-calendar-alt fa-fw"></i> 2021-11-22</div><div class=title>聊聊 sk_buff 中一个冷门字段: nohdr</div></div></a></div><div><a href=/posts/2022/01/31/a-simple-introduction-about-network-monitoring-in-linux-kernel/ title="简单聊聊在 Linux 内核中的网络质量监控"><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/08/15/10/sculpture-7776861_1280.jpg alt=cover><div class="content is-center"><div class=date><i class="far fa-calendar-alt fa-fw"></i> 2022-01-31</div><div class=title>简单聊聊在 Linux 内核中的网络质量监控</div></div></a></div><div><a href=/posts/2020/11/07/a-simple-introduction-about-signal-process-in-linux-v2/ title="简单聊聊进程中的信号处理 V2"><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/01/30/19/40/gulls-7756481_1280.jpg alt=cover><div class="content is-center"><div class=date><i class="far fa-calendar-alt fa-fw"></i> 2020-11-07</div><div class=title>简单聊聊进程中的信号处理 V2</div></div></a></div><div><a href=/posts/2020/10/24/a-simple-introduction-about-signal-process-in-linux/ title=简单聊聊进程中的信号处理><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/06/16/46/sea-7772372_1280.jpg alt=cover><div class="content is-center"><div class=date><i class="far fa-calendar-alt fa-fw"></i> 2020-10-24</div><div class=title>简单聊聊进程中的信号处理</div></div></a></div><div><a href=/posts/2021/02/13/a-simple-introduction-about-the-init-process-in-container/ title=简单聊聊容器中的一号进程><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/04/07/50/daisy-7766609_1280.jpg alt=cover><div class="content is-center"><div class=date><i class="far fa-calendar-alt fa-fw"></i> 2021-02-13</div><div class=title>简单聊聊容器中的一号进程</div></div></a></div><div><a href=/posts/2021/12/03/a-simple-introduction-about-uid-docker/ title="简单聊聊容器中的 UID 中的一点小坑"><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/04/07/50/flower-7766608_1280.jpg alt=cover><div class="content is-center"><div class=date><i class="far fa-calendar-alt fa-fw"></i> 2021-12-03</div><div class=title>简单聊聊容器中的 UID 中的一点小坑</div></div></a></div></div></div><hr><div id=post-comment><div class=comment-head><div class=comment-headline><i class="fas fa-comments fa-fw"></i><span> Comment</span></div></div><div class=comment-wrap><div><div id=disqus_thread></div></div></div></div></div><div class=aside-content id=aside-content><div class="card-widget card-info"><div class=is-center><div class=avatar-img><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://avatars.githubusercontent.com/u/7054676?v=4" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt=avatar></div><div class=author-info__name>Manjusaka</div><div class=author-info__description>热忱之心不可磨灭</div></div><div class="card-info-data site-data is-center"><a href=/archives/ ><div class=headline>Articles</div><div class=length-num>74</div></a><a href=/tags/ ><div class=headline>Tags</div><div class=length-num>51</div></a><a href=/categories/ ><div class=headline>Categories</div><div class=length-num>32</div></a></div><a id=card-info-btn target=_blank rel="noopener external nofollow noreferrer" href=https://github.com/youngjuning><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class=social-icon href=https://github.com/ZheaoLi rel="external nofollow noreferrer" target=_blank title=Github><i class="fab fa-github"></i></a><a class=social-icon href=mailto:me@manjusaka.me rel="external nofollow noreferrer" target=_blank title=Email><i class="fas fa-envelope"></i></a><a class=social-icon href=https://twitter.com/Manjusaka_Lee rel="external nofollow noreferrer" target=_blank title=推特><i class="fab fa-twitter"></i></a></div></div><div class="card-widget card-announcement"><div class=item-headline><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class=announcement_content>This is my Blog</div></div><div class=sticky_layout><div class=card-widget id=card-toc><div class=item-headline><i class="fas fa-stream"></i><span>Catalog</span><span class=toc-percentage></span></div><div class="toc-content is-expand"><ol class=toc><li class="toc-item toc-level-2"><a class=toc-link href=#%E8%83%8C%E6%99%AF><span class=toc-number>1.</span> <span class=toc-text>背景</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E5%88%86%E6%9E%90><span class=toc-number>2.</span> <span class=toc-text>分析</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E6%80%BB%E7%BB%93><span class=toc-number>3.</span> <span class=toc-text>总结</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class=item-headline><i class="fas fa-history"></i><span>Recent Post</span></div><div class=aside-list><div class=aside-list-item><a class=thumbnail href=/posts/2023/06/19/why-do-I-love-ultraman/ title=为什么奥特曼是我的信仰><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://user-images.githubusercontent.com/7054676/228287041-c86e7928-0da8-4097-b7ff-e575faa8cf8c.png onerror='this.onerror=null,this.src="/img/404.jpg"' alt=为什么奥特曼是我的信仰></a><div class=content><a class=title href=/posts/2023/06/19/why-do-I-love-ultraman/ title=为什么奥特曼是我的信仰>为什么奥特曼是我的信仰</a><time datetime=2023-06-19T20:00:00.000Z title="Created 2023-06-20 04:00:00">2023-06-20</time></div></div><div class=aside-list-item><a class=thumbnail href=/posts/2023/06/16/how-do-I-build-homelab/ title="家庭 Homelab 升级计划"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/04/07/50/flower-7766608_1280.jpg onerror='this.onerror=null,this.src="/img/404.jpg"' alt="家庭 Homelab 升级计划"></a><div class=content><a class=title href=/posts/2023/06/16/how-do-I-build-homelab/ title="家庭 Homelab 升级计划">家庭 Homelab 升级计划</a><time datetime=2023-06-16T16:00:00.000Z title="Created 2023-06-17 00:00:00">2023-06-17</time></div></div><div class=aside-list-item><a class=thumbnail href=/posts/2023/03/12/a-simple-introduction-about-iac/ title="简单聊聊 IaC：Infrastructure as Code"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/01/14/19/50/flower-7718952_1280.jpg onerror='this.onerror=null,this.src="/img/404.jpg"' alt="简单聊聊 IaC：Infrastructure as Code"></a><div class=content><a class=title href=/posts/2023/03/12/a-simple-introduction-about-iac/ title="简单聊聊 IaC：Infrastructure as Code">简单聊聊 IaC：Infrastructure as Code</a><time datetime=2023-03-12T13:00:00.000Z title="Created 2023-03-12 21:00:00">2023-03-12</time></div></div><div class=aside-list-item><a class=thumbnail href=/posts/2023/01/26/what-I-can-learn-from-a-refactor-project/ title=从一个重构项目中能学到什么东西><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/04/07/50/daisy-7766609_1280.jpg onerror='this.onerror=null,this.src="/img/404.jpg"' alt=从一个重构项目中能学到什么东西></a><div class=content><a class=title href=/posts/2023/01/26/what-I-can-learn-from-a-refactor-project/ title=从一个重构项目中能学到什么东西>从一个重构项目中能学到什么东西</a><time datetime=2023-01-26T16:00:00.000Z title="Created 2023-01-27 00:00:00">2023-01-27</time></div></div><div class=aside-list-item><a class=thumbnail href=/posts/2023/01/19/simple-brief-about-blue-lotus-group/ title=蓝莲花公益小组简报><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/04/07/50/flower-7766608_1280.jpg onerror='this.onerror=null,this.src="/img/404.jpg"' alt=蓝莲花公益小组简报></a><div class=content><a class=title href=/posts/2023/01/19/simple-brief-about-blue-lotus-group/ title=蓝莲花公益小组简报>蓝莲花公益小组简报</a><time datetime=2023-01-19T11:00:00.000Z title="Created 2023-01-19 19:00:00">2023-01-19</time></div></div></div></div><div class="card-widget ads-wrap"><ins class=adsbygoogle style=display:block data-ad-client=ca-pub-7962287588031867 data-ad-slot=1257383027 data-ad-format=auto data-full-width-responsive=true></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div></div></div></main><footer id=footer style="background:0 0"></footer></div><div id=rightside><div id=rightside-config-hide><button id=readmode type=button title="Read Mode"><i class="fas fa-book-open"></i></button><button id=translateLink type=button title="Switch Between Traditional Chinese And Simplified Chinese">繁</button><button id=darkmode type=button title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id=hide-aside-btn type=button title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id=rightside-config-show><button id=rightside_config type=button title=Setting><i class="fas fa-cog fa-spin"></i></button><button class=close id=mobile-toc-button type=button title="Table Of Contents"><i class="fas fa-list-ul"></i></button><a id=to_comment href=#post-comment title="Scroll To Comments"><i class="fas fa-comments"></i></a><button id=go-up type=button title="Back To Top"><span class=scroll-percent></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src=https://manjusaka.blog/js/utils.js></script><script src=https://www.manjusaka.blog/js/main.js></script><script src=https://manjusaka.blog/js/tw_cn.js></script><script src=https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js></script><script src=https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js></script><script src=https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js></script><script>function panguFn(){"object"==typeof pangu?pangu.autoSpacingPage():getScript("https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js").then(()=>{pangu.autoSpacingPage()})}function panguInit(){panguFn()}document.addEventListener("DOMContentLoaded",panguInit)</script><div class=js-pjax><script>(()=>{const e=document.querySelectorAll("#article-container .mermaid-wrap");var t;e.length&&(window.runMermaid=()=>{window.loadMermaid=!0;const n="dark"===document.documentElement.getAttribute("data-theme")?"dark":"default";Array.from(e).forEach((e,t)=>{const d=e.firstElementChild;e="%%{init:{ 'theme':'"+n+"'}}%%\n"+d.textContent;mermaid.mermaidAPI.render("mermaid-"+t,e,e=>{d.insertAdjacentHTML("afterend",e)})})},t=()=>{window.loadMermaid?runMermaid():getScript("https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js").then(runMermaid)},window.pjax?t():document.addEventListener("DOMContentLoaded",t))})()</script><script>function loadDisqus(){function e(){this.page.url="https://manjusaka.blog/posts/2021/08/24/a-little-problem-about-posix-node-js-execsync/",this.page.identifier="/posts/2021/08/24/a-little-problem-about-posix-node-js-execsync/",this.page.title="关于 Node.js 中 execSync 的一点问题"}var t,s;window.disqusReset=()=>{DISQUS.reset({reload:!0,config:e})},window.DISQUS?disqusReset():(t=document,(s=t.createElement("script")).src="https://manjusakablog.disqus.com/embed.js",s.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(s)),document.getElementById("darkmode").addEventListener("click",()=>{setTimeout(()=>window.disqusReset(),200)})}function loadOtherComment(){loadDisqus()}loadDisqus()</script></div><canvas class=fireworks mobile=false></canvas><script src=https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js></script><script defer=defer id=fluttering_ribbon mobile=false src=https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js></script><script src=https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!0,POWERMODE.mobile=!1,document.body.addEventListener("input",POWERMODE)</script><script async data-pjax src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script></div><div id=local-search><div class=search-dialog><nav class=search-nav><span class=search-dialog-title>Search</span><span id=loading-status></span><button class=search-close-button><i class="fas fa-times"></i></button></nav><div class=is-center id=loading-database><i class="fas fa-spinner fa-pulse"></i><span> Loading the Database</span></div><div class=search-wrap><div id=local-search-input><div class=local-search-box><input class=local-search-box--input placeholder="Search for Posts" type=text></div></div><hr><div id=local-search-results></div></div></div><div id=search-mask></div><script src=https://manjusaka.blog/js/search/local-search.js></script></div><script data-pjax>function butterfly_swiper_injector_config(){var i=document.getElementById("recent-posts");console.log("已挂载butterfly_swiper"),i.insertAdjacentHTML("afterbegin",'<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="/posts/2023/06/19/why-do-I-love-ultraman/" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://user-images.githubusercontent.com/7054676/228287041-c86e7928-0da8-4097-b7ff-e575faa8cf8c.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-06-19</span><a class="blog-slider__title" href="/posts/2023/06/19/why-do-I-love-ultraman/" alt="">为什么奥特曼是我的信仰</a><div class="blog-slider__text">優しさを失わないでくれ。弱い者を労り互いに助け合い。</div><a class="blog-slider__button" href="/posts/2023/06/19/why-do-I-love-ultraman/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="/posts/2023/06/16/how-do-I-build-homelab/" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.pixabay.com/photo/2023/02/04/07/50/flower-7766608_1280.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-06-16</span><a class="blog-slider__title" href="/posts/2023/06/16/how-do-I-build-homelab/" alt="">家庭 Homelab 升级计划</a><div class="blog-slider__text">人生嘛，Homelab 图个乐子</div><a class="blog-slider__button" href="/posts/2023/06/16/how-do-I-build-homelab/" alt="">详情   </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>')}for(var elist="undefined".split(","),cpage=location.pathname,epage="all",flag=0,i=0;i<elist.length;i++)cpage.includes(elist[i])&&flag++;("all"===epage&&0==flag||epage===cpage)&&butterfly_swiper_injector_config()</script><script defer=defer src=https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.js></script><script defer=defer data-pjax src=https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper_init.js></script><script async src=//at.alicdn.com/t/font_2032782_8d5kxvn09md.js></script><script src=/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05></script><script>L2Dwidget.init({log:!1,pluginJsPath:"lib/",pluginModelPath:"assets/",pluginRootPath:"live2dw/",tagMode:!1})</script></body></html>