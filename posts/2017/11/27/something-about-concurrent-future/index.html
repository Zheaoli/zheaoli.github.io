<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Python concurrent.future 使用教程及源码初剖 - Manjusaka</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Manjusaka"><meta name="msapplication-TileImage" content="https://user-images.githubusercontent.com/7054676/56820343-2fe1b580-687e-11e9-8f6f-778df3a8eafd.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Manjusaka"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="垃圾话很久没写博客了，想了想不能再划水，于是给自己定了一个目标，写点 concurrent.future 的内容，于是这篇文章就是来聊聊 Python 3.2 中新增的 concurrent.future 模块。"><meta property="og:type" content="blog"><meta property="og:title" content="Python concurrent.future 使用教程及源码初剖"><meta property="og:url" content="http://manjusaka.itscoder.com/posts/2017/11/27/something-about-concurrent-future/"><meta property="og:site_name" content="Manjusaka"><meta property="og:description" content="垃圾话很久没写博客了，想了想不能再划水，于是给自己定了一个目标，写点 concurrent.future 的内容，于是这篇文章就是来聊聊 Python 3.2 中新增的 concurrent.future 模块。"><meta property="og:locale" content="en_US"><meta property="og:image" content="http://manjusaka.itscoder.com/img/og_image.png"><meta property="article:published_time" content="2017-11-27T16:09:54.000Z"><meta property="article:modified_time" content="2022-02-05T07:39:46.258Z"><meta property="article:author" content="Manjusaka"><meta property="article:tag" content="Python"><meta property="article:tag" content="编程"><meta property="article:tag" content="编程技巧"><meta property="article:tag" content="并发编程"><meta property="article:tag" content="源码剖析"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://manjusaka.itscoder.com/posts/2017/11/27/something-about-concurrent-future/"},"headline":"Python concurrent.future 使用教程及源码初剖","image":["http://manjusaka.itscoder.com/img/og_image.png"],"datePublished":"2017-11-27T16:09:54.000Z","dateModified":"2022-02-05T07:39:46.258Z","author":{"@type":"Person","name":"Manjusaka"},"publisher":{"@type":"Organization","name":"Manjusaka","logo":{"@type":"ImageObject","url":"https://user-images.githubusercontent.com/7054676/56820277-0a54ac00-687e-11e9-9f34-f79089938638.png"}},"description":"垃圾话很久没写博客了，想了想不能再划水，于是给自己定了一个目标，写点 concurrent.future 的内容，于是这篇文章就是来聊聊 Python 3.2 中新增的 concurrent.future 模块。"}</script><link rel="canonical" href="http://manjusaka.itscoder.com/posts/2017/11/27/something-about-concurrent-future/"><link rel="icon" href="https://user-images.githubusercontent.com/7054676/56820343-2fe1b580-687e-11e9-8f6f-778df3a8eafd.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/monokai.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?56ca085ae4b8a4667f041cdd04856321";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=UA-154407994-1" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'UA-154407994-1');</script><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!-- hexo injector head_end start -->
        <script>
            function switchTab(element) {
                const id = element.parentElement.id;
                const tabElements = element.parentElement.parentElement.children;
                const contentElements = element.parentElement.parentElement.parentElement.parentElement.children[1].children;
                for (let i = 0; i < tabElements.length; i++) {
                    const $tab = tabElements[i];
                    const $content = contentElements[i];
                    if ($tab.id === id) {
                        $tab.classList.add('is-active');
                    } else {
                        $tab.classList.remove('is-active');
                    }
                    if ($content.id === id) {
                        $content.classList.remove('is-hidden');
                    } else {
                        $content.classList.add('is-hidden');
                    }
                }
            }
        </script>
        <!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="/atom.xml" title="Manjusaka" type="application/atom+xml">
</head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="https://user-images.githubusercontent.com/7054676/56820277-0a54ac00-687e-11e9-9f34-f79089938638.png" alt="Manjusaka" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/.">主页</a><a class="navbar-item" href="/archives">文章</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/atom.xml">订阅</a><a class="navbar-item" href="/resume">我的简历</a><a class="navbar-item" href="/about">关于我</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/Zheaoli"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2017-11-27T16:09:54.000Z" title="11/27/2017, 4:09:54 PM">2017-11-28</time></span><span class="level-item">Updated&nbsp;<time dateTime="2022-02-05T07:39:46.258Z" title="2/5/2022, 7:39:46 AM">2022-02-05</time></span><span class="level-item"><a class="link-muted" href="/categories/%E7%BC%96%E7%A8%8B/">编程</a><span> / </span><a class="link-muted" href="/categories/%E7%BC%96%E7%A8%8B/Python/">Python</a></span><span class="level-item">44 minutes read (About 6672 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">Python concurrent.future 使用教程及源码初剖</h1><div class="content"><h1 id="垃圾话"><a href="#垃圾话" class="headerlink" title="垃圾话"></a>垃圾话</h1><p>很久没写博客了，想了想不能再划水，于是给自己定了一个目标，写点 <strong>concurrent.future</strong> 的内容，于是这篇文章就是来聊聊 Python 3.2 中新增的 <strong>concurrent.future</strong> 模块。</p>
<span id="more"></span>

<h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><h2 id="Python-的异步处理"><a href="#Python-的异步处理" class="headerlink" title="Python 的异步处理"></a>Python 的异步处理</h2><p>有一个 Python 开发工程师小明，在面试过程中，突然接到这样一个需求：去请求几个网站，拿到他们的数据，小明定睛一想，简单啊，噼里啪啦，他写了如下的代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> multiprocessing</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">request_url</span>(<span class="params">query_url: <span class="built_in">str</span></span>):</span><br><span class="line">    time.sleep(<span class="number">3</span>)  <span class="comment"># 请求处理逻辑</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    url_list = [<span class="string">&quot;abc.com&quot;</span>, <span class="string">&quot;xyz.com&quot;</span>]</span><br><span class="line">    task_list = [multiprocessing.Process(target=request_url, args=(url,)) <span class="keyword">for</span> url <span class="keyword">in</span> url_list]</span><br><span class="line">    [task.start() <span class="keyword">for</span> task <span class="keyword">in</span> task_list]</span><br><span class="line">    [task.join() <span class="keyword">for</span> task <span class="keyword">in</span> task_list]</span><br></pre></td></tr></table></figure>

<p>Easy, 好了，现在新的需求来了，我们想获取每一个请求结果，怎么办?小明想了想，又写出如下的代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> multiprocessing</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">request_url</span>(<span class="params">query_url: <span class="built_in">str</span>, result_dict: <span class="built_in">dict</span></span>):</span><br><span class="line">    time.sleep(<span class="number">3</span>)  <span class="comment"># 请求处理逻辑</span></span><br><span class="line">    result_dict[query_url] = &#123;&#125;  <span class="comment"># 返回结果</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    process_manager = multiprocessing.Manager()</span><br><span class="line">    result_dict = process_manager.<span class="built_in">dict</span>()</span><br><span class="line">    url_list = [<span class="string">&quot;abc.com&quot;</span>, <span class="string">&quot;xyz.com&quot;</span>]</span><br><span class="line">    task_list = [multiprocessing.Process(target=request_url, args=(url, result_dict)) <span class="keyword">for</span> url <span class="keyword">in</span> url_list]</span><br><span class="line">    [task.start() <span class="keyword">for</span> task <span class="keyword">in</span> task_list]</span><br><span class="line">    [task.join() <span class="keyword">for</span> task <span class="keyword">in</span> task_list]</span><br><span class="line">    <span class="built_in">print</span>(result_dict)</span><br></pre></td></tr></table></figure>

<p>好了，面试官说，恩看起来不错，好了，我再改改题目，首先，我们不能阻塞主进程，主进程需要根据任务当前的状态（结束/未结束）来及时的获取对应的结果，怎么改？，小明想了想，要不，我们直接用信号量，让任务完成后，向父进程发送一个信号量？然后直接暴力出奇迹？还有更简单的方法么？貌似没了？最后面试官心理说了一句 naive ，脸上笑而不语，让小明回去慢慢等消息。</p>
<p>从小明的窘境，我们可以看出一个这样的问题，就是我们最常用的 <code>multiprocessing</code> 或者是 <code>threding</code> 两个模块，对于我们想实现异步任务的场景来说，其实略有一点不友好的，我们往往需要做一些额外的工作，才能比较干净的实现一些异步的需求。为了解决这样的窘境，09 年 10 月，Brian Quinlan 先生提出了 <a target="_blank" rel="noopener" href="https://www.python.org/dev/peps/pep-3148/">PEP 3148</a> ，在这个提案中，他提出将我们常用的 <code>multiprocessing</code> 和 <code>threding</code> 模块进行进一步封装，达成较好的支持异步操作的目的。最终这个提案在 Python 3.2 中被引入。也就是我们今天要聊聊的 <strong>concurrent.future</strong> 。</p>
<h2 id="Future-模式"><a href="#Future-模式" class="headerlink" title="Future 模式"></a>Future 模式</h2><p>在我们正式开始聊新模块之前，我们需要去了解关于 <code>Future</code> 模式的相关姿势</p>
<p>首先 <code>Future</code> 模式，是什么？</p>
<p><code>Future</code> 其实是<strong>生产-消费者</strong>模型的一种扩展，在<strong>生产-消费者</strong>模型中，生产者不关心消费者什么时候处理完数据，也不关心消费者处理的结果。比如我们经常写出如下的代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> multiprocessing, Queue</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randint</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Producer</span>(multiprocessing.Process):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, queue</span>):</span><br><span class="line">        multiprocessing.Process.__init__(self)</span><br><span class="line">        self.queue = queue</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            self.queue.put(<span class="string">&#x27;one product&#x27;</span>)</span><br><span class="line">            <span class="built_in">print</span>(multiprocessing.current_process().name + <span class="built_in">str</span>(os.getpid()) + <span class="string">&#x27; produced one product, the no of queue now is: %d&#x27;</span> %self.queue.qsize())</span><br><span class="line">            sleep(randint(<span class="number">1</span>, <span class="number">3</span>))</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Consumer</span>(multiprocessing.Process):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, queue</span>):</span><br><span class="line">        multiprocessing.Process.__init__(self)</span><br><span class="line">        self.queue = queue</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            d = self.queue.get(<span class="number">1</span>)</span><br><span class="line">            <span class="keyword">if</span> d != <span class="literal">None</span>:</span><br><span class="line">                <span class="built_in">print</span>(multiprocessing.current_process().name + <span class="built_in">str</span>(os.getpid()) + <span class="string">&#x27; consumed  %s, the no of queue now is: %d&#x27;</span> %(d,self.queue.qsize()))</span><br><span class="line">                sleep(randint(<span class="number">1</span>, <span class="number">4</span>))</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">                </span><br><span class="line"><span class="comment">#create queue</span></span><br><span class="line">queue = multiprocessing.Queue(<span class="number">40</span>)</span><br><span class="line">       </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Excited!&quot;)</span></span><br><span class="line"><span class="string">    #create processes    </span></span><br><span class="line"><span class="string">    processed = []</span></span><br><span class="line"><span class="string">    for i in range(3):</span></span><br><span class="line"><span class="string">        processed.append(Producer(queue))</span></span><br><span class="line"><span class="string">        processed.append(Consumer(queue))</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">    #start processes        </span></span><br><span class="line"><span class="string">    for i in range(len(processed)):</span></span><br><span class="line"><span class="string">        processed[i].start()</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    #join processes    </span></span><br><span class="line"><span class="string">    for i in range(len(processed)):</span></span><br><span class="line"><span class="string">        processed[i].join()  </span></span><br></pre></td></tr></table></figure>

<p>这就是<strong>生产-消费者</strong>模型的一个简单的实现，我们利用一个 <code>multiprocessing</code> 中的 <code>Queue</code> 来作为通信渠道，我们的生产者负责往队列中传入数据，消费者负责从队列中获取数据并处理。不过就如同上面所说的一样，在这种模式中，生产者并不关心消费者何时处理完数据，也不关心处理的结果。而在 <code>Future</code> 中，我们可以让生产者等待消息处理完成，如果需要的话，我们还可以获取相关的计算结果。</p>
<p>比如，大家可以看看下面这样一段 Java 代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> concurrent;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Callable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataProcessThread</span> <span class="keyword">implements</span> <span class="title class_">Callable</span>&lt;String&gt; &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		Thread.sleep(<span class="number">10000</span>);<span class="comment">//模拟数据处理</span></span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;数据返回&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这是我们负责处理数据的代码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> concurrent;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutionException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.FutureTask;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainThread</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException,</span><br><span class="line">			ExecutionException &#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		<span class="type">DataProcessThread</span> <span class="variable">dataProcessThread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataProcessThread</span>();</span><br><span class="line">		FutureTask&lt;String&gt; future = <span class="keyword">new</span> <span class="title class_">FutureTask</span>&lt;String&gt;(dataProcessThread);</span><br><span class="line"></span><br><span class="line">		<span class="type">ExecutorService</span> <span class="variable">executor</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">1</span>);</span><br><span class="line">		executor.submit(future);</span><br><span class="line"></span><br><span class="line">		Thread.sleep(<span class="number">10000</span>);<span class="comment">//模拟继续处理自身其他业务</span></span><br><span class="line">		<span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span> (future.isDone()) &#123;</span><br><span class="line">				System.out.println(future.get());</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		executor.shutdown();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这是我们主线程，大家可以看到，我们可以很方便的获取数据处理任务的状态。同时获取相关的结果。</p>
<h2 id="Python-中的-concurrent-futures"><a href="#Python-中的-concurrent-futures" class="headerlink" title="Python 中的 concurrent.futures"></a>Python 中的 concurrent.futures</h2><p>前面说了，在 Python 3.2 以后，<strong>concurrent.futures</strong>　是内置的模块，我们可以直接使用</p>
<blockquote>
<p><strong>Note</strong>: 如果你需要在 Python 2.7 中使用 <strong>concurrent.futures</strong> , 那么请用 pip 进行安装，<code>pip install futures</code> </p>
</blockquote>
<p>好了，准备就绪后，我们来看看怎么使用这个东西呢</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ProcessPoolExecutor</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">return_future_result</span>(<span class="params">message</span>):</span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span> message</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    pool = ProcessPoolExecutor(max_workers=<span class="number">2</span>)  <span class="comment"># 创建一个最大可容纳2个task的进程池</span></span><br><span class="line">    future1 = pool.submit(return_future_result, (<span class="string">&quot;hello&quot;</span>))  <span class="comment"># 往进程池里面加入一个task</span></span><br><span class="line">    future2 = pool.submit(return_future_result, (<span class="string">&quot;world&quot;</span>))  <span class="comment"># 往进程池里面加入一个task</span></span><br><span class="line">    <span class="built_in">print</span>(future1.done())  <span class="comment"># 判断task1是否结束</span></span><br><span class="line">    time.sleep(<span class="number">3</span>)</span><br><span class="line">    <span class="built_in">print</span>(future2.done())  <span class="comment"># 判断task2是否结束</span></span><br><span class="line">    <span class="built_in">print</span>(future1.result())  <span class="comment"># 查看task1返回的结果</span></span><br><span class="line">    <span class="built_in">print</span>(future2.result())  <span class="comment"># 查看task2返回的结果</span></span><br></pre></td></tr></table></figure>

<p>首先 <code>from concurrent.futures import ProcessPoolExecutor</code> 从 <code>concurrent.futures</code> 引入 <code>ProcessPoolExecutor</code> 作为我们的进程池，处理我们后面的数据。(在 <code>concurrent.futures</code> 中，为我们提供了两种 <code>Executor</code> ，一种是我们现在用的 <code>ProcessPoolExecutor</code>, 一种是 <code>ThreadPoolExecutor</code> 他们对外暴露的方法一致，大家可以根据自己的实际需求选用。)</p>
<p>紧接着，初始化一个最大容量为 2 的进程池。然后我们调用进程池中的 <code>submit</code> 方法提交一个任务。好了有意思的点来了，我们在调用 <code>submit</code> 方法后，得到了一个特殊的变量，这个变量是 <code>Future</code> 类的实例，代表着一个在未来完成的操作。换句话说，当 <code>submit</code> 返回 <code>Future</code> 实例的时候，我们的任务可能还没有完成，我们可以通过调用 <code>Future</code> 实例中的 <code>done</code> 方法来获取当前任务的运行状态，如果任务结束后，我们可以通过 <code>result</code> 方法来获取返回的结果。如果在执行后续的逻辑时，我们因为一些原因想要取消任务时，我们可以通过调用 <code>cancel</code> 方法来取消当前的任务。</p>
<p>现在新的问题来了，我们如果想要提交很多个任务应该怎么办呢？<code>concurrent.future</code> 为我们提供了 <code>map</code> 方法来方便我们批量添加任务。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> concurrent.futures</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">task_url = [(<span class="string">&#x27;http://www.baidu.com&#x27;</span>, <span class="number">40</span>), (<span class="string">&#x27;http://example.com/&#x27;</span>, <span class="number">40</span>), (<span class="string">&#x27;https://www.github.com/&#x27;</span>, <span class="number">40</span>)]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_url</span>(<span class="params">params: <span class="built_in">tuple</span></span>):</span><br><span class="line">    <span class="keyword">return</span> requests.get(params[<span class="number">0</span>], timeout=params[<span class="number">1</span>]).text</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">with</span> concurrent.futures.ProcessPoolExecutor(max_workers=<span class="number">3</span>) <span class="keyword">as</span> executor:</span><br><span class="line">        <span class="keyword">for</span> url, data <span class="keyword">in</span> <span class="built_in">zip</span>(task_url, executor.<span class="built_in">map</span>(load_url, task_url)):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;%r page is %d bytes&#x27;</span> % (url, <span class="built_in">len</span>(data)))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>恩，<code>concurrent.future</code> 中线程/进程池所提供的 <code>map</code> 方法和标准库中的 <code>map</code> 函数使用方法一样。</p>
<h2 id="剖一下-concurrent-futures"><a href="#剖一下-concurrent-futures" class="headerlink" title="剖一下 concurrent.futures"></a>剖一下 concurrent.futures</h2><p>前面讲了怎么使用 <code>concurrent.futures</code> 后，我们都比较好奇，<code>concurrent.futures</code> 是怎么实现 <code>Future</code> 模式的。里面是怎么将任务和结果进行关联的。我们现在开始从 <code>submit</code> 方法着手来简单看一下 <code>ProcessPoolExecutor</code> 的实现。</p>
<p>首先，在初始化 <code>ProcessPoolExecutor</code> 时，它的 <code>__init__</code> 方法中进行了一些关键变量的初始化操作。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ProcessPoolExecutor</span>(_base.Executor):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, max_workers=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Initializes a new ProcessPoolExecutor instance.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            max_workers: The maximum number of processes that can be used to</span></span><br><span class="line"><span class="string">                execute the given calls. If None or not given then as many</span></span><br><span class="line"><span class="string">                worker processes will be created as the machine has processors.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        _check_system_limits()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> max_workers <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            self._max_workers = os.cpu_count() <span class="keyword">or</span> <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> max_workers &lt;= <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">&quot;max_workers must be greater than 0&quot;</span>)</span><br><span class="line"></span><br><span class="line">            self._max_workers = max_workers</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Make the call queue slightly larger than the number of processes to</span></span><br><span class="line">        <span class="comment"># prevent the worker processes from idling. But don&#x27;t make it too big</span></span><br><span class="line">        <span class="comment"># because futures in the call queue cannot be cancelled.</span></span><br><span class="line">        self._call_queue = multiprocessing.Queue(self._max_workers +</span><br><span class="line">                                                 EXTRA_QUEUED_CALLS)</span><br><span class="line">        <span class="comment"># Killed worker processes can produce spurious &quot;broken pipe&quot;</span></span><br><span class="line">        <span class="comment"># tracebacks in the queue&#x27;s own worker thread. But we detect killed</span></span><br><span class="line">        <span class="comment"># processes anyway, so silence the tracebacks.</span></span><br><span class="line">        self._call_queue._ignore_epipe = <span class="literal">True</span></span><br><span class="line">        self._result_queue = SimpleQueue()</span><br><span class="line">        self._work_ids = queue.Queue()</span><br><span class="line">        self._queue_management_thread = <span class="literal">None</span></span><br><span class="line">        <span class="comment"># Map of pids to processes</span></span><br><span class="line">        self._processes = &#123;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Shutdown is a two-step process.</span></span><br><span class="line">        self._shutdown_thread = <span class="literal">False</span></span><br><span class="line">        self._shutdown_lock = threading.Lock()</span><br><span class="line">        self._broken = <span class="literal">False</span></span><br><span class="line">        self._queue_count = <span class="number">0</span></span><br><span class="line">        self._pending_work_items = &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>好了，我们来看看我们今天的入口 <code>submit</code> 方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">submit</span>(<span class="params">self, fn, *args, **kwargs</span>):</span><br><span class="line">    <span class="keyword">with</span> self._shutdown_lock:</span><br><span class="line">        <span class="keyword">if</span> self._broken:</span><br><span class="line">            <span class="keyword">raise</span> BrokenProcessPool(<span class="string">&#x27;A child process terminated &#x27;</span></span><br><span class="line">                <span class="string">&#x27;abruptly, the process pool is not usable anymore&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> self._shutdown_thread:</span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">&#x27;cannot schedule new futures after shutdown&#x27;</span>)</span><br><span class="line">        f = _base.Future()</span><br><span class="line">        w = _WorkItem(f, fn, args, kwargs)</span><br><span class="line">        self._pending_work_items[self._queue_count] = w</span><br><span class="line">        self._work_ids.put(self._queue_count)</span><br><span class="line">        self._queue_count += <span class="number">1</span></span><br><span class="line">        <span class="comment"># Wake up queue management thread</span></span><br><span class="line">        self._result_queue.put(<span class="literal">None</span>)</span><br><span class="line">        self._start_queue_management_thread()</span><br><span class="line">        <span class="keyword">return</span> f</span><br></pre></td></tr></table></figure>

<p>首先，传入的参数 <code>fn</code> 是我们的处理函数，<code>args</code> 以及 <code>kwargs</code> 是我们要传递 <code>fn</code> 函数的参数。在 <code>submit</code> 函数最开始，首先根据 <code>_broken</code> 和 <code>_shutdown_thread</code> 的值来判断当前进程池中处理进程的状态以及目前进程池的状态。如果处理进程突然被销毁或者进程池已经被关闭，那么将抛出异常表明目前不再接受新的 <code>submit</code> 操作。</p>
<p>如果前面状态没有问题，首先，实例化 <code>Future</code> 类，然后将这个实例和处理函数和相关参数一起，作为参数来实例化 <code>_WorkItem</code> 类，然后将实例 w 作为 value ，<code>_queue_count</code> 作为 key 存入 <code>_pending_work_items</code> 中。然后调用 <code>_start_queue_management_thread</code> 方法开启进程池中的管理线程。现在来看看这部分代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_start_queue_management_thread</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="comment"># When the executor gets lost, the weakref callback will wake up</span></span><br><span class="line">    <span class="comment"># the queue management thread.</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">weakref_cb</span>(<span class="params">_, q=self._result_queue</span>):</span><br><span class="line">        q.put(<span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> self._queue_management_thread <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="comment"># Start the processes so that their sentinels are known.</span></span><br><span class="line">        self._adjust_process_count()</span><br><span class="line">        self._queue_management_thread = threading.Thread(</span><br><span class="line">            target=_queue_management_worker,</span><br><span class="line">            args=(weakref.ref(self, weakref_cb),</span><br><span class="line">                  self._processes,</span><br><span class="line">                  self._pending_work_items,</span><br><span class="line">                  self._work_ids,</span><br><span class="line">                  self._call_queue,</span><br><span class="line">                  self._result_queue))</span><br><span class="line">        self._queue_management_thread.daemon = <span class="literal">True</span></span><br><span class="line">        self._queue_management_thread.start()</span><br><span class="line">        _threads_queues[self._queue_management_thread] = self._result_queue</span><br></pre></td></tr></table></figure>

<p>这一部分很简单，首先运行 <code>_adjust_process_count</code> 方法，然后开启一个守护线程，运行 <code>_queue_management_worker</code> 方法。我们首先来看看 <code>_adjust_process_count</code> 方法。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">_adjust_process_count</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(self._processes), self._max_workers):</span><br><span class="line">        p = multiprocessing.Process(</span><br><span class="line">                target=_process_worker,</span><br><span class="line">                args=(self._call_queue,</span><br><span class="line">                      self._result_queue))</span><br><span class="line">        p.start()</span><br><span class="line">        self._processes[p.pid] = p</span><br></pre></td></tr></table></figure>

<p>根据在 <code>__init__</code> 方法中设定的 <code>_max_workers</code> 来开启对应数量的进程，在进程中运行 <code>_process_worker</code> 函数。</p>
<p>恩，顺藤摸瓜，我们先来看看 <code>_process_worker</code> 函数吧？</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_process_worker</span>(<span class="params">call_queue, result_queue</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Evaluates calls from call_queue and places the results in result_queue.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    This worker is run in a separate process.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        call_queue: A multiprocessing.Queue of _CallItems that will be read and</span></span><br><span class="line"><span class="string">            evaluated by the worker.</span></span><br><span class="line"><span class="string">        result_queue: A multiprocessing.Queue of _ResultItems that will written</span></span><br><span class="line"><span class="string">            to by the worker.</span></span><br><span class="line"><span class="string">        shutdown: A multiprocessing.Event that will be set as a signal to the</span></span><br><span class="line"><span class="string">            worker that it should exit when call_queue is empty.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        call_item = call_queue.get(block=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">if</span> call_item <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="comment"># Wake up queue management thread</span></span><br><span class="line">            result_queue.put(os.getpid())</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            r = call_item.fn(*call_item.args, **call_item.kwargs)</span><br><span class="line">        <span class="keyword">except</span> BaseException <span class="keyword">as</span> e:</span><br><span class="line">            exc = _ExceptionWithTraceback(e, e.__traceback__)</span><br><span class="line">            result_queue.put(_ResultItem(call_item.work_id, exception=exc))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            result_queue.put(_ResultItem(call_item.work_id,</span><br><span class="line">                                         result=r))</span><br></pre></td></tr></table></figure>

<p>首先，这里搞了一个死循环，紧接着，我们从 <code>call_queue</code> 队列中获取一个 <code>_WorkItem</code> 实例，然后如果获取的值为 <code>None</code> 的话，那么证明没有新的任务进来了，我们可以把当前进程的 <code>pid</code> 放入结果队列中。然后结束进程。</p>
<p>如果收到了任务，那么执行这个任务。不管是在执行过程中发生异常，亦或者是得到最终的结果，都将其封装为 <code>_ResultItem</code> 实例，并将其放入结果队列中。</p>
<p>好了，我们回到刚刚看了一半的 <code>_start_queue_management_thread</code> 函数，</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_start_queue_management_thread</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="comment"># When the executor gets lost, the weakref callback will wake up</span></span><br><span class="line">    <span class="comment"># the queue management thread.</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">weakref_cb</span>(<span class="params">_, q=self._result_queue</span>):</span><br><span class="line">        q.put(<span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> self._queue_management_thread <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="comment"># Start the processes so that their sentinels are known.</span></span><br><span class="line">        self._adjust_process_count()</span><br><span class="line">        self._queue_management_thread = threading.Thread(</span><br><span class="line">            target=_queue_management_worker,</span><br><span class="line">            args=(weakref.ref(self, weakref_cb),</span><br><span class="line">                  self._processes,</span><br><span class="line">                  self._pending_work_items,</span><br><span class="line">                  self._work_ids,</span><br><span class="line">                  self._call_queue,</span><br><span class="line">                  self._result_queue))</span><br><span class="line">        self._queue_management_thread.daemon = <span class="literal">True</span></span><br><span class="line">        self._queue_management_thread.start()</span><br><span class="line">        _threads_queues[self._queue_management_thread] = self._result_queue</span><br></pre></td></tr></table></figure>

<p>在执行完 <code>_adjust_process_count</code> 函数后，我们进程池中的 <code>_processes</code> 变量（它是一个 dict ）便关联了一些处理进程。然后我们开启一个后台守护线程，来执行 <code>_queue_management_worker</code> 函数，我们给它传了几个变量，首先 <code>_processes</code> 是我们的进程映射，<code>_pending_work_items</code> 中存放着我们待处理任务，还有 <code>_call_queue</code> 和 <code>_result_queue</code> 。好了还有一个参数大家可能不太理解，就是 <code>weakref.ref(self, weakref_cb)</code> 这货。</p>
<p>首先，Python 是一门具有垃圾回收机制的语言，有着 GC (Garbage Collection) 机制意味着我们在大多数时候，不太需要去关注内存的分配与回收。在 Python 中，什么时候对象会被回收是由其引用计数所决定的。当引用计数为 0 的时候，这个对象会被回收。在有一些情况下，我们对象因为交叉引用或者其余的一些原因，造成引用计数始终不为0，这意味着这个对象无法被回收。造成内存泄露<br>。因此区别于我们普通的引用，Python 中新增了一个引用机制叫做弱引用，弱引用的意义在于，某个变量持有一个对象，却不会增加这个对象的引用计数。因此 <code>weakref.ref(self, weakref_cb)</code> 在大多数而言，等价于 <code>self</code> （至于这里为什么要使用弱引用，我们这里先不讲，会开一个单章来说）</p>
<p>好了，这一部分代码看完，我们来看看，<code>_queue_management_worker</code> 怎么实现的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_queue_management_worker</span>(<span class="params">executor_reference,</span></span><br><span class="line"><span class="params">                             processes,</span></span><br><span class="line"><span class="params">                             pending_work_items,</span></span><br><span class="line"><span class="params">                             work_ids_queue,</span></span><br><span class="line"><span class="params">                             call_queue,</span></span><br><span class="line"><span class="params">                             result_queue</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Manages the communication between this process and the worker processes.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    This function is run in a local thread.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        executor_reference: A weakref.ref to the ProcessPoolExecutor that owns</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        process: A list of the multiprocessing.Process instances used as</span></span><br><span class="line"><span class="string">            this thread. Used to determine if the ProcessPoolExecutor has been</span></span><br><span class="line"><span class="string">            garbage collected and that this function can exit.</span></span><br><span class="line"><span class="string">            workers.</span></span><br><span class="line"><span class="string">        pending_work_items: A dict mapping work ids to _WorkItems e.g.</span></span><br><span class="line"><span class="string">            &#123;5: &lt;_WorkItem...&gt;, 6: &lt;_WorkItem...&gt;, ...&#125;</span></span><br><span class="line"><span class="string">        work_ids_queue: A queue.Queue of work ids e.g. Queue([5, 6, ...]).</span></span><br><span class="line"><span class="string">        call_queue: A multiprocessing.Queue that will be filled with _CallItems</span></span><br><span class="line"><span class="string">            derived from _WorkItems for processing by the process workers.</span></span><br><span class="line"><span class="string">        result_queue: A multiprocessing.Queue of _ResultItems generated by the</span></span><br><span class="line"><span class="string">            process workers.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    executor = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">shutting_down</span>():</span><br><span class="line">        <span class="keyword">return</span> _shutdown <span class="keyword">or</span> executor <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> executor._shutdown_thread</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">shutdown_worker</span>():</span><br><span class="line">        <span class="comment"># This is an upper bound</span></span><br><span class="line">        nb_children_alive = <span class="built_in">sum</span>(p.is_alive() <span class="keyword">for</span> p <span class="keyword">in</span> processes.values())</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, nb_children_alive):</span><br><span class="line">            call_queue.put_nowait(<span class="literal">None</span>)</span><br><span class="line">        <span class="comment"># Release the queue&#x27;s resources as soon as possible.</span></span><br><span class="line">        call_queue.close()</span><br><span class="line">        <span class="comment"># If .join() is not called on the created processes then</span></span><br><span class="line">        <span class="comment"># some multiprocessing.Queue methods may deadlock on Mac OS X.</span></span><br><span class="line">        <span class="keyword">for</span> p <span class="keyword">in</span> processes.values():</span><br><span class="line">            p.join()</span><br><span class="line"></span><br><span class="line">    reader = result_queue._reader</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        _add_call_item_to_queue(pending_work_items,</span><br><span class="line">                                work_ids_queue,</span><br><span class="line">                                call_queue)</span><br><span class="line"></span><br><span class="line">        sentinels = [p.sentinel <span class="keyword">for</span> p <span class="keyword">in</span> processes.values()]</span><br><span class="line">        <span class="keyword">assert</span> sentinels</span><br><span class="line">        ready = wait([reader] + sentinels)</span><br><span class="line">        <span class="keyword">if</span> reader <span class="keyword">in</span> ready:</span><br><span class="line">            result_item = reader.recv()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># Mark the process pool broken so that submits fail right now.</span></span><br><span class="line">            executor = executor_reference()</span><br><span class="line">            <span class="keyword">if</span> executor <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                executor._broken = <span class="literal">True</span></span><br><span class="line">                executor._shutdown_thread = <span class="literal">True</span></span><br><span class="line">                executor = <span class="literal">None</span></span><br><span class="line">            <span class="comment"># All futures in flight must be marked failed</span></span><br><span class="line">            <span class="keyword">for</span> work_id, work_item <span class="keyword">in</span> pending_work_items.items():</span><br><span class="line">                work_item.future.set_exception(</span><br><span class="line">                    BrokenProcessPool(</span><br><span class="line">                        <span class="string">&quot;A process in the process pool was &quot;</span></span><br><span class="line">                        <span class="string">&quot;terminated abruptly while the future was &quot;</span></span><br><span class="line">                        <span class="string">&quot;running or pending.&quot;</span></span><br><span class="line">                    ))</span><br><span class="line">                <span class="comment"># Delete references to object. See issue16284</span></span><br><span class="line">                <span class="keyword">del</span> work_item</span><br><span class="line">            pending_work_items.clear()</span><br><span class="line">            <span class="comment"># Terminate remaining workers forcibly: the queues or their</span></span><br><span class="line">            <span class="comment"># locks may be in a dirty state and block forever.</span></span><br><span class="line">            <span class="keyword">for</span> p <span class="keyword">in</span> processes.values():</span><br><span class="line">                p.terminate()</span><br><span class="line">            shutdown_worker()</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(result_item, <span class="built_in">int</span>):</span><br><span class="line">            <span class="comment"># Clean shutdown of a worker using its PID</span></span><br><span class="line">            <span class="comment"># (avoids marking the executor broken)</span></span><br><span class="line">            <span class="keyword">assert</span> shutting_down()</span><br><span class="line">            p = processes.pop(result_item)</span><br><span class="line">            p.join()</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> processes:</span><br><span class="line">                shutdown_worker()</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">elif</span> result_item <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            work_item = pending_work_items.pop(result_item.work_id, <span class="literal">None</span>)</span><br><span class="line">            <span class="comment"># work_item can be None if another process terminated (see above)</span></span><br><span class="line">            <span class="keyword">if</span> work_item <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="keyword">if</span> result_item.exception:</span><br><span class="line">                    work_item.future.set_exception(result_item.exception)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    work_item.future.set_result(result_item.result)</span><br><span class="line">                <span class="comment"># Delete references to object. See issue16284</span></span><br><span class="line">                <span class="keyword">del</span> work_item</span><br><span class="line">        <span class="comment"># Check whether we should start shutting down.</span></span><br><span class="line">        executor = executor_reference()</span><br><span class="line">        <span class="comment"># No more work items can be added if:</span></span><br><span class="line">        <span class="comment">#   - The interpreter is shutting down OR</span></span><br><span class="line">        <span class="comment">#   - The executor that owns this worker has been collected OR</span></span><br><span class="line">        <span class="comment">#   - The executor that owns this worker has been shutdown.</span></span><br><span class="line">        <span class="keyword">if</span> shutting_down():</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># Since no new work items can be added, it is safe to shutdown</span></span><br><span class="line">                <span class="comment"># this thread if there are no pending work items.</span></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> pending_work_items:</span><br><span class="line">                    shutdown_worker()</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">            <span class="keyword">except</span> Full:</span><br><span class="line">                <span class="comment"># This is not a problem: we will eventually be woken up (in</span></span><br><span class="line">                <span class="comment"># result_queue.get()) and be able to send a sentinel again.</span></span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">        executor = <span class="literal">None</span></span><br></pre></td></tr></table></figure>

<p>熟悉的大循环，循环的第一步，利用 <code>_add_call_item_to_queue</code> 函数来将等待队列中的任务加入到调用队列中去，先来看看这一部分代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">_add_call_item_to_queue</span>(<span class="params">pending_work_items,</span></span><br><span class="line"><span class="params">                            work_ids,</span></span><br><span class="line"><span class="params">                            call_queue</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Fills call_queue with _WorkItems from pending_work_items.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    This function never blocks.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        pending_work_items: A dict mapping work ids to _WorkItems e.g.</span></span><br><span class="line"><span class="string">            &#123;5: &lt;_WorkItem...&gt;, 6: &lt;_WorkItem...&gt;, ...&#125;</span></span><br><span class="line"><span class="string">        work_ids: A queue.Queue of work ids e.g. Queue([5, 6, ...]). Work ids</span></span><br><span class="line"><span class="string">            are consumed and the corresponding _WorkItems from</span></span><br><span class="line"><span class="string">            pending_work_items are transformed into _CallItems and put in</span></span><br><span class="line"><span class="string">            call_queue.</span></span><br><span class="line"><span class="string">        call_queue: A multiprocessing.Queue that will be filled with _CallItems</span></span><br><span class="line"><span class="string">            derived from _WorkItems.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">if</span> call_queue.full():</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            work_id = work_ids.get(block=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">except</span> queue.Empty:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            work_item = pending_work_items[work_id]</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> work_item.future.set_running_or_notify_cancel():</span><br><span class="line">                call_queue.put(_CallItem(work_id,</span><br><span class="line">                                         work_item.fn,</span><br><span class="line">                                         work_item.args,</span><br><span class="line">                                         work_item.kwargs),</span><br><span class="line">                               block=<span class="literal">True</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">del</span> pending_work_items[work_id]</span><br><span class="line">                <span class="keyword">continue</span></span><br></pre></td></tr></table></figure>

<p>首先，判断调用队列是不是已经满了，如果满了，则放弃这次循环。紧接着从 <code>work_id</code> 队列中取出，然后从等待任务中取出对应的 <code>_WorkItem</code> 实例。紧接着，调用实例中绑定的 <code>Future</code> 实例的 <code>set_running_or_notify_cancel</code> 方法来设置任务的状态，紧接着将其扔入调用队列中。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">set_running_or_notify_cancel</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Mark the future as running or process any cancel notifications.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Should only be used by Executor implementations and unit tests.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    If the future has been cancelled (cancel() was called and returned</span></span><br><span class="line"><span class="string">    True) then any threads waiting on the future completing (though calls</span></span><br><span class="line"><span class="string">    to as_completed() or wait()) are notified and False is returned.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    If the future was not cancelled then it is put in the running state</span></span><br><span class="line"><span class="string">    (future calls to running() will return True) and True is returned.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    This method should be called by Executor implementations before</span></span><br><span class="line"><span class="string">    executing the work associated with this future. If this method returns</span></span><br><span class="line"><span class="string">    False then the work should not be executed.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        False if the Future was cancelled, True otherwise.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Raises:</span></span><br><span class="line"><span class="string">        RuntimeError: if this method was already called or if set_result()</span></span><br><span class="line"><span class="string">            or set_exception() was called.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">with</span> self._condition:</span><br><span class="line">        <span class="keyword">if</span> self._state == CANCELLED:</span><br><span class="line">            self._state = CANCELLED_AND_NOTIFIED</span><br><span class="line">            <span class="keyword">for</span> waiter <span class="keyword">in</span> self._waiters:</span><br><span class="line">                waiter.add_cancelled(self)</span><br><span class="line">            <span class="comment"># self._condition.notify_all() is not necessary because</span></span><br><span class="line">            <span class="comment"># self.cancel() triggers a notification.</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">elif</span> self._state == PENDING:</span><br><span class="line">            self._state = RUNNING</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            LOGGER.critical(<span class="string">&#x27;Future %s in unexpected state: %s&#x27;</span>,</span><br><span class="line">                            <span class="built_in">id</span>(self),</span><br><span class="line">                            self._state)</span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">&#x27;Future in unexpected state&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>这一部分内容很简单，检查当前实例如果处于等待状态，就返回 True ，如果处于被取消的状态，就返回 False , 在 <code>_add_call_item_to_queue</code> 函数中，会将已经处于 <code>cancel</code> 状态的 <code>_WorkItem</code> 从等待任务中移除。</p>
<p>好了，我们继续回到 <code>_queue_management_worker</code> 函数中去，</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_queue_management_worker</span>(<span class="params">executor_reference,</span></span><br><span class="line"><span class="params">                             processes,</span></span><br><span class="line"><span class="params">                             pending_work_items,</span></span><br><span class="line"><span class="params">                             work_ids_queue,</span></span><br><span class="line"><span class="params">                             call_queue,</span></span><br><span class="line"><span class="params">                             result_queue</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Manages the communication between this process and the worker processes.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    This function is run in a local thread.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        executor_reference: A weakref.ref to the ProcessPoolExecutor that owns</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        process: A list of the multiprocessing.Process instances used as</span></span><br><span class="line"><span class="string">            this thread. Used to determine if the ProcessPoolExecutor has been</span></span><br><span class="line"><span class="string">            garbage collected and that this function can exit.</span></span><br><span class="line"><span class="string">            workers.</span></span><br><span class="line"><span class="string">        pending_work_items: A dict mapping work ids to _WorkItems e.g.</span></span><br><span class="line"><span class="string">            &#123;5: &lt;_WorkItem...&gt;, 6: &lt;_WorkItem...&gt;, ...&#125;</span></span><br><span class="line"><span class="string">        work_ids_queue: A queue.Queue of work ids e.g. Queue([5, 6, ...]).</span></span><br><span class="line"><span class="string">        call_queue: A multiprocessing.Queue that will be filled with _CallItems</span></span><br><span class="line"><span class="string">            derived from _WorkItems for processing by the process workers.</span></span><br><span class="line"><span class="string">        result_queue: A multiprocessing.Queue of _ResultItems generated by the</span></span><br><span class="line"><span class="string">            process workers.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    executor = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">shutting_down</span>():</span><br><span class="line">        <span class="keyword">return</span> _shutdown <span class="keyword">or</span> executor <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> executor._shutdown_thread</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">shutdown_worker</span>():</span><br><span class="line">        <span class="comment"># This is an upper bound</span></span><br><span class="line">        nb_children_alive = <span class="built_in">sum</span>(p.is_alive() <span class="keyword">for</span> p <span class="keyword">in</span> processes.values())</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, nb_children_alive):</span><br><span class="line">            call_queue.put_nowait(<span class="literal">None</span>)</span><br><span class="line">        <span class="comment"># Release the queue&#x27;s resources as soon as possible.</span></span><br><span class="line">        call_queue.close()</span><br><span class="line">        <span class="comment"># If .join() is not called on the created processes then</span></span><br><span class="line">        <span class="comment"># some multiprocessing.Queue methods may deadlock on Mac OS X.</span></span><br><span class="line">        <span class="keyword">for</span> p <span class="keyword">in</span> processes.values():</span><br><span class="line">            p.join()</span><br><span class="line"></span><br><span class="line">    reader = result_queue._reader</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        _add_call_item_to_queue(pending_work_items,</span><br><span class="line">                                work_ids_queue,</span><br><span class="line">                                call_queue)</span><br><span class="line"></span><br><span class="line">        sentinels = [p.sentinel <span class="keyword">for</span> p <span class="keyword">in</span> processes.values()]</span><br><span class="line">        <span class="keyword">assert</span> sentinels</span><br><span class="line">        ready = wait([reader] + sentinels)</span><br><span class="line">        <span class="keyword">if</span> reader <span class="keyword">in</span> ready:</span><br><span class="line">            result_item = reader.recv()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># Mark the process pool broken so that submits fail right now.</span></span><br><span class="line">            executor = executor_reference()</span><br><span class="line">            <span class="keyword">if</span> executor <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                executor._broken = <span class="literal">True</span></span><br><span class="line">                executor._shutdown_thread = <span class="literal">True</span></span><br><span class="line">                executor = <span class="literal">None</span></span><br><span class="line">            <span class="comment"># All futures in flight must be marked failed</span></span><br><span class="line">            <span class="keyword">for</span> work_id, work_item <span class="keyword">in</span> pending_work_items.items():</span><br><span class="line">                work_item.future.set_exception(</span><br><span class="line">                    BrokenProcessPool(</span><br><span class="line">                        <span class="string">&quot;A process in the process pool was &quot;</span></span><br><span class="line">                        <span class="string">&quot;terminated abruptly while the future was &quot;</span></span><br><span class="line">                        <span class="string">&quot;running or pending.&quot;</span></span><br><span class="line">                    ))</span><br><span class="line">                <span class="comment"># Delete references to object. See issue16284</span></span><br><span class="line">                <span class="keyword">del</span> work_item</span><br><span class="line">            pending_work_items.clear()</span><br><span class="line">            <span class="comment"># Terminate remaining workers forcibly: the queues or their</span></span><br><span class="line">            <span class="comment"># locks may be in a dirty state and block forever.</span></span><br><span class="line">            <span class="keyword">for</span> p <span class="keyword">in</span> processes.values():</span><br><span class="line">                p.terminate()</span><br><span class="line">            shutdown_worker()</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(result_item, <span class="built_in">int</span>):</span><br><span class="line">            <span class="comment"># Clean shutdown of a worker using its PID</span></span><br><span class="line">            <span class="comment"># (avoids marking the executor broken)</span></span><br><span class="line">            <span class="keyword">assert</span> shutting_down()</span><br><span class="line">            p = processes.pop(result_item)</span><br><span class="line">            p.join()</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> processes:</span><br><span class="line">                shutdown_worker()</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">elif</span> result_item <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            work_item = pending_work_items.pop(result_item.work_id, <span class="literal">None</span>)</span><br><span class="line">            <span class="comment"># work_item can be None if another process terminated (see above)</span></span><br><span class="line">            <span class="keyword">if</span> work_item <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="keyword">if</span> result_item.exception:</span><br><span class="line">                    work_item.future.set_exception(result_item.exception)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    work_item.future.set_result(result_item.result)</span><br><span class="line">                <span class="comment"># Delete references to object. See issue16284</span></span><br><span class="line">                <span class="keyword">del</span> work_item</span><br><span class="line">        <span class="comment"># Check whether we should start shutting down.</span></span><br><span class="line">        executor = executor_reference()</span><br><span class="line">        <span class="comment"># No more work items can be added if:</span></span><br><span class="line">        <span class="comment">#   - The interpreter is shutting down OR</span></span><br><span class="line">        <span class="comment">#   - The executor that owns this worker has been collected OR</span></span><br><span class="line">        <span class="comment">#   - The executor that owns this worker has been shutdown.</span></span><br><span class="line">        <span class="keyword">if</span> shutting_down():</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># Since no new work items can be added, it is safe to shutdown</span></span><br><span class="line">                <span class="comment"># this thread if there are no pending work items.</span></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> pending_work_items:</span><br><span class="line">                    shutdown_worker()</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">            <span class="keyword">except</span> Full:</span><br><span class="line">                <span class="comment"># This is not a problem: we will eventually be woken up (in</span></span><br><span class="line">                <span class="comment"># result_queue.get()) and be able to send a sentinel again.</span></span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">        executor = <span class="literal">None</span></span><br></pre></td></tr></table></figure>

<p><code>result_item</code> 变量</p>
<p>我们看看</p>
<p>首先，大家可能在这里有点疑问了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">sentinels = [p.sentinel <span class="keyword">for</span> p <span class="keyword">in</span> processes.values()]</span><br><span class="line"><span class="keyword">assert</span> sentinels</span><br><span class="line">ready = wait([reader] + sentinels)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这个 <code>wait</code> 是什么鬼啊，<code>reader</code> 又是什么鬼啊。一步步来。首先，我们看到，前面，<code>reader = result_queue._reader</code> 也会引起大家的疑问，这里我们 <code>result_queue</code> 是 <code>multiprocess</code> 里面的 <code>SimpleQueue</code> 啊，它没有 <code>_reader</code> 方法啊QAQ</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SimpleQueue</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, *, ctx</span>):</span><br><span class="line">        self._reader, self._writer = connection.Pipe(duplex=<span class="literal">False</span>)</span><br><span class="line">        self._rlock = ctx.Lock()</span><br><span class="line">        self._poll = self._reader.poll</span><br><span class="line">        <span class="keyword">if</span> sys.platform == <span class="string">&#x27;win32&#x27;</span>:</span><br><span class="line">            self._wlock = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self._wlock = ctx.Lock()</span><br></pre></td></tr></table></figure>

<p>上面这贴出来的，是 <code>SimpleQueue</code> 的部分代码，我们可以很清楚的看到，<code>SimpleQueue</code> 本质是利用一个 <code>Pipe</code> 来进行进程间通信的，然后 <code>_reader</code> 是读取 <code>Pipe</code> 的一个变量。</p>
<blockquote>
<p><strong>Note</strong> : 大家可以复习下其余几种进程间通信的方法了</p>
</blockquote>
<p>好了，这一部分看懂后，我们来看看 <code>wait</code> 方法吧。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">wait</span>(<span class="params">object_list, timeout=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    Wait till an object in object_list is ready/readable.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns list of those objects in object_list which are ready/readable.</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">with</span> _WaitSelector() <span class="keyword">as</span> selector:</span><br><span class="line">        <span class="keyword">for</span> obj <span class="keyword">in</span> object_list:</span><br><span class="line">            selector.register(obj, selectors.EVENT_READ)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> timeout <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            deadline = time.time() + timeout</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            ready = selector.select(timeout)</span><br><span class="line">            <span class="keyword">if</span> ready:</span><br><span class="line">                <span class="keyword">return</span> [key.fileobj <span class="keyword">for</span> (key, events) <span class="keyword">in</span> ready]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">if</span> timeout <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                    timeout = deadline - time.time()</span><br><span class="line">                    <span class="keyword">if</span> timeout &lt; <span class="number">0</span>:</span><br><span class="line">                        <span class="keyword">return</span> ready</span><br></pre></td></tr></table></figure>

<p>这一部分代码很简单，首先将我们待读取的对象，进行一次注册，然后当 <code>timeout</code> 为 None 的时候，就一直等待到有对象读取数据成功为止</p>
<p>好了，我们继续回到前面的 <code>_queue_management_worker</code> 函数中去，来看看这样一段代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ready = wait([reader] + sentinels)</span><br><span class="line"><span class="keyword">if</span> reader <span class="keyword">in</span> ready:</span><br><span class="line">    result_item = reader.recv()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="comment"># Mark the process pool broken so that submits fail right now.</span></span><br><span class="line">    executor = executor_reference()</span><br><span class="line">    <span class="keyword">if</span> executor <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        executor._broken = <span class="literal">True</span></span><br><span class="line">        executor._shutdown_thread = <span class="literal">True</span></span><br><span class="line">        executor = <span class="literal">None</span></span><br><span class="line">    <span class="comment"># All futures in flight must be marked failed</span></span><br><span class="line">    <span class="keyword">for</span> work_id, work_item <span class="keyword">in</span> pending_work_items.items():</span><br><span class="line">        work_item.future.set_exception(</span><br><span class="line">            BrokenProcessPool(</span><br><span class="line">                <span class="string">&quot;A process in the process pool was &quot;</span></span><br><span class="line">                <span class="string">&quot;terminated abruptly while the future was &quot;</span></span><br><span class="line">                <span class="string">&quot;running or pending.&quot;</span></span><br><span class="line">            ))</span><br><span class="line">        <span class="comment"># Delete references to object. See issue16284</span></span><br><span class="line">        <span class="keyword">del</span> work_item</span><br><span class="line">    pending_work_items.clear()</span><br><span class="line">    <span class="comment"># Terminate remaining workers forcibly: the queues or their</span></span><br><span class="line">    <span class="comment"># locks may be in a dirty state and block forever.</span></span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> processes.values():</span><br><span class="line">        p.terminate()</span><br><span class="line">    shutdown_worker()</span><br><span class="line">    <span class="keyword">return</span></span><br></pre></td></tr></table></figure>

<p>我们用 <code>wait</code> 函数来读取一系列对象，因为我们没有设置 <code>Timeout</code> ，所以当我们拿到可读取对象的结果时，如果 <code>result_queue._reader</code> 没有在列表中，那么意味着，有处理进程突然异常关闭了，这个时候，我们开始执行后面的语句来执行目前进程池的关闭操作。如果在列表中，我们读取数据，得到 <code>result_item</code> 变量</p>
<p>我们再看看下面的代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">isinstance</span>(result_item, <span class="built_in">int</span>):</span><br><span class="line">    <span class="comment"># Clean shutdown of a worker using its PID</span></span><br><span class="line">    <span class="comment"># (avoids marking the executor broken)</span></span><br><span class="line">    <span class="keyword">assert</span> shutting_down()</span><br><span class="line">    p = processes.pop(result_item)</span><br><span class="line">    p.join()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> processes:</span><br><span class="line">        shutdown_worker()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"><span class="keyword">elif</span> result_item <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">    work_item = pending_work_items.pop(result_item.work_id, <span class="literal">None</span>)</span><br><span class="line">    <span class="comment"># work_item can be None if another process terminated (see above)</span></span><br><span class="line">    <span class="keyword">if</span> work_item <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">if</span> result_item.exception:</span><br><span class="line">            work_item.future.set_exception(result_item.exception)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            work_item.future.set_result(result_item.result)</span><br><span class="line">        <span class="comment"># Delete references to object. See issue16284</span></span><br><span class="line">        <span class="keyword">del</span> work_item</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>首先，如果 <code>result_item</code> 变量是 int 类型的话，不知道大家还记不记得在 <code>_process_worker</code> 函数中有这样一段逻辑</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">call_item = call_queue.get(block=<span class="literal">True</span>)</span><br><span class="line"><span class="keyword">if</span> call_item <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    <span class="comment"># Wake up queue management thread</span></span><br><span class="line">    result_queue.put(os.getpid())</span><br><span class="line">    <span class="keyword">return</span></span><br></pre></td></tr></table></figure>

<p>当调用队列中没有新的任务时，将进程 <code>pid</code> 放入 <code>result_queue</code> 中。那么我们 <code>result_item</code> 如果值为 <code>int</code> 那么意味着，我们之前任务处理工作已经完毕，于是开始清理，关闭我们的进程池。</p>
<p>如果 <code>result_item</code> 既不为 <code>int</code> 也不为 <code>None</code> , 那么必然是 <code>_ResultItem</code> 的实例，我们根据 <code>work_id</code> 取出 <code>_WorkItem</code> 实例，并将产生的异常或者值和 <code>_WorkItem</code> 实例中的 <code>Future</code> 实例（也就是我们 submit 后返回的那货）进行绑定。</p>
<p>最后，删除这个 <code>work_item</code> ，完事儿，手工</p>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>洋洋洒洒写了一大篇辣鸡文章，希望大家不要介意，其实我们能看到 <code>concurrent.future</code> 的实现，其实并没有用什么高深的黑魔法，但是其中细节值得我们一一品味，所以这篇文章我们先写到这里。后面有机会的话，我们再去看看 <code>concurrent.future</code> 其余部分代码。也有蛮多值得品味的地方。</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>1.<a target="_blank" rel="noopener" href="https://docs.python.org/3/library/multiprocessing.html#multiprocessing.SimpleQueue">Python 3 multiprocessing</a></p>
<p>2.<a target="_blank" rel="noopener" href="https://docs.python.org/3/library/weakref.html">Python 3 weakref</a></p>
<p>3.<a target="_blank" rel="noopener" href="https://my.oschina.net/u/1255754/blog/207331">并发编程之Future模式</a></p>
<p>4.<a target="_blank" rel="noopener" href="https://www.ziwenxie.site/2016/12/24/python-concurrent-futures/">Python并发编程之线程池/进程池</a></p>
<p>5.<a target="_blank" rel="noopener" href="http://zha-zi.iteye.com/blog/1408189">Future 模式详解（并发使用）</a></p>
</div><div class="article-licensing box"><div class="licensing-title"><p>Python concurrent.future 使用教程及源码初剖</p><p><a href="http://manjusaka.itscoder.com/posts/2017/11/27/something-about-concurrent-future/">http://manjusaka.itscoder.com/posts/2017/11/27/something-about-concurrent-future/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>Manjusaka</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2017-11-28</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2022-02-05</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Python/">Python</a><a class="link-muted mr-2" rel="tag" href="/tags/%E7%BC%96%E7%A8%8B/">编程</a><a class="link-muted mr-2" rel="tag" href="/tags/%E7%BC%96%E7%A8%8B%E6%8A%80%E5%B7%A7/">编程技巧</a><a class="link-muted mr-2" rel="tag" href="/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/">并发编程</a><a class="link-muted mr-2" rel="tag" href="/tags/%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/">源码剖析</a></div><div class="sharethis-inline-share-buttons"></div><script src="https://platform-api.sharethis.com/js/sharethis.js#property=61fe2890d7b259001917a0b2&amp;product=inline-share-buttons" defer></script></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/posts/2017/12/28/what-the-fuck-supvisor/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Supervisor 的一个隐藏坑</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/posts/2017/08/13/what-the-fuck-about-flask-part1/"><span class="level-item">你所不知道的 Flask Part1:Route 初探</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">Comments</h3><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div><script>var disqus_config = function () {
            this.page.url = 'http://manjusaka.itscoder.com/posts/2017/11/27/something-about-concurrent-future/';
            this.page.identifier = '/posts/2017/11/27/something-about-concurrent-future/';
        };
        (function() {
            var d = document, s = d.createElement('script');  
            s.src = '//' + 'manjusakablog' + '.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="https://user-images.githubusercontent.com/7054676/56820343-2fe1b580-687e-11e9-8f6f-778df3a8eafd.png" alt="Manjusaka"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Manjusaka</p><p class="is-size-6 is-block">Stay simple &amp;&amp; Stay Naive</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Beijing, China</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">63</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">28</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">46</p></a></div></div></nav><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/Zheaoli"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com/Manjusaka_Lee"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Telegram" href="https://t.me/ManjusakaL"><i class="fab fa-telegram"></i></a></div></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="level is-mobile" href="#垃圾话"><span class="level-left"><span class="level-item">1</span><span class="level-item">垃圾话</span></span></a></li><li><a class="level is-mobile" href="#正文"><span class="level-left"><span class="level-item">2</span><span class="level-item">正文</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#Python-的异步处理"><span class="level-left"><span class="level-item">2.1</span><span class="level-item">Python 的异步处理</span></span></a></li><li><a class="level is-mobile" href="#Future-模式"><span class="level-left"><span class="level-item">2.2</span><span class="level-item">Future 模式</span></span></a></li><li><a class="level is-mobile" href="#Python-中的-concurrent-futures"><span class="level-left"><span class="level-item">2.3</span><span class="level-item">Python 中的 concurrent.futures</span></span></a></li><li><a class="level is-mobile" href="#剖一下-concurrent-futures"><span class="level-left"><span class="level-item">2.4</span><span class="level-item">剖一下 concurrent.futures</span></span></a></li><li><a class="level is-mobile" href="#最后"><span class="level-left"><span class="level-item">2.5</span><span class="level-item">最后</span></span></a></li><li><a class="level is-mobile" href="#Reference"><span class="level-left"><span class="level-item">2.6</span><span class="level-item">Reference</span></span></a></li></ul></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">Links</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://pythonhunter.org/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">捕蛇者说</span></span><span class="level-right"><span class="level-item tag">pythonhunter.org</span></span></a></li><li><a class="level is-mobile" href="https://laike9m.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">laike9m&#039;s Blog</span></span><span class="level-right"><span class="level-item tag">laike9m.com</span></span></a></li><li><a class="level is-mobile" href="https://darkof.me/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Adam Wen&#039;s Blog</span></span><span class="level-right"><span class="level-item tag">darkof.me</span></span></a></li><li><a class="level is-mobile" href="https://www.kawabangga.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">卡瓦邦噶</span></span><span class="level-right"><span class="level-item tag">www.kawabangga.com</span></span></a></li><li><a class="level is-mobile" href="http://ice1000.org/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">千里冰封</span></span><span class="level-right"><span class="level-item tag">ice1000.org</span></span></a></li><li><a class="level is-mobile" href="https://leiysky.github.io/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">leiysky</span></span><span class="level-right"><span class="level-item tag">leiysky.github.io</span></span></a></li><li><a class="level is-mobile" href="https://xuanwo.io/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">漩涡的博客</span></span><span class="level-right"><span class="level-item tag">xuanwo.io</span></span></a></li><li><a class="level is-mobile" href="http://jaeger.itscoder.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">写代码的猴子</span></span><span class="level-right"><span class="level-item tag">jaeger.itscoder.com</span></span></a></li><li><a class="level is-mobile" href="https://www.kilerd.me/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">你好，耳先生</span></span><span class="level-right"><span class="level-item tag">www.kilerd.me</span></span></a></li><li><a class="level is-mobile" href="http://brucezz.itscoder.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">小天</span></span><span class="level-right"><span class="level-item tag">brucezz.itscoder.com</span></span></a></li><li><a class="level is-mobile" href="http://yongyu.itscoder.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">用语</span></span><span class="level-right"><span class="level-item tag">yongyu.itscoder.com</span></span></a></li><li><a class="level is-mobile" href="http://showzeng.itscoder.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">showzeng</span></span><span class="level-right"><span class="level-item tag">showzeng.itscoder.com</span></span></a></li><li><a class="level is-mobile" href="http://extremej.itscoder.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">extremej</span></span><span class="level-right"><span class="level-item tag">extremej.itscoder.com</span></span></a></li><li><a class="level is-mobile" href="http://melodyxxx.itscoder.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">melodyxxx</span></span><span class="level-right"><span class="level-item tag">melodyxxx.itscoder.com</span></span></a></li><li><a class="level is-mobile" href="http://melo.itscoder.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">melo</span></span><span class="level-right"><span class="level-item tag">melo.itscoder.com</span></span></a></li><li><a class="level is-mobile" href="http://hymane.itscoder.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">hymane</span></span><span class="level-right"><span class="level-item tag">hymane.itscoder.com</span></span></a></li><li><a class="level is-mobile" href="http://imxie.itscoder.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">imxie</span></span><span class="level-right"><span class="level-item tag">imxie.itscoder.com</span></span></a></li><li><a class="level is-mobile" href="http://www.iamlj.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Jing&#039;s Blog</span></span><span class="level-right"><span class="level-item tag">www.iamlj.com</span></span></a></li><li><a class="level is-mobile" href="https://xiaxichen.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">夏溪辰</span></span><span class="level-right"><span class="level-item tag">xiaxichen.com</span></span></a></li><li><a class="level is-mobile" href="https://ymkiux.github.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">ymkiux</span></span><span class="level-right"><span class="level-item tag">ymkiux.github.io</span></span></a></li></ul></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/%E4%BA%BA%E7%94%9F/"><span class="level-start"><span class="level-item">人生</span></span><span class="level-end"><span class="level-item tag">4</span></span></a><ul><li><a class="level is-mobile" href="/categories/%E4%BA%BA%E7%94%9F/%E6%9D%82%E8%AE%B0/"><span class="level-start"><span class="level-item">杂记</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/%E4%BA%BA%E9%97%B4%E4%B8%96/"><span class="level-start"><span class="level-item">人间世</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E5%B7%A5%E5%85%B7/"><span class="level-start"><span class="level-item">工具</span></span><span class="level-end"><span class="level-item tag">1</span></span></a><ul><li><a class="level is-mobile" href="/categories/%E5%B7%A5%E5%85%B7/%E8%BE%93%E5%85%A5%E6%B3%95/"><span class="level-start"><span class="level-item">输入法</span></span><span class="level-end"><span class="level-item tag">1</span></span></a><ul><li><a class="level is-mobile" href="/categories/%E5%B7%A5%E5%85%B7/%E8%BE%93%E5%85%A5%E6%B3%95/Rime/"><span class="level-start"><span class="level-item">Rime</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="/categories/%E7%94%9F%E6%B4%BB/"><span class="level-start"><span class="level-item">生活</span></span><span class="level-end"><span class="level-item tag">1</span></span></a><ul><li><a class="level is-mobile" href="/categories/%E7%94%9F%E6%B4%BB/%E7%94%B5%E5%AD%90%E4%BA%A7%E5%93%81/"><span class="level-start"><span class="level-item">电子产品</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/%E7%A4%BE%E4%BC%9A/"><span class="level-start"><span class="level-item">社会</span></span><span class="level-end"><span class="level-item tag">3</span></span></a><ul><li><a class="level is-mobile" href="/categories/%E7%A4%BE%E4%BC%9A/PKU/"><span class="level-start"><span class="level-item">PKU</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/%E7%BC%96%E7%A8%8B/"><span class="level-start"><span class="level-item">编程</span></span><span class="level-end"><span class="level-item tag">50</span></span></a><ul><li><a class="level is-mobile" href="/categories/%E7%BC%96%E7%A8%8B/Linux/"><span class="level-start"><span class="level-item">Linux</span></span><span class="level-end"><span class="level-item tag">10</span></span></a><ul><li><a class="level is-mobile" href="/categories/%E7%BC%96%E7%A8%8B/Linux/Kernel/"><span class="level-start"><span class="level-item">Kernel</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/%E7%BC%96%E7%A8%8B/Python/"><span class="level-start"><span class="level-item">Python</span></span><span class="level-end"><span class="level-item tag">23</span></span></a><ul><li><a class="level is-mobile" href="/categories/%E7%BC%96%E7%A8%8B/Python/MySQL/"><span class="level-start"><span class="level-item">MySQL</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/%E7%BC%96%E7%A8%8B/Python/PEP484/"><span class="level-start"><span class="level-item">PEP484</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E7%BC%96%E7%A8%8B/Python/%E9%9A%8F%E7%AC%94/"><span class="level-start"><span class="level-item">随笔</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/%E7%BC%96%E7%A8%8B/leetcode/"><span class="level-start"><span class="level-item">leetcode</span></span><span class="level-end"><span class="level-item tag">3</span></span></a><ul><li><a class="level is-mobile" href="/categories/%E7%BC%96%E7%A8%8B/leetcode/%E5%88%B7%E9%A2%98/"><span class="level-start"><span class="level-item">刷题</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/%E7%BC%96%E7%A8%8B/%E6%9D%82%E8%AE%B0/"><span class="level-start"><span class="level-item">杂记</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E7%BC%96%E7%A8%8B/%E6%B0%B4%E6%96%87/"><span class="level-start"><span class="level-item">水文</span></span><span class="level-end"><span class="level-item tag">2</span></span></a><ul><li><a class="level is-mobile" href="/categories/%E7%BC%96%E7%A8%8B/%E6%B0%B4%E6%96%87/%E8%AE%BA%E6%96%87/"><span class="level-start"><span class="level-item">论文</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/%E7%BC%96%E7%A8%8B/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/"><span class="level-start"><span class="level-item">网络编程</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E7%BC%96%E7%A8%8B/%E7%BF%BB%E8%AF%91/"><span class="level-start"><span class="level-item">翻译</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/categories/%E7%BC%96%E7%A8%8B/%E9%9A%8F%E6%83%B3/"><span class="level-start"><span class="level-item">随想</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/%E9%9A%8F%E7%AC%94/"><span class="level-start"><span class="level-item">随笔</span></span><span class="level-end"><span class="level-item tag">3</span></span></a><ul><li><a class="level is-mobile" href="/categories/%E9%9A%8F%E7%AC%94/%E6%80%BB%E7%BB%93/"><span class="level-start"><span class="level-item">总结</span></span><span class="level-end"><span class="level-item tag">3</span></span></a><ul><li><a class="level is-mobile" href="/categories/%E9%9A%8F%E7%AC%94/%E6%80%BB%E7%BB%93/%E7%A7%80%E6%81%A9%E7%88%B1/"><span class="level-start"><span class="level-item">秀恩爱</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li></ul></li></ul></li></ul></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/%E4%BA%BA%E7%94%9F/"><span class="level-start"><span class="level-item">人生</span></span><span class="level-end"><span class="level-item tag">4</span></span></a><ul><li><a class="level is-mobile" href="/categories/%E4%BA%BA%E7%94%9F/%E6%9D%82%E8%AE%B0/"><span class="level-start"><span class="level-item">杂记</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/%E4%BA%BA%E9%97%B4%E4%B8%96/"><span class="level-start"><span class="level-item">人间世</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E5%B7%A5%E5%85%B7/"><span class="level-start"><span class="level-item">工具</span></span><span class="level-end"><span class="level-item tag">1</span></span></a><ul><li><a class="level is-mobile" href="/categories/%E5%B7%A5%E5%85%B7/%E8%BE%93%E5%85%A5%E6%B3%95/"><span class="level-start"><span class="level-item">输入法</span></span><span class="level-end"><span class="level-item tag">1</span></span></a><ul><li><a class="level is-mobile" href="/categories/%E5%B7%A5%E5%85%B7/%E8%BE%93%E5%85%A5%E6%B3%95/Rime/"><span class="level-start"><span class="level-item">Rime</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="/categories/%E7%94%9F%E6%B4%BB/"><span class="level-start"><span class="level-item">生活</span></span><span class="level-end"><span class="level-item tag">1</span></span></a><ul><li><a class="level is-mobile" href="/categories/%E7%94%9F%E6%B4%BB/%E7%94%B5%E5%AD%90%E4%BA%A7%E5%93%81/"><span class="level-start"><span class="level-item">电子产品</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/%E7%A4%BE%E4%BC%9A/"><span class="level-start"><span class="level-item">社会</span></span><span class="level-end"><span class="level-item tag">3</span></span></a><ul><li><a class="level is-mobile" href="/categories/%E7%A4%BE%E4%BC%9A/PKU/"><span class="level-start"><span class="level-item">PKU</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/%E7%BC%96%E7%A8%8B/"><span class="level-start"><span class="level-item">编程</span></span><span class="level-end"><span class="level-item tag">50</span></span></a><ul><li><a class="level is-mobile" href="/categories/%E7%BC%96%E7%A8%8B/Linux/"><span class="level-start"><span class="level-item">Linux</span></span><span class="level-end"><span class="level-item tag">10</span></span></a><ul><li><a class="level is-mobile" href="/categories/%E7%BC%96%E7%A8%8B/Linux/Kernel/"><span class="level-start"><span class="level-item">Kernel</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/%E7%BC%96%E7%A8%8B/Python/"><span class="level-start"><span class="level-item">Python</span></span><span class="level-end"><span class="level-item tag">23</span></span></a><ul><li><a class="level is-mobile" href="/categories/%E7%BC%96%E7%A8%8B/Python/MySQL/"><span class="level-start"><span class="level-item">MySQL</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/%E7%BC%96%E7%A8%8B/Python/PEP484/"><span class="level-start"><span class="level-item">PEP484</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E7%BC%96%E7%A8%8B/Python/%E9%9A%8F%E7%AC%94/"><span class="level-start"><span class="level-item">随笔</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/%E7%BC%96%E7%A8%8B/leetcode/"><span class="level-start"><span class="level-item">leetcode</span></span><span class="level-end"><span class="level-item tag">3</span></span></a><ul><li><a class="level is-mobile" href="/categories/%E7%BC%96%E7%A8%8B/leetcode/%E5%88%B7%E9%A2%98/"><span class="level-start"><span class="level-item">刷题</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/%E7%BC%96%E7%A8%8B/%E6%9D%82%E8%AE%B0/"><span class="level-start"><span class="level-item">杂记</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E7%BC%96%E7%A8%8B/%E6%B0%B4%E6%96%87/"><span class="level-start"><span class="level-item">水文</span></span><span class="level-end"><span class="level-item tag">2</span></span></a><ul><li><a class="level is-mobile" href="/categories/%E7%BC%96%E7%A8%8B/%E6%B0%B4%E6%96%87/%E8%AE%BA%E6%96%87/"><span class="level-start"><span class="level-item">论文</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/%E7%BC%96%E7%A8%8B/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/"><span class="level-start"><span class="level-item">网络编程</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E7%BC%96%E7%A8%8B/%E7%BF%BB%E8%AF%91/"><span class="level-start"><span class="level-item">翻译</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/categories/%E7%BC%96%E7%A8%8B/%E9%9A%8F%E6%83%B3/"><span class="level-start"><span class="level-item">随想</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/%E9%9A%8F%E7%AC%94/"><span class="level-start"><span class="level-item">随笔</span></span><span class="level-end"><span class="level-item tag">3</span></span></a><ul><li><a class="level is-mobile" href="/categories/%E9%9A%8F%E7%AC%94/%E6%80%BB%E7%BB%93/"><span class="level-start"><span class="level-item">总结</span></span><span class="level-end"><span class="level-item tag">3</span></span></a><ul><li><a class="level is-mobile" href="/categories/%E9%9A%8F%E7%AC%94/%E6%80%BB%E7%BB%93/%E7%A7%80%E6%81%A9%E7%88%B1/"><span class="level-start"><span class="level-item">秀恩爱</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li></ul></li></ul></li></ul></div></div></div><div class="column-right-shadow is-hidden-widescreen is-sticky"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3 is-sticky"><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2022/01/"><span class="level-start"><span class="level-item">January 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/12/"><span class="level-start"><span class="level-item">December 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/11/"><span class="level-start"><span class="level-item">November 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/08/"><span class="level-start"><span class="level-item">August 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/05/"><span class="level-start"><span class="level-item">May 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/04/"><span class="level-start"><span class="level-item">April 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/02/"><span class="level-start"><span class="level-item">February 2021</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/12/"><span class="level-start"><span class="level-item">December 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/11/"><span class="level-start"><span class="level-item">November 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/10/"><span class="level-start"><span class="level-item">October 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/06/"><span class="level-start"><span class="level-item">June 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/05/"><span class="level-start"><span class="level-item">May 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/03/"><span class="level-start"><span class="level-item">March 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/02/"><span class="level-start"><span class="level-item">February 2020</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/01/"><span class="level-start"><span class="level-item">January 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/11/"><span class="level-start"><span class="level-item">November 2019</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/07/"><span class="level-start"><span class="level-item">July 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/04/"><span class="level-start"><span class="level-item">April 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/03/"><span class="level-start"><span class="level-item">March 2019</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/01/"><span class="level-start"><span class="level-item">January 2019</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/10/"><span class="level-start"><span class="level-item">October 2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/07/"><span class="level-start"><span class="level-item">July 2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/04/"><span class="level-start"><span class="level-item">April 2018</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/02/"><span class="level-start"><span class="level-item">February 2018</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/12/"><span class="level-start"><span class="level-item">December 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/11/"><span class="level-start"><span class="level-item">November 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/08/"><span class="level-start"><span class="level-item">August 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/06/"><span class="level-start"><span class="level-item">June 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/02/"><span class="level-start"><span class="level-item">February 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/12/"><span class="level-start"><span class="level-item">December 2016</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/11/"><span class="level-start"><span class="level-item">November 2016</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/10/"><span class="level-start"><span class="level-item">October 2016</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/09/"><span class="level-start"><span class="level-item">September 2016</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/08/"><span class="level-start"><span class="level-item">August 2016</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/07/"><span class="level-start"><span class="level-item">July 2016</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Apple/"><span class="tag">Apple</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Flask/"><span class="tag">Flask</span><span class="tag">9</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux/"><span class="tag">Linux</span><span class="tag">10</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MySQL/"><span class="tag">MySQL</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Node-js/"><span class="tag">Node.js</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Objective-C/"><span class="tag">Objective-C</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/PEP/"><span class="tag">PEP</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/PEP484/"><span class="tag">PEP484</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/PKU/"><span class="tag">PKU</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Python/"><span class="tag">Python</span><span class="tag">26</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Swift/"><span class="tag">Swift</span><span class="tag">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SystemTap/"><span class="tag">SystemTap</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Unix/"><span class="tag">Unix</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/async/"><span class="tag">async</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/eBPF/"><span class="tag">eBPF</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/iOS/"><span class="tag">iOS</span><span class="tag">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/leetcode/"><span class="tag">leetcode</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E4%BA%91%E5%8E%9F%E7%94%9F/"><span class="tag">云原生</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E4%BA%BA%E7%94%9F/"><span class="tag">人生</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E4%BA%BA%E9%97%B4%E4%B8%96/"><span class="tag">人间世</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/"><span class="tag">分布式</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%88%B7%E9%A2%98/"><span class="tag">刷题</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%89%8D%E7%AB%AF/"><span class="tag">前端</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%8D%8F%E7%A8%8B/"><span class="tag">协程</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%90%90%E6%A7%BD/"><span class="tag">吐槽</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%B7%A5%E5%85%B7/"><span class="tag">工具</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"><span class="tag">并发编程</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%80%BB%E7%BB%93/"><span class="tag">总结</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%8E%98%E9%87%91%E7%BF%BB%E8%AF%91%E8%AE%A1%E5%88%92/"><span class="tag">掘金翻译计划</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%9D%82%E8%AE%B0/"><span class="tag">杂记</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%B0%B4%E6%96%87/"><span class="tag">水文</span><span class="tag">12</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/"><span class="tag">源码剖析</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/"><span class="tag">源码阅读</span><span class="tag">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%94%B5%E5%AD%90%E4%BA%A7%E5%93%81/"><span class="tag">电子产品</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%A4%BE%E4%BC%9A/"><span class="tag">社会</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%A7%80%E6%81%A9%E7%88%B1/"><span class="tag">秀恩爱</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%AC%94%E8%AE%B0/"><span class="tag">笔记</span><span class="tag">11</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%BC%96%E7%A8%8B/"><span class="tag">编程</span><span class="tag">49</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%BC%96%E7%A8%8B%E6%8A%80%E5%B7%A7/"><span class="tag">编程技巧</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/"><span class="tag">网络编程</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%AE%BA%E6%96%87/"><span class="tag">论文</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%AF%84%E6%B5%8B/"><span class="tag">评测</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%BE%93%E5%85%A5%E6%B3%95/"><span class="tag">输入法</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%9A%8F%E6%83%B3/"><span class="tag">随想</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%9A%8F%E7%AC%94/"><span class="tag">随笔</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%BB%91%E9%AD%94%E6%B3%95/"><span class="tag">黑魔法</span><span class="tag">2</span></a></div></div></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="https://user-images.githubusercontent.com/7054676/56820277-0a54ac00-687e-11e9-9f34-f79089938638.png" alt="Manjusaka" height="28"></a><p class="is-size-7"><span>&copy; 2022 Manjusaka</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/Zheaoli/manjusaka-blog"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>