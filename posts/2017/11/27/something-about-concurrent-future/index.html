<!DOCTYPE html><html lang=en data-theme=auto><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><title>Python concurrent.future 使用教程及源码初剖 | Manjusaka</title><meta name=author content=Manjusaka><meta name=copyright content=Manjusaka><meta name=format-detection content="telephone=no"><meta name=theme-color content=ffffff><meta name=description content="垃圾话很久没写博客了，想了想不能再划水，于是给自己定了一个目标，写点 concurrent.future 的内容，于是这篇文章就是来聊聊 Python 3.2 中新增的 concurrent.future 模块。"><meta property=og:type content=article><meta property=og:title content="Python concurrent.future 使用教程及源码初剖"><meta property=og:url content=https://www.manjusaka.blog/posts/2017/11/27/something-about-concurrent-future/index.html><meta property=og:site_name content=Manjusaka><meta property=og:description content="垃圾话很久没写博客了，想了想不能再划水，于是给自己定了一个目标，写点 concurrent.future 的内容，于是这篇文章就是来聊聊 Python 3.2 中新增的 concurrent.future 模块。"><meta property=og:locale content=en_US><meta property=og:image content=https://cdn.pixabay.com/photo/2023/01/14/19/50/flower-7718952_1280.jpg><meta property=article:published_time content=2017-11-27T16:09:54.000Z><meta property=article:modified_time content=2024-11-21T19:22:43.502Z><meta property=article:author content=Manjusaka><meta property=article:tag content=编程><meta property=article:tag content=Python><meta property=article:tag content=编程技巧><meta property=article:tag content=并发编程><meta property=article:tag content=源码剖析><meta name=twitter:card content=summary><meta name=twitter:image content="https://avatars.githubusercontent.com/u/7054676?v=4"><meta name=twitter:creator content=@Manjusaka_Lee><meta name=twitter:site content=https://twitter.com/Manjusaka_Lee><link rel="shortcut icon" href="https://avatars.githubusercontent.com/u/7054676?v=4"><link rel=canonical href=https://www.manjusaka.blog/posts/2017/11/27/something-about-concurrent-future/index.html><link rel=preconnect href=//cdn.jsdelivr.net><link rel=preconnect href=//www.google-analytics.com crossorigin=""><link rel=preconnect href=//busuanzi.ibruce.info><link rel=stylesheet href=/css/index.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css media=print onload='this.media="all"'><script>(()=>{let t={set:(e,t,a)=>{a&&(a=Date.now()+864e5*a,localStorage.setItem(e,JSON.stringify({value:t,expiry:a})))},get:e=>{var t=localStorage.getItem(e);if(t){var{value:t,expiry:a}=JSON.parse(t);if(!(Date.now()>a))return t;localStorage.removeItem(e)}}},a=(window.btf={saveToLocal:t,getScript:(o,r={})=>new Promise((e,t)=>{let a=document.createElement("script");a.src=o,a.async=!0,Object.entries(r).forEach(([e,t])=>a.setAttribute(e,t)),a.onload=a.onreadystatechange=()=>{a.readyState&&!/loaded|complete/.test(a.readyState)||e()},a.onerror=t,document.head.appendChild(a)}),getCSS:(o,r)=>new Promise((e,t)=>{let a=document.createElement("link");a.rel="stylesheet",a.href=o,r&&(a.id=r),a.onload=a.onreadystatechange=()=>{a.readyState&&!/loaded|complete/.test(a.readyState)||e()},a.onerror=t,document.head.appendChild(a)}),addGlobalFn:(e,t,a=!1,o=window)=>{var r;e.startsWith("pjax")||((r=o.globalFn||{})[e]=r[e]||{},r[e][a||Object.keys(r[e]).length]=t,o.globalFn=r)}},()=>{document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")}),o=()=>{document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","ffffff")};btf.activateDarkMode=a,btf.activateLightMode=o;var r=t.get("theme"),n=window.matchMedia("(prefers-color-scheme: dark)"),d=window.matchMedia("(prefers-color-scheme: light)"),d=(void 0===r?((!d.matches&&(n.matches||(d=(new Date).getHours())<=6||18<=d)?a:o)(),n.addEventListener("change",()=>{void 0===t.get("theme")&&(e.matches?a:o)()})):("light"===r?o:a)(),t.get("aside-status"));void 0!==d&&document.documentElement.classList.toggle("hide-aside","hide"===d);/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})()</script><script async=async src="https://www.googletagmanager.com/gtag/js?id=UA-154407994-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-154407994-1"),btf.addGlobalFn("pjaxComplete",()=>{gtag("config","UA-154407994-1",{page_path:window.location.pathname})},"google_analytics")</script><script>let GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:void 0,translate:{defaultEncoding:2,translateDelay:0,msgToTraditionalChinese:"繁",msgToSimplifiedChinese:"簡"},highlight:{plugin:"highlight.js",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:!1,highlightFullpage:!1,highlightMacStyle:!1},copy:{success:"Copy Successful",error:"Copy Failed",noSupport:"Browser Not Supported"},relativeDate:{homepage:!0,post:!0},runtime:"",dateSuffix:{just:"Just now",min:"minutes ago",hour:"hours ago",day:"days ago",month:"months ago"},copyright:{limitCount:100,languages:{author:"Author: Manjusaka",link:"Link: ",source:"Source: Manjusaka",info:"Copyright belongs to the author. For commercial use, please contact the author for authorization. For non-commercial use, please indicate the source."}},lightbox:"null",Snackbar:{chs_to_cht:"You have switched to Traditional Chinese",cht_to_chs:"You have switched to Simplified Chinese",day_to_night:"You have switched to Dark Mode",night_to_day:"You have switched to Light Mode",bgLight:"#59C173",bgDark:"#1f1f1f",position:"bottom-left"},infinitegrid:{js:"https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js",buttonText:"Load More"},isPhotoFigcaption:!0,islazyload:!0,isAnchor:!0,percent:{toc:!0,rightside:!0},autoDarkmode:!0}</script><script id=config-diff>var GLOBAL_CONFIG_SITE={title:"Python concurrent.future 使用教程及源码初剖",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,isShuoshuo:!1}</script><link rel=stylesheet href=https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.css media=print onload='this.media="all"'><link rel=stylesheet href=https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiperstyle.css media=print onload='this.media="all"'><link rel=stylesheet href=https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css media=defer onload='this.media="all"'><link rel=stylesheet href=https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css media=defer onload='this.media="all"'><script src=https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js></script><meta name=generator content="Hexo 6.3.0"><link rel=alternate href=/atom.xml title=Manjusaka type=application/atom+xml></head><body><div id=loading-box><div class=loading-left-bg></div><div class=loading-right-bg></div><div class=spinner-box><div class=configure-border-1><div class=configure-core></div></div><div class=configure-border-2><div class=configure-core></div></div><div class=loading-word>Loading...</div></div></div><script>(()=>{let e=document.getElementById("loading-box"),d=document.body;const o=()=>{d.style.overflow="",e.classList.add("loaded")},l=()=>{d.style.overflow="hidden",e.classList.remove("loaded")};l(),window.addEventListener("load",o)})()</script><div id=web_bg style="background-image:url('url(https://cdn.jsdelivr.net/gh/youngjuning/images@main/1680450445599.png)')"></div><div id=sidebar><div id=menu-mask></div><div id=sidebar-menus><div class="avatar-img text-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://avatars.githubusercontent.com/u/7054676?v=4" onerror='onerror=null,src="/img/friend_404.gif"' alt=avatar></div><div class="site-data text-center"><a href=/archives/ ><div class=headline>Articles</div><div class=length-num>95</div></a><a href=/tags/ ><div class=headline>Tags</div><div class=length-num>58</div></a><a href=/categories/ ><div class=headline>Categories</div><div class=length-num>38</div></a></div><div class=menus_items><div class=menus_item><a class=site-page href=/ ><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class=menus_item><span class="site-page group"><i class="fa-fw fa-fw fas fa-lines-leaning"></i><span> 文章</span><i class="fas fa-chevron-down"></i></span><ul class=menus_item_child><li><a class="site-page child" href=/categories/ ><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href=/tags/ ><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href=/archives/ ><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href=/random/ ><i class="fa-fw fas fa-random"></i><span> 随便逛逛</span></a></li></ul></div><div class=menus_item><a class=site-page href=/weekly/ ><i class="fa-fw fas fa-newspaper"></i><span> 周报</span></a></div><div class=menus_item><a class=site-page href=/leetcode/ ><i class="fa-fw fas fa-newspaper"></i><span> 刷题</span></a></div><div class=menus_item><span class="site-page group"><i class="fa-fw fas fa-heart"></i><span> 我的</span><i class="fas fa-chevron-down"></i></span><ul class=menus_item_child><li><a class="site-page child" href=/about/ ><i class="fa-fw fas fa-spa"></i><span> 关于</span></a></li><li><a class="site-page child" href=/weekly/ ><i class="fa-fw fas fa-newspaper"></i><span> 周报</span></a></li></ul></div></div></div></div><div class="post type-tags" id=body-wrap><header class=post-bg id=page-header style=background-image:url(https://cdn.pixabay.com/photo/2023/01/14/19/50/flower-7718952_1280.jpg)><nav id=nav><span id=blog-info><a class=nav-site-title href=/ ><img class=site-icon src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://avatars.githubusercontent.com/u/7054676?v=4# image" alt=Logo><span class=site-name>Manjusaka</span></a><a class=nav-page-title href=/ ><span class=site-name>Python concurrent.future 使用教程及源码初剖</span></a></span><div id=menus><div class=menus_items><div class=menus_item><a class=site-page href=/ ><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class=menus_item><span class="site-page group"><i class="fa-fw fa-fw fas fa-lines-leaning"></i><span> 文章</span><i class="fas fa-chevron-down"></i></span><ul class=menus_item_child><li><a class="site-page child" href=/categories/ ><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href=/tags/ ><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href=/archives/ ><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href=/random/ ><i class="fa-fw fas fa-random"></i><span> 随便逛逛</span></a></li></ul></div><div class=menus_item><a class=site-page href=/weekly/ ><i class="fa-fw fas fa-newspaper"></i><span> 周报</span></a></div><div class=menus_item><a class=site-page href=/leetcode/ ><i class="fa-fw fas fa-newspaper"></i><span> 刷题</span></a></div><div class=menus_item><span class="site-page group"><i class="fa-fw fas fa-heart"></i><span> 我的</span><i class="fas fa-chevron-down"></i></span><ul class=menus_item_child><li><a class="site-page child" href=/about/ ><i class="fa-fw fas fa-spa"></i><span> 关于</span></a></li><li><a class="site-page child" href=/weekly/ ><i class="fa-fw fas fa-newspaper"></i><span> 周报</span></a></li></ul></div></div><div id=toggle-menu><span class=site-page><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id=post-info><h1 class=post-title>Python concurrent.future 使用教程及源码初剖<a class=post-edit-link href=https://github.com/Zheaoli/Zheaoli.github.io/edit/main/source/_posts/something-about-concurrent-future.md rel="external nofollow noreferrer" title=Edit target=_blank><i class="fas fa-pencil-alt"></i></a></h1><div id=post-meta><div class=meta-firstline><span class=post-meta-date><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class=post-meta-label>Created</span><time datetime=2017-11-27T16:09:54.000Z title="Created 2017-11-28 00:09:54">2017-11-28</time></span><span class=post-meta-categories><span class=post-meta-separator>|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class=post-meta-categories href=/categories/%E7%BC%96%E7%A8%8B/ >编程</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class=post-meta-categories href=/categories/%E7%BC%96%E7%A8%8B/Python/ >Python</a></span></div><div class=meta-secondline><span class=post-meta-separator>|</span><span class=post-meta-wordcount><i class="far fa-file-word fa-fw post-meta-icon"></i><span class=post-meta-label>Word Count:</span><span class=word-count>6.1k</span><span class=post-meta-separator>|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class=post-meta-label>Reading Time:</span><span>27mins</span></span><span class=post-meta-separator>|</span><span class=post-meta-pv-cv id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class=post-meta-label>Post Views:</span><span id=busuanzi_value_page_pv><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class=layout id=content-inner><div id=post><article class="container post-content" id=article-container><div id=post-outdate-notice data="{&quot;limitDay&quot;:365,&quot;messagePrev&quot;:&quot;It has been&quot;,&quot;messageNext&quot;:&quot;days since the last update, the content of the article may be outdated.&quot;,&quot;postUpdate&quot;:&quot;2024-11-22 03:22:43&quot;}" hidden></div><h1 id=垃圾话><a href=#垃圾话 class=headerlink title=垃圾话></a>垃圾话</h1><p>很久没写博客了，想了想不能再划水，于是给自己定了一个目标，写点 <strong>concurrent.future</strong> 的内容，于是这篇文章就是来聊聊 Python 3.2 中新增的 <strong>concurrent.future</strong> 模块。</p><span id=more></span><h1 id=正文><a href=#正文 class=headerlink title=正文></a>正文</h1><h2 id=Python-的异步处理><a href=#Python-的异步处理 class=headerlink title="Python 的异步处理"></a>Python 的异步处理</h2><p>有一个 Python 开发工程师小明，在面试过程中，突然接到这样一个需求：去请求几个网站，拿到他们的数据，小明定睛一想，简单啊，噼里啪啦，他写了如下的代码</p><figure class="highlight python"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br></pre></td><td class=code><pre><span class=line></span><br><span class=line><span class=keyword>import</span> multiprocessing</span><br><span class=line><span class=keyword>import</span> time</span><br><span class=line></span><br><span class=line></span><br><span class=line><span class=keyword>def</span> <span class="title function_">request_url</span>(<span class=params>query_url: <span class=built_in>str</span></span>):</span><br><span class=line>    time.sleep(<span class=number>3</span>)  <span class=comment># 请求处理逻辑</span></span><br><span class=line></span><br><span class=line></span><br><span class=line><span class=keyword>if</span> __name__ == <span class=string>&#x27;__main__&#x27;</span>:</span><br><span class=line>    url_list = [<span class=string>&quot;abc.com&quot;</span>, <span class=string>&quot;xyz.com&quot;</span>]</span><br><span class=line>    task_list = [multiprocessing.Process(target=request_url, args=(url,)) <span class=keyword>for</span> url <span class=keyword>in</span> url_list]</span><br><span class=line>    [task.start() <span class=keyword>for</span> task <span class=keyword>in</span> task_list]</span><br><span class=line>    [task.join() <span class=keyword>for</span> task <span class=keyword>in</span> task_list]</span><br></pre></td></tr></table></figure><p>Easy, 好了，现在新的需求来了，我们想获取每一个请求结果，怎么办?小明想了想，又写出如下的代码</p><figure class="highlight python"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br></pre></td><td class=code><pre><span class=line></span><br><span class=line><span class=keyword>import</span> multiprocessing</span><br><span class=line><span class=keyword>import</span> time</span><br><span class=line></span><br><span class=line></span><br><span class=line><span class=keyword>def</span> <span class="title function_">request_url</span>(<span class=params>query_url: <span class=built_in>str</span>, result_dict: <span class=built_in>dict</span></span>):</span><br><span class=line>    time.sleep(<span class=number>3</span>)  <span class=comment># 请求处理逻辑</span></span><br><span class=line>    result_dict[query_url] = &#123;&#125;  <span class=comment># 返回结果</span></span><br><span class=line></span><br><span class=line></span><br><span class=line><span class=keyword>if</span> __name__ == <span class=string>&#x27;__main__&#x27;</span>:</span><br><span class=line>    process_manager = multiprocessing.Manager()</span><br><span class=line>    result_dict = process_manager.<span class=built_in>dict</span>()</span><br><span class=line>    url_list = [<span class=string>&quot;abc.com&quot;</span>, <span class=string>&quot;xyz.com&quot;</span>]</span><br><span class=line>    task_list = [multiprocessing.Process(target=request_url, args=(url, result_dict)) <span class=keyword>for</span> url <span class=keyword>in</span> url_list]</span><br><span class=line>    [task.start() <span class=keyword>for</span> task <span class=keyword>in</span> task_list]</span><br><span class=line>    [task.join() <span class=keyword>for</span> task <span class=keyword>in</span> task_list]</span><br><span class=line>    <span class=built_in>print</span>(result_dict)</span><br></pre></td></tr></table></figure><p>好了，面试官说，恩看起来不错，好了，我再改改题目，首先，我们不能阻塞主进程，主进程需要根据任务当前的状态（结束/未结束）来及时的获取对应的结果，怎么改？，小明想了想，要不，我们直接用信号量，让任务完成后，向父进程发送一个信号量？然后直接暴力出奇迹？还有更简单的方法么？貌似没了？最后面试官心理说了一句 naive ，脸上笑而不语，让小明回去慢慢等消息。</p><p>从小明的窘境，我们可以看出一个这样的问题，就是我们最常用的 <code>multiprocessing</code> 或者是 <code>threding</code> 两个模块，对于我们想实现异步任务的场景来说，其实略有一点不友好的，我们往往需要做一些额外的工作，才能比较干净的实现一些异步的需求。为了解决这样的窘境，09 年 10 月，Brian Quinlan 先生提出了 <a target=_blank rel="noopener external nofollow noreferrer" href=https://www.python.org/dev/peps/pep-3148/ >PEP 3148</a> ，在这个提案中，他提出将我们常用的 <code>multiprocessing</code> 和 <code>threding</code> 模块进行进一步封装，达成较好的支持异步操作的目的。最终这个提案在 Python 3.2 中被引入。也就是我们今天要聊聊的 <strong>concurrent.future</strong> 。</p><h2 id=Future-模式><a href=#Future-模式 class=headerlink title="Future 模式"></a>Future 模式</h2><p>在我们正式开始聊新模块之前，我们需要去了解关于 <code>Future</code> 模式的相关姿势</p><p>首先 <code>Future</code> 模式，是什么？</p><p><code>Future</code> 其实是<strong>生产-消费者</strong>模型的一种扩展，在<strong>生产-消费者</strong>模型中，生产者不关心消费者什么时候处理完数据，也不关心消费者处理的结果。比如我们经常写出如下的代码</p><figure class="highlight python"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br></pre></td><td class=code><pre><span class=line></span><br><span class=line><span class=keyword>import</span> multiprocessing, Queue</span><br><span class=line><span class=keyword>import</span> os</span><br><span class=line><span class=keyword>import</span> time</span><br><span class=line><span class=keyword>from</span> multiprocessing <span class=keyword>import</span> Process</span><br><span class=line><span class=keyword>from</span> time <span class=keyword>import</span> sleep</span><br><span class=line><span class=keyword>from</span> random <span class=keyword>import</span> randint</span><br><span class=line></span><br><span class=line><span class=keyword>class</span> <span class="title class_">Producer</span>(multiprocessing.Process):</span><br><span class=line>    <span class=keyword>def</span> <span class="title function_">__init__</span>(<span class=params>self, queue</span>):</span><br><span class=line>        multiprocessing.Process.__init__(<span class="variable language_">self</span>)</span><br><span class=line>        <span class="variable language_">self</span>.queue = queue</span><br><span class=line>        </span><br><span class=line>    <span class=keyword>def</span> <span class="title function_">run</span>(<span class=params>self</span>):</span><br><span class=line>        <span class=keyword>while</span> <span class=literal>True</span>:</span><br><span class=line>            <span class="variable language_">self</span>.queue.put(<span class=string>&#x27;one product&#x27;</span>)</span><br><span class=line>            <span class=built_in>print</span>(multiprocessing.current_process().name + <span class=built_in>str</span>(os.getpid()) + <span class=string>&#x27; produced one product, the no of queue now is: %d&#x27;</span> %<span class="variable language_">self</span>.queue.qsize())</span><br><span class=line>            sleep(randint(<span class=number>1</span>, <span class=number>3</span>))</span><br><span class=line>        </span><br><span class=line>        </span><br><span class=line><span class=keyword>class</span> <span class="title class_">Consumer</span>(multiprocessing.Process):</span><br><span class=line>    <span class=keyword>def</span> <span class="title function_">__init__</span>(<span class=params>self, queue</span>):</span><br><span class=line>        multiprocessing.Process.__init__(<span class="variable language_">self</span>)</span><br><span class=line>        <span class="variable language_">self</span>.queue = queue</span><br><span class=line>        </span><br><span class=line>    <span class=keyword>def</span> <span class="title function_">run</span>(<span class=params>self</span>):</span><br><span class=line>        <span class=keyword>while</span> <span class=literal>True</span>:</span><br><span class=line>            d = <span class="variable language_">self</span>.queue.get(<span class=number>1</span>)</span><br><span class=line>            <span class=keyword>if</span> d != <span class=literal>None</span>:</span><br><span class=line>                <span class=built_in>print</span>(multiprocessing.current_process().name + <span class=built_in>str</span>(os.getpid()) + <span class=string>&#x27; consumed  %s, the no of queue now is: %d&#x27;</span> %(d,<span class="variable language_">self</span>.queue.qsize()))</span><br><span class=line>                sleep(randint(<span class=number>1</span>, <span class=number>4</span>))</span><br><span class=line>                <span class=keyword>continue</span></span><br><span class=line>            <span class=keyword>else</span>:</span><br><span class=line>                <span class=keyword>break</span></span><br><span class=line>                </span><br><span class=line><span class=comment>#create queue</span></span><br><span class=line>queue = multiprocessing.Queue(<span class=number>40</span>)</span><br><span class=line>       </span><br><span class=line><span class=keyword>if</span> __name__ == <span class=string>&quot;__main__&quot;</span>:</span><br><span class=line>    <span class=built_in>print</span>(<span class=string>&#x27;Excited!&quot;)</span></span><br><span class=line><span class=string>    #create processes    </span></span><br><span class=line><span class=string>    processed = []</span></span><br><span class=line><span class=string>    for i in range(3):</span></span><br><span class=line><span class=string>        processed.append(Producer(queue))</span></span><br><span class=line><span class=string>        processed.append(Consumer(queue))</span></span><br><span class=line><span class=string>        </span></span><br><span class=line><span class=string>    #start processes        </span></span><br><span class=line><span class=string>    for i in range(len(processed)):</span></span><br><span class=line><span class=string>        processed[i].start()</span></span><br><span class=line><span class=string>    </span></span><br><span class=line><span class=string>    #join processes    </span></span><br><span class=line><span class=string>    for i in range(len(processed)):</span></span><br><span class=line><span class=string>        processed[i].join()  </span></span><br></pre></td></tr></table></figure><p>这就是<strong>生产-消费者</strong>模型的一个简单的实现，我们利用一个 <code>multiprocessing</code> 中的 <code>Queue</code> 来作为通信渠道，我们的生产者负责往队列中传入数据，消费者负责从队列中获取数据并处理。不过就如同上面所说的一样，在这种模式中，生产者并不关心消费者何时处理完数据，也不关心处理的结果。而在 <code>Future</code> 中，我们可以让生产者等待消息处理完成，如果需要的话，我们还可以获取相关的计算结果。</p><p>比如，大家可以看看下面这样一段 Java 代码</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br></pre></td><td class=code><pre><span class=line><span class=keyword>package</span> concurrent;</span><br><span class=line></span><br><span class=line><span class=keyword>import</span> java.util.concurrent.Callable;</span><br><span class=line></span><br><span class=line><span class=keyword>public</span> <span class=keyword>class</span> <span class="title class_">DataProcessThread</span> <span class=keyword>implements</span> <span class="title class_">Callable</span>&lt;String&gt; &#123;</span><br><span class=line></span><br><span class=line>	<span class=meta>@Override</span></span><br><span class=line>	<span class=keyword>public</span> String <span class="title function_">call</span><span class=params>()</span> <span class=keyword>throws</span> Exception &#123;</span><br><span class=line>		<span class=comment>// TODO Auto-generated method stub</span></span><br><span class=line>		Thread.sleep(<span class=number>10000</span>);<span class=comment>//模拟数据处理</span></span><br><span class=line>		<span class=keyword>return</span> <span class=string>&quot;数据返回&quot;</span>;</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>这是我们负责处理数据的代码。</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br></pre></td><td class=code><pre><span class=line></span><br><span class=line><span class=keyword>package</span> concurrent;</span><br><span class=line></span><br><span class=line><span class=keyword>import</span> java.util.concurrent.ExecutionException;</span><br><span class=line><span class=keyword>import</span> java.util.concurrent.ExecutorService;</span><br><span class=line><span class=keyword>import</span> java.util.concurrent.Executors;</span><br><span class=line><span class=keyword>import</span> java.util.concurrent.FutureTask;</span><br><span class=line></span><br><span class=line><span class=keyword>public</span> <span class=keyword>class</span> <span class="title class_">MainThread</span> &#123;</span><br><span class=line></span><br><span class=line>	<span class=keyword>public</span> <span class=keyword>static</span> <span class=keyword>void</span> <span class="title function_">main</span><span class=params>(String[] args)</span> <span class=keyword>throws</span> InterruptedException,</span><br><span class=line>			ExecutionException &#123;</span><br><span class=line>		<span class=comment>// TODO Auto-generated method stub</span></span><br><span class=line>		<span class=type>DataProcessThread</span> <span class=variable>dataProcessThread</span> <span class=operator>=</span> <span class=keyword>new</span> <span class="title class_">DataProcessThread</span>();</span><br><span class=line>		FutureTask&lt;String&gt; future = <span class=keyword>new</span> <span class="title class_">FutureTask</span>&lt;String&gt;(dataProcessThread);</span><br><span class=line></span><br><span class=line>		<span class=type>ExecutorService</span> <span class=variable>executor</span> <span class=operator>=</span> Executors.newFixedThreadPool(<span class=number>1</span>);</span><br><span class=line>		executor.submit(future);</span><br><span class=line></span><br><span class=line>		Thread.sleep(<span class=number>10000</span>);<span class=comment>//模拟继续处理自身其他业务</span></span><br><span class=line>		<span class=keyword>while</span> (<span class=literal>true</span>) &#123;</span><br><span class=line>			<span class=keyword>if</span> (future.isDone()) &#123;</span><br><span class=line>				System.out.println(future.get());</span><br><span class=line>				<span class=keyword>break</span>;</span><br><span class=line>			&#125;</span><br><span class=line>		&#125;</span><br><span class=line>		executor.shutdown();</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>&#125;</span><br><span class=line></span><br></pre></td></tr></table></figure><p>这是我们主线程，大家可以看到，我们可以很方便的获取数据处理任务的状态。同时获取相关的结果。</p><h2 id=Python-中的-concurrent-futures><a href=#Python-中的-concurrent-futures class=headerlink title="Python 中的 concurrent.futures"></a>Python 中的 concurrent.futures</h2><p>前面说了，在 Python 3.2 以后，<strong>concurrent.futures</strong>　是内置的模块，我们可以直接使用</p><blockquote><p><strong>Note</strong>: 如果你需要在 Python 2.7 中使用 <strong>concurrent.futures</strong> , 那么请用 pip 进行安装，<code>pip install futures</code></p></blockquote><p>好了，准备就绪后，我们来看看怎么使用这个东西呢</p><figure class="highlight python"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br></pre></td><td class=code><pre><span class=line></span><br><span class=line><span class=keyword>from</span> concurrent.futures <span class=keyword>import</span> ProcessPoolExecutor</span><br><span class=line><span class=keyword>import</span> time</span><br><span class=line></span><br><span class=line></span><br><span class=line><span class=keyword>def</span> <span class="title function_">return_future_result</span>(<span class=params>message</span>):</span><br><span class=line>    time.sleep(<span class=number>2</span>)</span><br><span class=line>    <span class=keyword>return</span> message</span><br><span class=line></span><br><span class=line></span><br><span class=line><span class=keyword>if</span> __name__ == <span class=string>&#x27;__main__&#x27;</span>:</span><br><span class=line>    pool = ProcessPoolExecutor(max_workers=<span class=number>2</span>)  <span class=comment># 创建一个最大可容纳2个task的进程池</span></span><br><span class=line>    future1 = pool.submit(return_future_result, (<span class=string>&quot;hello&quot;</span>))  <span class=comment># 往进程池里面加入一个task</span></span><br><span class=line>    future2 = pool.submit(return_future_result, (<span class=string>&quot;world&quot;</span>))  <span class=comment># 往进程池里面加入一个task</span></span><br><span class=line>    <span class=built_in>print</span>(future1.done())  <span class=comment># 判断task1是否结束</span></span><br><span class=line>    time.sleep(<span class=number>3</span>)</span><br><span class=line>    <span class=built_in>print</span>(future2.done())  <span class=comment># 判断task2是否结束</span></span><br><span class=line>    <span class=built_in>print</span>(future1.result())  <span class=comment># 查看task1返回的结果</span></span><br><span class=line>    <span class=built_in>print</span>(future2.result())  <span class=comment># 查看task2返回的结果</span></span><br></pre></td></tr></table></figure><p>首先 <code>from concurrent.futures import ProcessPoolExecutor</code> 从 <code>concurrent.futures</code> 引入 <code>ProcessPoolExecutor</code> 作为我们的进程池，处理我们后面的数据。(在 <code>concurrent.futures</code> 中，为我们提供了两种 <code>Executor</code> ，一种是我们现在用的 <code>ProcessPoolExecutor</code>, 一种是 <code>ThreadPoolExecutor</code> 他们对外暴露的方法一致，大家可以根据自己的实际需求选用。)</p><p>紧接着，初始化一个最大容量为 2 的进程池。然后我们调用进程池中的 <code>submit</code> 方法提交一个任务。好了有意思的点来了，我们在调用 <code>submit</code> 方法后，得到了一个特殊的变量，这个变量是 <code>Future</code> 类的实例，代表着一个在未来完成的操作。换句话说，当 <code>submit</code> 返回 <code>Future</code> 实例的时候，我们的任务可能还没有完成，我们可以通过调用 <code>Future</code> 实例中的 <code>done</code> 方法来获取当前任务的运行状态，如果任务结束后，我们可以通过 <code>result</code> 方法来获取返回的结果。如果在执行后续的逻辑时，我们因为一些原因想要取消任务时，我们可以通过调用 <code>cancel</code> 方法来取消当前的任务。</p><p>现在新的问题来了，我们如果想要提交很多个任务应该怎么办呢？<code>concurrent.future</code> 为我们提供了 <code>map</code> 方法来方便我们批量添加任务。</p><figure class="highlight python"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br></pre></td><td class=code><pre><span class=line><span class=keyword>import</span> concurrent.futures</span><br><span class=line><span class=keyword>import</span> requests</span><br><span class=line></span><br><span class=line>task_url = [(<span class=string>&#x27;http://www.baidu.com&#x27;</span>, <span class=number>40</span>), (<span class=string>&#x27;http://example.com/&#x27;</span>, <span class=number>40</span>), (<span class=string>&#x27;https://www.github.com/&#x27;</span>, <span class=number>40</span>)]</span><br><span class=line></span><br><span class=line></span><br><span class=line><span class=keyword>def</span> <span class="title function_">load_url</span>(<span class=params>params: <span class=built_in>tuple</span></span>):</span><br><span class=line>    <span class=keyword>return</span> requests.get(params[<span class=number>0</span>], timeout=params[<span class=number>1</span>]).text</span><br><span class=line></span><br><span class=line></span><br><span class=line><span class=keyword>if</span> __name__ == <span class=string>&#x27;__main__&#x27;</span>:</span><br><span class=line>    <span class=keyword>with</span> concurrent.futures.ProcessPoolExecutor(max_workers=<span class=number>3</span>) <span class=keyword>as</span> executor:</span><br><span class=line>        <span class=keyword>for</span> url, data <span class=keyword>in</span> <span class=built_in>zip</span>(task_url, executor.<span class=built_in>map</span>(load_url, task_url)):</span><br><span class=line>            <span class=built_in>print</span>(<span class=string>&#x27;%r page is %d bytes&#x27;</span> % (url, <span class=built_in>len</span>(data)))</span><br><span class=line></span><br></pre></td></tr></table></figure><p>恩，<code>concurrent.future</code> 中线程/进程池所提供的 <code>map</code> 方法和标准库中的 <code>map</code> 函数使用方法一样。</p><h2 id=剖一下-concurrent-futures><a href=#剖一下-concurrent-futures class=headerlink title="剖一下 concurrent.futures"></a>剖一下 concurrent.futures</h2><p>前面讲了怎么使用 <code>concurrent.futures</code> 后，我们都比较好奇，<code>concurrent.futures</code> 是怎么实现 <code>Future</code> 模式的。里面是怎么将任务和结果进行关联的。我们现在开始从 <code>submit</code> 方法着手来简单看一下 <code>ProcessPoolExecutor</code> 的实现。</p><p>首先，在初始化 <code>ProcessPoolExecutor</code> 时，它的 <code>__init__</code> 方法中进行了一些关键变量的初始化操作。</p><figure class="highlight python"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br></pre></td><td class=code><pre><span class=line></span><br><span class=line><span class=keyword>class</span> <span class="title class_">ProcessPoolExecutor</span>(_base.Executor):</span><br><span class=line>    <span class=keyword>def</span> <span class="title function_">__init__</span>(<span class=params>self, max_workers=<span class=literal>None</span></span>):</span><br><span class=line>        <span class=string>&quot;&quot;&quot;Initializes a new ProcessPoolExecutor instance.</span></span><br><span class=line><span class=string></span></span><br><span class=line><span class=string>        Args:</span></span><br><span class=line><span class=string>            max_workers: The maximum number of processes that can be used to</span></span><br><span class=line><span class=string>                execute the given calls. If None or not given then as many</span></span><br><span class=line><span class=string>                worker processes will be created as the machine has processors.</span></span><br><span class=line><span class=string>        &quot;&quot;&quot;</span></span><br><span class=line>        _check_system_limits()</span><br><span class=line></span><br><span class=line>        <span class=keyword>if</span> max_workers <span class=keyword>is</span> <span class=literal>None</span>:</span><br><span class=line>            <span class="variable language_">self</span>._max_workers = os.cpu_count() <span class=keyword>or</span> <span class=number>1</span></span><br><span class=line>        <span class=keyword>else</span>:</span><br><span class=line>            <span class=keyword>if</span> max_workers &lt;= <span class=number>0</span>:</span><br><span class=line>                <span class=keyword>raise</span> ValueError(<span class=string>&quot;max_workers must be greater than 0&quot;</span>)</span><br><span class=line></span><br><span class=line>            <span class="variable language_">self</span>._max_workers = max_workers</span><br><span class=line></span><br><span class=line>        <span class=comment># Make the call queue slightly larger than the number of processes to</span></span><br><span class=line>        <span class=comment># prevent the worker processes from idling. But don&#x27;t make it too big</span></span><br><span class=line>        <span class=comment># because futures in the call queue cannot be cancelled.</span></span><br><span class=line>        <span class="variable language_">self</span>._call_queue = multiprocessing.Queue(<span class="variable language_">self</span>._max_workers +</span><br><span class=line>                                                 EXTRA_QUEUED_CALLS)</span><br><span class=line>        <span class=comment># Killed worker processes can produce spurious &quot;broken pipe&quot;</span></span><br><span class=line>        <span class=comment># tracebacks in the queue&#x27;s own worker thread. But we detect killed</span></span><br><span class=line>        <span class=comment># processes anyway, so silence the tracebacks.</span></span><br><span class=line>        <span class="variable language_">self</span>._call_queue._ignore_epipe = <span class=literal>True</span></span><br><span class=line>        <span class="variable language_">self</span>._result_queue = SimpleQueue()</span><br><span class=line>        <span class="variable language_">self</span>._work_ids = queue.Queue()</span><br><span class=line>        <span class="variable language_">self</span>._queue_management_thread = <span class=literal>None</span></span><br><span class=line>        <span class=comment># Map of pids to processes</span></span><br><span class=line>        <span class="variable language_">self</span>._processes = &#123;&#125;</span><br><span class=line></span><br><span class=line>        <span class=comment># Shutdown is a two-step process.</span></span><br><span class=line>        <span class="variable language_">self</span>._shutdown_thread = <span class=literal>False</span></span><br><span class=line>        <span class="variable language_">self</span>._shutdown_lock = threading.Lock()</span><br><span class=line>        <span class="variable language_">self</span>._broken = <span class=literal>False</span></span><br><span class=line>        <span class="variable language_">self</span>._queue_count = <span class=number>0</span></span><br><span class=line>        <span class="variable language_">self</span>._pending_work_items = &#123;&#125;</span><br></pre></td></tr></table></figure><p>好了，我们来看看我们今天的入口 <code>submit</code> 方法</p><figure class="highlight python"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br></pre></td><td class=code><pre><span class=line></span><br><span class=line><span class=keyword>def</span> <span class="title function_">submit</span>(<span class=params>self, fn, *args, **kwargs</span>):</span><br><span class=line>    <span class=keyword>with</span> <span class="variable language_">self</span>._shutdown_lock:</span><br><span class=line>        <span class=keyword>if</span> <span class="variable language_">self</span>._broken:</span><br><span class=line>            <span class=keyword>raise</span> BrokenProcessPool(<span class=string>&#x27;A child process terminated &#x27;</span></span><br><span class=line>                <span class=string>&#x27;abruptly, the process pool is not usable anymore&#x27;</span>)</span><br><span class=line>        <span class=keyword>if</span> <span class="variable language_">self</span>._shutdown_thread:</span><br><span class=line>            <span class=keyword>raise</span> RuntimeError(<span class=string>&#x27;cannot schedule new futures after shutdown&#x27;</span>)</span><br><span class=line>        f = _base.Future()</span><br><span class=line>        w = _WorkItem(f, fn, args, kwargs)</span><br><span class=line>        <span class="variable language_">self</span>._pending_work_items[<span class="variable language_">self</span>._queue_count] = w</span><br><span class=line>        <span class="variable language_">self</span>._work_ids.put(<span class="variable language_">self</span>._queue_count)</span><br><span class=line>        <span class="variable language_">self</span>._queue_count += <span class=number>1</span></span><br><span class=line>        <span class=comment># Wake up queue management thread</span></span><br><span class=line>        <span class="variable language_">self</span>._result_queue.put(<span class=literal>None</span>)</span><br><span class=line>        <span class="variable language_">self</span>._start_queue_management_thread()</span><br><span class=line>        <span class=keyword>return</span> f</span><br></pre></td></tr></table></figure><p>首先，传入的参数 <code>fn</code> 是我们的处理函数，<code>args</code> 以及 <code>kwargs</code> 是我们要传递 <code>fn</code> 函数的参数。在 <code>submit</code> 函数最开始，首先根据 <code>_broken</code> 和 <code>_shutdown_thread</code> 的值来判断当前进程池中处理进程的状态以及目前进程池的状态。如果处理进程突然被销毁或者进程池已经被关闭，那么将抛出异常表明目前不再接受新的 <code>submit</code> 操作。</p><p>如果前面状态没有问题，首先，实例化 <code>Future</code> 类，然后将这个实例和处理函数和相关参数一起，作为参数来实例化 <code>_WorkItem</code> 类，然后将实例 w 作为 value ，<code>_queue_count</code> 作为 key 存入 <code>_pending_work_items</code> 中。然后调用 <code>_start_queue_management_thread</code> 方法开启进程池中的管理线程。现在来看看这部分代码</p><figure class="highlight python"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br></pre></td><td class=code><pre><span class=line></span><br><span class=line><span class=keyword>def</span> <span class="title function_">_start_queue_management_thread</span>(<span class=params>self</span>):</span><br><span class=line>    <span class=comment># When the executor gets lost, the weakref callback will wake up</span></span><br><span class=line>    <span class=comment># the queue management thread.</span></span><br><span class=line>    <span class=keyword>def</span> <span class="title function_">weakref_cb</span>(<span class=params>_, q=self._result_queue</span>):</span><br><span class=line>        q.put(<span class=literal>None</span>)</span><br><span class=line></span><br><span class=line>    <span class=keyword>if</span> <span class="variable language_">self</span>._queue_management_thread <span class=keyword>is</span> <span class=literal>None</span>:</span><br><span class=line>        <span class=comment># Start the processes so that their sentinels are known.</span></span><br><span class=line>        <span class="variable language_">self</span>._adjust_process_count()</span><br><span class=line>        <span class="variable language_">self</span>._queue_management_thread = threading.Thread(</span><br><span class=line>            target=_queue_management_worker,</span><br><span class=line>            args=(weakref.ref(<span class="variable language_">self</span>, weakref_cb),</span><br><span class=line>                  <span class="variable language_">self</span>._processes,</span><br><span class=line>                  <span class="variable language_">self</span>._pending_work_items,</span><br><span class=line>                  <span class="variable language_">self</span>._work_ids,</span><br><span class=line>                  <span class="variable language_">self</span>._call_queue,</span><br><span class=line>                  <span class="variable language_">self</span>._result_queue))</span><br><span class=line>        <span class="variable language_">self</span>._queue_management_thread.daemon = <span class=literal>True</span></span><br><span class=line>        <span class="variable language_">self</span>._queue_management_thread.start()</span><br><span class=line>        _threads_queues[<span class="variable language_">self</span>._queue_management_thread] = <span class="variable language_">self</span>._result_queue</span><br></pre></td></tr></table></figure><p>这一部分很简单，首先运行 <code>_adjust_process_count</code> 方法，然后开启一个守护线程，运行 <code>_queue_management_worker</code> 方法。我们首先来看看 <code>_adjust_process_count</code> 方法。</p><figure class="highlight python"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre></td><td class=code><pre><span class=line><span class=keyword>def</span> <span class="title function_">_adjust_process_count</span>(<span class=params>self</span>):</span><br><span class=line>    <span class=keyword>for</span> _ <span class=keyword>in</span> <span class=built_in>range</span>(<span class=built_in>len</span>(<span class="variable language_">self</span>._processes), <span class="variable language_">self</span>._max_workers):</span><br><span class=line>        p = multiprocessing.Process(</span><br><span class=line>                target=_process_worker,</span><br><span class=line>                args=(<span class="variable language_">self</span>._call_queue,</span><br><span class=line>                      <span class="variable language_">self</span>._result_queue))</span><br><span class=line>        p.start()</span><br><span class=line>        <span class="variable language_">self</span>._processes[p.pid] = p</span><br></pre></td></tr></table></figure><p>根据在 <code>__init__</code> 方法中设定的 <code>_max_workers</code> 来开启对应数量的进程，在进程中运行 <code>_process_worker</code> 函数。</p><p>恩，顺藤摸瓜，我们先来看看 <code>_process_worker</code> 函数吧？</p><figure class="highlight python"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br></pre></td><td class=code><pre><span class=line></span><br><span class=line><span class=keyword>def</span> <span class="title function_">_process_worker</span>(<span class=params>call_queue, result_queue</span>):</span><br><span class=line>    <span class=string>&quot;&quot;&quot;Evaluates calls from call_queue and places the results in result_queue.</span></span><br><span class=line><span class=string></span></span><br><span class=line><span class=string>    This worker is run in a separate process.</span></span><br><span class=line><span class=string></span></span><br><span class=line><span class=string>    Args:</span></span><br><span class=line><span class=string>        call_queue: A multiprocessing.Queue of _CallItems that will be read and</span></span><br><span class=line><span class=string>            evaluated by the worker.</span></span><br><span class=line><span class=string>        result_queue: A multiprocessing.Queue of _ResultItems that will written</span></span><br><span class=line><span class=string>            to by the worker.</span></span><br><span class=line><span class=string>        shutdown: A multiprocessing.Event that will be set as a signal to the</span></span><br><span class=line><span class=string>            worker that it should exit when call_queue is empty.</span></span><br><span class=line><span class=string>    &quot;&quot;&quot;</span></span><br><span class=line>    <span class=keyword>while</span> <span class=literal>True</span>:</span><br><span class=line>        call_item = call_queue.get(block=<span class=literal>True</span>)</span><br><span class=line>        <span class=keyword>if</span> call_item <span class=keyword>is</span> <span class=literal>None</span>:</span><br><span class=line>            <span class=comment># Wake up queue management thread</span></span><br><span class=line>            result_queue.put(os.getpid())</span><br><span class=line>            <span class=keyword>return</span></span><br><span class=line>        <span class=keyword>try</span>:</span><br><span class=line>            r = call_item.fn(*call_item.args, **call_item.kwargs)</span><br><span class=line>        <span class=keyword>except</span> BaseException <span class=keyword>as</span> e:</span><br><span class=line>            exc = _ExceptionWithTraceback(e, e.__traceback__)</span><br><span class=line>            result_queue.put(_ResultItem(call_item.work_id, exception=exc))</span><br><span class=line>        <span class=keyword>else</span>:</span><br><span class=line>            result_queue.put(_ResultItem(call_item.work_id,</span><br><span class=line>                                         result=r))</span><br></pre></td></tr></table></figure><p>首先，这里搞了一个死循环，紧接着，我们从 <code>call_queue</code> 队列中获取一个 <code>_WorkItem</code> 实例，然后如果获取的值为 <code>None</code> 的话，那么证明没有新的任务进来了，我们可以把当前进程的 <code>pid</code> 放入结果队列中。然后结束进程。</p><p>如果收到了任务，那么执行这个任务。不管是在执行过程中发生异常，亦或者是得到最终的结果，都将其封装为 <code>_ResultItem</code> 实例，并将其放入结果队列中。</p><p>好了，我们回到刚刚看了一半的 <code>_start_queue_management_thread</code> 函数，</p><figure class="highlight python"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br></pre></td><td class=code><pre><span class=line></span><br><span class=line><span class=keyword>def</span> <span class="title function_">_start_queue_management_thread</span>(<span class=params>self</span>):</span><br><span class=line>    <span class=comment># When the executor gets lost, the weakref callback will wake up</span></span><br><span class=line>    <span class=comment># the queue management thread.</span></span><br><span class=line>    <span class=keyword>def</span> <span class="title function_">weakref_cb</span>(<span class=params>_, q=self._result_queue</span>):</span><br><span class=line>        q.put(<span class=literal>None</span>)</span><br><span class=line></span><br><span class=line>    <span class=keyword>if</span> <span class="variable language_">self</span>._queue_management_thread <span class=keyword>is</span> <span class=literal>None</span>:</span><br><span class=line>        <span class=comment># Start the processes so that their sentinels are known.</span></span><br><span class=line>        <span class="variable language_">self</span>._adjust_process_count()</span><br><span class=line>        <span class="variable language_">self</span>._queue_management_thread = threading.Thread(</span><br><span class=line>            target=_queue_management_worker,</span><br><span class=line>            args=(weakref.ref(<span class="variable language_">self</span>, weakref_cb),</span><br><span class=line>                  <span class="variable language_">self</span>._processes,</span><br><span class=line>                  <span class="variable language_">self</span>._pending_work_items,</span><br><span class=line>                  <span class="variable language_">self</span>._work_ids,</span><br><span class=line>                  <span class="variable language_">self</span>._call_queue,</span><br><span class=line>                  <span class="variable language_">self</span>._result_queue))</span><br><span class=line>        <span class="variable language_">self</span>._queue_management_thread.daemon = <span class=literal>True</span></span><br><span class=line>        <span class="variable language_">self</span>._queue_management_thread.start()</span><br><span class=line>        _threads_queues[<span class="variable language_">self</span>._queue_management_thread] = <span class="variable language_">self</span>._result_queue</span><br></pre></td></tr></table></figure><p>在执行完 <code>_adjust_process_count</code> 函数后，我们进程池中的 <code>_processes</code> 变量（它是一个 dict ）便关联了一些处理进程。然后我们开启一个后台守护线程，来执行 <code>_queue_management_worker</code> 函数，我们给它传了几个变量，首先 <code>_processes</code> 是我们的进程映射，<code>_pending_work_items</code> 中存放着我们待处理任务，还有 <code>_call_queue</code> 和 <code>_result_queue</code> 。好了还有一个参数大家可能不太理解，就是 <code>weakref.ref(self, weakref_cb)</code> 这货。</p><p>首先，Python 是一门具有垃圾回收机制的语言，有着 GC (Garbage Collection) 机制意味着我们在大多数时候，不太需要去关注内存的分配与回收。在 Python 中，什么时候对象会被回收是由其引用计数所决定的。当引用计数为 0 的时候，这个对象会被回收。在有一些情况下，我们对象因为交叉引用或者其余的一些原因，造成引用计数始终不为0，这意味着这个对象无法被回收。造成内存泄露<br>。因此区别于我们普通的引用，Python 中新增了一个引用机制叫做弱引用，弱引用的意义在于，某个变量持有一个对象，却不会增加这个对象的引用计数。因此 <code>weakref.ref(self, weakref_cb)</code> 在大多数而言，等价于 <code>self</code> （至于这里为什么要使用弱引用，我们这里先不讲，会开一个单章来说）</p><p>好了，这一部分代码看完，我们来看看，<code>_queue_management_worker</code> 怎么实现的</p><figure class="highlight python"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br><span class=line>65</span><br><span class=line>66</span><br><span class=line>67</span><br><span class=line>68</span><br><span class=line>69</span><br><span class=line>70</span><br><span class=line>71</span><br><span class=line>72</span><br><span class=line>73</span><br><span class=line>74</span><br><span class=line>75</span><br><span class=line>76</span><br><span class=line>77</span><br><span class=line>78</span><br><span class=line>79</span><br><span class=line>80</span><br><span class=line>81</span><br><span class=line>82</span><br><span class=line>83</span><br><span class=line>84</span><br><span class=line>85</span><br><span class=line>86</span><br><span class=line>87</span><br><span class=line>88</span><br><span class=line>89</span><br><span class=line>90</span><br><span class=line>91</span><br><span class=line>92</span><br><span class=line>93</span><br><span class=line>94</span><br><span class=line>95</span><br><span class=line>96</span><br><span class=line>97</span><br><span class=line>98</span><br><span class=line>99</span><br><span class=line>100</span><br><span class=line>101</span><br><span class=line>102</span><br><span class=line>103</span><br><span class=line>104</span><br><span class=line>105</span><br><span class=line>106</span><br><span class=line>107</span><br><span class=line>108</span><br><span class=line>109</span><br><span class=line>110</span><br><span class=line>111</span><br><span class=line>112</span><br><span class=line>113</span><br><span class=line>114</span><br><span class=line>115</span><br></pre></td><td class=code><pre><span class=line></span><br><span class=line><span class=keyword>def</span> <span class="title function_">_queue_management_worker</span>(<span class=params>executor_reference,</span></span><br><span class=line><span class=params>                             processes,</span></span><br><span class=line><span class=params>                             pending_work_items,</span></span><br><span class=line><span class=params>                             work_ids_queue,</span></span><br><span class=line><span class=params>                             call_queue,</span></span><br><span class=line><span class=params>                             result_queue</span>):</span><br><span class=line>    <span class=string>&quot;&quot;&quot;Manages the communication between this process and the worker processes.</span></span><br><span class=line><span class=string></span></span><br><span class=line><span class=string>    This function is run in a local thread.</span></span><br><span class=line><span class=string></span></span><br><span class=line><span class=string>        executor_reference: A weakref.ref to the ProcessPoolExecutor that owns</span></span><br><span class=line><span class=string>    Args:</span></span><br><span class=line><span class=string>        process: A list of the multiprocessing.Process instances used as</span></span><br><span class=line><span class=string>            this thread. Used to determine if the ProcessPoolExecutor has been</span></span><br><span class=line><span class=string>            garbage collected and that this function can exit.</span></span><br><span class=line><span class=string>            workers.</span></span><br><span class=line><span class=string>        pending_work_items: A dict mapping work ids to _WorkItems e.g.</span></span><br><span class=line><span class=string>            &#123;5: &lt;_WorkItem...&gt;, 6: &lt;_WorkItem...&gt;, ...&#125;</span></span><br><span class=line><span class=string>        work_ids_queue: A queue.Queue of work ids e.g. Queue([5, 6, ...]).</span></span><br><span class=line><span class=string>        call_queue: A multiprocessing.Queue that will be filled with _CallItems</span></span><br><span class=line><span class=string>            derived from _WorkItems for processing by the process workers.</span></span><br><span class=line><span class=string>        result_queue: A multiprocessing.Queue of _ResultItems generated by the</span></span><br><span class=line><span class=string>            process workers.</span></span><br><span class=line><span class=string>    &quot;&quot;&quot;</span></span><br><span class=line>    executor = <span class=literal>None</span></span><br><span class=line></span><br><span class=line>    <span class=keyword>def</span> <span class="title function_">shutting_down</span>():</span><br><span class=line>        <span class=keyword>return</span> _shutdown <span class=keyword>or</span> executor <span class=keyword>is</span> <span class=literal>None</span> <span class=keyword>or</span> executor._shutdown_thread</span><br><span class=line></span><br><span class=line>    <span class=keyword>def</span> <span class="title function_">shutdown_worker</span>():</span><br><span class=line>        <span class=comment># This is an upper bound</span></span><br><span class=line>        nb_children_alive = <span class=built_in>sum</span>(p.is_alive() <span class=keyword>for</span> p <span class=keyword>in</span> processes.values())</span><br><span class=line>        <span class=keyword>for</span> i <span class=keyword>in</span> <span class=built_in>range</span>(<span class=number>0</span>, nb_children_alive):</span><br><span class=line>            call_queue.put_nowait(<span class=literal>None</span>)</span><br><span class=line>        <span class=comment># Release the queue&#x27;s resources as soon as possible.</span></span><br><span class=line>        call_queue.close()</span><br><span class=line>        <span class=comment># If .join() is not called on the created processes then</span></span><br><span class=line>        <span class=comment># some multiprocessing.Queue methods may deadlock on Mac OS X.</span></span><br><span class=line>        <span class=keyword>for</span> p <span class=keyword>in</span> processes.values():</span><br><span class=line>            p.join()</span><br><span class=line></span><br><span class=line>    reader = result_queue._reader</span><br><span class=line></span><br><span class=line>    <span class=keyword>while</span> <span class=literal>True</span>:</span><br><span class=line>        _add_call_item_to_queue(pending_work_items,</span><br><span class=line>                                work_ids_queue,</span><br><span class=line>                                call_queue)</span><br><span class=line></span><br><span class=line>        sentinels = [p.sentinel <span class=keyword>for</span> p <span class=keyword>in</span> processes.values()]</span><br><span class=line>        <span class=keyword>assert</span> sentinels</span><br><span class=line>        ready = wait([reader] + sentinels)</span><br><span class=line>        <span class=keyword>if</span> reader <span class=keyword>in</span> ready:</span><br><span class=line>            result_item = reader.recv()</span><br><span class=line>        <span class=keyword>else</span>:</span><br><span class=line>            <span class=comment># Mark the process pool broken so that submits fail right now.</span></span><br><span class=line>            executor = executor_reference()</span><br><span class=line>            <span class=keyword>if</span> executor <span class=keyword>is</span> <span class=keyword>not</span> <span class=literal>None</span>:</span><br><span class=line>                executor._broken = <span class=literal>True</span></span><br><span class=line>                executor._shutdown_thread = <span class=literal>True</span></span><br><span class=line>                executor = <span class=literal>None</span></span><br><span class=line>            <span class=comment># All futures in flight must be marked failed</span></span><br><span class=line>            <span class=keyword>for</span> work_id, work_item <span class=keyword>in</span> pending_work_items.items():</span><br><span class=line>                work_item.future.set_exception(</span><br><span class=line>                    BrokenProcessPool(</span><br><span class=line>                        <span class=string>&quot;A process in the process pool was &quot;</span></span><br><span class=line>                        <span class=string>&quot;terminated abruptly while the future was &quot;</span></span><br><span class=line>                        <span class=string>&quot;running or pending.&quot;</span></span><br><span class=line>                    ))</span><br><span class=line>                <span class=comment># Delete references to object. See issue16284</span></span><br><span class=line>                <span class=keyword>del</span> work_item</span><br><span class=line>            pending_work_items.clear()</span><br><span class=line>            <span class=comment># Terminate remaining workers forcibly: the queues or their</span></span><br><span class=line>            <span class=comment># locks may be in a dirty state and block forever.</span></span><br><span class=line>            <span class=keyword>for</span> p <span class=keyword>in</span> processes.values():</span><br><span class=line>                p.terminate()</span><br><span class=line>            shutdown_worker()</span><br><span class=line>            <span class=keyword>return</span></span><br><span class=line>        <span class=keyword>if</span> <span class=built_in>isinstance</span>(result_item, <span class=built_in>int</span>):</span><br><span class=line>            <span class=comment># Clean shutdown of a worker using its PID</span></span><br><span class=line>            <span class=comment># (avoids marking the executor broken)</span></span><br><span class=line>            <span class=keyword>assert</span> shutting_down()</span><br><span class=line>            p = processes.pop(result_item)</span><br><span class=line>            p.join()</span><br><span class=line>            <span class=keyword>if</span> <span class=keyword>not</span> processes:</span><br><span class=line>                shutdown_worker()</span><br><span class=line>                <span class=keyword>return</span></span><br><span class=line>        <span class=keyword>elif</span> result_item <span class=keyword>is</span> <span class=keyword>not</span> <span class=literal>None</span>:</span><br><span class=line>            work_item = pending_work_items.pop(result_item.work_id, <span class=literal>None</span>)</span><br><span class=line>            <span class=comment># work_item can be None if another process terminated (see above)</span></span><br><span class=line>            <span class=keyword>if</span> work_item <span class=keyword>is</span> <span class=keyword>not</span> <span class=literal>None</span>:</span><br><span class=line>                <span class=keyword>if</span> result_item.exception:</span><br><span class=line>                    work_item.future.set_exception(result_item.exception)</span><br><span class=line>                <span class=keyword>else</span>:</span><br><span class=line>                    work_item.future.set_result(result_item.result)</span><br><span class=line>                <span class=comment># Delete references to object. See issue16284</span></span><br><span class=line>                <span class=keyword>del</span> work_item</span><br><span class=line>        <span class=comment># Check whether we should start shutting down.</span></span><br><span class=line>        executor = executor_reference()</span><br><span class=line>        <span class=comment># No more work items can be added if:</span></span><br><span class=line>        <span class=comment>#   - The interpreter is shutting down OR</span></span><br><span class=line>        <span class=comment>#   - The executor that owns this worker has been collected OR</span></span><br><span class=line>        <span class=comment>#   - The executor that owns this worker has been shutdown.</span></span><br><span class=line>        <span class=keyword>if</span> shutting_down():</span><br><span class=line>            <span class=keyword>try</span>:</span><br><span class=line>                <span class=comment># Since no new work items can be added, it is safe to shutdown</span></span><br><span class=line>                <span class=comment># this thread if there are no pending work items.</span></span><br><span class=line>                <span class=keyword>if</span> <span class=keyword>not</span> pending_work_items:</span><br><span class=line>                    shutdown_worker()</span><br><span class=line>                    <span class=keyword>return</span></span><br><span class=line>            <span class=keyword>except</span> Full:</span><br><span class=line>                <span class=comment># This is not a problem: we will eventually be woken up (in</span></span><br><span class=line>                <span class=comment># result_queue.get()) and be able to send a sentinel again.</span></span><br><span class=line>                <span class=keyword>pass</span></span><br><span class=line>        executor = <span class=literal>None</span></span><br></pre></td></tr></table></figure><p>熟悉的大循环，循环的第一步，利用 <code>_add_call_item_to_queue</code> 函数来将等待队列中的任务加入到调用队列中去，先来看看这一部分代码</p><figure class="highlight python"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br></pre></td><td class=code><pre><span class=line><span class=keyword>def</span> <span class="title function_">_add_call_item_to_queue</span>(<span class=params>pending_work_items,</span></span><br><span class=line><span class=params>                            work_ids,</span></span><br><span class=line><span class=params>                            call_queue</span>):</span><br><span class=line>    <span class=string>&quot;&quot;&quot;Fills call_queue with _WorkItems from pending_work_items.</span></span><br><span class=line><span class=string></span></span><br><span class=line><span class=string>    This function never blocks.</span></span><br><span class=line><span class=string></span></span><br><span class=line><span class=string>    Args:</span></span><br><span class=line><span class=string>        pending_work_items: A dict mapping work ids to _WorkItems e.g.</span></span><br><span class=line><span class=string>            &#123;5: &lt;_WorkItem...&gt;, 6: &lt;_WorkItem...&gt;, ...&#125;</span></span><br><span class=line><span class=string>        work_ids: A queue.Queue of work ids e.g. Queue([5, 6, ...]). Work ids</span></span><br><span class=line><span class=string>            are consumed and the corresponding _WorkItems from</span></span><br><span class=line><span class=string>            pending_work_items are transformed into _CallItems and put in</span></span><br><span class=line><span class=string>            call_queue.</span></span><br><span class=line><span class=string>        call_queue: A multiprocessing.Queue that will be filled with _CallItems</span></span><br><span class=line><span class=string>            derived from _WorkItems.</span></span><br><span class=line><span class=string>    &quot;&quot;&quot;</span></span><br><span class=line>    <span class=keyword>while</span> <span class=literal>True</span>:</span><br><span class=line>        <span class=keyword>if</span> call_queue.full():</span><br><span class=line>            <span class=keyword>return</span></span><br><span class=line>        <span class=keyword>try</span>:</span><br><span class=line>            work_id = work_ids.get(block=<span class=literal>False</span>)</span><br><span class=line>        <span class=keyword>except</span> queue.Empty:</span><br><span class=line>            <span class=keyword>return</span></span><br><span class=line>        <span class=keyword>else</span>:</span><br><span class=line>            work_item = pending_work_items[work_id]</span><br><span class=line></span><br><span class=line>            <span class=keyword>if</span> work_item.future.set_running_or_notify_cancel():</span><br><span class=line>                call_queue.put(_CallItem(work_id,</span><br><span class=line>                                         work_item.fn,</span><br><span class=line>                                         work_item.args,</span><br><span class=line>                                         work_item.kwargs),</span><br><span class=line>                               block=<span class=literal>True</span>)</span><br><span class=line>            <span class=keyword>else</span>:</span><br><span class=line>                <span class=keyword>del</span> pending_work_items[work_id]</span><br><span class=line>                <span class=keyword>continue</span></span><br></pre></td></tr></table></figure><p>首先，判断调用队列是不是已经满了，如果满了，则放弃这次循环。紧接着从 <code>work_id</code> 队列中取出，然后从等待任务中取出对应的 <code>_WorkItem</code> 实例。紧接着，调用实例中绑定的 <code>Future</code> 实例的 <code>set_running_or_notify_cancel</code> 方法来设置任务的状态，紧接着将其扔入调用队列中。</p><figure class="highlight python"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br></pre></td><td class=code><pre><span class=line></span><br><span class=line><span class=keyword>def</span> <span class="title function_">set_running_or_notify_cancel</span>(<span class=params>self</span>):</span><br><span class=line>    <span class=string>&quot;&quot;&quot;Mark the future as running or process any cancel notifications.</span></span><br><span class=line><span class=string></span></span><br><span class=line><span class=string>    Should only be used by Executor implementations and unit tests.</span></span><br><span class=line><span class=string></span></span><br><span class=line><span class=string>    If the future has been cancelled (cancel() was called and returned</span></span><br><span class=line><span class=string>    True) then any threads waiting on the future completing (though calls</span></span><br><span class=line><span class=string>    to as_completed() or wait()) are notified and False is returned.</span></span><br><span class=line><span class=string></span></span><br><span class=line><span class=string>    If the future was not cancelled then it is put in the running state</span></span><br><span class=line><span class=string>    (future calls to running() will return True) and True is returned.</span></span><br><span class=line><span class=string></span></span><br><span class=line><span class=string>    This method should be called by Executor implementations before</span></span><br><span class=line><span class=string>    executing the work associated with this future. If this method returns</span></span><br><span class=line><span class=string>    False then the work should not be executed.</span></span><br><span class=line><span class=string></span></span><br><span class=line><span class=string>    Returns:</span></span><br><span class=line><span class=string>        False if the Future was cancelled, True otherwise.</span></span><br><span class=line><span class=string></span></span><br><span class=line><span class=string>    Raises:</span></span><br><span class=line><span class=string>        RuntimeError: if this method was already called or if set_result()</span></span><br><span class=line><span class=string>            or set_exception() was called.</span></span><br><span class=line><span class=string>    &quot;&quot;&quot;</span></span><br><span class=line>    <span class=keyword>with</span> <span class="variable language_">self</span>._condition:</span><br><span class=line>        <span class=keyword>if</span> <span class="variable language_">self</span>._state == CANCELLED:</span><br><span class=line>            <span class="variable language_">self</span>._state = CANCELLED_AND_NOTIFIED</span><br><span class=line>            <span class=keyword>for</span> waiter <span class=keyword>in</span> <span class="variable language_">self</span>._waiters:</span><br><span class=line>                waiter.add_cancelled(<span class="variable language_">self</span>)</span><br><span class=line>            <span class=comment># self._condition.notify_all() is not necessary because</span></span><br><span class=line>            <span class=comment># self.cancel() triggers a notification.</span></span><br><span class=line>            <span class=keyword>return</span> <span class=literal>False</span></span><br><span class=line>        <span class=keyword>elif</span> <span class="variable language_">self</span>._state == PENDING:</span><br><span class=line>            <span class="variable language_">self</span>._state = RUNNING</span><br><span class=line>            <span class=keyword>return</span> <span class=literal>True</span></span><br><span class=line>        <span class=keyword>else</span>:</span><br><span class=line>            LOGGER.critical(<span class=string>&#x27;Future %s in unexpected state: %s&#x27;</span>,</span><br><span class=line>                            <span class=built_in>id</span>(<span class="variable language_">self</span>),</span><br><span class=line>                            <span class="variable language_">self</span>._state)</span><br><span class=line>            <span class=keyword>raise</span> RuntimeError(<span class=string>&#x27;Future in unexpected state&#x27;</span>)</span><br></pre></td></tr></table></figure><p>这一部分内容很简单，检查当前实例如果处于等待状态，就返回 True ，如果处于被取消的状态，就返回 False , 在 <code>_add_call_item_to_queue</code> 函数中，会将已经处于 <code>cancel</code> 状态的 <code>_WorkItem</code> 从等待任务中移除。</p><p>好了，我们继续回到 <code>_queue_management_worker</code> 函数中去，</p><figure class="highlight python"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br><span class=line>65</span><br><span class=line>66</span><br><span class=line>67</span><br><span class=line>68</span><br><span class=line>69</span><br><span class=line>70</span><br><span class=line>71</span><br><span class=line>72</span><br><span class=line>73</span><br><span class=line>74</span><br><span class=line>75</span><br><span class=line>76</span><br><span class=line>77</span><br><span class=line>78</span><br><span class=line>79</span><br><span class=line>80</span><br><span class=line>81</span><br><span class=line>82</span><br><span class=line>83</span><br><span class=line>84</span><br><span class=line>85</span><br><span class=line>86</span><br><span class=line>87</span><br><span class=line>88</span><br><span class=line>89</span><br><span class=line>90</span><br><span class=line>91</span><br><span class=line>92</span><br><span class=line>93</span><br><span class=line>94</span><br><span class=line>95</span><br><span class=line>96</span><br><span class=line>97</span><br><span class=line>98</span><br><span class=line>99</span><br><span class=line>100</span><br><span class=line>101</span><br><span class=line>102</span><br><span class=line>103</span><br><span class=line>104</span><br><span class=line>105</span><br><span class=line>106</span><br><span class=line>107</span><br><span class=line>108</span><br><span class=line>109</span><br><span class=line>110</span><br><span class=line>111</span><br><span class=line>112</span><br><span class=line>113</span><br><span class=line>114</span><br><span class=line>115</span><br></pre></td><td class=code><pre><span class=line></span><br><span class=line><span class=keyword>def</span> <span class="title function_">_queue_management_worker</span>(<span class=params>executor_reference,</span></span><br><span class=line><span class=params>                             processes,</span></span><br><span class=line><span class=params>                             pending_work_items,</span></span><br><span class=line><span class=params>                             work_ids_queue,</span></span><br><span class=line><span class=params>                             call_queue,</span></span><br><span class=line><span class=params>                             result_queue</span>):</span><br><span class=line>    <span class=string>&quot;&quot;&quot;Manages the communication between this process and the worker processes.</span></span><br><span class=line><span class=string></span></span><br><span class=line><span class=string>    This function is run in a local thread.</span></span><br><span class=line><span class=string></span></span><br><span class=line><span class=string>        executor_reference: A weakref.ref to the ProcessPoolExecutor that owns</span></span><br><span class=line><span class=string>    Args:</span></span><br><span class=line><span class=string>        process: A list of the multiprocessing.Process instances used as</span></span><br><span class=line><span class=string>            this thread. Used to determine if the ProcessPoolExecutor has been</span></span><br><span class=line><span class=string>            garbage collected and that this function can exit.</span></span><br><span class=line><span class=string>            workers.</span></span><br><span class=line><span class=string>        pending_work_items: A dict mapping work ids to _WorkItems e.g.</span></span><br><span class=line><span class=string>            &#123;5: &lt;_WorkItem...&gt;, 6: &lt;_WorkItem...&gt;, ...&#125;</span></span><br><span class=line><span class=string>        work_ids_queue: A queue.Queue of work ids e.g. Queue([5, 6, ...]).</span></span><br><span class=line><span class=string>        call_queue: A multiprocessing.Queue that will be filled with _CallItems</span></span><br><span class=line><span class=string>            derived from _WorkItems for processing by the process workers.</span></span><br><span class=line><span class=string>        result_queue: A multiprocessing.Queue of _ResultItems generated by the</span></span><br><span class=line><span class=string>            process workers.</span></span><br><span class=line><span class=string>    &quot;&quot;&quot;</span></span><br><span class=line>    executor = <span class=literal>None</span></span><br><span class=line></span><br><span class=line>    <span class=keyword>def</span> <span class="title function_">shutting_down</span>():</span><br><span class=line>        <span class=keyword>return</span> _shutdown <span class=keyword>or</span> executor <span class=keyword>is</span> <span class=literal>None</span> <span class=keyword>or</span> executor._shutdown_thread</span><br><span class=line></span><br><span class=line>    <span class=keyword>def</span> <span class="title function_">shutdown_worker</span>():</span><br><span class=line>        <span class=comment># This is an upper bound</span></span><br><span class=line>        nb_children_alive = <span class=built_in>sum</span>(p.is_alive() <span class=keyword>for</span> p <span class=keyword>in</span> processes.values())</span><br><span class=line>        <span class=keyword>for</span> i <span class=keyword>in</span> <span class=built_in>range</span>(<span class=number>0</span>, nb_children_alive):</span><br><span class=line>            call_queue.put_nowait(<span class=literal>None</span>)</span><br><span class=line>        <span class=comment># Release the queue&#x27;s resources as soon as possible.</span></span><br><span class=line>        call_queue.close()</span><br><span class=line>        <span class=comment># If .join() is not called on the created processes then</span></span><br><span class=line>        <span class=comment># some multiprocessing.Queue methods may deadlock on Mac OS X.</span></span><br><span class=line>        <span class=keyword>for</span> p <span class=keyword>in</span> processes.values():</span><br><span class=line>            p.join()</span><br><span class=line></span><br><span class=line>    reader = result_queue._reader</span><br><span class=line></span><br><span class=line>    <span class=keyword>while</span> <span class=literal>True</span>:</span><br><span class=line>        _add_call_item_to_queue(pending_work_items,</span><br><span class=line>                                work_ids_queue,</span><br><span class=line>                                call_queue)</span><br><span class=line></span><br><span class=line>        sentinels = [p.sentinel <span class=keyword>for</span> p <span class=keyword>in</span> processes.values()]</span><br><span class=line>        <span class=keyword>assert</span> sentinels</span><br><span class=line>        ready = wait([reader] + sentinels)</span><br><span class=line>        <span class=keyword>if</span> reader <span class=keyword>in</span> ready:</span><br><span class=line>            result_item = reader.recv()</span><br><span class=line>        <span class=keyword>else</span>:</span><br><span class=line>            <span class=comment># Mark the process pool broken so that submits fail right now.</span></span><br><span class=line>            executor = executor_reference()</span><br><span class=line>            <span class=keyword>if</span> executor <span class=keyword>is</span> <span class=keyword>not</span> <span class=literal>None</span>:</span><br><span class=line>                executor._broken = <span class=literal>True</span></span><br><span class=line>                executor._shutdown_thread = <span class=literal>True</span></span><br><span class=line>                executor = <span class=literal>None</span></span><br><span class=line>            <span class=comment># All futures in flight must be marked failed</span></span><br><span class=line>            <span class=keyword>for</span> work_id, work_item <span class=keyword>in</span> pending_work_items.items():</span><br><span class=line>                work_item.future.set_exception(</span><br><span class=line>                    BrokenProcessPool(</span><br><span class=line>                        <span class=string>&quot;A process in the process pool was &quot;</span></span><br><span class=line>                        <span class=string>&quot;terminated abruptly while the future was &quot;</span></span><br><span class=line>                        <span class=string>&quot;running or pending.&quot;</span></span><br><span class=line>                    ))</span><br><span class=line>                <span class=comment># Delete references to object. See issue16284</span></span><br><span class=line>                <span class=keyword>del</span> work_item</span><br><span class=line>            pending_work_items.clear()</span><br><span class=line>            <span class=comment># Terminate remaining workers forcibly: the queues or their</span></span><br><span class=line>            <span class=comment># locks may be in a dirty state and block forever.</span></span><br><span class=line>            <span class=keyword>for</span> p <span class=keyword>in</span> processes.values():</span><br><span class=line>                p.terminate()</span><br><span class=line>            shutdown_worker()</span><br><span class=line>            <span class=keyword>return</span></span><br><span class=line>        <span class=keyword>if</span> <span class=built_in>isinstance</span>(result_item, <span class=built_in>int</span>):</span><br><span class=line>            <span class=comment># Clean shutdown of a worker using its PID</span></span><br><span class=line>            <span class=comment># (avoids marking the executor broken)</span></span><br><span class=line>            <span class=keyword>assert</span> shutting_down()</span><br><span class=line>            p = processes.pop(result_item)</span><br><span class=line>            p.join()</span><br><span class=line>            <span class=keyword>if</span> <span class=keyword>not</span> processes:</span><br><span class=line>                shutdown_worker()</span><br><span class=line>                <span class=keyword>return</span></span><br><span class=line>        <span class=keyword>elif</span> result_item <span class=keyword>is</span> <span class=keyword>not</span> <span class=literal>None</span>:</span><br><span class=line>            work_item = pending_work_items.pop(result_item.work_id, <span class=literal>None</span>)</span><br><span class=line>            <span class=comment># work_item can be None if another process terminated (see above)</span></span><br><span class=line>            <span class=keyword>if</span> work_item <span class=keyword>is</span> <span class=keyword>not</span> <span class=literal>None</span>:</span><br><span class=line>                <span class=keyword>if</span> result_item.exception:</span><br><span class=line>                    work_item.future.set_exception(result_item.exception)</span><br><span class=line>                <span class=keyword>else</span>:</span><br><span class=line>                    work_item.future.set_result(result_item.result)</span><br><span class=line>                <span class=comment># Delete references to object. See issue16284</span></span><br><span class=line>                <span class=keyword>del</span> work_item</span><br><span class=line>        <span class=comment># Check whether we should start shutting down.</span></span><br><span class=line>        executor = executor_reference()</span><br><span class=line>        <span class=comment># No more work items can be added if:</span></span><br><span class=line>        <span class=comment>#   - The interpreter is shutting down OR</span></span><br><span class=line>        <span class=comment>#   - The executor that owns this worker has been collected OR</span></span><br><span class=line>        <span class=comment>#   - The executor that owns this worker has been shutdown.</span></span><br><span class=line>        <span class=keyword>if</span> shutting_down():</span><br><span class=line>            <span class=keyword>try</span>:</span><br><span class=line>                <span class=comment># Since no new work items can be added, it is safe to shutdown</span></span><br><span class=line>                <span class=comment># this thread if there are no pending work items.</span></span><br><span class=line>                <span class=keyword>if</span> <span class=keyword>not</span> pending_work_items:</span><br><span class=line>                    shutdown_worker()</span><br><span class=line>                    <span class=keyword>return</span></span><br><span class=line>            <span class=keyword>except</span> Full:</span><br><span class=line>                <span class=comment># This is not a problem: we will eventually be woken up (in</span></span><br><span class=line>                <span class=comment># result_queue.get()) and be able to send a sentinel again.</span></span><br><span class=line>                <span class=keyword>pass</span></span><br><span class=line>        executor = <span class=literal>None</span></span><br></pre></td></tr></table></figure><p><code>result_item</code> 变量</p><p>我们看看</p><p>首先，大家可能在这里有点疑问了</p><figure class="highlight python"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre></td><td class=code><pre><span class=line></span><br><span class=line>sentinels = [p.sentinel <span class=keyword>for</span> p <span class=keyword>in</span> processes.values()]</span><br><span class=line><span class=keyword>assert</span> sentinels</span><br><span class=line>ready = wait([reader] + sentinels)</span><br><span class=line></span><br></pre></td></tr></table></figure><p>这个 <code>wait</code> 是什么鬼啊，<code>reader</code> 又是什么鬼啊。一步步来。首先，我们看到，前面，<code>reader = result_queue._reader</code> 也会引起大家的疑问，这里我们 <code>result_queue</code> 是 <code>multiprocess</code> 里面的 <code>SimpleQueue</code> 啊，它没有 <code>_reader</code> 方法啊QAQ</p><figure class="highlight python"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre></td><td class=code><pre><span class=line></span><br><span class=line><span class=keyword>class</span> <span class="title class_">SimpleQueue</span>(<span class="title class_ inherited__">object</span>):</span><br><span class=line></span><br><span class=line>    <span class=keyword>def</span> <span class="title function_">__init__</span>(<span class=params>self, *, ctx</span>):</span><br><span class=line>        <span class="variable language_">self</span>._reader, <span class="variable language_">self</span>._writer = connection.Pipe(duplex=<span class=literal>False</span>)</span><br><span class=line>        <span class="variable language_">self</span>._rlock = ctx.Lock()</span><br><span class=line>        <span class="variable language_">self</span>._poll = <span class="variable language_">self</span>._reader.poll</span><br><span class=line>        <span class=keyword>if</span> sys.platform == <span class=string>&#x27;win32&#x27;</span>:</span><br><span class=line>            <span class="variable language_">self</span>._wlock = <span class=literal>None</span></span><br><span class=line>        <span class=keyword>else</span>:</span><br><span class=line>            <span class="variable language_">self</span>._wlock = ctx.Lock()</span><br></pre></td></tr></table></figure><p>上面这贴出来的，是 <code>SimpleQueue</code> 的部分代码，我们可以很清楚的看到，<code>SimpleQueue</code> 本质是利用一个 <code>Pipe</code> 来进行进程间通信的，然后 <code>_reader</code> 是读取 <code>Pipe</code> 的一个变量。</p><blockquote><p><strong>Note</strong> : 大家可以复习下其余几种进程间通信的方法了</p></blockquote><p>好了，这一部分看懂后，我们来看看 <code>wait</code> 方法吧。</p><figure class="highlight python"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br></pre></td><td class=code><pre><span class=line></span><br><span class=line><span class=keyword>def</span> <span class="title function_">wait</span>(<span class=params>object_list, timeout=<span class=literal>None</span></span>):</span><br><span class=line>    <span class=string>&#x27;&#x27;&#x27;</span></span><br><span class=line><span class=string>    Wait till an object in object_list is ready/readable.</span></span><br><span class=line><span class=string></span></span><br><span class=line><span class=string>    Returns list of those objects in object_list which are ready/readable.</span></span><br><span class=line><span class=string>    &#x27;&#x27;&#x27;</span></span><br><span class=line>    <span class=keyword>with</span> _WaitSelector() <span class=keyword>as</span> selector:</span><br><span class=line>        <span class=keyword>for</span> obj <span class=keyword>in</span> object_list:</span><br><span class=line>            selector.register(obj, selectors.EVENT_READ)</span><br><span class=line></span><br><span class=line>        <span class=keyword>if</span> timeout <span class=keyword>is</span> <span class=keyword>not</span> <span class=literal>None</span>:</span><br><span class=line>            deadline = time.time() + timeout</span><br><span class=line></span><br><span class=line>        <span class=keyword>while</span> <span class=literal>True</span>:</span><br><span class=line>            ready = selector.select(timeout)</span><br><span class=line>            <span class=keyword>if</span> ready:</span><br><span class=line>                <span class=keyword>return</span> [key.fileobj <span class=keyword>for</span> (key, events) <span class=keyword>in</span> ready]</span><br><span class=line>            <span class=keyword>else</span>:</span><br><span class=line>                <span class=keyword>if</span> timeout <span class=keyword>is</span> <span class=keyword>not</span> <span class=literal>None</span>:</span><br><span class=line>                    timeout = deadline - time.time()</span><br><span class=line>                    <span class=keyword>if</span> timeout &lt; <span class=number>0</span>:</span><br><span class=line>                        <span class=keyword>return</span> ready</span><br></pre></td></tr></table></figure><p>这一部分代码很简单，首先将我们待读取的对象，进行一次注册，然后当 <code>timeout</code> 为 None 的时候，就一直等待到有对象读取数据成功为止</p><p>好了，我们继续回到前面的 <code>_queue_management_worker</code> 函数中去，来看看这样一段代码</p><figure class="highlight python"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br></pre></td><td class=code><pre><span class=line></span><br><span class=line>ready = wait([reader] + sentinels)</span><br><span class=line><span class=keyword>if</span> reader <span class=keyword>in</span> ready:</span><br><span class=line>    result_item = reader.recv()</span><br><span class=line><span class=keyword>else</span>:</span><br><span class=line>    <span class=comment># Mark the process pool broken so that submits fail right now.</span></span><br><span class=line>    executor = executor_reference()</span><br><span class=line>    <span class=keyword>if</span> executor <span class=keyword>is</span> <span class=keyword>not</span> <span class=literal>None</span>:</span><br><span class=line>        executor._broken = <span class=literal>True</span></span><br><span class=line>        executor._shutdown_thread = <span class=literal>True</span></span><br><span class=line>        executor = <span class=literal>None</span></span><br><span class=line>    <span class=comment># All futures in flight must be marked failed</span></span><br><span class=line>    <span class=keyword>for</span> work_id, work_item <span class=keyword>in</span> pending_work_items.items():</span><br><span class=line>        work_item.future.set_exception(</span><br><span class=line>            BrokenProcessPool(</span><br><span class=line>                <span class=string>&quot;A process in the process pool was &quot;</span></span><br><span class=line>                <span class=string>&quot;terminated abruptly while the future was &quot;</span></span><br><span class=line>                <span class=string>&quot;running or pending.&quot;</span></span><br><span class=line>            ))</span><br><span class=line>        <span class=comment># Delete references to object. See issue16284</span></span><br><span class=line>        <span class=keyword>del</span> work_item</span><br><span class=line>    pending_work_items.clear()</span><br><span class=line>    <span class=comment># Terminate remaining workers forcibly: the queues or their</span></span><br><span class=line>    <span class=comment># locks may be in a dirty state and block forever.</span></span><br><span class=line>    <span class=keyword>for</span> p <span class=keyword>in</span> processes.values():</span><br><span class=line>        p.terminate()</span><br><span class=line>    shutdown_worker()</span><br><span class=line>    <span class=keyword>return</span></span><br></pre></td></tr></table></figure><p>我们用 <code>wait</code> 函数来读取一系列对象，因为我们没有设置 <code>Timeout</code> ，所以当我们拿到可读取对象的结果时，如果 <code>result_queue._reader</code> 没有在列表中，那么意味着，有处理进程突然异常关闭了，这个时候，我们开始执行后面的语句来执行目前进程池的关闭操作。如果在列表中，我们读取数据，得到 <code>result_item</code> 变量</p><p>我们再看看下面的代码</p><figure class="highlight python"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br></pre></td><td class=code><pre><span class=line></span><br><span class=line><span class=keyword>if</span> <span class=built_in>isinstance</span>(result_item, <span class=built_in>int</span>):</span><br><span class=line>    <span class=comment># Clean shutdown of a worker using its PID</span></span><br><span class=line>    <span class=comment># (avoids marking the executor broken)</span></span><br><span class=line>    <span class=keyword>assert</span> shutting_down()</span><br><span class=line>    p = processes.pop(result_item)</span><br><span class=line>    p.join()</span><br><span class=line>    <span class=keyword>if</span> <span class=keyword>not</span> processes:</span><br><span class=line>        shutdown_worker()</span><br><span class=line>        <span class=keyword>return</span></span><br><span class=line><span class=keyword>elif</span> result_item <span class=keyword>is</span> <span class=keyword>not</span> <span class=literal>None</span>:</span><br><span class=line>    work_item = pending_work_items.pop(result_item.work_id, <span class=literal>None</span>)</span><br><span class=line>    <span class=comment># work_item can be None if another process terminated (see above)</span></span><br><span class=line>    <span class=keyword>if</span> work_item <span class=keyword>is</span> <span class=keyword>not</span> <span class=literal>None</span>:</span><br><span class=line>        <span class=keyword>if</span> result_item.exception:</span><br><span class=line>            work_item.future.set_exception(result_item.exception)</span><br><span class=line>        <span class=keyword>else</span>:</span><br><span class=line>            work_item.future.set_result(result_item.result)</span><br><span class=line>        <span class=comment># Delete references to object. See issue16284</span></span><br><span class=line>        <span class=keyword>del</span> work_item</span><br><span class=line></span><br></pre></td></tr></table></figure><p>首先，如果 <code>result_item</code> 变量是 int 类型的话，不知道大家还记不记得在 <code>_process_worker</code> 函数中有这样一段逻辑</p><figure class="highlight python"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre></td><td class=code><pre><span class=line></span><br><span class=line>call_item = call_queue.get(block=<span class=literal>True</span>)</span><br><span class=line><span class=keyword>if</span> call_item <span class=keyword>is</span> <span class=literal>None</span>:</span><br><span class=line>    <span class=comment># Wake up queue management thread</span></span><br><span class=line>    result_queue.put(os.getpid())</span><br><span class=line>    <span class=keyword>return</span></span><br></pre></td></tr></table></figure><p>当调用队列中没有新的任务时，将进程 <code>pid</code> 放入 <code>result_queue</code> 中。那么我们 <code>result_item</code> 如果值为 <code>int</code> 那么意味着，我们之前任务处理工作已经完毕，于是开始清理，关闭我们的进程池。</p><p>如果 <code>result_item</code> 既不为 <code>int</code> 也不为 <code>None</code> , 那么必然是 <code>_ResultItem</code> 的实例，我们根据 <code>work_id</code> 取出 <code>_WorkItem</code> 实例，并将产生的异常或者值和 <code>_WorkItem</code> 实例中的 <code>Future</code> 实例（也就是我们 submit 后返回的那货）进行绑定。</p><p>最后，删除这个 <code>work_item</code> ，完事儿，手工</p><h2 id=最后><a href=#最后 class=headerlink title=最后></a>最后</h2><p>洋洋洒洒写了一大篇辣鸡文章，希望大家不要介意，其实我们能看到 <code>concurrent.future</code> 的实现，其实并没有用什么高深的黑魔法，但是其中细节值得我们一一品味，所以这篇文章我们先写到这里。后面有机会的话，我们再去看看 <code>concurrent.future</code> 其余部分代码。也有蛮多值得品味的地方。</p><h2 id=Reference><a href=#Reference class=headerlink title=Reference></a>Reference</h2><p>1.<a target=_blank rel="noopener external nofollow noreferrer" href=https://docs.python.org/3/library/multiprocessing.html#multiprocessing.SimpleQueue>Python 3 multiprocessing</a></p><p>2.<a target=_blank rel="noopener external nofollow noreferrer" href=https://docs.python.org/3/library/weakref.html>Python 3 weakref</a></p><p>3.<a target=_blank rel="noopener external nofollow noreferrer" href=https://my.oschina.net/u/1255754/blog/207331>并发编程之Future模式</a></p><p>4.<a target=_blank rel="noopener external nofollow noreferrer" href=https://www.ziwenxie.site/2016/12/24/python-concurrent-futures/ >Python并发编程之线程池/进程池</a></p><p>5.<a target=_blank rel="noopener external nofollow noreferrer" href=http://zha-zi.iteye.com/blog/1408189>Future 模式详解（并发使用）</a></p></article><div class=post-copyright><div class=post-copyright__author><span class=post-copyright-meta><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class=post-copyright-info><a target=_blank rel="noopener external nofollow noreferrer" href=https://github.com/Zheaoli>Manjusaka</a></span></div><div class=post-copyright__type><span class=post-copyright-meta><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class=post-copyright-info><a href=https://www.manjusaka.blog/posts/2017/11/27/something-about-concurrent-future/ >https://www.manjusaka.blog/posts/2017/11/27/something-about-concurrent-future/</a></span></div><div class=post-copyright__notice><span class=post-copyright-meta><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class=post-copyright-info>All articles on this blog are licensed under <a target=_blank rel="noopener external nofollow noreferrer" href=https://creativecommons.org/licenses/by-nc-sa/4.0/ >CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class=tag_share><div class=post-meta__tag-list><a class=post-meta__tags href=/tags/%E7%BC%96%E7%A8%8B/ >编程</a><a class=post-meta__tags href=/tags/Python/ >Python</a><a class=post-meta__tags href=/tags/%E7%BC%96%E7%A8%8B%E6%8A%80%E5%B7%A7/ >编程技巧</a><a class=post-meta__tags href=/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/ >并发编程</a><a class=post-meta__tags href=/tags/%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/ >源码剖析</a></div><div class=post-share><div class=social-share data-image=https://cdn.pixabay.com/photo/2023/01/14/19/50/flower-7718952_1280.jpg data-sites=facebook,twitter,wechat,weibo,qq></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css media=print onload='this.media="all"'><script src=https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js defer=defer></script></div></div><div class=ads-wrap><ins class=adsbygoogle style=display:block;text-align:center data-ad-layout=in-article data-ad-format=fluid data-ad-client=ca-pub-7962287588031867 data-ad-slot=2542544532></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><nav class=pagination-post id=pagination><a class=pagination-related href=/posts/2017/12/28/what-the-fuck-supvisor/ title="Supervisor 的一个隐藏坑"><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/06/16/46/sea-7772372_1280.jpg onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class=info><div class=info-1><div class=info-item-1>Previous</div><div class=info-item-2>Supervisor 的一个隐藏坑</div></div><div class=info-2><div class=info-item-1>本垃圾 API 搬运工程师又来了啊，= =今天因为 Supervisor 一个隐藏的参数配置，造成了一个重要项目的线上崩溃。= =我觉得还是有必要分享一波，所以写了一篇垃圾水文。 起因写着写着代码，突然接到一堆报警邮件，让我直接觉得世界不那么可爱 然后定睛一看异常信息？卧槽？新建连接就马上传说中的 [Errno 24] Too many open files ？？这搞你xxx啊，开始搞呗。 查 bug首先，众所周知，Linux 中万物皆文件= =，于是我们操作网络链接的过程，其实也就是操作 File Descriptor 的问题= =，诶，既然 Too many open files 那就优先考虑，是不是系统设置的阀值太小了，于是 ulimit -a 一把梭？？ 诶？open files 一栏数字不小啊？足够啊？那这特么是什么鬼啊？ 行吧，查一下网络连接吧， 一把梭，netstat -n | awk &#39;/^tcp/ &#123;++S[$NF]&#125; END &#123;for(a in S) print a, S[a]&#125;&#39;...</div></div></div></a><a class=pagination-related href=/posts/2017/08/13/what-the-fuck-about-flask-part1/ title="你所不知道的 Flask Part1:Route 初探"><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/04/07/38/cherry-blossoms-7766588_1280.jpg onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="info text-right"><div class=info-1><div class=info-item-1>Next</div><div class=info-item-2>你所不知道的 Flask Part1:Route 初探</div></div><div class=info-2><div class=info-item-1>前言我自己都记不清楚上一次写博客是什么时候了（笑），上一次挖的坑现在还没填完，干脆，开个新坑吧，你不知道的 Flask ，记录下自己用 Flask 过程中一些很好玩的东西，当然很大可能我又会中途弃坑 开篇引子之前遇到一个很奇怪的需求，需要在flask中支持正则表达式比如，@app.route(&#39;/api/(.*?)&#39;) 这样，在视图函数被调用的时候，能传入 URL 中正则匹配的值。不过 Flask 路由中默认不支持这样的方法，那么我们该怎么办？我们先思考五分钟吧？ 好了，我先给出解决方案吧 12345678910from flask import Flaskfrom werkzeug.routing import BaseConverterclass RegexConverter(BaseConverter): def __init__(self, map, *args): self.map = map self.regex = args[0]app =...</div></div></div></a></nav><div class=relatedPosts><div class=headline><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class=relatedPosts-list><a class=pagination-related href=/posts/2016/12/28/Someone-tell-me-that-you-think-Python-is-simple-2/ title="听说你会 Python （2）：Python 高阶数据结构解析"><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/08/15/10/sculpture-7776861_1280.jpg alt=cover><div class="info text-center"><div class=info-1><div class=info-item-1><i class="far fa-calendar-alt fa-fw"></i> 2016-12-28</div><div class=info-item-2>听说你会 Python （2）：Python 高阶数据结构解析</div></div><div class=info-2><div class=info-item-1>前言之前写过一篇《听说你会 Python ？》的文章，大家反响都还不错，那么我想干脆把这个文章做成一个系列，继续讲解一下 Python 当中那些不为人知的细节吧。然后之前在和师父川爷讨论面试的时候，川爷说了一句“要是我，我就考考你们怎么去实现一个 namedtuple ，好用，方便，又能区分人”，说者无心，听者有意，我于是决定在这次的文章中，和大家聊一聊 Python 中一个特殊的高阶数据结构， namedtuple 的实现。 Let’s beginnamedtuple介绍tuple 是 Python 中 build-in 的一种特殊的数据结构，它是一种 immutable 的数据集合，我们经常会这样使用它 123456789def test(): a = (1, 2) print(a) return aif __name__ == &#x27;__main__&#x27;: b, c = test() print(a) Right，很多时候我们会直接使用 tuple 来进行一些数据的 packing/unpacking 的操作。OK，关于...</div></div></div></a><a class=pagination-related href=/posts/2016/10/12/Something-about-Descriptor/ title="Python 描述符入门指北"><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/04/07/50/daisy-7766609_1280.jpg alt=cover><div class="info text-center"><div class=info-1><div class=info-item-1><i class="far fa-calendar-alt fa-fw"></i> 2016-10-12</div><div class=info-item-2>Python 描述符入门指北</div></div><div class=info-2><div class=info-item-1>很久都没写 Flask 代码相关了，想想也真是惭愧，然并卵，这次还是不写 Flask 相关，不服你来打我啊（就这么贱，有本事咬我啊这次我来写一下 Python 一个很重要的东西，即 Descriptor （描述符） 初识描述符老规矩，Talk is cheap,Show me the code. 我们先来看看一段代码 1234567891011121314151617181920212223class Person(object): &quot;&quot;&quot;&quot;&quot;&quot; #---------------------------------------------------------------------- def __init__(self, first_name, last_name): &quot;&quot;&quot;Constructor&quot;&quot;&quot; self.first_name = first_name self.last_name =...</div></div></div></a><a class=pagination-related href=/posts/2016/11/18/Someone-tell-me-that-you-think-Python-is-simple/ title="听说你会 Python ？"><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/08/15/10/sculpture-7776861_1280.jpg alt=cover><div class="info text-center"><div class=info-1><div class=info-item-1><i class="far fa-calendar-alt fa-fw"></i> 2016-11-18</div><div class=info-item-2>听说你会 Python ？</div></div><div class=info-2><div class=info-item-1>前言最近觉得 Python 太“简单了”，于是在师父川爷面前放肆了一把：“我觉得 Python 是世界上最简单的语言！”。于是川爷嘴角闪过了一丝轻蔑的微笑（内心 OS：Naive！，作为一个 Python 开发者，我必须要给你一点人生经验，不然你不知道天高地厚！）于是川爷给我了一份满分 100 分的题，然后这篇文章就是记录下做这套题所踩过的坑。 1.列表生成器描述下面的代码会报错，为什么？ 1234567class A(object): x = 1 gen = (x for _ in xrange(10)) # gen=(x for _ in range(10))if __name__ == &quot;__main__&quot;: print(list(A.gen)) 答案这个问题是变量作用域问题，在 gen=(x for _ in xrange(10)) 中 gen 是一个 generator ,在 generator 中变量有自己的一套作用域，与其余作用域空间相互隔离。因此，将会出现这样的 NameError: name &#39;x&#39; is...</div></div></div></a><a class=pagination-related href=/posts/2019/04/27/something-about-pep-570/ title="随便聊聊 PEP570"><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/06/01/14/superb-fairywren-7770904_1280.jpg alt=cover><div class="info text-center"><div class=info-1><div class=info-item-1><i class="far fa-calendar-alt fa-fw"></i> 2019-04-27</div><div class=info-item-2>随便聊聊 PEP570</div></div><div class=info-2><div class=info-item-1>最近沉迷与 MIT 6.824 这门分布式系统的课，无心写文章。不过看到 PEP570 被接受了，决定还是写篇水文随便聊聊 PEP 570 Python 的 argument在聊 PEP570 之前，我们先要来看看 Python 的 argument 变迁 早在 Python 1.0 或更早，Python 的 argument 系统就已经支持我们现在主要使用的两种参数形式了，一种是 positional 一种是 keyword，举几个例子 1234567891011def abc(a, b, c): passabc(1, 2, 3)abc(1, 2, c=3)abc(1, b=2, c=3)abc(*(1, 2, 3))abc(**&#123;&quot;a&quot;: 1, &quot;b&quot;: 2, &quot;c&quot;: 3&#125;) 这是不是我们常见的集中使用方式？ 在发展了很长一段时间后，虽然期间有一些提案对 Python 的 argument 系统做优化和增强，但是一直都被 Reject，直到 PEP3102 的出现 3102...</div></div></div></a><a class=pagination-related href=/posts/2016/09/11/something-about-yield-in-python/ title="聊聊 Python 中生成器和协程那点事儿"><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/04/07/38/cherry-blossoms-7766587_1280.jpg alt=cover><div class="info text-center"><div class=info-1><div class=info-item-1><i class="far fa-calendar-alt fa-fw"></i> 2016-09-11</div><div class=info-item-2>聊聊 Python 中生成器和协程那点事儿</div></div><div class=info-2><div class=info-item-1>文章来源：itsCoder 的 WeeklyBolg 项目 itsCoder主页：http://itscoder.com/ 作者：Manjusaka 审阅者：allenwu,Brucezz 写在前面的话本来想这周继续写写 Flask 那点破事儿的，但是想了想决定换换口味，来聊聊很不容易理解但是很重要的 Python 中的生成器和协程。 Generators 科普我猜大家对于生成器肯定并不陌生，但是为了能让我愉快的继续装逼，我们还是用点篇幅讲一下什么是生成器吧。比如在 Python 里，我们想生成一个范围 (1,100000) 的一个 list，于是我们无脑写了如下的代码出来 12345def generateList(start,stop):	tempList=[]	for i in range(start,stop): tempList.append(i)	return tempList 注1：这里有同学提出了为什么我们不直接返回 range(start,stop)，Nice question，这里涉及到一个基础问题，range...</div></div></div></a><a class=pagination-related href=/posts/2016/12/15/A-Simple-Object-Model/ title="用 Python 实现一个最简单的对象模型"><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/04/07/50/daisy-7766609_1280.jpg alt=cover><div class="info text-center"><div class=info-1><div class=info-item-1><i class="far fa-calendar-alt fa-fw"></i> 2016-12-15</div><div class=info-item-2>用 Python 实现一个最简单的对象模型</div></div><div class=info-2><div class=info-item-1>原文地址：A Simple Object Model 原文作者：Carl Friedrich Bolz 译文出自：掘金翻译计划 译者：Zheaoli 校对者：Yuze Ma, Gran 一个简单的对象模型Carl Friedrich Bolz 是一位在伦敦国王大学任职的研究员，他沉迷于动态语言的实现及优化等领域而不可自拔。他是 PyPy/RPython 的核心开发者之一，于此同时，他也在为 Prolog, Racket, Smalltalk, PHP 和 Ruby 等语言贡献代码。这是他的 Twitter @cfbolz 。 开篇面向对象编程是目前被广泛使用的一种编程范式，这种编程范式也被大量现代编程语言所支持。虽然大部分语言给程序猿提供了相似的面向对象的机制，但是如果深究细节的话，还是能发现它们之间还是有很多不同的。大部分的语言的共同点在于都拥有对象处理和继承机制。而对于类来说的话，并不是每种语言都完美支持它。比如对于 Self 或者 JavaScript...</div></div></div></a></div></div><hr class=custom-hr><div id=post-comment><div class=comment-head><div class=comment-headline><i class="fas fa-comments fa-fw"></i><span> Comments</span></div></div><div class=comment-wrap><div><div id=disqus_thread></div></div></div></div></div><div class=aside-content id=aside-content><div class="card-widget card-info text-center"><div class=avatar-img><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://avatars.githubusercontent.com/u/7054676?v=4" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt=avatar></div><div class=author-info-name>Manjusaka</div><div class=author-info-description>热忱之心不可磨灭</div><div class=site-data><a href=/archives/ ><div class=headline>Articles</div><div class=length-num>95</div></a><a href=/tags/ ><div class=headline>Tags</div><div class=length-num>58</div></a><a href=/categories/ ><div class=headline>Categories</div><div class=length-num>38</div></a></div><a id=card-info-btn target=_blank rel="noopener external nofollow noreferrer" href=https://github.com/Zheaoli><i class="fab fa-github"></i><span>Follow Me</span></a><div class=card-info-social-icons><a class=social-icon href=https://github.com/ZheaoLi rel="external nofollow noreferrer" target=_blank title=Github><i class="fab fa-github"></i></a><a class=social-icon href=mailto:me@manjusaka.me rel="external nofollow noreferrer" target=_blank title=Email><i class="fas fa-envelope"></i></a><a class=social-icon href=https://twitter.com/Manjusaka_Lee rel="external nofollow noreferrer" target=_blank title=推特><i class="fab fa-twitter"></i></a><a class=social-icon href=/atom.xml target=_blank title=RSS><i class="fa-solid fa-feed"></i></a></div></div><div class="card-widget card-announcement"><div class=item-headline><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class=announcement_content>This is my Blog</div></div><div class=sticky_layout><div class=card-widget id=card-toc><div class=item-headline><i class="fas fa-stream"></i><span>Contents</span><span class=toc-percentage></span></div><div class="toc-content is-expand"><ol class=toc><li class="toc-item toc-level-1"><a class=toc-link href=#%E5%9E%83%E5%9C%BE%E8%AF%9D><span class=toc-number>1.</span> <span class=toc-text>垃圾话</span></a></li><li class="toc-item toc-level-1"><a class=toc-link href=#%E6%AD%A3%E6%96%87><span class=toc-number>2.</span> <span class=toc-text>正文</span></a><ol class=toc-child><li class="toc-item toc-level-2"><a class=toc-link href=#Python-%E7%9A%84%E5%BC%82%E6%AD%A5%E5%A4%84%E7%90%86><span class=toc-number>2.1.</span> <span class=toc-text>Python 的异步处理</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#Future-%E6%A8%A1%E5%BC%8F><span class=toc-number>2.2.</span> <span class=toc-text>Future 模式</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#Python-%E4%B8%AD%E7%9A%84-concurrent-futures><span class=toc-number>2.3.</span> <span class=toc-text>Python 中的 concurrent.futures</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E5%89%96%E4%B8%80%E4%B8%8B-concurrent-futures><span class=toc-number>2.4.</span> <span class=toc-text>剖一下 concurrent.futures</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E6%9C%80%E5%90%8E><span class=toc-number>2.5.</span> <span class=toc-text>最后</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#Reference><span class=toc-number>2.6.</span> <span class=toc-text>Reference</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class=item-headline><i class="fas fa-history"></i><span>Recent Posts</span></div><div class=aside-list><div class=aside-list-item><a class=thumbnail href=/posts/2024/10/02/how-to-extend-the-wasi-python-by-using-host-function-en/ title="How to Run CPython for WASI Using WASMTIME and Extend It with Python-Implemented Host Functions?"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/04/07/38/cherry-blossoms-7766587_1280.jpg onerror='this.onerror=null,this.src="/img/404.jpg"' alt="How to Run CPython for WASI Using WASMTIME and Extend It with Python-Implemented Host Functions?"></a><div class=content><a class=title href=/posts/2024/10/02/how-to-extend-the-wasi-python-by-using-host-function-en/ title="How to Run CPython for WASI Using WASMTIME and Extend It with Python-Implemented Host Functions?">How to Run CPython for WASI Using WASMTIME and Extend It with Python-Implemented Host Functions?</a><time datetime=2024-10-02T13:00:00.000Z title="Created 2024-10-02 21:00:00">2024-10-02</time></div></div><div class=aside-list-item><a class=thumbnail href=/posts/2024/10/02/how-to-extend-the-wasi-python-by-using-host-function-cn/ title="如何使用 WASMTIME 来运行 CPython for WASI，然后利用 Python 实现的 HostFunction 来扩展它？"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/07/14/45/snow-7774312_1280.jpg onerror='this.onerror=null,this.src="/img/404.jpg"' alt="如何使用 WASMTIME 来运行 CPython for WASI，然后利用 Python 实现的 HostFunction 来扩展它？"></a><div class=content><a class=title href=/posts/2024/10/02/how-to-extend-the-wasi-python-by-using-host-function-cn/ title="如何使用 WASMTIME 来运行 CPython for WASI，然后利用 Python 实现的 HostFunction 来扩展它？">如何使用 WASMTIME 来运行 CPython for WASI，然后利用 Python 实现的 HostFunction 来扩展它？</a><time datetime=2024-10-02T13:00:00.000Z title="Created 2024-10-02 21:00:00">2024-10-02</time></div></div><div class=aside-list-item><a class=thumbnail href=/posts/2024/09/18/a-live-debug-ecapture-gh-604/ title="Debug 日志：eCapture GH-604"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/06/16/46/sea-7772372_1280.jpg onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Debug 日志：eCapture GH-604"></a><div class=content><a class=title href=/posts/2024/09/18/a-live-debug-ecapture-gh-604/ title="Debug 日志：eCapture GH-604">Debug 日志：eCapture GH-604</a><time datetime=2024-09-18T14:00:00.000Z title="Created 2024-09-18 22:00:00">2024-09-18</time></div></div><div class=aside-list-item><a class=thumbnail href=/posts/2024/08/19/benchmark-for-python-web-framework-2024-part1-cn/ title="2024 年了，是 Gevent 还是选择 asyncio Part 1？"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/04/07/50/flower-7766608_1280.jpg onerror='this.onerror=null,this.src="/img/404.jpg"' alt="2024 年了，是 Gevent 还是选择 asyncio Part 1？"></a><div class=content><a class=title href=/posts/2024/08/19/benchmark-for-python-web-framework-2024-part1-cn/ title="2024 年了，是 Gevent 还是选择 asyncio Part 1？">2024 年了，是 Gevent 还是选择 asyncio Part 1？</a><time datetime=2024-08-19T17:00:00.000Z title="Created 2024-08-20 01:00:00">2024-08-20</time></div></div><div class=aside-list-item><a class=thumbnail href=/posts/2024/08/19/benchmark-for-python-web-framework-2024-part1-en/ title="In 2024, Gevent or asyncio? Part 1"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/04/07/38/cherry-blossoms-7766587_1280.jpg onerror='this.onerror=null,this.src="/img/404.jpg"' alt="In 2024, Gevent or asyncio? Part 1"></a><div class=content><a class=title href=/posts/2024/08/19/benchmark-for-python-web-framework-2024-part1-en/ title="In 2024, Gevent or asyncio? Part 1">In 2024, Gevent or asyncio? Part 1</a><time datetime=2024-08-19T17:00:00.000Z title="Created 2024-08-20 01:00:00">2024-08-20</time></div></div></div></div><div class="card-widget ads-wrap"><ins class=adsbygoogle style=display:block data-ad-client=ca-pub-7962287588031867 data-ad-slot=1257383027 data-ad-format=auto data-full-width-responsive=true></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div></div></div></main><footer id=footer><div id=footer-wrap><div class=copyright>&copy;2020 - 2024 By Manjusaka</div><div class=framework-info><span>Framework </span><a target=_blank rel="noopener external nofollow noreferrer" href=https://hexo.io>Hexo</a><span class=footer-separator>|</span><span>Theme </span><a target=_blank rel="noopener external nofollow noreferrer" href=https://github.com/jerryc127/hexo-theme-butterfly>Butterfly</a></div></div></footer></div><div id=rightside><div id=rightside-config-hide></div><div id=rightside-config-show><button id=darkmode type=button title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id=translateLink type=button title="Toggle Between Traditional and Simplified Chinese">简</button><button id=readmode type=button title="Reading Mode"><i class="fas fa-book-open"></i></button><button id=go-up type=button title="Back to Top"><span class=scroll-percent></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src=https://www.manjusaka.blog/js/utils.js></script><script src=https://www.manjusaka.blog/js/main.js></script><script src=https://www.manjusaka.blog/js/tw_cn.js></script><script src=https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js></script><script src=https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js></script><script>(()=>{let t=()=>{"object"==typeof pangu?pangu.autoSpacingPage():btf.getScript("https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js").then(()=>{pangu.autoSpacingPage()})};var n=()=>{t()};btf.addGlobalFn("pjaxComplete",n,"pangu"),document.addEventListener("DOMContentLoaded",n)})()</script><div class=js-pjax><script>(()=>{var e=()=>{var e;0!==(e=document.querySelectorAll("pre > code.mermaid")).length&&e.forEach(e=>{var t=document.createElement("pre"),d=(t.className="mermaid-src",t.hidden=!0,t.textContent=e.textContent,document.createElement("div"));d.className="mermaid-wrap",d.appendChild(t),e.parentNode.replaceWith(d)});let t=document.querySelectorAll("#article-container .mermaid-wrap");0!==t.length&&(e=()=>(e=>{window.loadMermaid=!0;let n="dark"===document.documentElement.getAttribute("data-theme")?"dark":"default";e.forEach((e,t)=>{let d=e.firstElementChild;e=`%%{init:{ 'theme':'${n}'}}%%
`+d.textContent,t=mermaid.render("mermaid-"+t,e);let a=e=>{d.insertAdjacentHTML("afterend",e)};"string"==typeof t?a(t):t.then(({svg:e})=>a(e))})})(t),btf.addGlobalFn("themeChange",e,"mermaid"),window.loadMermaid?e():btf.getScript("https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js").then(e))};btf.addGlobalFn("encrypt",e,"mermaid"),window.pjax?e():document.addEventListener("DOMContentLoaded",e)})()</script><script>(()=>{let i=GLOBAL_CONFIG_SITE.isShuoshuo,n=t=>{window.DISQUS&&window.DISQUS.reset({reload:!0,config:t})};var t=(t,e)=>{i&&(window.shuoshuoComment.destroyDisqus=()=>{t.children.length&&(t.innerHTML="",t.classList.add("no-comment"))}),window.disqus_identifier=i?e:"/posts/2017/11/27/something-about-concurrent-future/",window.disqus_url=i?location.origin+e:"https://www.manjusaka.blog/posts/2017/11/27/something-about-concurrent-future/";function s(){this.page.url=disqus_url,this.page.identifier=disqus_identifier,this.page.title="Python concurrent.future 使用教程及源码初剖"}window.DISQUS?n(s):((e=document.createElement("script")).src="https://manjusakablog.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),document.head.appendChild(e)),btf.addGlobalFn("themeChange",()=>n(s),"disqus")};i?window.shuoshuoComment={loadComment:t}:t()})()</script></div><script defer=defer id=fluttering_ribbon mobile=false src=https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js></script><script src=https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!0,POWERMODE.mobile=!1,document.body.addEventListener("input",POWERMODE)</script><script async data-pjax src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script></div><script data-pjax>function butterfly_swiper_injector_config(){var s=document.getElementById("recent-posts");console.log("已挂载butterfly_swiper"),s.insertAdjacentHTML("afterbegin",'<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="/posts/2024/02/20/a-simple-discussion-about-the-ultraman/" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.pixabay.com/photo/2023/02/04/07/38/cherry-blossoms-7766587_1280.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2024-02-20</span><a class="blog-slider__title" href="/posts/2024/02/20/a-simple-discussion-about-the-ultraman/" alt="">简单聊聊奥特曼中很有趣的细节</a><div class="blog-slider__text">ヒーロが必要なんだよ，金城君。ヒーローが必要なんだ！</div><a class="blog-slider__button" href="/posts/2024/02/20/a-simple-discussion-about-the-ultraman/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="/posts/2023/12/29/per-aspera-ad-astra/" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.pixabay.com/photo/2023/02/06/16/46/sea-7772372_1280.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-12-29</span><a class="blog-slider__title" href="/posts/2023/12/29/per-aspera-ad-astra/" alt="">Per aspera, Ad astra</a><div class="blog-slider__text">再怎么看我也不知道怎么描述它的啦！</div><a class="blog-slider__button" href="/posts/2023/12/29/per-aspera-ad-astra/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="/posts/2023/10/24/open-source-is-simple-than-you-think/" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.pixabay.com/photo/2023/02/08/15/10/sculpture-7776861_1280.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-10-24</span><a class="blog-slider__title" href="/posts/2023/10/24/open-source-is-simple-than-you-think/" alt="">开源可能没你想的那么难</a><div class="blog-slider__text">再怎么看我也不知道怎么描述它的啦！</div><a class="blog-slider__button" href="/posts/2023/10/24/open-source-is-simple-than-you-think/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="/posts/2023/06/25/love-and-hope-is-all-we-need/" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://github.com/Zheaoli/yuque-py/assets/7054676/ea9460a2-e351-4b73-9f82-7aef6cd20c33" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-06-25</span><a class="blog-slider__title" href="/posts/2023/06/25/love-and-hope-is-all-we-need/" alt="">聊聊公益和助学</a><div class="blog-slider__text">很多时候，帮助人不需要那么多理由</div><a class="blog-slider__button" href="/posts/2023/06/25/love-and-hope-is-all-we-need/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="/posts/2023/12/28/how-do-I-build-homelab-part2/" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.pixabay.com/photo/2023/02/07/14/45/snow-7774312_1280.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-12-28</span><a class="blog-slider__title" href="/posts/2023/12/28/how-do-I-build-homelab-part2/" alt="">家庭 Homelab 升级计划: v2</a><div class="blog-slider__text">人生嘛，Homelab 图个乐子</div><a class="blog-slider__button" href="/posts/2023/12/28/how-do-I-build-homelab-part2/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="/posts/2023/06/19/why-do-I-love-ultraman/" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://user-images.githubusercontent.com/7054676/228287041-c86e7928-0da8-4097-b7ff-e575faa8cf8c.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-06-19</span><a class="blog-slider__title" href="/posts/2023/06/19/why-do-I-love-ultraman/" alt="">为什么奥特曼是我的信仰</a><div class="blog-slider__text">優しさを失わないでくれ。弱い者を労り互いに助け合い。</div><a class="blog-slider__button" href="/posts/2023/06/19/why-do-I-love-ultraman/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="/posts/2023/06/16/how-do-I-build-homelab/" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.pixabay.com/photo/2023/02/04/07/38/cherry-blossoms-7766587_1280.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-06-16</span><a class="blog-slider__title" href="/posts/2023/06/16/how-do-I-build-homelab/" alt="">家庭 Homelab 升级计划</a><div class="blog-slider__text">人生嘛，Homelab 图个乐子</div><a class="blog-slider__button" href="/posts/2023/06/16/how-do-I-build-homelab/" alt="">详情   </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>')}for(var elist="undefined".split(","),cpage=location.pathname,epage="all",flag=0,i=0;i<elist.length;i++)cpage.includes(elist[i])&&flag++;("all"===epage&&0==flag||epage===cpage)&&butterfly_swiper_injector_config()</script><script defer=defer src=https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.js></script><script defer=defer data-pjax src=https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper_init.js></script><script async src=//at.alicdn.com/t/font_2032782_8d5kxvn09md.js></script></body></html>