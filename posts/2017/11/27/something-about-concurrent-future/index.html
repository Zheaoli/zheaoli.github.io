<!DOCTYPE html><html lang=en data-theme=auto><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><title>Python concurrent.future 使用教程及源码初剖 | Manjusaka</title><meta name=author content=Manjusaka><meta name=copyright content=Manjusaka><meta name=format-detection content="telephone=no"><meta name=theme-color content=ffffff><meta name=description content="垃圾话很久没写博客了，想了想不能再划水，于是给自己定了一个目标，写点 concurrent.future 的内容，于是这篇文章就是来聊聊 Python 3.2 中新增的 concurrent.future 模块。"><meta property=og:type content=article><meta property=og:title content="Python concurrent.future 使用教程及源码初剖"><meta property=og:url content=https://www.manjusaka.blog/posts/2017/11/27/something-about-concurrent-future/index.html><meta property=og:site_name content=Manjusaka><meta property=og:description content="垃圾话很久没写博客了，想了想不能再划水，于是给自己定了一个目标，写点 concurrent.future 的内容，于是这篇文章就是来聊聊 Python 3.2 中新增的 concurrent.future 模块。"><meta property=og:locale content=en_US><meta property=og:image content=https://cdn.pixabay.com/photo/2023/02/08/15/10/sculpture-7776861_1280.jpg><meta property=article:published_time content=2017-11-27T16:09:54.000Z><meta property=article:modified_time content=2023-08-06T16:17:52.607Z><meta property=article:author content=Manjusaka><meta property=article:tag content=Python><meta property=article:tag content=编程><meta property=article:tag content=编程技巧><meta property=article:tag content=并发编程><meta property=article:tag content=源码剖析><meta name=twitter:card content=summary><meta name=twitter:image content="https://avatars.githubusercontent.com/u/7054676?v=4"><meta name=twitter:creator content=@Manjusaka_Lee><meta name=twitter:site content=https://twitter.com/Manjusaka_Lee><link rel="shortcut icon" href="https://avatars.githubusercontent.com/u/7054676?v=4"><link rel=canonical href=https://www.manjusaka.blog/posts/2017/11/27/something-about-concurrent-future/index.html><link rel=preconnect href=//cdn.jsdelivr.net><link rel=preconnect href=//www.google-analytics.com crossorigin=""><link rel=preconnect href=//busuanzi.ibruce.info><link rel=stylesheet href=/css/index.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css media=print onload='this.media="all"'><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css media=print onload='this.media="all"'><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css media=print onload='this.media="all"'><script async=async src="https://www.googletagmanager.com/gtag/js?id=UA-154407994-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-154407994-1")</script><script>const GLOBAL_CONFIG={root:"/",algolia:{appId:"DL1RURGHTB",indexName:"manjusaka.blog",hits:{per_page:6},languages:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}.",hits_stats:"${hits} results found in ${time} ms"}},localSearch:void 0,translate:{defaultEncoding:2,translateDelay:0,msgToTraditionalChinese:"繁",msgToSimplifiedChinese:"簡"},noticeOutdate:{limitDay:365,position:"top",messagePrev:"It has been",messageNext:"days since the last update, the content of the article may be outdated."},highlight:{plugin:"highlighjs",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:400},copy:{success:"Copy successfully",error:"Copy error",noSupport:"The browser does not support"},relativeDate:{homepage:!0,post:!0},runtime:"days",date_suffix:{just:"Just",min:"minutes ago",hour:"hours ago",day:"days ago",month:"months ago"},copyright:{limitCount:100,languages:{author:"Author: Manjusaka",link:"Link: ",source:"Source: Manjusaka",info:"Copyright is owned by the author. For commercial reprints, please contact the author for authorization. For non-commercial reprints, please indicate the source."}},lightbox:"fancybox",Snackbar:{chs_to_cht:"Traditional Chinese Activated Manually",cht_to_chs:"Simplified Chinese Activated Manually",day_to_night:"Dark Mode Activated Manually",night_to_day:"Light Mode Activated Manually",bgLight:"#59C173",bgDark:"#1f1f1f",position:"bottom-left"},source:{justifiedGallery:{js:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js",css:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css"}},isPhotoFigcaption:!0,islazyload:!0,isAnchor:!0,percent:{toc:!0,rightside:!0}}</script><script id=config-diff>var GLOBAL_CONFIG_SITE={title:"Python concurrent.future 使用教程及源码初剖",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2023-08-07 00:17:52"}</script><noscript><style type=text/css>#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:function(e,t,a){0!==a&&(a=864e5*a,t={value:t,expiry:(new Date).getTime()+a},localStorage.setItem(e,JSON.stringify(t)))},get:function(e){var t=localStorage.getItem(e);if(t){t=JSON.parse(t);if(!((new Date).getTime()>t.expiry))return t.value;localStorage.removeItem(e)}}},e.getScript=o=>new Promise((t,e)=>{const a=document.createElement("script");a.src=o,a.async=!0,a.onerror=e,a.onload=a.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},document.head.appendChild(a)}),e.getCSS=(o,n=!1)=>new Promise((t,e)=>{const a=document.createElement("link");a.rel="stylesheet",a.href=o,n&&(a.id=n),a.onerror=e,a.onload=a.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},document.head.appendChild(a)}),e.activateDarkMode=function(){document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},e.activateLightMode=function(){document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","ffffff")};var e=saveToLocal.get("theme"),t=window.matchMedia("(prefers-color-scheme: dark)").matches,a=window.matchMedia("(prefers-color-scheme: light)").matches,o=window.matchMedia("(prefers-color-scheme: no-preference)").matches,n=!t&&!a&&!o,t=(void 0===e?(a?activateLightMode():t?activateDarkMode():(o||n)&&((a=(new Date).getHours())<=6||18<=a?activateDarkMode:activateLightMode)(),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){void 0===saveToLocal.get("theme")&&(e.matches?activateDarkMode:activateLightMode)()})):("light"===e?activateLightMode:activateDarkMode)(),saveToLocal.get("aside-status"));void 0!==t&&("hide"===t?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})(window)</script><link rel=stylesheet href=https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.css media=print onload='this.media="all"'><link rel=stylesheet href=https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiperstyle.css media=print onload='this.media="all"'><link rel=stylesheet href=https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css media=defer onload='this.media="all"'><link rel=stylesheet href=https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css media=defer onload='this.media="all"'><script src=https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js></script><meta name=generator content="Hexo 6.3.0"><link rel=alternate href=/atom.xml title=Manjusaka type=application/atom+xml></head><body><div id=web_bg></div><div id=sidebar><div id=menu-mask></div><div id=sidebar-menus><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://avatars.githubusercontent.com/u/7054676?v=4" onerror='onerror=null,src="/img/friend_404.gif"' alt=avatar></div><div class="sidebar-site-data site-data is-center"><a href=/archives/ ><div class=headline>Articles</div><div class=length-num>75</div></a><a href=/tags/ ><div class=headline>Tags</div><div class=length-num>51</div></a><a href=/categories/ ><div class=headline>Categories</div><div class=length-num>32</div></a></div><hr><div class=menus_items><div class=menus_item><a class=site-page href=/ ><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class=menus_item><a class="site-page group" href=javascript:void(0); rel="external nofollow noreferrer"><i class="fa-fw fa-fw fas fa-lines-leaning"></i><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class=menus_item_child><li><a class="site-page child" href=/categories/ ><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href=/tags/ ><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href=/archives/ ><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href=/random/ ><i class="fa-fw fas fa-random"></i><span> 随便逛逛</span></a></li></ul></div><div class=menus_item><a class=site-page href=/weekly/ ><i class="fa-fw fas fa-newspaper"></i><span> 周报</span></a></div><div class=menus_item><a class="site-page group" href=javascript:void(0); rel="external nofollow noreferrer"><i class="fa-fw fas fa-heart"></i><span> 我的</span><i class="fas fa-chevron-down"></i></a><ul class=menus_item_child><li><a class="site-page child" href=/about/ ><i class="fa-fw fas fa-spa"></i><span> 关于</span></a></li><li><a class="site-page child" href=/weekly/ ><i class="fa-fw fas fa-newspaper"></i><span> 周报</span></a></li></ul></div></div></div></div><div class=post id=body-wrap><header class=post-bg id=page-header style=background-image:url(https://cdn.pixabay.com/photo/2023/02/08/15/10/sculpture-7776861_1280.jpg)><nav id=nav><span id=blog-info><a href=/ title=Manjusaka><img class=site-icon src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://avatars.githubusercontent.com/u/7054676?v=4# image"><span class=site-name>Manjusaka</span></a></span><div id=menus><div id=search-button><a class="site-page social-icon search" href=javascript:void(0); rel="external nofollow noreferrer"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class=menus_items><div class=menus_item><a class=site-page href=/ ><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class=menus_item><a class="site-page group" href=javascript:void(0); rel="external nofollow noreferrer"><i class="fa-fw fa-fw fas fa-lines-leaning"></i><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class=menus_item_child><li><a class="site-page child" href=/categories/ ><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href=/tags/ ><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href=/archives/ ><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href=/random/ ><i class="fa-fw fas fa-random"></i><span> 随便逛逛</span></a></li></ul></div><div class=menus_item><a class=site-page href=/weekly/ ><i class="fa-fw fas fa-newspaper"></i><span> 周报</span></a></div><div class=menus_item><a class="site-page group" href=javascript:void(0); rel="external nofollow noreferrer"><i class="fa-fw fas fa-heart"></i><span> 我的</span><i class="fas fa-chevron-down"></i></a><ul class=menus_item_child><li><a class="site-page child" href=/about/ ><i class="fa-fw fas fa-spa"></i><span> 关于</span></a></li><li><a class="site-page child" href=/weekly/ ><i class="fa-fw fas fa-newspaper"></i><span> 周报</span></a></li></ul></div></div><div id=toggle-menu><a class=site-page href=javascript:void(0); rel="external nofollow noreferrer"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id=post-info><h1 class=post-title>Python concurrent.future 使用教程及源码初剖<a class=post-edit-link href=https://github.com/Zheaoli/Zheaoli.github.io/edit/main/source/_posts/something-about-concurrent-future.md rel="external nofollow noreferrer" title="Edited on" target=_blank><i class="fas fa-pencil-alt"></i></a></h1><div id=post-meta><div class=meta-firstline><span class=post-meta-date><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class=post-meta-label>Created</span><time datetime=2017-11-27T16:09:54.000Z title="Created 2017-11-28 00:09:54">2017-11-28</time></span><span class=post-meta-categories><span class=post-meta-separator>|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class=post-meta-categories href=/categories/%E7%BC%96%E7%A8%8B/ >编程</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class=post-meta-categories href=/categories/%E7%BC%96%E7%A8%8B/Python/ >Python</a></span></div><div class=meta-secondline><span class=post-meta-separator>|</span><span class=post-meta-wordcount><i class="far fa-file-word fa-fw post-meta-icon"></i><span class=post-meta-label>Word count:</span><span class=word-count>6.1k</span><span class=post-meta-separator>|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class=post-meta-label>Reading time:</span><span>27min</span></span><span class=post-meta-separator>|</span><span class=post-meta-pv-cv id="" data-flag-title="Python concurrent.future 使用教程及源码初剖"><i class="far fa-eye fa-fw post-meta-icon"></i><span class=post-meta-label>Post View:</span><span id=busuanzi_value_page_pv><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class=layout id=content-inner><div id=post><article class=post-content id=article-container><h1 id=垃圾话><a href=#垃圾话 class=headerlink title=垃圾话></a>垃圾话</h1><p>很久没写博客了，想了想不能再划水，于是给自己定了一个目标，写点 <strong>concurrent.future</strong> 的内容，于是这篇文章就是来聊聊 Python 3.2 中新增的 <strong>concurrent.future</strong> 模块。</p><span id=more></span><h1 id=正文><a href=#正文 class=headerlink title=正文></a>正文</h1><h2 id=Python-的异步处理><a href=#Python-的异步处理 class=headerlink title="Python 的异步处理"></a>Python 的异步处理</h2><p>有一个 Python 开发工程师小明，在面试过程中，突然接到这样一个需求：去请求几个网站，拿到他们的数据，小明定睛一想，简单啊，噼里啪啦，他写了如下的代码</p><figure class="highlight python"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br></pre></td><td class=code><pre><span class=line></span><br><span class=line><span class=keyword>import</span> multiprocessing</span><br><span class=line><span class=keyword>import</span> time</span><br><span class=line></span><br><span class=line></span><br><span class=line><span class=keyword>def</span> <span class="title function_">request_url</span>(<span class=params>query_url: <span class=built_in>str</span></span>):</span><br><span class=line>    time.sleep(<span class=number>3</span>)  <span class=comment># 请求处理逻辑</span></span><br><span class=line></span><br><span class=line></span><br><span class=line><span class=keyword>if</span> __name__ == <span class=string>&#x27;__main__&#x27;</span>:</span><br><span class=line>    url_list = [<span class=string>&quot;abc.com&quot;</span>, <span class=string>&quot;xyz.com&quot;</span>]</span><br><span class=line>    task_list = [multiprocessing.Process(target=request_url, args=(url,)) <span class=keyword>for</span> url <span class=keyword>in</span> url_list]</span><br><span class=line>    [task.start() <span class=keyword>for</span> task <span class=keyword>in</span> task_list]</span><br><span class=line>    [task.join() <span class=keyword>for</span> task <span class=keyword>in</span> task_list]</span><br></pre></td></tr></table></figure><p>Easy, 好了，现在新的需求来了，我们想获取每一个请求结果，怎么办?小明想了想，又写出如下的代码</p><figure class="highlight python"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br></pre></td><td class=code><pre><span class=line></span><br><span class=line><span class=keyword>import</span> multiprocessing</span><br><span class=line><span class=keyword>import</span> time</span><br><span class=line></span><br><span class=line></span><br><span class=line><span class=keyword>def</span> <span class="title function_">request_url</span>(<span class=params>query_url: <span class=built_in>str</span>, result_dict: <span class=built_in>dict</span></span>):</span><br><span class=line>    time.sleep(<span class=number>3</span>)  <span class=comment># 请求处理逻辑</span></span><br><span class=line>    result_dict[query_url] = &#123;&#125;  <span class=comment># 返回结果</span></span><br><span class=line></span><br><span class=line></span><br><span class=line><span class=keyword>if</span> __name__ == <span class=string>&#x27;__main__&#x27;</span>:</span><br><span class=line>    process_manager = multiprocessing.Manager()</span><br><span class=line>    result_dict = process_manager.<span class=built_in>dict</span>()</span><br><span class=line>    url_list = [<span class=string>&quot;abc.com&quot;</span>, <span class=string>&quot;xyz.com&quot;</span>]</span><br><span class=line>    task_list = [multiprocessing.Process(target=request_url, args=(url, result_dict)) <span class=keyword>for</span> url <span class=keyword>in</span> url_list]</span><br><span class=line>    [task.start() <span class=keyword>for</span> task <span class=keyword>in</span> task_list]</span><br><span class=line>    [task.join() <span class=keyword>for</span> task <span class=keyword>in</span> task_list]</span><br><span class=line>    <span class=built_in>print</span>(result_dict)</span><br></pre></td></tr></table></figure><p>好了，面试官说，恩看起来不错，好了，我再改改题目，首先，我们不能阻塞主进程，主进程需要根据任务当前的状态（结束/未结束）来及时的获取对应的结果，怎么改？，小明想了想，要不，我们直接用信号量，让任务完成后，向父进程发送一个信号量？然后直接暴力出奇迹？还有更简单的方法么？貌似没了？最后面试官心理说了一句 naive ，脸上笑而不语，让小明回去慢慢等消息。</p><p>从小明的窘境，我们可以看出一个这样的问题，就是我们最常用的 <code>multiprocessing</code> 或者是 <code>threding</code> 两个模块，对于我们想实现异步任务的场景来说，其实略有一点不友好的，我们往往需要做一些额外的工作，才能比较干净的实现一些异步的需求。为了解决这样的窘境，09 年 10 月，Brian Quinlan 先生提出了 <a target=_blank rel="noopener external nofollow noreferrer" href=https://www.python.org/dev/peps/pep-3148/ >PEP 3148</a> ，在这个提案中，他提出将我们常用的 <code>multiprocessing</code> 和 <code>threding</code> 模块进行进一步封装，达成较好的支持异步操作的目的。最终这个提案在 Python 3.2 中被引入。也就是我们今天要聊聊的 <strong>concurrent.future</strong> 。</p><h2 id=Future-模式><a href=#Future-模式 class=headerlink title="Future 模式"></a>Future 模式</h2><p>在我们正式开始聊新模块之前，我们需要去了解关于 <code>Future</code> 模式的相关姿势</p><p>首先 <code>Future</code> 模式，是什么？</p><p><code>Future</code> 其实是<strong>生产-消费者</strong>模型的一种扩展，在<strong>生产-消费者</strong>模型中，生产者不关心消费者什么时候处理完数据，也不关心消费者处理的结果。比如我们经常写出如下的代码</p><figure class="highlight python"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br></pre></td><td class=code><pre><span class=line></span><br><span class=line><span class=keyword>import</span> multiprocessing, Queue</span><br><span class=line><span class=keyword>import</span> os</span><br><span class=line><span class=keyword>import</span> time</span><br><span class=line><span class=keyword>from</span> multiprocessing <span class=keyword>import</span> Process</span><br><span class=line><span class=keyword>from</span> time <span class=keyword>import</span> sleep</span><br><span class=line><span class=keyword>from</span> random <span class=keyword>import</span> randint</span><br><span class=line></span><br><span class=line><span class=keyword>class</span> <span class="title class_">Producer</span>(multiprocessing.Process):</span><br><span class=line>    <span class=keyword>def</span> <span class="title function_">__init__</span>(<span class=params>self, queue</span>):</span><br><span class=line>        multiprocessing.Process.__init__(self)</span><br><span class=line>        self.queue = queue</span><br><span class=line>        </span><br><span class=line>    <span class=keyword>def</span> <span class="title function_">run</span>(<span class=params>self</span>):</span><br><span class=line>        <span class=keyword>while</span> <span class=literal>True</span>:</span><br><span class=line>            self.queue.put(<span class=string>&#x27;one product&#x27;</span>)</span><br><span class=line>            <span class=built_in>print</span>(multiprocessing.current_process().name + <span class=built_in>str</span>(os.getpid()) + <span class=string>&#x27; produced one product, the no of queue now is: %d&#x27;</span> %self.queue.qsize())</span><br><span class=line>            sleep(randint(<span class=number>1</span>, <span class=number>3</span>))</span><br><span class=line>        </span><br><span class=line>        </span><br><span class=line><span class=keyword>class</span> <span class="title class_">Consumer</span>(multiprocessing.Process):</span><br><span class=line>    <span class=keyword>def</span> <span class="title function_">__init__</span>(<span class=params>self, queue</span>):</span><br><span class=line>        multiprocessing.Process.__init__(self)</span><br><span class=line>        self.queue = queue</span><br><span class=line>        </span><br><span class=line>    <span class=keyword>def</span> <span class="title function_">run</span>(<span class=params>self</span>):</span><br><span class=line>        <span class=keyword>while</span> <span class=literal>True</span>:</span><br><span class=line>            d = self.queue.get(<span class=number>1</span>)</span><br><span class=line>            <span class=keyword>if</span> d != <span class=literal>None</span>:</span><br><span class=line>                <span class=built_in>print</span>(multiprocessing.current_process().name + <span class=built_in>str</span>(os.getpid()) + <span class=string>&#x27; consumed  %s, the no of queue now is: %d&#x27;</span> %(d,self.queue.qsize()))</span><br><span class=line>                sleep(randint(<span class=number>1</span>, <span class=number>4</span>))</span><br><span class=line>                <span class=keyword>continue</span></span><br><span class=line>            <span class=keyword>else</span>:</span><br><span class=line>                <span class=keyword>break</span></span><br><span class=line>                </span><br><span class=line><span class=comment>#create queue</span></span><br><span class=line>queue = multiprocessing.Queue(<span class=number>40</span>)</span><br><span class=line>       </span><br><span class=line><span class=keyword>if</span> __name__ == <span class=string>&quot;__main__&quot;</span>:</span><br><span class=line>    <span class=built_in>print</span>(<span class=string>&#x27;Excited!&quot;)</span></span><br><span class=line><span class=string>    #create processes    </span></span><br><span class=line><span class=string>    processed = []</span></span><br><span class=line><span class=string>    for i in range(3):</span></span><br><span class=line><span class=string>        processed.append(Producer(queue))</span></span><br><span class=line><span class=string>        processed.append(Consumer(queue))</span></span><br><span class=line><span class=string>        </span></span><br><span class=line><span class=string>    #start processes        </span></span><br><span class=line><span class=string>    for i in range(len(processed)):</span></span><br><span class=line><span class=string>        processed[i].start()</span></span><br><span class=line><span class=string>    </span></span><br><span class=line><span class=string>    #join processes    </span></span><br><span class=line><span class=string>    for i in range(len(processed)):</span></span><br><span class=line><span class=string>        processed[i].join()  </span></span><br></pre></td></tr></table></figure><p>这就是<strong>生产-消费者</strong>模型的一个简单的实现，我们利用一个 <code>multiprocessing</code> 中的 <code>Queue</code> 来作为通信渠道，我们的生产者负责往队列中传入数据，消费者负责从队列中获取数据并处理。不过就如同上面所说的一样，在这种模式中，生产者并不关心消费者何时处理完数据，也不关心处理的结果。而在 <code>Future</code> 中，我们可以让生产者等待消息处理完成，如果需要的话，我们还可以获取相关的计算结果。</p><p>比如，大家可以看看下面这样一段 Java 代码</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br></pre></td><td class=code><pre><span class=line><span class=keyword>package</span> concurrent;</span><br><span class=line></span><br><span class=line><span class=keyword>import</span> java.util.concurrent.Callable;</span><br><span class=line></span><br><span class=line><span class=keyword>public</span> <span class=keyword>class</span> <span class="title class_">DataProcessThread</span> <span class=keyword>implements</span> <span class="title class_">Callable</span>&lt;String&gt; &#123;</span><br><span class=line></span><br><span class=line>	<span class=meta>@Override</span></span><br><span class=line>	<span class=keyword>public</span> String <span class="title function_">call</span><span class=params>()</span> <span class=keyword>throws</span> Exception &#123;</span><br><span class=line>		<span class=comment>// TODO Auto-generated method stub</span></span><br><span class=line>		Thread.sleep(<span class=number>10000</span>);<span class=comment>//模拟数据处理</span></span><br><span class=line>		<span class=keyword>return</span> <span class=string>&quot;数据返回&quot;</span>;</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>这是我们负责处理数据的代码。</p><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br></pre></td><td class=code><pre><span class=line></span><br><span class=line><span class=keyword>package</span> concurrent;</span><br><span class=line></span><br><span class=line><span class=keyword>import</span> java.util.concurrent.ExecutionException;</span><br><span class=line><span class=keyword>import</span> java.util.concurrent.ExecutorService;</span><br><span class=line><span class=keyword>import</span> java.util.concurrent.Executors;</span><br><span class=line><span class=keyword>import</span> java.util.concurrent.FutureTask;</span><br><span class=line></span><br><span class=line><span class=keyword>public</span> <span class=keyword>class</span> <span class="title class_">MainThread</span> &#123;</span><br><span class=line></span><br><span class=line>	<span class=keyword>public</span> <span class=keyword>static</span> <span class=keyword>void</span> <span class="title function_">main</span><span class=params>(String[] args)</span> <span class=keyword>throws</span> InterruptedException,</span><br><span class=line>			ExecutionException &#123;</span><br><span class=line>		<span class=comment>// TODO Auto-generated method stub</span></span><br><span class=line>		<span class=type>DataProcessThread</span> <span class=variable>dataProcessThread</span> <span class=operator>=</span> <span class=keyword>new</span> <span class="title class_">DataProcessThread</span>();</span><br><span class=line>		FutureTask&lt;String&gt; future = <span class=keyword>new</span> <span class="title class_">FutureTask</span>&lt;String&gt;(dataProcessThread);</span><br><span class=line></span><br><span class=line>		<span class=type>ExecutorService</span> <span class=variable>executor</span> <span class=operator>=</span> Executors.newFixedThreadPool(<span class=number>1</span>);</span><br><span class=line>		executor.submit(future);</span><br><span class=line></span><br><span class=line>		Thread.sleep(<span class=number>10000</span>);<span class=comment>//模拟继续处理自身其他业务</span></span><br><span class=line>		<span class=keyword>while</span> (<span class=literal>true</span>) &#123;</span><br><span class=line>			<span class=keyword>if</span> (future.isDone()) &#123;</span><br><span class=line>				System.out.println(future.get());</span><br><span class=line>				<span class=keyword>break</span>;</span><br><span class=line>			&#125;</span><br><span class=line>		&#125;</span><br><span class=line>		executor.shutdown();</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>&#125;</span><br><span class=line></span><br></pre></td></tr></table></figure><p>这是我们主线程，大家可以看到，我们可以很方便的获取数据处理任务的状态。同时获取相关的结果。</p><h2 id=Python-中的-concurrent-futures><a href=#Python-中的-concurrent-futures class=headerlink title="Python 中的 concurrent.futures"></a>Python 中的 concurrent.futures</h2><p>前面说了，在 Python 3.2 以后，<strong>concurrent.futures</strong>　是内置的模块，我们可以直接使用</p><blockquote><p><strong>Note</strong>: 如果你需要在 Python 2.7 中使用 <strong>concurrent.futures</strong> , 那么请用 pip 进行安装，<code>pip install futures</code></p></blockquote><p>好了，准备就绪后，我们来看看怎么使用这个东西呢</p><figure class="highlight python"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br></pre></td><td class=code><pre><span class=line></span><br><span class=line><span class=keyword>from</span> concurrent.futures <span class=keyword>import</span> ProcessPoolExecutor</span><br><span class=line><span class=keyword>import</span> time</span><br><span class=line></span><br><span class=line></span><br><span class=line><span class=keyword>def</span> <span class="title function_">return_future_result</span>(<span class=params>message</span>):</span><br><span class=line>    time.sleep(<span class=number>2</span>)</span><br><span class=line>    <span class=keyword>return</span> message</span><br><span class=line></span><br><span class=line></span><br><span class=line><span class=keyword>if</span> __name__ == <span class=string>&#x27;__main__&#x27;</span>:</span><br><span class=line>    pool = ProcessPoolExecutor(max_workers=<span class=number>2</span>)  <span class=comment># 创建一个最大可容纳2个task的进程池</span></span><br><span class=line>    future1 = pool.submit(return_future_result, (<span class=string>&quot;hello&quot;</span>))  <span class=comment># 往进程池里面加入一个task</span></span><br><span class=line>    future2 = pool.submit(return_future_result, (<span class=string>&quot;world&quot;</span>))  <span class=comment># 往进程池里面加入一个task</span></span><br><span class=line>    <span class=built_in>print</span>(future1.done())  <span class=comment># 判断task1是否结束</span></span><br><span class=line>    time.sleep(<span class=number>3</span>)</span><br><span class=line>    <span class=built_in>print</span>(future2.done())  <span class=comment># 判断task2是否结束</span></span><br><span class=line>    <span class=built_in>print</span>(future1.result())  <span class=comment># 查看task1返回的结果</span></span><br><span class=line>    <span class=built_in>print</span>(future2.result())  <span class=comment># 查看task2返回的结果</span></span><br></pre></td></tr></table></figure><p>首先 <code>from concurrent.futures import ProcessPoolExecutor</code> 从 <code>concurrent.futures</code> 引入 <code>ProcessPoolExecutor</code> 作为我们的进程池，处理我们后面的数据。(在 <code>concurrent.futures</code> 中，为我们提供了两种 <code>Executor</code> ，一种是我们现在用的 <code>ProcessPoolExecutor</code>, 一种是 <code>ThreadPoolExecutor</code> 他们对外暴露的方法一致，大家可以根据自己的实际需求选用。)</p><p>紧接着，初始化一个最大容量为 2 的进程池。然后我们调用进程池中的 <code>submit</code> 方法提交一个任务。好了有意思的点来了，我们在调用 <code>submit</code> 方法后，得到了一个特殊的变量，这个变量是 <code>Future</code> 类的实例，代表着一个在未来完成的操作。换句话说，当 <code>submit</code> 返回 <code>Future</code> 实例的时候，我们的任务可能还没有完成，我们可以通过调用 <code>Future</code> 实例中的 <code>done</code> 方法来获取当前任务的运行状态，如果任务结束后，我们可以通过 <code>result</code> 方法来获取返回的结果。如果在执行后续的逻辑时，我们因为一些原因想要取消任务时，我们可以通过调用 <code>cancel</code> 方法来取消当前的任务。</p><p>现在新的问题来了，我们如果想要提交很多个任务应该怎么办呢？<code>concurrent.future</code> 为我们提供了 <code>map</code> 方法来方便我们批量添加任务。</p><figure class="highlight python"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br></pre></td><td class=code><pre><span class=line><span class=keyword>import</span> concurrent.futures</span><br><span class=line><span class=keyword>import</span> requests</span><br><span class=line></span><br><span class=line>task_url = [(<span class=string>&#x27;http://www.baidu.com&#x27;</span>, <span class=number>40</span>), (<span class=string>&#x27;http://example.com/&#x27;</span>, <span class=number>40</span>), (<span class=string>&#x27;https://www.github.com/&#x27;</span>, <span class=number>40</span>)]</span><br><span class=line></span><br><span class=line></span><br><span class=line><span class=keyword>def</span> <span class="title function_">load_url</span>(<span class=params>params: <span class=built_in>tuple</span></span>):</span><br><span class=line>    <span class=keyword>return</span> requests.get(params[<span class=number>0</span>], timeout=params[<span class=number>1</span>]).text</span><br><span class=line></span><br><span class=line></span><br><span class=line><span class=keyword>if</span> __name__ == <span class=string>&#x27;__main__&#x27;</span>:</span><br><span class=line>    <span class=keyword>with</span> concurrent.futures.ProcessPoolExecutor(max_workers=<span class=number>3</span>) <span class=keyword>as</span> executor:</span><br><span class=line>        <span class=keyword>for</span> url, data <span class=keyword>in</span> <span class=built_in>zip</span>(task_url, executor.<span class=built_in>map</span>(load_url, task_url)):</span><br><span class=line>            <span class=built_in>print</span>(<span class=string>&#x27;%r page is %d bytes&#x27;</span> % (url, <span class=built_in>len</span>(data)))</span><br><span class=line></span><br></pre></td></tr></table></figure><p>恩，<code>concurrent.future</code> 中线程/进程池所提供的 <code>map</code> 方法和标准库中的 <code>map</code> 函数使用方法一样。</p><h2 id=剖一下-concurrent-futures><a href=#剖一下-concurrent-futures class=headerlink title="剖一下 concurrent.futures"></a>剖一下 concurrent.futures</h2><p>前面讲了怎么使用 <code>concurrent.futures</code> 后，我们都比较好奇，<code>concurrent.futures</code> 是怎么实现 <code>Future</code> 模式的。里面是怎么将任务和结果进行关联的。我们现在开始从 <code>submit</code> 方法着手来简单看一下 <code>ProcessPoolExecutor</code> 的实现。</p><p>首先，在初始化 <code>ProcessPoolExecutor</code> 时，它的 <code>__init__</code> 方法中进行了一些关键变量的初始化操作。</p><figure class="highlight python"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br></pre></td><td class=code><pre><span class=line></span><br><span class=line><span class=keyword>class</span> <span class="title class_">ProcessPoolExecutor</span>(_base.Executor):</span><br><span class=line>    <span class=keyword>def</span> <span class="title function_">__init__</span>(<span class=params>self, max_workers=<span class=literal>None</span></span>):</span><br><span class=line>        <span class=string>&quot;&quot;&quot;Initializes a new ProcessPoolExecutor instance.</span></span><br><span class=line><span class=string></span></span><br><span class=line><span class=string>        Args:</span></span><br><span class=line><span class=string>            max_workers: The maximum number of processes that can be used to</span></span><br><span class=line><span class=string>                execute the given calls. If None or not given then as many</span></span><br><span class=line><span class=string>                worker processes will be created as the machine has processors.</span></span><br><span class=line><span class=string>        &quot;&quot;&quot;</span></span><br><span class=line>        _check_system_limits()</span><br><span class=line></span><br><span class=line>        <span class=keyword>if</span> max_workers <span class=keyword>is</span> <span class=literal>None</span>:</span><br><span class=line>            self._max_workers = os.cpu_count() <span class=keyword>or</span> <span class=number>1</span></span><br><span class=line>        <span class=keyword>else</span>:</span><br><span class=line>            <span class=keyword>if</span> max_workers &lt;= <span class=number>0</span>:</span><br><span class=line>                <span class=keyword>raise</span> ValueError(<span class=string>&quot;max_workers must be greater than 0&quot;</span>)</span><br><span class=line></span><br><span class=line>            self._max_workers = max_workers</span><br><span class=line></span><br><span class=line>        <span class=comment># Make the call queue slightly larger than the number of processes to</span></span><br><span class=line>        <span class=comment># prevent the worker processes from idling. But don&#x27;t make it too big</span></span><br><span class=line>        <span class=comment># because futures in the call queue cannot be cancelled.</span></span><br><span class=line>        self._call_queue = multiprocessing.Queue(self._max_workers +</span><br><span class=line>                                                 EXTRA_QUEUED_CALLS)</span><br><span class=line>        <span class=comment># Killed worker processes can produce spurious &quot;broken pipe&quot;</span></span><br><span class=line>        <span class=comment># tracebacks in the queue&#x27;s own worker thread. But we detect killed</span></span><br><span class=line>        <span class=comment># processes anyway, so silence the tracebacks.</span></span><br><span class=line>        self._call_queue._ignore_epipe = <span class=literal>True</span></span><br><span class=line>        self._result_queue = SimpleQueue()</span><br><span class=line>        self._work_ids = queue.Queue()</span><br><span class=line>        self._queue_management_thread = <span class=literal>None</span></span><br><span class=line>        <span class=comment># Map of pids to processes</span></span><br><span class=line>        self._processes = &#123;&#125;</span><br><span class=line></span><br><span class=line>        <span class=comment># Shutdown is a two-step process.</span></span><br><span class=line>        self._shutdown_thread = <span class=literal>False</span></span><br><span class=line>        self._shutdown_lock = threading.Lock()</span><br><span class=line>        self._broken = <span class=literal>False</span></span><br><span class=line>        self._queue_count = <span class=number>0</span></span><br><span class=line>        self._pending_work_items = &#123;&#125;</span><br></pre></td></tr></table></figure><p>好了，我们来看看我们今天的入口 <code>submit</code> 方法</p><figure class="highlight python"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br></pre></td><td class=code><pre><span class=line></span><br><span class=line><span class=keyword>def</span> <span class="title function_">submit</span>(<span class=params>self, fn, *args, **kwargs</span>):</span><br><span class=line>    <span class=keyword>with</span> self._shutdown_lock:</span><br><span class=line>        <span class=keyword>if</span> self._broken:</span><br><span class=line>            <span class=keyword>raise</span> BrokenProcessPool(<span class=string>&#x27;A child process terminated &#x27;</span></span><br><span class=line>                <span class=string>&#x27;abruptly, the process pool is not usable anymore&#x27;</span>)</span><br><span class=line>        <span class=keyword>if</span> self._shutdown_thread:</span><br><span class=line>            <span class=keyword>raise</span> RuntimeError(<span class=string>&#x27;cannot schedule new futures after shutdown&#x27;</span>)</span><br><span class=line>        f = _base.Future()</span><br><span class=line>        w = _WorkItem(f, fn, args, kwargs)</span><br><span class=line>        self._pending_work_items[self._queue_count] = w</span><br><span class=line>        self._work_ids.put(self._queue_count)</span><br><span class=line>        self._queue_count += <span class=number>1</span></span><br><span class=line>        <span class=comment># Wake up queue management thread</span></span><br><span class=line>        self._result_queue.put(<span class=literal>None</span>)</span><br><span class=line>        self._start_queue_management_thread()</span><br><span class=line>        <span class=keyword>return</span> f</span><br></pre></td></tr></table></figure><p>首先，传入的参数 <code>fn</code> 是我们的处理函数，<code>args</code> 以及 <code>kwargs</code> 是我们要传递 <code>fn</code> 函数的参数。在 <code>submit</code> 函数最开始，首先根据 <code>_broken</code> 和 <code>_shutdown_thread</code> 的值来判断当前进程池中处理进程的状态以及目前进程池的状态。如果处理进程突然被销毁或者进程池已经被关闭，那么将抛出异常表明目前不再接受新的 <code>submit</code> 操作。</p><p>如果前面状态没有问题，首先，实例化 <code>Future</code> 类，然后将这个实例和处理函数和相关参数一起，作为参数来实例化 <code>_WorkItem</code> 类，然后将实例 w 作为 value ，<code>_queue_count</code> 作为 key 存入 <code>_pending_work_items</code> 中。然后调用 <code>_start_queue_management_thread</code> 方法开启进程池中的管理线程。现在来看看这部分代码</p><figure class="highlight python"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br></pre></td><td class=code><pre><span class=line></span><br><span class=line><span class=keyword>def</span> <span class="title function_">_start_queue_management_thread</span>(<span class=params>self</span>):</span><br><span class=line>    <span class=comment># When the executor gets lost, the weakref callback will wake up</span></span><br><span class=line>    <span class=comment># the queue management thread.</span></span><br><span class=line>    <span class=keyword>def</span> <span class="title function_">weakref_cb</span>(<span class=params>_, q=self._result_queue</span>):</span><br><span class=line>        q.put(<span class=literal>None</span>)</span><br><span class=line></span><br><span class=line>    <span class=keyword>if</span> self._queue_management_thread <span class=keyword>is</span> <span class=literal>None</span>:</span><br><span class=line>        <span class=comment># Start the processes so that their sentinels are known.</span></span><br><span class=line>        self._adjust_process_count()</span><br><span class=line>        self._queue_management_thread = threading.Thread(</span><br><span class=line>            target=_queue_management_worker,</span><br><span class=line>            args=(weakref.ref(self, weakref_cb),</span><br><span class=line>                  self._processes,</span><br><span class=line>                  self._pending_work_items,</span><br><span class=line>                  self._work_ids,</span><br><span class=line>                  self._call_queue,</span><br><span class=line>                  self._result_queue))</span><br><span class=line>        self._queue_management_thread.daemon = <span class=literal>True</span></span><br><span class=line>        self._queue_management_thread.start()</span><br><span class=line>        _threads_queues[self._queue_management_thread] = self._result_queue</span><br></pre></td></tr></table></figure><p>这一部分很简单，首先运行 <code>_adjust_process_count</code> 方法，然后开启一个守护线程，运行 <code>_queue_management_worker</code> 方法。我们首先来看看 <code>_adjust_process_count</code> 方法。</p><figure class="highlight python"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre></td><td class=code><pre><span class=line><span class=keyword>def</span> <span class="title function_">_adjust_process_count</span>(<span class=params>self</span>):</span><br><span class=line>    <span class=keyword>for</span> _ <span class=keyword>in</span> <span class=built_in>range</span>(<span class=built_in>len</span>(self._processes), self._max_workers):</span><br><span class=line>        p = multiprocessing.Process(</span><br><span class=line>                target=_process_worker,</span><br><span class=line>                args=(self._call_queue,</span><br><span class=line>                      self._result_queue))</span><br><span class=line>        p.start()</span><br><span class=line>        self._processes[p.pid] = p</span><br></pre></td></tr></table></figure><p>根据在 <code>__init__</code> 方法中设定的 <code>_max_workers</code> 来开启对应数量的进程，在进程中运行 <code>_process_worker</code> 函数。</p><p>恩，顺藤摸瓜，我们先来看看 <code>_process_worker</code> 函数吧？</p><figure class="highlight python"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br></pre></td><td class=code><pre><span class=line></span><br><span class=line><span class=keyword>def</span> <span class="title function_">_process_worker</span>(<span class=params>call_queue, result_queue</span>):</span><br><span class=line>    <span class=string>&quot;&quot;&quot;Evaluates calls from call_queue and places the results in result_queue.</span></span><br><span class=line><span class=string></span></span><br><span class=line><span class=string>    This worker is run in a separate process.</span></span><br><span class=line><span class=string></span></span><br><span class=line><span class=string>    Args:</span></span><br><span class=line><span class=string>        call_queue: A multiprocessing.Queue of _CallItems that will be read and</span></span><br><span class=line><span class=string>            evaluated by the worker.</span></span><br><span class=line><span class=string>        result_queue: A multiprocessing.Queue of _ResultItems that will written</span></span><br><span class=line><span class=string>            to by the worker.</span></span><br><span class=line><span class=string>        shutdown: A multiprocessing.Event that will be set as a signal to the</span></span><br><span class=line><span class=string>            worker that it should exit when call_queue is empty.</span></span><br><span class=line><span class=string>    &quot;&quot;&quot;</span></span><br><span class=line>    <span class=keyword>while</span> <span class=literal>True</span>:</span><br><span class=line>        call_item = call_queue.get(block=<span class=literal>True</span>)</span><br><span class=line>        <span class=keyword>if</span> call_item <span class=keyword>is</span> <span class=literal>None</span>:</span><br><span class=line>            <span class=comment># Wake up queue management thread</span></span><br><span class=line>            result_queue.put(os.getpid())</span><br><span class=line>            <span class=keyword>return</span></span><br><span class=line>        <span class=keyword>try</span>:</span><br><span class=line>            r = call_item.fn(*call_item.args, **call_item.kwargs)</span><br><span class=line>        <span class=keyword>except</span> BaseException <span class=keyword>as</span> e:</span><br><span class=line>            exc = _ExceptionWithTraceback(e, e.__traceback__)</span><br><span class=line>            result_queue.put(_ResultItem(call_item.work_id, exception=exc))</span><br><span class=line>        <span class=keyword>else</span>:</span><br><span class=line>            result_queue.put(_ResultItem(call_item.work_id,</span><br><span class=line>                                         result=r))</span><br></pre></td></tr></table></figure><p>首先，这里搞了一个死循环，紧接着，我们从 <code>call_queue</code> 队列中获取一个 <code>_WorkItem</code> 实例，然后如果获取的值为 <code>None</code> 的话，那么证明没有新的任务进来了，我们可以把当前进程的 <code>pid</code> 放入结果队列中。然后结束进程。</p><p>如果收到了任务，那么执行这个任务。不管是在执行过程中发生异常，亦或者是得到最终的结果，都将其封装为 <code>_ResultItem</code> 实例，并将其放入结果队列中。</p><p>好了，我们回到刚刚看了一半的 <code>_start_queue_management_thread</code> 函数，</p><figure class="highlight python"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br></pre></td><td class=code><pre><span class=line></span><br><span class=line><span class=keyword>def</span> <span class="title function_">_start_queue_management_thread</span>(<span class=params>self</span>):</span><br><span class=line>    <span class=comment># When the executor gets lost, the weakref callback will wake up</span></span><br><span class=line>    <span class=comment># the queue management thread.</span></span><br><span class=line>    <span class=keyword>def</span> <span class="title function_">weakref_cb</span>(<span class=params>_, q=self._result_queue</span>):</span><br><span class=line>        q.put(<span class=literal>None</span>)</span><br><span class=line></span><br><span class=line>    <span class=keyword>if</span> self._queue_management_thread <span class=keyword>is</span> <span class=literal>None</span>:</span><br><span class=line>        <span class=comment># Start the processes so that their sentinels are known.</span></span><br><span class=line>        self._adjust_process_count()</span><br><span class=line>        self._queue_management_thread = threading.Thread(</span><br><span class=line>            target=_queue_management_worker,</span><br><span class=line>            args=(weakref.ref(self, weakref_cb),</span><br><span class=line>                  self._processes,</span><br><span class=line>                  self._pending_work_items,</span><br><span class=line>                  self._work_ids,</span><br><span class=line>                  self._call_queue,</span><br><span class=line>                  self._result_queue))</span><br><span class=line>        self._queue_management_thread.daemon = <span class=literal>True</span></span><br><span class=line>        self._queue_management_thread.start()</span><br><span class=line>        _threads_queues[self._queue_management_thread] = self._result_queue</span><br></pre></td></tr></table></figure><p>在执行完 <code>_adjust_process_count</code> 函数后，我们进程池中的 <code>_processes</code> 变量（它是一个 dict ）便关联了一些处理进程。然后我们开启一个后台守护线程，来执行 <code>_queue_management_worker</code> 函数，我们给它传了几个变量，首先 <code>_processes</code> 是我们的进程映射，<code>_pending_work_items</code> 中存放着我们待处理任务，还有 <code>_call_queue</code> 和 <code>_result_queue</code> 。好了还有一个参数大家可能不太理解，就是 <code>weakref.ref(self, weakref_cb)</code> 这货。</p><p>首先，Python 是一门具有垃圾回收机制的语言，有着 GC (Garbage Collection) 机制意味着我们在大多数时候，不太需要去关注内存的分配与回收。在 Python 中，什么时候对象会被回收是由其引用计数所决定的。当引用计数为 0 的时候，这个对象会被回收。在有一些情况下，我们对象因为交叉引用或者其余的一些原因，造成引用计数始终不为0，这意味着这个对象无法被回收。造成内存泄露<br>。因此区别于我们普通的引用，Python 中新增了一个引用机制叫做弱引用，弱引用的意义在于，某个变量持有一个对象，却不会增加这个对象的引用计数。因此 <code>weakref.ref(self, weakref_cb)</code> 在大多数而言，等价于 <code>self</code> （至于这里为什么要使用弱引用，我们这里先不讲，会开一个单章来说）</p><p>好了，这一部分代码看完，我们来看看，<code>_queue_management_worker</code> 怎么实现的</p><figure class="highlight python"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br><span class=line>65</span><br><span class=line>66</span><br><span class=line>67</span><br><span class=line>68</span><br><span class=line>69</span><br><span class=line>70</span><br><span class=line>71</span><br><span class=line>72</span><br><span class=line>73</span><br><span class=line>74</span><br><span class=line>75</span><br><span class=line>76</span><br><span class=line>77</span><br><span class=line>78</span><br><span class=line>79</span><br><span class=line>80</span><br><span class=line>81</span><br><span class=line>82</span><br><span class=line>83</span><br><span class=line>84</span><br><span class=line>85</span><br><span class=line>86</span><br><span class=line>87</span><br><span class=line>88</span><br><span class=line>89</span><br><span class=line>90</span><br><span class=line>91</span><br><span class=line>92</span><br><span class=line>93</span><br><span class=line>94</span><br><span class=line>95</span><br><span class=line>96</span><br><span class=line>97</span><br><span class=line>98</span><br><span class=line>99</span><br><span class=line>100</span><br><span class=line>101</span><br><span class=line>102</span><br><span class=line>103</span><br><span class=line>104</span><br><span class=line>105</span><br><span class=line>106</span><br><span class=line>107</span><br><span class=line>108</span><br><span class=line>109</span><br><span class=line>110</span><br><span class=line>111</span><br><span class=line>112</span><br><span class=line>113</span><br><span class=line>114</span><br><span class=line>115</span><br></pre></td><td class=code><pre><span class=line></span><br><span class=line><span class=keyword>def</span> <span class="title function_">_queue_management_worker</span>(<span class=params>executor_reference,</span></span><br><span class=line><span class=params>                             processes,</span></span><br><span class=line><span class=params>                             pending_work_items,</span></span><br><span class=line><span class=params>                             work_ids_queue,</span></span><br><span class=line><span class=params>                             call_queue,</span></span><br><span class=line><span class=params>                             result_queue</span>):</span><br><span class=line>    <span class=string>&quot;&quot;&quot;Manages the communication between this process and the worker processes.</span></span><br><span class=line><span class=string></span></span><br><span class=line><span class=string>    This function is run in a local thread.</span></span><br><span class=line><span class=string></span></span><br><span class=line><span class=string>        executor_reference: A weakref.ref to the ProcessPoolExecutor that owns</span></span><br><span class=line><span class=string>    Args:</span></span><br><span class=line><span class=string>        process: A list of the multiprocessing.Process instances used as</span></span><br><span class=line><span class=string>            this thread. Used to determine if the ProcessPoolExecutor has been</span></span><br><span class=line><span class=string>            garbage collected and that this function can exit.</span></span><br><span class=line><span class=string>            workers.</span></span><br><span class=line><span class=string>        pending_work_items: A dict mapping work ids to _WorkItems e.g.</span></span><br><span class=line><span class=string>            &#123;5: &lt;_WorkItem...&gt;, 6: &lt;_WorkItem...&gt;, ...&#125;</span></span><br><span class=line><span class=string>        work_ids_queue: A queue.Queue of work ids e.g. Queue([5, 6, ...]).</span></span><br><span class=line><span class=string>        call_queue: A multiprocessing.Queue that will be filled with _CallItems</span></span><br><span class=line><span class=string>            derived from _WorkItems for processing by the process workers.</span></span><br><span class=line><span class=string>        result_queue: A multiprocessing.Queue of _ResultItems generated by the</span></span><br><span class=line><span class=string>            process workers.</span></span><br><span class=line><span class=string>    &quot;&quot;&quot;</span></span><br><span class=line>    executor = <span class=literal>None</span></span><br><span class=line></span><br><span class=line>    <span class=keyword>def</span> <span class="title function_">shutting_down</span>():</span><br><span class=line>        <span class=keyword>return</span> _shutdown <span class=keyword>or</span> executor <span class=keyword>is</span> <span class=literal>None</span> <span class=keyword>or</span> executor._shutdown_thread</span><br><span class=line></span><br><span class=line>    <span class=keyword>def</span> <span class="title function_">shutdown_worker</span>():</span><br><span class=line>        <span class=comment># This is an upper bound</span></span><br><span class=line>        nb_children_alive = <span class=built_in>sum</span>(p.is_alive() <span class=keyword>for</span> p <span class=keyword>in</span> processes.values())</span><br><span class=line>        <span class=keyword>for</span> i <span class=keyword>in</span> <span class=built_in>range</span>(<span class=number>0</span>, nb_children_alive):</span><br><span class=line>            call_queue.put_nowait(<span class=literal>None</span>)</span><br><span class=line>        <span class=comment># Release the queue&#x27;s resources as soon as possible.</span></span><br><span class=line>        call_queue.close()</span><br><span class=line>        <span class=comment># If .join() is not called on the created processes then</span></span><br><span class=line>        <span class=comment># some multiprocessing.Queue methods may deadlock on Mac OS X.</span></span><br><span class=line>        <span class=keyword>for</span> p <span class=keyword>in</span> processes.values():</span><br><span class=line>            p.join()</span><br><span class=line></span><br><span class=line>    reader = result_queue._reader</span><br><span class=line></span><br><span class=line>    <span class=keyword>while</span> <span class=literal>True</span>:</span><br><span class=line>        _add_call_item_to_queue(pending_work_items,</span><br><span class=line>                                work_ids_queue,</span><br><span class=line>                                call_queue)</span><br><span class=line></span><br><span class=line>        sentinels = [p.sentinel <span class=keyword>for</span> p <span class=keyword>in</span> processes.values()]</span><br><span class=line>        <span class=keyword>assert</span> sentinels</span><br><span class=line>        ready = wait([reader] + sentinels)</span><br><span class=line>        <span class=keyword>if</span> reader <span class=keyword>in</span> ready:</span><br><span class=line>            result_item = reader.recv()</span><br><span class=line>        <span class=keyword>else</span>:</span><br><span class=line>            <span class=comment># Mark the process pool broken so that submits fail right now.</span></span><br><span class=line>            executor = executor_reference()</span><br><span class=line>            <span class=keyword>if</span> executor <span class=keyword>is</span> <span class=keyword>not</span> <span class=literal>None</span>:</span><br><span class=line>                executor._broken = <span class=literal>True</span></span><br><span class=line>                executor._shutdown_thread = <span class=literal>True</span></span><br><span class=line>                executor = <span class=literal>None</span></span><br><span class=line>            <span class=comment># All futures in flight must be marked failed</span></span><br><span class=line>            <span class=keyword>for</span> work_id, work_item <span class=keyword>in</span> pending_work_items.items():</span><br><span class=line>                work_item.future.set_exception(</span><br><span class=line>                    BrokenProcessPool(</span><br><span class=line>                        <span class=string>&quot;A process in the process pool was &quot;</span></span><br><span class=line>                        <span class=string>&quot;terminated abruptly while the future was &quot;</span></span><br><span class=line>                        <span class=string>&quot;running or pending.&quot;</span></span><br><span class=line>                    ))</span><br><span class=line>                <span class=comment># Delete references to object. See issue16284</span></span><br><span class=line>                <span class=keyword>del</span> work_item</span><br><span class=line>            pending_work_items.clear()</span><br><span class=line>            <span class=comment># Terminate remaining workers forcibly: the queues or their</span></span><br><span class=line>            <span class=comment># locks may be in a dirty state and block forever.</span></span><br><span class=line>            <span class=keyword>for</span> p <span class=keyword>in</span> processes.values():</span><br><span class=line>                p.terminate()</span><br><span class=line>            shutdown_worker()</span><br><span class=line>            <span class=keyword>return</span></span><br><span class=line>        <span class=keyword>if</span> <span class=built_in>isinstance</span>(result_item, <span class=built_in>int</span>):</span><br><span class=line>            <span class=comment># Clean shutdown of a worker using its PID</span></span><br><span class=line>            <span class=comment># (avoids marking the executor broken)</span></span><br><span class=line>            <span class=keyword>assert</span> shutting_down()</span><br><span class=line>            p = processes.pop(result_item)</span><br><span class=line>            p.join()</span><br><span class=line>            <span class=keyword>if</span> <span class=keyword>not</span> processes:</span><br><span class=line>                shutdown_worker()</span><br><span class=line>                <span class=keyword>return</span></span><br><span class=line>        <span class=keyword>elif</span> result_item <span class=keyword>is</span> <span class=keyword>not</span> <span class=literal>None</span>:</span><br><span class=line>            work_item = pending_work_items.pop(result_item.work_id, <span class=literal>None</span>)</span><br><span class=line>            <span class=comment># work_item can be None if another process terminated (see above)</span></span><br><span class=line>            <span class=keyword>if</span> work_item <span class=keyword>is</span> <span class=keyword>not</span> <span class=literal>None</span>:</span><br><span class=line>                <span class=keyword>if</span> result_item.exception:</span><br><span class=line>                    work_item.future.set_exception(result_item.exception)</span><br><span class=line>                <span class=keyword>else</span>:</span><br><span class=line>                    work_item.future.set_result(result_item.result)</span><br><span class=line>                <span class=comment># Delete references to object. See issue16284</span></span><br><span class=line>                <span class=keyword>del</span> work_item</span><br><span class=line>        <span class=comment># Check whether we should start shutting down.</span></span><br><span class=line>        executor = executor_reference()</span><br><span class=line>        <span class=comment># No more work items can be added if:</span></span><br><span class=line>        <span class=comment>#   - The interpreter is shutting down OR</span></span><br><span class=line>        <span class=comment>#   - The executor that owns this worker has been collected OR</span></span><br><span class=line>        <span class=comment>#   - The executor that owns this worker has been shutdown.</span></span><br><span class=line>        <span class=keyword>if</span> shutting_down():</span><br><span class=line>            <span class=keyword>try</span>:</span><br><span class=line>                <span class=comment># Since no new work items can be added, it is safe to shutdown</span></span><br><span class=line>                <span class=comment># this thread if there are no pending work items.</span></span><br><span class=line>                <span class=keyword>if</span> <span class=keyword>not</span> pending_work_items:</span><br><span class=line>                    shutdown_worker()</span><br><span class=line>                    <span class=keyword>return</span></span><br><span class=line>            <span class=keyword>except</span> Full:</span><br><span class=line>                <span class=comment># This is not a problem: we will eventually be woken up (in</span></span><br><span class=line>                <span class=comment># result_queue.get()) and be able to send a sentinel again.</span></span><br><span class=line>                <span class=keyword>pass</span></span><br><span class=line>        executor = <span class=literal>None</span></span><br></pre></td></tr></table></figure><p>熟悉的大循环，循环的第一步，利用 <code>_add_call_item_to_queue</code> 函数来将等待队列中的任务加入到调用队列中去，先来看看这一部分代码</p><figure class="highlight python"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br></pre></td><td class=code><pre><span class=line><span class=keyword>def</span> <span class="title function_">_add_call_item_to_queue</span>(<span class=params>pending_work_items,</span></span><br><span class=line><span class=params>                            work_ids,</span></span><br><span class=line><span class=params>                            call_queue</span>):</span><br><span class=line>    <span class=string>&quot;&quot;&quot;Fills call_queue with _WorkItems from pending_work_items.</span></span><br><span class=line><span class=string></span></span><br><span class=line><span class=string>    This function never blocks.</span></span><br><span class=line><span class=string></span></span><br><span class=line><span class=string>    Args:</span></span><br><span class=line><span class=string>        pending_work_items: A dict mapping work ids to _WorkItems e.g.</span></span><br><span class=line><span class=string>            &#123;5: &lt;_WorkItem...&gt;, 6: &lt;_WorkItem...&gt;, ...&#125;</span></span><br><span class=line><span class=string>        work_ids: A queue.Queue of work ids e.g. Queue([5, 6, ...]). Work ids</span></span><br><span class=line><span class=string>            are consumed and the corresponding _WorkItems from</span></span><br><span class=line><span class=string>            pending_work_items are transformed into _CallItems and put in</span></span><br><span class=line><span class=string>            call_queue.</span></span><br><span class=line><span class=string>        call_queue: A multiprocessing.Queue that will be filled with _CallItems</span></span><br><span class=line><span class=string>            derived from _WorkItems.</span></span><br><span class=line><span class=string>    &quot;&quot;&quot;</span></span><br><span class=line>    <span class=keyword>while</span> <span class=literal>True</span>:</span><br><span class=line>        <span class=keyword>if</span> call_queue.full():</span><br><span class=line>            <span class=keyword>return</span></span><br><span class=line>        <span class=keyword>try</span>:</span><br><span class=line>            work_id = work_ids.get(block=<span class=literal>False</span>)</span><br><span class=line>        <span class=keyword>except</span> queue.Empty:</span><br><span class=line>            <span class=keyword>return</span></span><br><span class=line>        <span class=keyword>else</span>:</span><br><span class=line>            work_item = pending_work_items[work_id]</span><br><span class=line></span><br><span class=line>            <span class=keyword>if</span> work_item.future.set_running_or_notify_cancel():</span><br><span class=line>                call_queue.put(_CallItem(work_id,</span><br><span class=line>                                         work_item.fn,</span><br><span class=line>                                         work_item.args,</span><br><span class=line>                                         work_item.kwargs),</span><br><span class=line>                               block=<span class=literal>True</span>)</span><br><span class=line>            <span class=keyword>else</span>:</span><br><span class=line>                <span class=keyword>del</span> pending_work_items[work_id]</span><br><span class=line>                <span class=keyword>continue</span></span><br></pre></td></tr></table></figure><p>首先，判断调用队列是不是已经满了，如果满了，则放弃这次循环。紧接着从 <code>work_id</code> 队列中取出，然后从等待任务中取出对应的 <code>_WorkItem</code> 实例。紧接着，调用实例中绑定的 <code>Future</code> 实例的 <code>set_running_or_notify_cancel</code> 方法来设置任务的状态，紧接着将其扔入调用队列中。</p><figure class="highlight python"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br></pre></td><td class=code><pre><span class=line></span><br><span class=line><span class=keyword>def</span> <span class="title function_">set_running_or_notify_cancel</span>(<span class=params>self</span>):</span><br><span class=line>    <span class=string>&quot;&quot;&quot;Mark the future as running or process any cancel notifications.</span></span><br><span class=line><span class=string></span></span><br><span class=line><span class=string>    Should only be used by Executor implementations and unit tests.</span></span><br><span class=line><span class=string></span></span><br><span class=line><span class=string>    If the future has been cancelled (cancel() was called and returned</span></span><br><span class=line><span class=string>    True) then any threads waiting on the future completing (though calls</span></span><br><span class=line><span class=string>    to as_completed() or wait()) are notified and False is returned.</span></span><br><span class=line><span class=string></span></span><br><span class=line><span class=string>    If the future was not cancelled then it is put in the running state</span></span><br><span class=line><span class=string>    (future calls to running() will return True) and True is returned.</span></span><br><span class=line><span class=string></span></span><br><span class=line><span class=string>    This method should be called by Executor implementations before</span></span><br><span class=line><span class=string>    executing the work associated with this future. If this method returns</span></span><br><span class=line><span class=string>    False then the work should not be executed.</span></span><br><span class=line><span class=string></span></span><br><span class=line><span class=string>    Returns:</span></span><br><span class=line><span class=string>        False if the Future was cancelled, True otherwise.</span></span><br><span class=line><span class=string></span></span><br><span class=line><span class=string>    Raises:</span></span><br><span class=line><span class=string>        RuntimeError: if this method was already called or if set_result()</span></span><br><span class=line><span class=string>            or set_exception() was called.</span></span><br><span class=line><span class=string>    &quot;&quot;&quot;</span></span><br><span class=line>    <span class=keyword>with</span> self._condition:</span><br><span class=line>        <span class=keyword>if</span> self._state == CANCELLED:</span><br><span class=line>            self._state = CANCELLED_AND_NOTIFIED</span><br><span class=line>            <span class=keyword>for</span> waiter <span class=keyword>in</span> self._waiters:</span><br><span class=line>                waiter.add_cancelled(self)</span><br><span class=line>            <span class=comment># self._condition.notify_all() is not necessary because</span></span><br><span class=line>            <span class=comment># self.cancel() triggers a notification.</span></span><br><span class=line>            <span class=keyword>return</span> <span class=literal>False</span></span><br><span class=line>        <span class=keyword>elif</span> self._state == PENDING:</span><br><span class=line>            self._state = RUNNING</span><br><span class=line>            <span class=keyword>return</span> <span class=literal>True</span></span><br><span class=line>        <span class=keyword>else</span>:</span><br><span class=line>            LOGGER.critical(<span class=string>&#x27;Future %s in unexpected state: %s&#x27;</span>,</span><br><span class=line>                            <span class=built_in>id</span>(self),</span><br><span class=line>                            self._state)</span><br><span class=line>            <span class=keyword>raise</span> RuntimeError(<span class=string>&#x27;Future in unexpected state&#x27;</span>)</span><br></pre></td></tr></table></figure><p>这一部分内容很简单，检查当前实例如果处于等待状态，就返回 True ，如果处于被取消的状态，就返回 False , 在 <code>_add_call_item_to_queue</code> 函数中，会将已经处于 <code>cancel</code> 状态的 <code>_WorkItem</code> 从等待任务中移除。</p><p>好了，我们继续回到 <code>_queue_management_worker</code> 函数中去，</p><figure class="highlight python"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br><span class=line>65</span><br><span class=line>66</span><br><span class=line>67</span><br><span class=line>68</span><br><span class=line>69</span><br><span class=line>70</span><br><span class=line>71</span><br><span class=line>72</span><br><span class=line>73</span><br><span class=line>74</span><br><span class=line>75</span><br><span class=line>76</span><br><span class=line>77</span><br><span class=line>78</span><br><span class=line>79</span><br><span class=line>80</span><br><span class=line>81</span><br><span class=line>82</span><br><span class=line>83</span><br><span class=line>84</span><br><span class=line>85</span><br><span class=line>86</span><br><span class=line>87</span><br><span class=line>88</span><br><span class=line>89</span><br><span class=line>90</span><br><span class=line>91</span><br><span class=line>92</span><br><span class=line>93</span><br><span class=line>94</span><br><span class=line>95</span><br><span class=line>96</span><br><span class=line>97</span><br><span class=line>98</span><br><span class=line>99</span><br><span class=line>100</span><br><span class=line>101</span><br><span class=line>102</span><br><span class=line>103</span><br><span class=line>104</span><br><span class=line>105</span><br><span class=line>106</span><br><span class=line>107</span><br><span class=line>108</span><br><span class=line>109</span><br><span class=line>110</span><br><span class=line>111</span><br><span class=line>112</span><br><span class=line>113</span><br><span class=line>114</span><br><span class=line>115</span><br></pre></td><td class=code><pre><span class=line></span><br><span class=line><span class=keyword>def</span> <span class="title function_">_queue_management_worker</span>(<span class=params>executor_reference,</span></span><br><span class=line><span class=params>                             processes,</span></span><br><span class=line><span class=params>                             pending_work_items,</span></span><br><span class=line><span class=params>                             work_ids_queue,</span></span><br><span class=line><span class=params>                             call_queue,</span></span><br><span class=line><span class=params>                             result_queue</span>):</span><br><span class=line>    <span class=string>&quot;&quot;&quot;Manages the communication between this process and the worker processes.</span></span><br><span class=line><span class=string></span></span><br><span class=line><span class=string>    This function is run in a local thread.</span></span><br><span class=line><span class=string></span></span><br><span class=line><span class=string>        executor_reference: A weakref.ref to the ProcessPoolExecutor that owns</span></span><br><span class=line><span class=string>    Args:</span></span><br><span class=line><span class=string>        process: A list of the multiprocessing.Process instances used as</span></span><br><span class=line><span class=string>            this thread. Used to determine if the ProcessPoolExecutor has been</span></span><br><span class=line><span class=string>            garbage collected and that this function can exit.</span></span><br><span class=line><span class=string>            workers.</span></span><br><span class=line><span class=string>        pending_work_items: A dict mapping work ids to _WorkItems e.g.</span></span><br><span class=line><span class=string>            &#123;5: &lt;_WorkItem...&gt;, 6: &lt;_WorkItem...&gt;, ...&#125;</span></span><br><span class=line><span class=string>        work_ids_queue: A queue.Queue of work ids e.g. Queue([5, 6, ...]).</span></span><br><span class=line><span class=string>        call_queue: A multiprocessing.Queue that will be filled with _CallItems</span></span><br><span class=line><span class=string>            derived from _WorkItems for processing by the process workers.</span></span><br><span class=line><span class=string>        result_queue: A multiprocessing.Queue of _ResultItems generated by the</span></span><br><span class=line><span class=string>            process workers.</span></span><br><span class=line><span class=string>    &quot;&quot;&quot;</span></span><br><span class=line>    executor = <span class=literal>None</span></span><br><span class=line></span><br><span class=line>    <span class=keyword>def</span> <span class="title function_">shutting_down</span>():</span><br><span class=line>        <span class=keyword>return</span> _shutdown <span class=keyword>or</span> executor <span class=keyword>is</span> <span class=literal>None</span> <span class=keyword>or</span> executor._shutdown_thread</span><br><span class=line></span><br><span class=line>    <span class=keyword>def</span> <span class="title function_">shutdown_worker</span>():</span><br><span class=line>        <span class=comment># This is an upper bound</span></span><br><span class=line>        nb_children_alive = <span class=built_in>sum</span>(p.is_alive() <span class=keyword>for</span> p <span class=keyword>in</span> processes.values())</span><br><span class=line>        <span class=keyword>for</span> i <span class=keyword>in</span> <span class=built_in>range</span>(<span class=number>0</span>, nb_children_alive):</span><br><span class=line>            call_queue.put_nowait(<span class=literal>None</span>)</span><br><span class=line>        <span class=comment># Release the queue&#x27;s resources as soon as possible.</span></span><br><span class=line>        call_queue.close()</span><br><span class=line>        <span class=comment># If .join() is not called on the created processes then</span></span><br><span class=line>        <span class=comment># some multiprocessing.Queue methods may deadlock on Mac OS X.</span></span><br><span class=line>        <span class=keyword>for</span> p <span class=keyword>in</span> processes.values():</span><br><span class=line>            p.join()</span><br><span class=line></span><br><span class=line>    reader = result_queue._reader</span><br><span class=line></span><br><span class=line>    <span class=keyword>while</span> <span class=literal>True</span>:</span><br><span class=line>        _add_call_item_to_queue(pending_work_items,</span><br><span class=line>                                work_ids_queue,</span><br><span class=line>                                call_queue)</span><br><span class=line></span><br><span class=line>        sentinels = [p.sentinel <span class=keyword>for</span> p <span class=keyword>in</span> processes.values()]</span><br><span class=line>        <span class=keyword>assert</span> sentinels</span><br><span class=line>        ready = wait([reader] + sentinels)</span><br><span class=line>        <span class=keyword>if</span> reader <span class=keyword>in</span> ready:</span><br><span class=line>            result_item = reader.recv()</span><br><span class=line>        <span class=keyword>else</span>:</span><br><span class=line>            <span class=comment># Mark the process pool broken so that submits fail right now.</span></span><br><span class=line>            executor = executor_reference()</span><br><span class=line>            <span class=keyword>if</span> executor <span class=keyword>is</span> <span class=keyword>not</span> <span class=literal>None</span>:</span><br><span class=line>                executor._broken = <span class=literal>True</span></span><br><span class=line>                executor._shutdown_thread = <span class=literal>True</span></span><br><span class=line>                executor = <span class=literal>None</span></span><br><span class=line>            <span class=comment># All futures in flight must be marked failed</span></span><br><span class=line>            <span class=keyword>for</span> work_id, work_item <span class=keyword>in</span> pending_work_items.items():</span><br><span class=line>                work_item.future.set_exception(</span><br><span class=line>                    BrokenProcessPool(</span><br><span class=line>                        <span class=string>&quot;A process in the process pool was &quot;</span></span><br><span class=line>                        <span class=string>&quot;terminated abruptly while the future was &quot;</span></span><br><span class=line>                        <span class=string>&quot;running or pending.&quot;</span></span><br><span class=line>                    ))</span><br><span class=line>                <span class=comment># Delete references to object. See issue16284</span></span><br><span class=line>                <span class=keyword>del</span> work_item</span><br><span class=line>            pending_work_items.clear()</span><br><span class=line>            <span class=comment># Terminate remaining workers forcibly: the queues or their</span></span><br><span class=line>            <span class=comment># locks may be in a dirty state and block forever.</span></span><br><span class=line>            <span class=keyword>for</span> p <span class=keyword>in</span> processes.values():</span><br><span class=line>                p.terminate()</span><br><span class=line>            shutdown_worker()</span><br><span class=line>            <span class=keyword>return</span></span><br><span class=line>        <span class=keyword>if</span> <span class=built_in>isinstance</span>(result_item, <span class=built_in>int</span>):</span><br><span class=line>            <span class=comment># Clean shutdown of a worker using its PID</span></span><br><span class=line>            <span class=comment># (avoids marking the executor broken)</span></span><br><span class=line>            <span class=keyword>assert</span> shutting_down()</span><br><span class=line>            p = processes.pop(result_item)</span><br><span class=line>            p.join()</span><br><span class=line>            <span class=keyword>if</span> <span class=keyword>not</span> processes:</span><br><span class=line>                shutdown_worker()</span><br><span class=line>                <span class=keyword>return</span></span><br><span class=line>        <span class=keyword>elif</span> result_item <span class=keyword>is</span> <span class=keyword>not</span> <span class=literal>None</span>:</span><br><span class=line>            work_item = pending_work_items.pop(result_item.work_id, <span class=literal>None</span>)</span><br><span class=line>            <span class=comment># work_item can be None if another process terminated (see above)</span></span><br><span class=line>            <span class=keyword>if</span> work_item <span class=keyword>is</span> <span class=keyword>not</span> <span class=literal>None</span>:</span><br><span class=line>                <span class=keyword>if</span> result_item.exception:</span><br><span class=line>                    work_item.future.set_exception(result_item.exception)</span><br><span class=line>                <span class=keyword>else</span>:</span><br><span class=line>                    work_item.future.set_result(result_item.result)</span><br><span class=line>                <span class=comment># Delete references to object. See issue16284</span></span><br><span class=line>                <span class=keyword>del</span> work_item</span><br><span class=line>        <span class=comment># Check whether we should start shutting down.</span></span><br><span class=line>        executor = executor_reference()</span><br><span class=line>        <span class=comment># No more work items can be added if:</span></span><br><span class=line>        <span class=comment>#   - The interpreter is shutting down OR</span></span><br><span class=line>        <span class=comment>#   - The executor that owns this worker has been collected OR</span></span><br><span class=line>        <span class=comment>#   - The executor that owns this worker has been shutdown.</span></span><br><span class=line>        <span class=keyword>if</span> shutting_down():</span><br><span class=line>            <span class=keyword>try</span>:</span><br><span class=line>                <span class=comment># Since no new work items can be added, it is safe to shutdown</span></span><br><span class=line>                <span class=comment># this thread if there are no pending work items.</span></span><br><span class=line>                <span class=keyword>if</span> <span class=keyword>not</span> pending_work_items:</span><br><span class=line>                    shutdown_worker()</span><br><span class=line>                    <span class=keyword>return</span></span><br><span class=line>            <span class=keyword>except</span> Full:</span><br><span class=line>                <span class=comment># This is not a problem: we will eventually be woken up (in</span></span><br><span class=line>                <span class=comment># result_queue.get()) and be able to send a sentinel again.</span></span><br><span class=line>                <span class=keyword>pass</span></span><br><span class=line>        executor = <span class=literal>None</span></span><br></pre></td></tr></table></figure><p><code>result_item</code> 变量</p><p>我们看看</p><p>首先，大家可能在这里有点疑问了</p><figure class="highlight python"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre></td><td class=code><pre><span class=line></span><br><span class=line>sentinels = [p.sentinel <span class=keyword>for</span> p <span class=keyword>in</span> processes.values()]</span><br><span class=line><span class=keyword>assert</span> sentinels</span><br><span class=line>ready = wait([reader] + sentinels)</span><br><span class=line></span><br></pre></td></tr></table></figure><p>这个 <code>wait</code> 是什么鬼啊，<code>reader</code> 又是什么鬼啊。一步步来。首先，我们看到，前面，<code>reader = result_queue._reader</code> 也会引起大家的疑问，这里我们 <code>result_queue</code> 是 <code>multiprocess</code> 里面的 <code>SimpleQueue</code> 啊，它没有 <code>_reader</code> 方法啊QAQ</p><figure class="highlight python"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre></td><td class=code><pre><span class=line></span><br><span class=line><span class=keyword>class</span> <span class="title class_">SimpleQueue</span>(<span class="title class_ inherited__">object</span>):</span><br><span class=line></span><br><span class=line>    <span class=keyword>def</span> <span class="title function_">__init__</span>(<span class=params>self, *, ctx</span>):</span><br><span class=line>        self._reader, self._writer = connection.Pipe(duplex=<span class=literal>False</span>)</span><br><span class=line>        self._rlock = ctx.Lock()</span><br><span class=line>        self._poll = self._reader.poll</span><br><span class=line>        <span class=keyword>if</span> sys.platform == <span class=string>&#x27;win32&#x27;</span>:</span><br><span class=line>            self._wlock = <span class=literal>None</span></span><br><span class=line>        <span class=keyword>else</span>:</span><br><span class=line>            self._wlock = ctx.Lock()</span><br></pre></td></tr></table></figure><p>上面这贴出来的，是 <code>SimpleQueue</code> 的部分代码，我们可以很清楚的看到，<code>SimpleQueue</code> 本质是利用一个 <code>Pipe</code> 来进行进程间通信的，然后 <code>_reader</code> 是读取 <code>Pipe</code> 的一个变量。</p><blockquote><p><strong>Note</strong> : 大家可以复习下其余几种进程间通信的方法了</p></blockquote><p>好了，这一部分看懂后，我们来看看 <code>wait</code> 方法吧。</p><figure class="highlight python"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br></pre></td><td class=code><pre><span class=line></span><br><span class=line><span class=keyword>def</span> <span class="title function_">wait</span>(<span class=params>object_list, timeout=<span class=literal>None</span></span>):</span><br><span class=line>    <span class=string>&#x27;&#x27;&#x27;</span></span><br><span class=line><span class=string>    Wait till an object in object_list is ready/readable.</span></span><br><span class=line><span class=string></span></span><br><span class=line><span class=string>    Returns list of those objects in object_list which are ready/readable.</span></span><br><span class=line><span class=string>    &#x27;&#x27;&#x27;</span></span><br><span class=line>    <span class=keyword>with</span> _WaitSelector() <span class=keyword>as</span> selector:</span><br><span class=line>        <span class=keyword>for</span> obj <span class=keyword>in</span> object_list:</span><br><span class=line>            selector.register(obj, selectors.EVENT_READ)</span><br><span class=line></span><br><span class=line>        <span class=keyword>if</span> timeout <span class=keyword>is</span> <span class=keyword>not</span> <span class=literal>None</span>:</span><br><span class=line>            deadline = time.time() + timeout</span><br><span class=line></span><br><span class=line>        <span class=keyword>while</span> <span class=literal>True</span>:</span><br><span class=line>            ready = selector.select(timeout)</span><br><span class=line>            <span class=keyword>if</span> ready:</span><br><span class=line>                <span class=keyword>return</span> [key.fileobj <span class=keyword>for</span> (key, events) <span class=keyword>in</span> ready]</span><br><span class=line>            <span class=keyword>else</span>:</span><br><span class=line>                <span class=keyword>if</span> timeout <span class=keyword>is</span> <span class=keyword>not</span> <span class=literal>None</span>:</span><br><span class=line>                    timeout = deadline - time.time()</span><br><span class=line>                    <span class=keyword>if</span> timeout &lt; <span class=number>0</span>:</span><br><span class=line>                        <span class=keyword>return</span> ready</span><br></pre></td></tr></table></figure><p>这一部分代码很简单，首先将我们待读取的对象，进行一次注册，然后当 <code>timeout</code> 为 None 的时候，就一直等待到有对象读取数据成功为止</p><p>好了，我们继续回到前面的 <code>_queue_management_worker</code> 函数中去，来看看这样一段代码</p><figure class="highlight python"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br></pre></td><td class=code><pre><span class=line></span><br><span class=line>ready = wait([reader] + sentinels)</span><br><span class=line><span class=keyword>if</span> reader <span class=keyword>in</span> ready:</span><br><span class=line>    result_item = reader.recv()</span><br><span class=line><span class=keyword>else</span>:</span><br><span class=line>    <span class=comment># Mark the process pool broken so that submits fail right now.</span></span><br><span class=line>    executor = executor_reference()</span><br><span class=line>    <span class=keyword>if</span> executor <span class=keyword>is</span> <span class=keyword>not</span> <span class=literal>None</span>:</span><br><span class=line>        executor._broken = <span class=literal>True</span></span><br><span class=line>        executor._shutdown_thread = <span class=literal>True</span></span><br><span class=line>        executor = <span class=literal>None</span></span><br><span class=line>    <span class=comment># All futures in flight must be marked failed</span></span><br><span class=line>    <span class=keyword>for</span> work_id, work_item <span class=keyword>in</span> pending_work_items.items():</span><br><span class=line>        work_item.future.set_exception(</span><br><span class=line>            BrokenProcessPool(</span><br><span class=line>                <span class=string>&quot;A process in the process pool was &quot;</span></span><br><span class=line>                <span class=string>&quot;terminated abruptly while the future was &quot;</span></span><br><span class=line>                <span class=string>&quot;running or pending.&quot;</span></span><br><span class=line>            ))</span><br><span class=line>        <span class=comment># Delete references to object. See issue16284</span></span><br><span class=line>        <span class=keyword>del</span> work_item</span><br><span class=line>    pending_work_items.clear()</span><br><span class=line>    <span class=comment># Terminate remaining workers forcibly: the queues or their</span></span><br><span class=line>    <span class=comment># locks may be in a dirty state and block forever.</span></span><br><span class=line>    <span class=keyword>for</span> p <span class=keyword>in</span> processes.values():</span><br><span class=line>        p.terminate()</span><br><span class=line>    shutdown_worker()</span><br><span class=line>    <span class=keyword>return</span></span><br></pre></td></tr></table></figure><p>我们用 <code>wait</code> 函数来读取一系列对象，因为我们没有设置 <code>Timeout</code> ，所以当我们拿到可读取对象的结果时，如果 <code>result_queue._reader</code> 没有在列表中，那么意味着，有处理进程突然异常关闭了，这个时候，我们开始执行后面的语句来执行目前进程池的关闭操作。如果在列表中，我们读取数据，得到 <code>result_item</code> 变量</p><p>我们再看看下面的代码</p><figure class="highlight python"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br></pre></td><td class=code><pre><span class=line></span><br><span class=line><span class=keyword>if</span> <span class=built_in>isinstance</span>(result_item, <span class=built_in>int</span>):</span><br><span class=line>    <span class=comment># Clean shutdown of a worker using its PID</span></span><br><span class=line>    <span class=comment># (avoids marking the executor broken)</span></span><br><span class=line>    <span class=keyword>assert</span> shutting_down()</span><br><span class=line>    p = processes.pop(result_item)</span><br><span class=line>    p.join()</span><br><span class=line>    <span class=keyword>if</span> <span class=keyword>not</span> processes:</span><br><span class=line>        shutdown_worker()</span><br><span class=line>        <span class=keyword>return</span></span><br><span class=line><span class=keyword>elif</span> result_item <span class=keyword>is</span> <span class=keyword>not</span> <span class=literal>None</span>:</span><br><span class=line>    work_item = pending_work_items.pop(result_item.work_id, <span class=literal>None</span>)</span><br><span class=line>    <span class=comment># work_item can be None if another process terminated (see above)</span></span><br><span class=line>    <span class=keyword>if</span> work_item <span class=keyword>is</span> <span class=keyword>not</span> <span class=literal>None</span>:</span><br><span class=line>        <span class=keyword>if</span> result_item.exception:</span><br><span class=line>            work_item.future.set_exception(result_item.exception)</span><br><span class=line>        <span class=keyword>else</span>:</span><br><span class=line>            work_item.future.set_result(result_item.result)</span><br><span class=line>        <span class=comment># Delete references to object. See issue16284</span></span><br><span class=line>        <span class=keyword>del</span> work_item</span><br><span class=line></span><br></pre></td></tr></table></figure><p>首先，如果 <code>result_item</code> 变量是 int 类型的话，不知道大家还记不记得在 <code>_process_worker</code> 函数中有这样一段逻辑</p><figure class="highlight python"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre></td><td class=code><pre><span class=line></span><br><span class=line>call_item = call_queue.get(block=<span class=literal>True</span>)</span><br><span class=line><span class=keyword>if</span> call_item <span class=keyword>is</span> <span class=literal>None</span>:</span><br><span class=line>    <span class=comment># Wake up queue management thread</span></span><br><span class=line>    result_queue.put(os.getpid())</span><br><span class=line>    <span class=keyword>return</span></span><br></pre></td></tr></table></figure><p>当调用队列中没有新的任务时，将进程 <code>pid</code> 放入 <code>result_queue</code> 中。那么我们 <code>result_item</code> 如果值为 <code>int</code> 那么意味着，我们之前任务处理工作已经完毕，于是开始清理，关闭我们的进程池。</p><p>如果 <code>result_item</code> 既不为 <code>int</code> 也不为 <code>None</code> , 那么必然是 <code>_ResultItem</code> 的实例，我们根据 <code>work_id</code> 取出 <code>_WorkItem</code> 实例，并将产生的异常或者值和 <code>_WorkItem</code> 实例中的 <code>Future</code> 实例（也就是我们 submit 后返回的那货）进行绑定。</p><p>最后，删除这个 <code>work_item</code> ，完事儿，手工</p><h2 id=最后><a href=#最后 class=headerlink title=最后></a>最后</h2><p>洋洋洒洒写了一大篇辣鸡文章，希望大家不要介意，其实我们能看到 <code>concurrent.future</code> 的实现，其实并没有用什么高深的黑魔法，但是其中细节值得我们一一品味，所以这篇文章我们先写到这里。后面有机会的话，我们再去看看 <code>concurrent.future</code> 其余部分代码。也有蛮多值得品味的地方。</p><h2 id=Reference><a href=#Reference class=headerlink title=Reference></a>Reference</h2><p>1.<a target=_blank rel="noopener external nofollow noreferrer" href=https://docs.python.org/3/library/multiprocessing.html#multiprocessing.SimpleQueue>Python 3 multiprocessing</a></p><p>2.<a target=_blank rel="noopener external nofollow noreferrer" href=https://docs.python.org/3/library/weakref.html>Python 3 weakref</a></p><p>3.<a target=_blank rel="noopener external nofollow noreferrer" href=https://my.oschina.net/u/1255754/blog/207331>并发编程之Future模式</a></p><p>4.<a target=_blank rel="noopener external nofollow noreferrer" href=https://www.ziwenxie.site/2016/12/24/python-concurrent-futures/ >Python并发编程之线程池/进程池</a></p><p>5.<a target=_blank rel="noopener external nofollow noreferrer" href=http://zha-zi.iteye.com/blog/1408189>Future 模式详解（并发使用）</a></p></article><div class=post-copyright><div class=post-copyright__author><span class=post-copyright-meta>Author: </span><span class=post-copyright-info><a target=_blank rel="noopener external nofollow noreferrer" href=https://github.com/Zheaoli>Manjusaka</a></span></div><div class=post-copyright__type><span class=post-copyright-meta>Link: </span><span class=post-copyright-info><a href=https://www.manjusaka.blog/posts/2017/11/27/something-about-concurrent-future/ >https://www.manjusaka.blog/posts/2017/11/27/something-about-concurrent-future/</a></span></div><div class=post-copyright__notice><span class=post-copyright-meta>Copyright Notice: </span><span class=post-copyright-info>All articles in this blog are licensed under <a target=_blank rel="noopener external nofollow noreferrer" href=https://creativecommons.org/licenses/by-nc-sa/4.0/ >CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class=tag_share><div class=post-meta__tag-list><a class=post-meta__tags href=/tags/Python/ >Python</a><a class=post-meta__tags href=/tags/%E7%BC%96%E7%A8%8B/ >编程</a><a class=post-meta__tags href=/tags/%E7%BC%96%E7%A8%8B%E6%8A%80%E5%B7%A7/ >编程技巧</a><a class=post-meta__tags href=/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/ >并发编程</a><a class=post-meta__tags href=/tags/%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/ >源码剖析</a></div><div class=post_share><div class=social-share data-image=https://cdn.pixabay.com/photo/2023/02/08/15/10/sculpture-7776861_1280.jpg data-sites=facebook,twitter,wechat,weibo,qq></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css media=print onload='this.media="all"'><script src=https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js defer=defer></script></div></div><div class=ads-wrap><ins class=adsbygoogle style=display:block;text-align:center data-ad-layout=in-article data-ad-format=fluid data-ad-client=ca-pub-7962287588031867 data-ad-slot=2542544532></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><nav class=pagination-post id=pagination><div class="prev-post pull-left"><a href=/posts/2017/12/28/what-the-fuck-supvisor/ title="Supervisor 的一个隐藏坑"><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/06/16/46/sea-7772372_1280.jpg onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class=pagination-info><div class=label>Previous Post</div><div class=prev_info>Supervisor 的一个隐藏坑</div></div></a></div><div class="next-post pull-right"><a href=/posts/2017/08/13/what-the-fuck-about-flask-part1/ title="你所不知道的 Flask Part1:Route 初探"><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/04/07/38/cherry-blossoms-7766588_1280.jpg onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class=pagination-info><div class=label>Next Post</div><div class=next_info>你所不知道的 Flask Part1:Route 初探</div></div></a></div></nav><div class=relatedPosts><div class=headline><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class=relatedPosts-list><div><a href=/posts/2016/12/28/Someone-tell-me-that-you-think-Python-is-simple-2/ title="听说你会 Python （2）：Python 高阶数据结构解析"><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/01/30/19/40/gulls-7756481_1280.jpg alt=cover><div class="content is-center"><div class=date><i class="far fa-calendar-alt fa-fw"></i> 2016-12-28</div><div class=title>听说你会 Python （2）：Python 高阶数据结构解析</div></div></a></div><div><a href=/posts/2016/11/18/Someone-tell-me-that-you-think-Python-is-simple/ title="听说你会 Python ？"><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/04/07/38/cherry-blossoms-7766588_1280.jpg alt=cover><div class="content is-center"><div class=date><i class="far fa-calendar-alt fa-fw"></i> 2016-11-18</div><div class=title>听说你会 Python ？</div></div></a></div><div><a href=/posts/2016/10/12/Something-about-Descriptor/ title="Python 描述符入门指北"><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/06/01/14/superb-fairywren-7770904_1280.jpg alt=cover><div class="content is-center"><div class=date><i class="far fa-calendar-alt fa-fw"></i> 2016-10-12</div><div class=title>Python 描述符入门指北</div></div></a></div><div><a href=/posts/2019/04/27/something-about-pep-570/ title="随便聊聊 PEP570"><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/08/15/10/sculpture-7776861_1280.jpg alt=cover><div class="content is-center"><div class=date><i class="far fa-calendar-alt fa-fw"></i> 2019-04-27</div><div class=title>随便聊聊 PEP570</div></div></a></div><div><a href=/posts/2016/09/11/something-about-yield-in-python/ title="聊聊 Python 中生成器和协程那点事儿"><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/01/30/19/40/gulls-7756481_1280.jpg alt=cover><div class="content is-center"><div class=date><i class="far fa-calendar-alt fa-fw"></i> 2016-09-11</div><div class=title>聊聊 Python 中生成器和协程那点事儿</div></div></a></div><div><a href=/posts/2016/12/15/A-Simple-Object-Model/ title="用 Python 实现一个最简单的对象模型"><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/04/07/38/cherry-blossoms-7766587_1280.jpg alt=cover><div class="content is-center"><div class=date><i class="far fa-calendar-alt fa-fw"></i> 2016-12-15</div><div class=title>用 Python 实现一个最简单的对象模型</div></div></a></div></div></div><hr><div id=post-comment><div class=comment-head><div class=comment-headline><i class="fas fa-comments fa-fw"></i><span> Comment</span></div></div><div class=comment-wrap><div><div id=disqus_thread></div></div></div></div></div><div class=aside-content id=aside-content><div class="card-widget card-info"><div class=is-center><div class=avatar-img><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://avatars.githubusercontent.com/u/7054676?v=4" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt=avatar></div><div class=author-info__name>Manjusaka</div><div class=author-info__description>热忱之心不可磨灭</div></div><div class="card-info-data site-data is-center"><a href=/archives/ ><div class=headline>Articles</div><div class=length-num>75</div></a><a href=/tags/ ><div class=headline>Tags</div><div class=length-num>51</div></a><a href=/categories/ ><div class=headline>Categories</div><div class=length-num>32</div></a></div><a id=card-info-btn target=_blank rel="noopener external nofollow noreferrer" href=https://github.com/Zheaoli><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class=social-icon href=https://github.com/ZheaoLi rel="external nofollow noreferrer" target=_blank title=Github><i class="fab fa-github"></i></a><a class=social-icon href=mailto:me@manjusaka.me rel="external nofollow noreferrer" target=_blank title=Email><i class="fas fa-envelope"></i></a><a class=social-icon href=https://twitter.com/Manjusaka_Lee rel="external nofollow noreferrer" target=_blank title=推特><i class="fab fa-twitter"></i></a></div></div><div class="card-widget card-announcement"><div class=item-headline><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class=announcement_content>This is my Blog</div></div><div class=sticky_layout><div class=card-widget id=card-toc><div class=item-headline><i class="fas fa-stream"></i><span>Catalog</span><span class=toc-percentage></span></div><div class="toc-content is-expand"><ol class=toc><li class="toc-item toc-level-1"><a class=toc-link href=#%E5%9E%83%E5%9C%BE%E8%AF%9D><span class=toc-number>1.</span> <span class=toc-text>垃圾话</span></a></li><li class="toc-item toc-level-1"><a class=toc-link href=#%E6%AD%A3%E6%96%87><span class=toc-number>2.</span> <span class=toc-text>正文</span></a><ol class=toc-child><li class="toc-item toc-level-2"><a class=toc-link href=#Python-%E7%9A%84%E5%BC%82%E6%AD%A5%E5%A4%84%E7%90%86><span class=toc-number>2.1.</span> <span class=toc-text>Python 的异步处理</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#Future-%E6%A8%A1%E5%BC%8F><span class=toc-number>2.2.</span> <span class=toc-text>Future 模式</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#Python-%E4%B8%AD%E7%9A%84-concurrent-futures><span class=toc-number>2.3.</span> <span class=toc-text>Python 中的 concurrent.futures</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E5%89%96%E4%B8%80%E4%B8%8B-concurrent-futures><span class=toc-number>2.4.</span> <span class=toc-text>剖一下 concurrent.futures</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E6%9C%80%E5%90%8E><span class=toc-number>2.5.</span> <span class=toc-text>最后</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#Reference><span class=toc-number>2.6.</span> <span class=toc-text>Reference</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class=item-headline><i class="fas fa-history"></i><span>Recent Post</span></div><div class=aside-list><div class=aside-list-item><a class=thumbnail href=/posts/2023/06/25/love-and-hope-is-all-we-need/ title=聊聊公益和助学><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://github.com/Zheaoli/yuque-py/assets/7054676/ea9460a2-e351-4b73-9f82-7aef6cd20c33 onerror='this.onerror=null,this.src="/img/404.jpg"' alt=聊聊公益和助学></a><div class=content><a class=title href=/posts/2023/06/25/love-and-hope-is-all-we-need/ title=聊聊公益和助学>聊聊公益和助学</a><time datetime=2023-06-25T18:00:00.000Z title="Created 2023-06-26 02:00:00">2023-06-26</time></div></div><div class=aside-list-item><a class=thumbnail href=/posts/2023/06/19/why-do-I-love-ultraman/ title=为什么奥特曼是我的信仰><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://user-images.githubusercontent.com/7054676/228287041-c86e7928-0da8-4097-b7ff-e575faa8cf8c.png onerror='this.onerror=null,this.src="/img/404.jpg"' alt=为什么奥特曼是我的信仰></a><div class=content><a class=title href=/posts/2023/06/19/why-do-I-love-ultraman/ title=为什么奥特曼是我的信仰>为什么奥特曼是我的信仰</a><time datetime=2023-06-19T20:00:00.000Z title="Created 2023-06-20 04:00:00">2023-06-20</time></div></div><div class=aside-list-item><a class=thumbnail href=/posts/2023/06/16/how-do-I-build-homelab/ title="家庭 Homelab 升级计划"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/04/07/38/cherry-blossoms-7766587_1280.jpg onerror='this.onerror=null,this.src="/img/404.jpg"' alt="家庭 Homelab 升级计划"></a><div class=content><a class=title href=/posts/2023/06/16/how-do-I-build-homelab/ title="家庭 Homelab 升级计划">家庭 Homelab 升级计划</a><time datetime=2023-06-16T16:00:00.000Z title="Created 2023-06-17 00:00:00">2023-06-17</time></div></div><div class=aside-list-item><a class=thumbnail href=/posts/2023/03/12/a-simple-introduction-about-iac/ title="简单聊聊 IaC：Infrastructure as Code"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/06/16/46/sea-7772372_1280.jpg onerror='this.onerror=null,this.src="/img/404.jpg"' alt="简单聊聊 IaC：Infrastructure as Code"></a><div class=content><a class=title href=/posts/2023/03/12/a-simple-introduction-about-iac/ title="简单聊聊 IaC：Infrastructure as Code">简单聊聊 IaC：Infrastructure as Code</a><time datetime=2023-03-12T13:00:00.000Z title="Created 2023-03-12 21:00:00">2023-03-12</time></div></div><div class=aside-list-item><a class=thumbnail href=/posts/2023/01/26/what-I-can-learn-from-a-refactor-project/ title=从一个重构项目中能学到什么东西><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/06/16/46/sea-7772372_1280.jpg onerror='this.onerror=null,this.src="/img/404.jpg"' alt=从一个重构项目中能学到什么东西></a><div class=content><a class=title href=/posts/2023/01/26/what-I-can-learn-from-a-refactor-project/ title=从一个重构项目中能学到什么东西>从一个重构项目中能学到什么东西</a><time datetime=2023-01-26T16:00:00.000Z title="Created 2023-01-27 00:00:00">2023-01-27</time></div></div></div></div><div class="card-widget ads-wrap"><ins class=adsbygoogle style=display:block data-ad-client=ca-pub-7962287588031867 data-ad-slot=1257383027 data-ad-format=auto data-full-width-responsive=true></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div></div></div></main><footer id=footer style="background:0 0"></footer></div><div id=rightside><div id=rightside-config-hide><button id=readmode type=button title="Read Mode"><i class="fas fa-book-open"></i></button><button id=translateLink type=button title="Switch Between Traditional Chinese And Simplified Chinese">繁</button><button id=darkmode type=button title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id=hide-aside-btn type=button title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id=rightside-config-show><button id=rightside_config type=button title=Setting><i class="fas fa-cog fa-spin"></i></button><button class=close id=mobile-toc-button type=button title="Table Of Contents"><i class="fas fa-list-ul"></i></button><a id=to_comment href=#post-comment title="Scroll To Comments"><i class="fas fa-comments"></i></a><button id=go-up type=button title="Back To Top"><span class=scroll-percent></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src=https://www.manjusaka.blog/js/utils.js></script><script src=https://www.manjusaka.blog/js/main.js></script><script src=https://www.manjusaka.blog/js/tw_cn.js></script><script src=https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js></script><script src=https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js></script><script src=https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js></script><script>function panguFn(){"object"==typeof pangu?pangu.autoSpacingPage():getScript("https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js").then(()=>{pangu.autoSpacingPage()})}function panguInit(){panguFn()}document.addEventListener("DOMContentLoaded",panguInit)</script><div class=js-pjax><script>(()=>{const e=document.querySelectorAll("#article-container .mermaid-wrap");var t;e.length&&(window.runMermaid=()=>{window.loadMermaid=!0;const n="dark"===document.documentElement.getAttribute("data-theme")?"dark":"default";Array.from(e).forEach((e,t)=>{const d=e.firstElementChild;e="%%{init:{ 'theme':'"+n+"'}}%%\n"+d.textContent;mermaid.mermaidAPI.render("mermaid-"+t,e,e=>{d.insertAdjacentHTML("afterend",e)})})},t=()=>{window.loadMermaid?runMermaid():getScript("https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js").then(runMermaid)},window.pjax?t():document.addEventListener("DOMContentLoaded",t))})()</script><script>function loadDisqus(){function t(){this.page.url="https://www.manjusaka.blog/posts/2017/11/27/something-about-concurrent-future/",this.page.identifier="/posts/2017/11/27/something-about-concurrent-future/",this.page.title="Python concurrent.future 使用教程及源码初剖"}var e,s;window.disqusReset=()=>{DISQUS.reset({reload:!0,config:t})},window.DISQUS?disqusReset():(e=document,(s=e.createElement("script")).src="https://manjusakablog.disqus.com/embed.js",s.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(s)),document.getElementById("darkmode").addEventListener("click",()=>{setTimeout(()=>window.disqusReset(),200)})}function loadOtherComment(){loadDisqus()}loadDisqus()</script></div><canvas class=fireworks mobile=false></canvas><script src=https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js></script><script defer=defer id=fluttering_ribbon mobile=false src=https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js></script><script src=https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!0,POWERMODE.mobile=!1,document.body.addEventListener("input",POWERMODE)</script><script async data-pjax src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script></div><div id=algolia-search><div class=search-dialog><nav class=search-nav><span class=search-dialog-title>Search</span><button class=search-close-button><i class="fas fa-times"></i></button></nav><div class=search-wrap><div id=algolia-search-input></div><hr><div id=algolia-search-results><div id=algolia-hits></div><div id=algolia-pagination></div><div id=algolia-info><div class=algolia-stats></div><div class=algolia-poweredBy></div></div></div></div></div><div id=search-mask></div><script src=https://cdn.jsdelivr.net/npm/algoliasearch/dist/algoliasearch-lite.umd.min.js></script><script src=https://cdn.jsdelivr.net/npm/instantsearch.js/dist/instantsearch.production.min.js></script><script src=https://www.manjusaka.blog/js/search/algolia.js></script></div><script data-pjax>function butterfly_swiper_injector_config(){var s=document.getElementById("recent-posts");console.log("已挂载butterfly_swiper"),s.insertAdjacentHTML("afterbegin",'<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="/posts/2023/06/25/love-and-hope-is-all-we-need/" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://github.com/Zheaoli/yuque-py/assets/7054676/ea9460a2-e351-4b73-9f82-7aef6cd20c33" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-06-25</span><a class="blog-slider__title" href="/posts/2023/06/25/love-and-hope-is-all-we-need/" alt="">聊聊公益和助学</a><div class="blog-slider__text">很多时候，帮助人不需要那么多理由</div><a class="blog-slider__button" href="/posts/2023/06/25/love-and-hope-is-all-we-need/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="/posts/2023/06/19/why-do-I-love-ultraman/" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://user-images.githubusercontent.com/7054676/228287041-c86e7928-0da8-4097-b7ff-e575faa8cf8c.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-06-19</span><a class="blog-slider__title" href="/posts/2023/06/19/why-do-I-love-ultraman/" alt="">为什么奥特曼是我的信仰</a><div class="blog-slider__text">優しさを失わないでくれ。弱い者を労り互いに助け合い。</div><a class="blog-slider__button" href="/posts/2023/06/19/why-do-I-love-ultraman/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="/posts/2023/06/16/how-do-I-build-homelab/" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.pixabay.com/photo/2023/02/04/07/38/cherry-blossoms-7766587_1280.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-06-16</span><a class="blog-slider__title" href="/posts/2023/06/16/how-do-I-build-homelab/" alt="">家庭 Homelab 升级计划</a><div class="blog-slider__text">人生嘛，Homelab 图个乐子</div><a class="blog-slider__button" href="/posts/2023/06/16/how-do-I-build-homelab/" alt="">详情   </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>')}for(var elist="undefined".split(","),cpage=location.pathname,epage="all",flag=0,i=0;i<elist.length;i++)cpage.includes(elist[i])&&flag++;("all"===epage&&0==flag||epage===cpage)&&butterfly_swiper_injector_config()</script><script defer=defer src=https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.js></script><script defer=defer data-pjax src=https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper_init.js></script><script async src=//at.alicdn.com/t/font_2032782_8d5kxvn09md.js></script><script src=/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05></script><script>L2Dwidget.init({log:!1,pluginJsPath:"lib/",pluginModelPath:"assets/",pluginRootPath:"live2dw/",tagMode:!1})</script></body></html>