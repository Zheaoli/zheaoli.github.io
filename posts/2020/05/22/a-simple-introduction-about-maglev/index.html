<!DOCTYPE html><html lang=en data-theme=auto><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><title>简单聊聊 Maglev ，来自 Google 的软负载均衡实践 | Manjusaka</title><meta name=author content=Manjusaka><meta name=copyright content=Manjusaka><meta name=format-detection content="telephone=no"><meta name=theme-color content=ffffff><meta name=description content="好久没博客了，来写个简单的读论文笔记吧，这篇文章是来自 Google 2016 年发表的一篇论文 Maglev: A Fast and Reliable Software Network Load Balancer 分享了他们内部从08年开始大规模使用的软负载均衡系统的实现。里面很多很有趣的细节，我看我能写多少，算多少吧"><meta property=og:type content=article><meta property=og:title content="简单聊聊 Maglev ，来自 Google 的软负载均衡实践"><meta property=og:url content=https://www.manjusaka.blog/posts/2020/05/22/a-simple-introduction-about-maglev/index.html><meta property=og:site_name content=Manjusaka><meta property=og:description content="好久没博客了，来写个简单的读论文笔记吧，这篇文章是来自 Google 2016 年发表的一篇论文 Maglev: A Fast and Reliable Software Network Load Balancer 分享了他们内部从08年开始大规模使用的软负载均衡系统的实现。里面很多很有趣的细节，我看我能写多少，算多少吧"><meta property=og:locale content=en_US><meta property=og:image content=https://cdn.pixabay.com/photo/2023/01/30/19/40/gulls-7756481_1280.jpg><meta property=article:published_time content=2020-05-22T19:09:00.000Z><meta property=article:modified_time content=2023-09-14T14:31:15.051Z><meta property=article:author content=Manjusaka><meta property=article:tag content=编程><meta property=article:tag content=笔记><meta property=article:tag content=水文><meta property=article:tag content=分布式><meta property=article:tag content=论文><meta name=twitter:card content=summary><meta name=twitter:image content="https://avatars.githubusercontent.com/u/7054676?v=4"><meta name=twitter:creator content=@Manjusaka_Lee><meta name=twitter:site content=https://twitter.com/Manjusaka_Lee><link rel="shortcut icon" href="https://avatars.githubusercontent.com/u/7054676?v=4"><link rel=canonical href=https://www.manjusaka.blog/posts/2020/05/22/a-simple-introduction-about-maglev/index.html><link rel=preconnect href=//cdn.jsdelivr.net><link rel=preconnect href=//www.google-analytics.com crossorigin=""><link rel=preconnect href=//busuanzi.ibruce.info><link rel=stylesheet href=/css/index.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css media=print onload='this.media="all"'><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css media=print onload='this.media="all"'><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css media=print onload='this.media="all"'><script async=async src="https://www.googletagmanager.com/gtag/js?id=UA-154407994-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-154407994-1")</script><script>const GLOBAL_CONFIG={root:"/",algolia:{appId:"DL1RURGHTB",indexName:"manjusaka.blog",hits:{per_page:6},languages:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}.",hits_stats:"${hits} results found in ${time} ms"}},localSearch:void 0,translate:{defaultEncoding:2,translateDelay:0,msgToTraditionalChinese:"繁",msgToSimplifiedChinese:"簡"},noticeOutdate:{limitDay:365,position:"top",messagePrev:"It has been",messageNext:"days since the last update, the content of the article may be outdated."},highlight:{plugin:"highlighjs",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:400},copy:{success:"Copy successfully",error:"Copy error",noSupport:"The browser does not support"},relativeDate:{homepage:!0,post:!0},runtime:"days",dateSuffix:{just:"Just",min:"minutes ago",hour:"hours ago",day:"days ago",month:"months ago"},copyright:{limitCount:100,languages:{author:"Author: Manjusaka",link:"Link: ",source:"Source: Manjusaka",info:"Copyright is owned by the author. For commercial reprints, please contact the author for authorization. For non-commercial reprints, please indicate the source."}},lightbox:"fancybox",Snackbar:{chs_to_cht:"Traditional Chinese Activated Manually",cht_to_chs:"Simplified Chinese Activated Manually",day_to_night:"Dark Mode Activated Manually",night_to_day:"Light Mode Activated Manually",bgLight:"#59C173",bgDark:"#1f1f1f",position:"bottom-left"},source:{justifiedGallery:{js:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js",css:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css"}},isPhotoFigcaption:!0,islazyload:!0,isAnchor:!0,percent:{toc:!0,rightside:!0},autoDarkmode:!0}</script><script id=config-diff>var GLOBAL_CONFIG_SITE={title:"简单聊聊 Maglev ，来自 Google 的软负载均衡实践",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2023-09-14 22:31:15"}</script><noscript><style type=text/css>#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:function(e,t,a){0!==a&&(a=864e5*a,t={value:t,expiry:(new Date).getTime()+a},localStorage.setItem(e,JSON.stringify(t)))},get:function(e){var t=localStorage.getItem(e);if(t){t=JSON.parse(t);if(!((new Date).getTime()>t.expiry))return t.value;localStorage.removeItem(e)}}},e.getScript=o=>new Promise((t,e)=>{const a=document.createElement("script");a.src=o,a.async=!0,a.onerror=e,a.onload=a.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},document.head.appendChild(a)}),e.getCSS=(o,n=!1)=>new Promise((t,e)=>{const a=document.createElement("link");a.rel="stylesheet",a.href=o,n&&(a.id=n),a.onerror=e,a.onload=a.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},document.head.appendChild(a)}),e.activateDarkMode=function(){document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},e.activateLightMode=function(){document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","ffffff")};var e=saveToLocal.get("theme"),t=window.matchMedia("(prefers-color-scheme: dark)").matches,a=window.matchMedia("(prefers-color-scheme: light)").matches,o=window.matchMedia("(prefers-color-scheme: no-preference)").matches,n=!t&&!a&&!o,t=(void 0===e?(a?activateLightMode():t?activateDarkMode():(o||n)&&((a=(new Date).getHours())<=6||18<=a?activateDarkMode:activateLightMode)(),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){void 0===saveToLocal.get("theme")&&(e.matches?activateDarkMode:activateLightMode)()})):("light"===e?activateLightMode:activateDarkMode)(),saveToLocal.get("aside-status"));void 0!==t&&("hide"===t?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})(window)</script><link rel=stylesheet href=https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.css media=print onload='this.media="all"'><link rel=stylesheet href=https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiperstyle.css media=print onload='this.media="all"'><link rel=stylesheet href=https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css media=defer onload='this.media="all"'><link rel=stylesheet href=https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css media=defer onload='this.media="all"'><script src=https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js></script><meta name=generator content="Hexo 6.3.0"><link rel=alternate href=/atom.xml title=Manjusaka type=application/atom+xml></head><body><div id=web_bg></div><div id=sidebar><div id=menu-mask></div><div id=sidebar-menus><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://avatars.githubusercontent.com/u/7054676?v=4" onerror='onerror=null,src="/img/friend_404.gif"' alt=avatar></div><div class="sidebar-site-data site-data is-center"><a href=/archives/ ><div class=headline>Articles</div><div class=length-num>78</div></a><a href=/tags/ ><div class=headline>Tags</div><div class=length-num>51</div></a><a href=/categories/ ><div class=headline>Categories</div><div class=length-num>32</div></a></div><hr class=custom-hr><div class=menus_items><div class=menus_item><a class=site-page href=/ ><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class=menus_item><a class="site-page group" href=javascript:void(0); rel="external nofollow noreferrer"><i class="fa-fw fa-fw fas fa-lines-leaning"></i><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class=menus_item_child><li><a class="site-page child" href=/categories/ ><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href=/tags/ ><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href=/archives/ ><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href=/random/ ><i class="fa-fw fas fa-random"></i><span> 随便逛逛</span></a></li></ul></div><div class=menus_item><a class=site-page href=/weekly/ ><i class="fa-fw fas fa-newspaper"></i><span> 周报</span></a></div><div class=menus_item><a class=site-page href=/leetcode/ ><i class="fa-fw fas fa-newspaper"></i><span> 刷题</span></a></div><div class=menus_item><a class="site-page group" href=javascript:void(0); rel="external nofollow noreferrer"><i class="fa-fw fas fa-heart"></i><span> 我的</span><i class="fas fa-chevron-down"></i></a><ul class=menus_item_child><li><a class="site-page child" href=/about/ ><i class="fa-fw fas fa-spa"></i><span> 关于</span></a></li><li><a class="site-page child" href=/weekly/ ><i class="fa-fw fas fa-newspaper"></i><span> 周报</span></a></li></ul></div></div></div></div><div class=post id=body-wrap><header class=post-bg id=page-header style=background-image:url(https://cdn.pixabay.com/photo/2023/01/30/19/40/gulls-7756481_1280.jpg)><nav id=nav><span id=blog-info><a href=/ title=Manjusaka><img class=site-icon src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://avatars.githubusercontent.com/u/7054676?v=4# image"><span class=site-name>Manjusaka</span></a></span><div id=menus><div id=search-button><a class="site-page social-icon search" href=javascript:void(0); rel="external nofollow noreferrer"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class=menus_items><div class=menus_item><a class=site-page href=/ ><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class=menus_item><a class="site-page group" href=javascript:void(0); rel="external nofollow noreferrer"><i class="fa-fw fa-fw fas fa-lines-leaning"></i><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class=menus_item_child><li><a class="site-page child" href=/categories/ ><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href=/tags/ ><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href=/archives/ ><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href=/random/ ><i class="fa-fw fas fa-random"></i><span> 随便逛逛</span></a></li></ul></div><div class=menus_item><a class=site-page href=/weekly/ ><i class="fa-fw fas fa-newspaper"></i><span> 周报</span></a></div><div class=menus_item><a class=site-page href=/leetcode/ ><i class="fa-fw fas fa-newspaper"></i><span> 刷题</span></a></div><div class=menus_item><a class="site-page group" href=javascript:void(0); rel="external nofollow noreferrer"><i class="fa-fw fas fa-heart"></i><span> 我的</span><i class="fas fa-chevron-down"></i></a><ul class=menus_item_child><li><a class="site-page child" href=/about/ ><i class="fa-fw fas fa-spa"></i><span> 关于</span></a></li><li><a class="site-page child" href=/weekly/ ><i class="fa-fw fas fa-newspaper"></i><span> 周报</span></a></li></ul></div></div><div id=toggle-menu><a class=site-page href=javascript:void(0); rel="external nofollow noreferrer"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id=post-info><h1 class=post-title>简单聊聊 Maglev ，来自 Google 的软负载均衡实践<a class=post-edit-link href=https://github.com/Zheaoli/Zheaoli.github.io/edit/main/source/_posts/a-simple-introduction-about-maglev.md rel="external nofollow noreferrer" title="Edited on" target=_blank><i class="fas fa-pencil-alt"></i></a></h1><div id=post-meta><div class=meta-firstline><span class=post-meta-date><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class=post-meta-label>Created</span><time datetime=2020-05-22T19:09:00.000Z title="Created 2020-05-23 03:09:00">2020-05-23</time></span><span class=post-meta-categories><span class=post-meta-separator>|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class=post-meta-categories href=/categories/%E7%BC%96%E7%A8%8B/ >编程</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class=post-meta-categories href=/categories/%E7%BC%96%E7%A8%8B/%E6%B0%B4%E6%96%87/ >水文</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class=post-meta-categories href=/categories/%E7%BC%96%E7%A8%8B/%E6%B0%B4%E6%96%87/%E8%AE%BA%E6%96%87/ >论文</a></span></div><div class=meta-secondline><span class=post-meta-separator>|</span><span class=post-meta-wordcount><i class="far fa-file-word fa-fw post-meta-icon"></i><span class=post-meta-label>Word count:</span><span class=word-count>5.6k</span><span class=post-meta-separator>|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class=post-meta-label>Reading time:</span><span>17min</span></span><span class=post-meta-separator>|</span><span class=post-meta-pv-cv id="" data-flag-title="简单聊聊 Maglev ，来自 Google 的软负载均衡实践"><i class="far fa-eye fa-fw post-meta-icon"></i><span class=post-meta-label>Post View:</span><span id=busuanzi_value_page_pv><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class=layout id=content-inner><div id=post><article class=post-content id=article-container><p>好久没博客了，来写个简单的读论文笔记吧，这篇文章是来自 Google 2016 年发表的一篇论文 <a target=_blank rel="noopener external nofollow noreferrer" href=https://research.google/pubs/pub44824/ >Maglev: A Fast and Reliable Software Network Load Balancer</a> 分享了他们内部从08年开始大规模使用的软负载均衡系统的实现。里面很多很有趣的细节，我看我能写多少，算多少吧<br><span id=more></span></p><h2 id=背景><a href=#背景 class=headerlink title=背景></a>背景</h2><p>负载均衡的概念大家肯定都比较熟悉了，再次不再赘述。现在我们需要考虑 Google 的场景。设计之初，Google 需要一种高性能的 LB 来承担 Google 一些重头服务的流量，比如 Google 搜索，Gmail 等等。由于流量非常庞大，那么 LB 需要非常强大的性能来处理大量的流量。</p><p>在这里，传统的想法可能说，我直接上专业的硬件负载均衡，能用钱解决的问题，都不算事（笑。但是这样的方案有着不小的问题</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://user-images.githubusercontent.com/7054676/82123782-c9537080-97cd-11ea-9030-4af01358be9d.png alt=image></p><ol><li>硬件负载均衡单点的性能决定了整个网络能承担的请求</li><li>在 HA 上存在缺陷。为了保证单点失效的时候，整个网络集群不陷入瘫痪。那么我们通常需要 1:1 的做冗余</li><li>灵活性和编程性欠缺，想做骚操作的时候没有切入点</li><li>太贵了。贵到 Google 都承受不了（逃</li></ol><p>在这样一种情况下，Google 开始考虑自行构建一种 SLB (Software Load Balance) 系统。去构建这样一种系统。好处也很明显。比如方便的 Scale ，为了保证 HA 所需的冗余从之前的 1:1 可以降至 N+1 ，方便的定制性等。架构就演变成下图了</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://user-images.githubusercontent.com/7054676/82126035-7c2acb00-97dc-11ea-9f65-8aa4f29b34ea.png alt=image></p><p>但是挑战也很明显。首先需要有足够的性能，这样保证集群有足够的吞吐。同时需要做 connection tracking ，这样保证同一个连接的数据包能妥投到同一个机器上。也许要保证能有透明的 failover 的能力。</p><p>这样一些要件结合起来，这也就是我们今天要聊的 Maglev。Google 从 08 年开始大规模的应用的 LB 系统</p><h2 id=Maglev-初窥><a href=#Maglev-初窥 class=headerlink title="Maglev 初窥"></a>Maglev 初窥</h2><h3 id=背景知识><a href=#背景知识 class=headerlink title=背景知识></a>背景知识</h3><p>在继续聊 Maglev 之前，我们需要去了解 Google 现在怎么样去去使用 Maglev 的，下面是一个简化后的示意图</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://user-images.githubusercontent.com/7054676/82126042-8c42aa80-97dc-11ea-8647-767d5e63dda8.png alt=image></p><p>同时这里我们需要介绍一个很重要的概念叫做 VIP(Virtual IP Address) 。 用过 Kubernetes 的同学肯定对这个概念并不陌生。VIP 并不是一个实际与网卡绑定的物理 IP。近似来讲它可以作为后端一组 Endpoint 的抽象，当你访问这个 VIP 的时候，实际上是在访问后端的 Endpoint 。这里举个更方便理解的例子，以 Kubernetes 为例，我们在创建完一组 Pod 后，为了暴露 Pod 中提供的服务，我们通常会创建一个 Service 来关联对应的 Pod。Service 通常会有一个 IP，那么这个 IP 就是一个 VIP 。当我们访问 Service 的 IP 的时候，通常会随机从后面的 Pod 中选择一个承接请求。</p><p>好了，回到 Maglev ，我们现在来看下整个的一个流程。Maglev 会和 VIP 关联，然后将 VIP 透传给一组 Router。 当用户在浏览器中输入 <a target=_blank rel="noopener external nofollow noreferrer" href=https://www.google.com>https://www.google.com</a> 并按下回车的时候，浏览器会进行 DNS 解析。而 DNS 解析将由 Google 的 DNS 服务器进行处理。DNS 服务器会根据用户的区域选择一个最近集群的 VIP 返回给用户，然后浏览器会根据获取到的 VIP 建立连接。</p><p>当 Router 收到对应包时，会将包转发给 VIP 所属的 Maglev 集群中的任意节点。集群中的每个节点权重都是平衡。Maglev 节点在接受到包的时候，会利用 GRE(Generic Routing Encapsulation) 进行封包。然后传输给对应的后端端点。</p><p>当后端端点接收到数据包的时候，会进行接包并处理请求。当响应数据准备就绪的时候，会进行封包操作，会将 VIP 的作为源地址，用户的 IP 作为目标地址，然后响应数据作为数据包操作。这个时候，后端端点会利用 DSR(Direct Server Return) 将数据包绕过 Maglev 直接返回。这样避免响应过大的时候对 Maglev 造成额外的负担。实际上 DSR 在 L4 的 LB 实现，如 HAProxy，Envoy 等都得到了比较多的应用。改天有时间写篇博客来聊聊。</p><h3 id=Maglev-配置><a href=#Maglev-配置 class=headerlink title="Maglev 配置"></a>Maglev 配置</h3><p>如前面所说， Maglev 接收来自 Router 的 VIP 请求，然后将对应流量转发到对应的后端端点上。每个 Maglev 将由 Controller 和 Forwarder 组成，其架构如下所示</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://user-images.githubusercontent.com/7054676/82127700-3d9b0d80-97e8-11ea-8cc3-8a6f5b1ccd3e.png alt=image></p><p>而 Controller 和 Forwarder 都利用 Configuration Object 管理相关 VIP。Configuration Object 这一套实际上又是另外一套系统（可以近似的认为是注册中心），彼此之间通过 RPC 来通信。</p><p>在 Maglev 机器上，Controller 会定期对 Forwarder 进行检查。根据检查结果来确定是否通过 BGP 提交/撤回所有 VIP 的注册（要么全部成功，要么全部失败，其实还是为了保障系统的一致性）。这样确保从 Router 过来的流量都能扔到健康的机器上</p><p>而从 Router 过来的 VIP 流量将会由 Forwarder 进行处理。在 Forwarder 中，每个 VIP 都会和一个或多个 backend pool 关联。除非特殊处理，Maglev 中的 backend 都是服务端点。一个 backend pool 可以包含一组服务端点的的物理 IP ，也可以是其余的 backend pool。每个 backend pool 都会根据其特定需求，设计若干个监控检查器，数据包只会转发给健康的服务。如之前所说，同一个服务可能会被包含在多个 backend pool 中，因此 Forwarder 将会根据具体的地址进行去重，避免额外的开销。</p><p>Forwarder 的 Config Manager 将负责从 Configuration Object 中拉取，解析并验证相关的配置。所有配置的提交都是具备原子性（要么全部成功，要么全部失败）。在推送和解析到生效的过程中，存在一个非常短暂的 gap，在此期间，一个 Maglev 集群之间的配置可能存在不同步的情况。不过因为一致性 Hash 的存在，在这个非常短的 Gap 内，大部分请求还是能成功妥投。</p><h2 id=Maglev-实现><a href=#Maglev-实现 class=headerlink title="Maglev 实现"></a>Maglev 实现</h2><p>好了，扯了这么多，来看一下 Maglev 整个系统的一些实践细节</p><h3 id=概述><a href=#概述 class=headerlink title=概述></a>概述</h3><p>总所周知（如前面所说），Maglev 由 Forwarder 来实际承担流量相关的转发工作，我们用一张图来说明一下它的结构</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://user-images.githubusercontent.com/7054676/82140858-7082e700-9864-11ea-9653-a5e8ba9b5d97.png alt=image></p><p>Forwarder 将直接从 NIC(Network Interface Card) 拿到数据包，然后直接扔入 NIC 转发到后端。期间所有操作都不会过内核（实际上过内核会有额外的 cost）</p><p>从 NIC 中捞出的包，会先由 <code>Steering Module</code> 进行处理，在处理过程中，<code>Steering Module</code> 将会根据五元组（协议，目标地址，目标端口，源地址，源端口）进行 hash 计算。然后将其转入对应的 <code>Receiving Queue</code> 中。每个 <code>Receiving Queue</code> 都会对应一个处理线程。处理线程将过滤掉目标 VIP 和本机注册 VIP 不匹配的包。然后会重新计算五元组 hash，然后从 <code>Connection Tracking Table</code> 中查找对应的值。</p><p>在 <code>Connection Tracking Table</code> 中存放之前五元组 Hash 所对应的 Backend，然后如果查找命中，那么直接复用，如果未命中，则为这个包选择一个新的 Backend, 然后将键值对加入 <code>Connection Tracking Table</code>。如果此时没有 Backend 可用，那么这个包会被丢弃。当这个包完成查找操作后，如前面所说，会改写这个包，然后将其放入 <code>transmission queue</code> 中去。最后将 <code>muxing module</code> 会将 <code>transmission queue</code> 的包直接通过 NIC 发送出去。</p><p>这里有个问题，在 <code>Steering Module</code> 中为啥不考虑根据 <code>round-robin</code> 这种常见的策略来做？大家都知道每个线程的处理速度是不一致的，如果直接裸 <code>round-robin</code> ，那么面对这种情况，可能会导致数据包重排的情况发生，如果是引入权重的概念来改良，又会引入新的复杂度，毕竟线程的处理速度是动态变化的。另外一种是 <code>connnection tracking</code> 的情况，假设我们有个需要持久化的连接，我们需要保证每个包都能扔到同样的机器上，这个时候用 <code>round-robin</code> 就会引入额外的复杂性。不过对于一些特殊情况，比如 <code>receive queue</code> 满了，一致性 Hash 处理不过来的时候，我们会利用 <code>round-robin</code> 作为 backup 的手段来替代一致性 Hash，这种情况对于同时存在同样5元组包的时候比较好用。</p><h3 id=高效处理数据包><a href=#高效处理数据包 class=headerlink title=高效处理数据包></a>高效处理数据包</h3><p>前面已经花了很多时间讲述了，Maglev 是直接对 TCP 的数据包进行操作，同时因为 Google 的流量极为庞大，那么这个时候实际上是需要 Maglev 有着良好的转发性能。不然在大规模场景下，其吞吐能力会无法满足需求。Google 怎么做的？答：直接对网卡操作。。</p><p>我们都知道在 Linux 中进行网络编程的时候，将数据包从内核态拷贝到用户态实际上是一件开销非常大的事，所以对于一些极端需求性能的场景，如 L4 的负载均衡等，大家可能更倾向于将东西做到内核里，避免跨态拷贝。这也是 LVS 等工具的思路。但是实际上对于更大规模的流量，来讲，从网卡到内核，经过内核中的一堆 filter 处理也是一件开销非常大的事，而如同前面所说，Maglev 只依赖数据包中的五元组，对于包序列号，包 payload ，都不需要关心。于是 Google：我有一个大胆的想法！好了，来看张图</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://user-images.githubusercontent.com/7054676/82677245-4bceab00-9c7a-11ea-9d30-68f948b32f9a.png alt=image></p><p>Google 选择直接在 NIC (即网卡) 上进行编程。让 <code>Forwarder</code> 和 NIC 共享一片内存。内存中维护的是一个环状的数据包池子。然后 <code>Forwarder</code> 中的 <code>steering module</code> 和 <code>muxing module</code> 各自维护三个指针来处理这些数据包，下面详细描述一下</p><p>首先而言 <code>steering module</code> 维护了三个指针</p><ol><li><code>received</code> ，管理接收数据包</li><li><code>reserved</code>, 管理已接收未处理的数据包</li><li><code>processed</code>, 管理处理完成的数据包</li></ol><p>那么流程是这样的，当 NIC 接受到新的数据包后，那么 <code>received</code> 指针指向的内存会被修改。然后当一个数据包被分发给线程完成相关操作后，那么 <code>processed</code> 指针指向的内存地址会被修改。因为是个环状结构嘛， <code>received</code> 和 <code>processed</code> 中间存在的数据包就是已接收但未完成处理的包，由 <code>reserved</code> 指针进行管理。</p><p>于此对应的，<code>muxing module</code> 也维护了三个指针</p><ol><li><code>sent</code>，管理已发送完毕的数据包</li><li><code>ready</code>，管理已经就绪等待发送的数据包</li><li><code>recycled</code>, 管理已回收的数据包</li></ol><p>那么对应的流程是这样的，当 <code>steering module</code> 完成相关包的处理的时候，<code>ready</code> 指针指向的内存会被修改，然后等待发送。当一个数据包发送后，<code>sent</code> 指向的内存地址被修改。在 <code>ready</code> 和 <code>sent</code> 之外有另一个状态 <code>recycled</code> 管理已经回收的数据包。</p><p>我们可以看到在这个过程中，没有发生数据拷贝的操作，实际上这减小了一部分复制数据带来的时延。不过这种方法存在的问题就是，当指针越界后，会带来很大的额外开销。所以 Google 采用的做法是批处理，比如接收 3000 个小包集中处理一次，这样的骚操作</p><p>另外需要做一些额外的优化，比如包处理线程之间不共享数据以避免竞态。比如需要将线程与具体 CPU Core 绑定来保证性能等等</p><p>目前来看，Google 这一套的做法效率非常的出色，平均每个包的处理只需要 300 ns($10^{-9}$s)。如同前面所说，Google 采用批处理的方式来处理包，这样的问题是每当一些例如硬件中断的情况发生的时候，可能到达处理阈值的时间会比大部分情况长很多，所以 Google 设计了一个 50μs($10^{-6}$s) 的 Timer 来处理这种情况。换句话说，当因为硬件或者其余问题时，整体的包处理时长可能会增加 50μs 的时间（其实这里感觉 Google 怎么是在得瑟，你看我们性能超棒的噢，只有硬件是我们的瓶颈喔（逃</p><h3 id=后端选择><a href=#后端选择 class=headerlink title=后端选择></a>后端选择</h3><p>如同前面所说的一样，<code>Forwarder</code> 会为数据包选择一个后端。对于 TCP 这种常见来说，将相同五元组的数据包转发到同一个后端节点上非常重要。Google 采取在 Maglev 中维护一个 <code>connction tracking table</code> 来解决这个问题。当一个包抵达的时候，Maglev 会计算其五元组 Hash ，然后确定在 table 中是否存在，如果不存在，则选择一个节点作为后端，然后将记录值添加到 table 中。如果存在则直接复用</p><p>这样看起来没有问题了对吧？Google：不，不是，还有问题！</p><p>我们首先考虑这样一种场景：如前面所说，Maglev 前面挂了一个/组 Router，而 Router 是不提供连接亲和的，即不保证把同一个连接的包发送到同一个机器上。所以可能存在的情况是同一个连接的不同数据包会被仍在不同的机器上。再比如，我们假设 Router 是具有连接亲和的，但是也会存在如果机器发生重启后，<code>connection tracking table</code> 被清空的情况。</p><p>再来一个例子，我们都知道 <code>connection tracking table</code> 它所能使用的内存，必定是有一个阈值的。这样在面对一些流量非常大，或者 <code>SYN Flood</code> 这种非正常情景的时候。当 <code>connection tracking table</code> 的容量到达阈值的时候，我们势必会清理一些数据。那么在这个时候，一个连接的 tracking 信息就很有可能被清理。那么在这种情况下，我们怎么样去做 <code>connection tracking</code> ？</p><p>Google 选择的做法是引入一致性 Hash</p><h3 id=一致性-Hash：Maglev-Hash><a href=#一致性-Hash：Maglev-Hash class=headerlink title="一致性 Hash：Maglev Hash"></a>一致性 Hash：Maglev Hash</h3><p>整体算法其实有很多细节，这里只说明大概，具体细节大家可以去阅读原文查找</p><p>首先，我们要确定经过预处理后的产物 <code>lookup table</code> 的长度 M。所有 Key 都会被 hash 到这个 <code>lookup table</code> 中去，而 <code>lookup table</code> 中的每个元素都会被映射到一个 Node 上</p><p>而计算 <code>lookup table</code> 的计算分为两步</p><ol><li>计算每一个 node 对于每一个 lookup table 项的一个取值（也就是原文中提到的 permutation）；</li><li>根据这个值，去计算每一个 lookup table 项所映射到的 node（放在 entry 中，此处 entry 用原文的话来讲就是叫做 <code>the final lookup table</code>）。</li></ol><p>permutation 是一个 M×N 的矩阵，列对应 lookup table，行对应 node。 为了计算 permutation，需要挑选两个 hash 算法，分别计算两个值 offset 与 skip 。最后根据 offset 和 skip 的值来填充 permutation，计算方式描述如下：</p><ol><li>offset ← h 1 (name[i]) mod M</li><li>skip ← h 2 (name[i]) mod (M − 1)+ 1</li><li>permutation[i][j] ← (offset+ j × skip) mod M</li></ol><p>其中 i 是 Node Table 中 Node 的下标，j 是 lookup table 下标</p><p>在计算完 permutation 后，我们就可以计算最后的 lookup table 了，这个 table 用一维的数组表示</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://user-images.githubusercontent.com/7054676/82696622-f73b2800-9c99-11ea-8d14-08f67487f3b9.png alt=image></p><p>这里贴一张图，大家可以配合下面的代码一起看一下</p><figure class="highlight python"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br></pre></td><td class=code><pre><span class=line><span class=keyword>from</span> typing <span class=keyword>import</span> <span class=type>List</span></span><br><span class=line></span><br><span class=line><span class=comment># 根据已经计算好的 permutation 来计算 lookup_table</span></span><br><span class=line><span class=keyword>def</span> <span class="title function_">calculate_lookup_table</span>(<span class=params>n: <span class=built_in>int</span>, m: <span class=built_in>int</span>, permutation: <span class=type>List</span>[<span class=type>List</span>[<span class=built_in>int</span>]]</span>) -&gt; <span class=type>List</span>[<span class=built_in>int</span>]:</span><br><span class=line>    <span class=comment># result 是最终记录分布的 Hash 表</span></span><br><span class=line>    result: <span class=type>List</span>[<span class=built_in>int</span>] = [-<span class=number>1</span>] * m</span><br><span class=line>    <span class=comment># next 是用来解决冲突的，在遍历过程中突然想要填入的 entry 表已经被占用，</span></span><br><span class=line>    <span class=comment># 则通过 next 找到下一行。一直进行该过程直到找到一个空位。</span></span><br><span class=line>    <span class=comment># 因为每一列都包含有 0~M-1 的每一个值，所以最终肯定能遍历完每一行。</span></span><br><span class=line>    <span class=comment># 计算复杂度为 O(M logM) ~ O(M^2)</span></span><br><span class=line>    <span class=built_in>next</span>: <span class=type>List</span>[<span class=built_in>int</span>] = [<span class=number>0</span>] * n</span><br><span class=line>    flag = <span class=number>0</span></span><br><span class=line>    <span class=keyword>while</span> <span class=literal>True</span>:</span><br><span class=line>        <span class=keyword>for</span> i <span class=keyword>in</span> <span class=built_in>range</span>(n):</span><br><span class=line>            x = permutation[i][<span class=built_in>next</span>[i]]</span><br><span class=line>            <span class=keyword>while</span> <span class=literal>True</span>:</span><br><span class=line>                <span class=comment># 找到空位，退出查找</span></span><br><span class=line>                <span class=keyword>if</span> result[x] == -<span class=number>1</span>:</span><br><span class=line>                    <span class=keyword>break</span></span><br><span class=line>                <span class=built_in>next</span>[i] += <span class=number>1</span></span><br><span class=line>                x = permutation[i][<span class=built_in>next</span>[i]]</span><br><span class=line>            result[x] = i</span><br><span class=line>            <span class=built_in>next</span>[i] += <span class=number>1</span></span><br><span class=line>            flag += <span class=number>1</span></span><br><span class=line>            <span class=comment># 表已经填满，退出计算</span></span><br><span class=line>            <span class=keyword>if</span> flag == m:</span><br><span class=line>                <span class=keyword>return</span> result</span><br></pre></td></tr></table></figure><p>在这里我们能看到，这段循环代码必然结束，而最坏情况下，复杂度会非常高，最坏的情况可能会到 O(M^2)。原文中建议找一个远大于 N 的 M （To avoid this happening we always choose M such that M ≫ N.）可以使平均复杂度维持在 O(MlogM)</p><p>而 Maglev 中 Google 自研的一致性算法性能怎么样呢？论文中也做了测试</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://user-images.githubusercontent.com/7054676/82696955-abd54980-9c9a-11ea-8aa4-480ae328d387.png alt=image></p><p>可以看到，对于不同大小的 lookup table，Maglev 表现出了更好的均衡性</p><p>说实话，Maglev 在我看来本质上是一个带虚节点的 Hash，说实话，我没想到为什么 Google 不用 Dynamo 等已经比较成熟的 Hash ？难道是因为政策原因？（毕竟 Dynamo 是 AWS 家的嘛（逃。BTW Enovy 也实现了 Maglev 。参见 <a target=_blank rel="noopener external nofollow noreferrer" href=https://github.com/envoyproxy/envoy/issues/2267>Evaluate other consistent hash LB algorithms</a> ，而且引入了权重，实现的挺不错，有兴趣的同学可以去看看（逃</p><p>说实话，Maglev Hash 还有很多细节没有讲，不过实在懒得写了，，等后面出一个一致性 Hash 的分析博客吧，Flag++</p><h2 id=Maglev-优化><a href=#Maglev-优化 class=headerlink title="Maglev 优化"></a>Maglev 优化</h2><p>前面我们已经把 Maglev 这一套的基本原理讲的差不多了。但是如果作为一个生产上大规模使用的 LB ，那么势必还需要针对细节做很多优化，由于这里涉及到很多方面，我这里只简单介绍一下，剩下的还是建议大家直接去读原文</p><h3 id=分段数据包的处理><a href=#分段数据包的处理 class=headerlink title=分段数据包的处理></a>分段数据包的处理</h3><p>熟悉网络的同学都知道，在基于 IP 协议传输报文的时候，受限于 MTU 的大小，在传输的时候，可能会存在数据分片传输的情况，而这些分片后的数据不一定会带有完整的五元组信息。比如一个数据被切分为两段，那么第一段将带有 L3 和 L4 的头部信息，而第二段只带有 L3 的信息。而在传输过程中，因为网络关系，Maglev 无法完全保证对接收到的数据作出正确的处理</p><p>这样问题就大了，因为数据分段的情况实际上是非常场景的。那么对于这样的场景，Maglev 应该怎么样去处理？首先我们需要确定怎么样才能保证所有数据都能妥投</p><ol><li>保证一个数据报文的不同数据段都需要由同一个 Maglev 实例处理</li><li>对于同一个数据报文的不同数据段需要能保证后端选择结果是一致的</li></ol><p>OK，那么我们来看看 Google 是怎么解决这个问题的。</p><p>首先，每个 Maglev 实例中都会有一个特殊的 <code>backend pool</code> ，池子中是该 Maglev 集群中所有的实例。当接收到数据后，Maglev 会先根据三元组（源地址，目标地址，协议簇）计算 hash ，然后选择一个 Maglev 实例进行转发，这样就能保证同一数据报文的不同分段能传输到同一个 Maglev 实例上。当然这里需要利用 GRE 的递归控制来避免无限循环。</p><p>好了我们来看看条件2怎么满足。在每个 Maglev 实例上会维护一个特殊的表，记录数据分片后第一个数据端的转发结果。以前面的例子为例，当一个报文的第二个分段抵达的时候，Maglev 会查询表中是否存在第一个数据段的转发结果。如果存在则直接转发，如果不存在，则将这个数据段缓存，直到第一个数据段抵达，或者到达超时阈值</p><h3 id=监控与调试><a href=#监控与调试 class=headerlink title=监控与调试></a>监控与调试</h3><p>真正的用时都是不需要调试（划掉）（笑，Google 为了这一套系统设计了辅助的监控与调试手段来帮助日常的开发迭代。</p><p>在监控这边，分为黑盒和白盒两种监控手段。比如遍布全球的特定监控节点，以确认 VIP 的健康状态。当然与之配套的还有一整套白盒监控。Google 会监控具体的服务器指标，同时会监控 Maglev 本身的指标</p><p>当然与之配套的还有一些调试工具。比如 Google 开发了一套类似 X-Trace 的 packettracer。可以通过 packettracer 来发送一些带有特定标头和 payload 的信息。当 Maglev 接到这样一些特殊的数据包后，除了照常转发数据包以外，也会讲一些关键信息上报到指定位置</p><p>这其实也体现了软负载均衡相较于硬件负载均衡的一个好处，无论可调试性还是可迭代性都是硬件负载均衡无法媲美的</p><h2 id=总结><a href=#总结 class=headerlink title=总结></a>总结</h2><p>这篇文章其实我读了挺久，里面很多细节挺值得慢慢深究的，所以再次建议大家一定要去找原文读一下，非常不错。另外顺便推荐一篇文章，是美团技术团队的作品，他们也参考了 Maglev 来实现自己的高性能 L4 负载均衡，参见<a target=_blank rel="noopener external nofollow noreferrer" href=https://tech.meituan.com/2017/01/05/mgw.html>MGW——美团点评高性能四层负载均衡</a></p><p>好了，这篇文章，就先到这里吧，这篇文章应该是我写的最耗时的一篇文章了。。不过想想后面还有几篇文章要写，头就很大</p><p>溜了溜了</p></article><div class=post-copyright><div class=post-copyright__author><span class=post-copyright-meta>Author: </span><span class=post-copyright-info><a target=_blank rel="noopener external nofollow noreferrer" href=https://github.com/Zheaoli>Manjusaka</a></span></div><div class=post-copyright__type><span class=post-copyright-meta>Link: </span><span class=post-copyright-info><a href=https://www.manjusaka.blog/posts/2020/05/22/a-simple-introduction-about-maglev/ >https://www.manjusaka.blog/posts/2020/05/22/a-simple-introduction-about-maglev/</a></span></div><div class=post-copyright__notice><span class=post-copyright-meta>Copyright Notice: </span><span class=post-copyright-info>All articles in this blog are licensed under <a target=_blank rel="noopener external nofollow noreferrer" href=https://creativecommons.org/licenses/by-nc-sa/4.0/ >CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class=tag_share><div class=post-meta__tag-list><a class=post-meta__tags href=/tags/%E7%BC%96%E7%A8%8B/ >编程</a><a class=post-meta__tags href=/tags/%E7%AC%94%E8%AE%B0/ >笔记</a><a class=post-meta__tags href=/tags/%E6%B0%B4%E6%96%87/ >水文</a><a class=post-meta__tags href=/tags/%E5%88%86%E5%B8%83%E5%BC%8F/ >分布式</a><a class=post-meta__tags href=/tags/%E8%AE%BA%E6%96%87/ >论文</a></div><div class=post_share><div class=social-share data-image=https://cdn.pixabay.com/photo/2023/01/30/19/40/gulls-7756481_1280.jpg data-sites=facebook,twitter,wechat,weibo,qq></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css media=print onload='this.media="all"'><script src=https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js defer=defer></script></div></div><div class=ads-wrap><ins class=adsbygoogle style=display:block;text-align:center data-ad-layout=in-article data-ad-format=fluid data-ad-client=ca-pub-7962287588031867 data-ad-slot=2542544532></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><nav class=pagination-post id=pagination><div class="prev-post pull-left"><a href=/posts/2020/06/29/some-tips-about-kubernetes-and-container/ title="关于 Kubernetes 和容器化的一些随想"><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/06/01/14/superb-fairywren-7770904_1280.jpg onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class=pagination-info><div class=label>Previous Post</div><div class=prev_info>关于 Kubernetes 和容器化的一些随想</div></div></a></div><div class="next-post pull-right"><a href=/posts/2020/03/20/a-simple-history-about-type-hint-in-python/ title="为什么 Python 的 Type Hint 没有流行起来"><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/01/30/19/40/gulls-7756481_1280.jpg onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class=pagination-info><div class=label>Next Post</div><div class=next_info>为什么 Python 的 Type Hint 没有流行起来</div></div></a></div></nav><div class=relatedPosts><div class=headline><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class=relatedPosts-list><div><a href=/posts/2021/11/22/a-litte-introduction-about-nohdr-filed-in-skbuff/ title="聊聊 sk_buff 中一个冷门字段: nohdr"><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/04/07/50/flower-7766608_1280.jpg alt=cover><div class="content is-center"><div class=date><i class="far fa-calendar-alt fa-fw"></i> 2021-11-22</div><div class=title>聊聊 sk_buff 中一个冷门字段: nohdr</div></div></a></div><div><a href=/posts/2023/08/26/a-little-bit-design-about-cpu-burst-in-k8s/ title="关于 CPU Burst 在 K8s 中的一些设计想法"><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/07/14/45/snow-7774312_1280.jpg alt=cover><div class="content is-center"><div class=date><i class="far fa-calendar-alt fa-fw"></i> 2023-08-27</div><div class=title>关于 CPU Burst 在 K8s 中的一些设计想法</div></div></a></div><div><a href=/posts/2023/08/22/a-little-bit-idea-about-unwind/ title=关于用户态栈回溯（Unwind）的一些杂记和想法><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/06/01/14/superb-fairywren-7770904_1280.jpg alt=cover><div class="content is-center"><div class=date><i class="far fa-calendar-alt fa-fw"></i> 2023-08-23</div><div class=title>关于用户态栈回溯（Unwind）的一些杂记和想法</div></div></a></div><div><a href=/posts/2021/08/24/a-little-problem-about-posix-node-js-execsync/ title="关于 Node.js 中 execSync 的一点问题"><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/01/14/19/50/flower-7718952_1280.jpg alt=cover><div class="content is-center"><div class=date><i class="far fa-calendar-alt fa-fw"></i> 2021-08-24</div><div class=title>关于 Node.js 中 execSync 的一点问题</div></div></a></div><div><a href=/posts/2021/04/11/a-simple-introduce-about-ci-cd/ title="当我们在聊 CI&#x2F;CD 时，我们在聊什么？"><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/04/07/50/flower-7766608_1280.jpg alt=cover><div class="content is-center"><div class=date><i class="far fa-calendar-alt fa-fw"></i> 2021-04-11</div><div class=title>当我们在聊 CI&#x2F;CD 时，我们在聊什么？</div></div></a></div><div><a href=/posts/2022/01/31/a-simple-introduction-about-network-monitoring-in-linux-kernel/ title="简单聊聊在 Linux 内核中的网络质量监控"><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/04/07/38/cherry-blossoms-7766588_1280.jpg alt=cover><div class="content is-center"><div class=date><i class="far fa-calendar-alt fa-fw"></i> 2022-01-31</div><div class=title>简单聊聊在 Linux 内核中的网络质量监控</div></div></a></div></div></div><hr class=custom-hr><div id=post-comment><div class=comment-head><div class=comment-headline><i class="fas fa-comments fa-fw"></i><span> Comment</span></div></div><div class=comment-wrap><div><div id=disqus_thread></div></div></div></div></div><div class=aside-content id=aside-content><div class="card-widget card-info"><div class=is-center><div class=avatar-img><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://avatars.githubusercontent.com/u/7054676?v=4" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt=avatar></div><div class=author-info__name>Manjusaka</div><div class=author-info__description>热忱之心不可磨灭</div></div><div class="card-info-data site-data is-center"><a href=/archives/ ><div class=headline>Articles</div><div class=length-num>78</div></a><a href=/tags/ ><div class=headline>Tags</div><div class=length-num>51</div></a><a href=/categories/ ><div class=headline>Categories</div><div class=length-num>32</div></a></div><a id=card-info-btn target=_blank rel="noopener external nofollow noreferrer" href=https://github.com/Zheaoli><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class=social-icon href=https://github.com/ZheaoLi rel="external nofollow noreferrer" target=_blank title=Github><i class="fab fa-github"></i></a><a class=social-icon href=mailto:me@manjusaka.me rel="external nofollow noreferrer" target=_blank title=Email><i class="fas fa-envelope"></i></a><a class=social-icon href=https://twitter.com/Manjusaka_Lee rel="external nofollow noreferrer" target=_blank title=推特><i class="fab fa-twitter"></i></a><a class=social-icon href=/atom.xml target=_blank title=RSS><i class="fab fa-feed"></i></a></div></div><div class="card-widget card-announcement"><div class=item-headline><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class=announcement_content>This is my Blog</div></div><div class=sticky_layout><div class=card-widget id=card-toc><div class=item-headline><i class="fas fa-stream"></i><span>Catalog</span><span class=toc-percentage></span></div><div class="toc-content is-expand"><ol class=toc><li class="toc-item toc-level-2"><a class=toc-link href=#%E8%83%8C%E6%99%AF><span class=toc-number>1.</span> <span class=toc-text>背景</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#Maglev-%E5%88%9D%E7%AA%A5><span class=toc-number>2.</span> <span class=toc-text>Maglev 初窥</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#%E8%83%8C%E6%99%AF%E7%9F%A5%E8%AF%86><span class=toc-number>2.1.</span> <span class=toc-text>背景知识</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#Maglev-%E9%85%8D%E7%BD%AE><span class=toc-number>2.2.</span> <span class=toc-text>Maglev 配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class=toc-link href=#Maglev-%E5%AE%9E%E7%8E%B0><span class=toc-number>3.</span> <span class=toc-text>Maglev 实现</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#%E6%A6%82%E8%BF%B0><span class=toc-number>3.1.</span> <span class=toc-text>概述</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E9%AB%98%E6%95%88%E5%A4%84%E7%90%86%E6%95%B0%E6%8D%AE%E5%8C%85><span class=toc-number>3.2.</span> <span class=toc-text>高效处理数据包</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E5%90%8E%E7%AB%AF%E9%80%89%E6%8B%A9><span class=toc-number>3.3.</span> <span class=toc-text>后端选择</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E4%B8%80%E8%87%B4%E6%80%A7-Hash%EF%BC%9AMaglev-Hash><span class=toc-number>3.4.</span> <span class=toc-text>一致性 Hash：Maglev Hash</span></a></li></ol></li><li class="toc-item toc-level-2"><a class=toc-link href=#Maglev-%E4%BC%98%E5%8C%96><span class=toc-number>4.</span> <span class=toc-text>Maglev 优化</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#%E5%88%86%E6%AE%B5%E6%95%B0%E6%8D%AE%E5%8C%85%E7%9A%84%E5%A4%84%E7%90%86><span class=toc-number>4.1.</span> <span class=toc-text>分段数据包的处理</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E7%9B%91%E6%8E%A7%E4%B8%8E%E8%B0%83%E8%AF%95><span class=toc-number>4.2.</span> <span class=toc-text>监控与调试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E6%80%BB%E7%BB%93><span class=toc-number>5.</span> <span class=toc-text>总结</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class=item-headline><i class="fas fa-history"></i><span>Recent Post</span></div><div class=aside-list><div class=aside-list-item><a class=thumbnail href=/posts/2023/08/26/a-little-bit-design-about-cpu-burst-in-k8s/ title="关于 CPU Burst 在 K8s 中的一些设计想法"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/07/14/45/snow-7774312_1280.jpg onerror='this.onerror=null,this.src="/img/404.jpg"' alt="关于 CPU Burst 在 K8s 中的一些设计想法"></a><div class=content><a class=title href=/posts/2023/08/26/a-little-bit-design-about-cpu-burst-in-k8s/ title="关于 CPU Burst 在 K8s 中的一些设计想法">关于 CPU Burst 在 K8s 中的一些设计想法</a><time datetime=2023-08-26T19:09:00.000Z title="Created 2023-08-27 03:09:00">2023-08-27</time></div></div><div class=aside-list-item><a class=thumbnail href=/posts/2023/08/22/a-little-bit-idea-about-unwind/ title=关于用户态栈回溯（Unwind）的一些杂记和想法><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/06/01/14/superb-fairywren-7770904_1280.jpg onerror='this.onerror=null,this.src="/img/404.jpg"' alt=关于用户态栈回溯（Unwind）的一些杂记和想法></a><div class=content><a class=title href=/posts/2023/08/22/a-little-bit-idea-about-unwind/ title=关于用户态栈回溯（Unwind）的一些杂记和想法>关于用户态栈回溯（Unwind）的一些杂记和想法</a><time datetime=2023-08-22T16:09:00.000Z title="Created 2023-08-23 00:09:00">2023-08-23</time></div></div><div class=aside-list-item><a class=thumbnail href=/posts/2023/08/10/is-it-possible-to-lose-the-signal-in-linux/ title=子进程退出后，父进程有可能会收不到信号吗？><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/04/07/50/daisy-7766609_1280.jpg onerror='this.onerror=null,this.src="/img/404.jpg"' alt=子进程退出后，父进程有可能会收不到信号吗？></a><div class=content><a class=title href=/posts/2023/08/10/is-it-possible-to-lose-the-signal-in-linux/ title=子进程退出后，父进程有可能会收不到信号吗？>子进程退出后，父进程有可能会收不到信号吗？</a><time datetime=2023-08-10T14:09:00.000Z title="Created 2023-08-10 22:09:00">2023-08-10</time></div></div><div class=aside-list-item><a class=thumbnail href=/posts/2023/06/25/love-and-hope-is-all-we-need/ title=聊聊公益和助学><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://github.com/Zheaoli/yuque-py/assets/7054676/ea9460a2-e351-4b73-9f82-7aef6cd20c33 onerror='this.onerror=null,this.src="/img/404.jpg"' alt=聊聊公益和助学></a><div class=content><a class=title href=/posts/2023/06/25/love-and-hope-is-all-we-need/ title=聊聊公益和助学>聊聊公益和助学</a><time datetime=2023-06-25T18:00:00.000Z title="Created 2023-06-26 02:00:00">2023-06-26</time></div></div><div class=aside-list-item><a class=thumbnail href=/posts/2023/06/19/why-do-I-love-ultraman/ title=为什么奥特曼是我的信仰><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://user-images.githubusercontent.com/7054676/228287041-c86e7928-0da8-4097-b7ff-e575faa8cf8c.png onerror='this.onerror=null,this.src="/img/404.jpg"' alt=为什么奥特曼是我的信仰></a><div class=content><a class=title href=/posts/2023/06/19/why-do-I-love-ultraman/ title=为什么奥特曼是我的信仰>为什么奥特曼是我的信仰</a><time datetime=2023-06-19T20:00:00.000Z title="Created 2023-06-20 04:00:00">2023-06-20</time></div></div></div></div><div class="card-widget ads-wrap"><ins class=adsbygoogle style=display:block data-ad-client=ca-pub-7962287588031867 data-ad-slot=1257383027 data-ad-format=auto data-full-width-responsive=true></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div></div></div></main><footer id=footer style="background:0 0"><div id=footer-wrap><div class=copyright>&copy;2020 - 2023 By Manjusaka</div><div class=framework-info><span>Framework </span><a target=_blank rel="noopener external nofollow noreferrer" href=https://hexo.io>Hexo</a><span class=footer-separator>|</span><span>Theme </span><a target=_blank rel="noopener external nofollow noreferrer" href=https://github.com/jerryc127/hexo-theme-butterfly>Butterfly</a></div></div></footer></div><div id=rightside><div id=rightside-config-hide><button id=readmode type=button title="Read Mode"><i class="fas fa-book-open"></i></button><button id=translateLink type=button title="Switch Between Traditional Chinese And Simplified Chinese">繁</button><button id=darkmode type=button title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id=hide-aside-btn type=button title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id=rightside-config-show><button id=rightside_config type=button title=Setting><i class="fas fa-cog fa-spin"></i></button><button class=close id=mobile-toc-button type=button title="Table Of Contents"><i class="fas fa-list-ul"></i></button><a id=to_comment href=#post-comment title="Scroll To Comments"><i class="fas fa-comments"></i></a><button id=go-up type=button title="Back To Top"><span class=scroll-percent></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src=https://www.manjusaka.blog/js/utils.js></script><script src=https://www.manjusaka.blog/js/main.js></script><script src=https://www.manjusaka.blog/js/tw_cn.js></script><script src=https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js></script><script src=https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js></script><script src=https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js></script><script>function panguFn(){"object"==typeof pangu?pangu.autoSpacingPage():getScript("https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js").then(()=>{pangu.autoSpacingPage()})}function panguInit(){panguFn()}document.addEventListener("DOMContentLoaded",panguInit)</script><div class=js-pjax><script>(()=>{const e=document.querySelectorAll("#article-container .mermaid-wrap");if(0!==e.length){const n=()=>{window.loadMermaid=!0;const r="dark"===document.documentElement.getAttribute("data-theme")?"dark":"default";Array.from(e).forEach((e,t)=>{const n=e.firstElementChild;e="%%{init:{ 'theme':'"+r+"'}}%%\n"+n.textContent;const d=mermaid.render("mermaid-"+t,e);"string"==typeof d?(t=d,n.insertAdjacentHTML("afterend",t)):d.then(({svg:e})=>{n.insertAdjacentHTML("afterend",e)})})};var t=()=>{window.loadMermaid?n():getScript("https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js").then(n)};btf.addModeChange("mermaid",n),window.pjax?t():document.addEventListener("DOMContentLoaded",t)}})()</script><script>function loadDisqus(){function t(){this.page.url="https://www.manjusaka.blog/posts/2020/05/22/a-simple-introduction-about-maglev/",this.page.identifier="/posts/2020/05/22/a-simple-introduction-about-maglev/",this.page.title="简单聊聊 Maglev ，来自 Google 的软负载均衡实践"}var e,a=()=>{DISQUS.reset({reload:!0,config:t})};btf.addModeChange("disqus",a),window.DISQUS?a():(a=document,(e=a.createElement("script")).src="https://manjusakablog.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(a.head||a.body).appendChild(e))}function loadOtherComment(){loadDisqus()}loadDisqus()</script></div><canvas class=fireworks mobile=false></canvas><script src=https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js></script><script defer=defer id=fluttering_ribbon mobile=false src=https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js></script><script src=https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!0,POWERMODE.mobile=!1,document.body.addEventListener("input",POWERMODE)</script><script async data-pjax src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><div id=algolia-search><div class=search-dialog><nav class=search-nav><span class=search-dialog-title>Search</span><button class=search-close-button><i class="fas fa-times"></i></button></nav><div class=search-wrap><div id=algolia-search-input></div><hr><div id=algolia-search-results><div id=algolia-hits></div><div id=algolia-pagination></div><div id=algolia-info><div class=algolia-stats></div><div class=algolia-poweredBy></div></div></div></div></div><div id=search-mask></div><script src=https://cdn.jsdelivr.net/npm/algoliasearch/dist/algoliasearch-lite.umd.min.js></script><script src=https://cdn.jsdelivr.net/npm/instantsearch.js/dist/instantsearch.production.min.js></script><script src=https://www.manjusaka.blog/js/search/algolia.js></script></div></div><script data-pjax>function butterfly_swiper_injector_config(){var s=document.getElementById("recent-posts");console.log("已挂载butterfly_swiper"),s.insertAdjacentHTML("afterbegin",'<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="/posts/2023/06/25/love-and-hope-is-all-we-need/" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://github.com/Zheaoli/yuque-py/assets/7054676/ea9460a2-e351-4b73-9f82-7aef6cd20c33" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-06-25</span><a class="blog-slider__title" href="/posts/2023/06/25/love-and-hope-is-all-we-need/" alt="">聊聊公益和助学</a><div class="blog-slider__text">很多时候，帮助人不需要那么多理由</div><a class="blog-slider__button" href="/posts/2023/06/25/love-and-hope-is-all-we-need/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="/posts/2023/06/19/why-do-I-love-ultraman/" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://user-images.githubusercontent.com/7054676/228287041-c86e7928-0da8-4097-b7ff-e575faa8cf8c.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-06-19</span><a class="blog-slider__title" href="/posts/2023/06/19/why-do-I-love-ultraman/" alt="">为什么奥特曼是我的信仰</a><div class="blog-slider__text">優しさを失わないでくれ。弱い者を労り互いに助け合い。</div><a class="blog-slider__button" href="/posts/2023/06/19/why-do-I-love-ultraman/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="/posts/2023/06/16/how-do-I-build-homelab/" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.pixabay.com/photo/2023/02/04/07/50/daisy-7766609_1280.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-06-16</span><a class="blog-slider__title" href="/posts/2023/06/16/how-do-I-build-homelab/" alt="">家庭 Homelab 升级计划</a><div class="blog-slider__text">人生嘛，Homelab 图个乐子</div><a class="blog-slider__button" href="/posts/2023/06/16/how-do-I-build-homelab/" alt="">详情   </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>')}for(var elist="undefined".split(","),cpage=location.pathname,epage="all",flag=0,i=0;i<elist.length;i++)cpage.includes(elist[i])&&flag++;("all"===epage&&0==flag||epage===cpage)&&butterfly_swiper_injector_config()</script><script defer=defer src=https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.js></script><script defer=defer data-pjax src=https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper_init.js></script><script async src=//at.alicdn.com/t/font_2032782_8d5kxvn09md.js></script><script src=/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05></script><script>L2Dwidget.init({log:!1,pluginJsPath:"lib/",pluginModelPath:"assets/",pluginRootPath:"live2dw/",tagMode:!1})</script></body></html>