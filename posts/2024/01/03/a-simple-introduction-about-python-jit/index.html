<!DOCTYPE html><html lang=en data-theme=auto><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><title>简单聊聊 Python 3.13 的 JIT 方案 | Manjusaka</title><meta name=author content=Manjusaka><meta name=copyright content=Manjusaka><meta name=format-detection content="telephone=no"><meta name=theme-color content=ffffff><meta name=description content="Python 3.13 的 JIT 方案最终确定了，我觉得可以说又新又好。所以深夜水一篇水文，来聊聊这个 JIT 方案 这篇文章可能会有些枯燥，所以如果对此不感兴趣的同学可以直接 x 掉"><meta property=og:type content=article><meta property=og:title content="简单聊聊 Python 3.13 的 JIT 方案"><meta property=og:url content=https://www.manjusaka.blog/posts/2024/01/03/a-simple-introduction-about-python-jit/index.html><meta property=og:site_name content=Manjusaka><meta property=og:description content="Python 3.13 的 JIT 方案最终确定了，我觉得可以说又新又好。所以深夜水一篇水文，来聊聊这个 JIT 方案 这篇文章可能会有些枯燥，所以如果对此不感兴趣的同学可以直接 x 掉"><meta property=og:locale content=en_US><meta property=og:image content=https://cdn.pixabay.com/photo/2023/02/04/07/50/flower-7766608_1280.jpg><meta property=article:published_time content=2024-01-03T18:30:00.000Z><meta property=article:modified_time content=2025-07-13T19:25:45.919Z><meta property=article:author content=Manjusaka><meta property=article:tag content=编程><meta property=article:tag content=Linux><meta property=article:tag content=Python><meta property=article:tag content=笔记><meta property=article:tag content=水文><meta name=twitter:card content=summary><meta name=twitter:image content="https://avatars.githubusercontent.com/u/7054676?v=4"><meta name=twitter:creator content=@Manjusaka_Lee><meta name=twitter:site content=https://twitter.com/Manjusaka_Lee><script type=application/ld+json>{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "简单聊聊 Python 3.13 的 JIT 方案",
  "url": "https://www.manjusaka.blog/posts/2024/01/03/a-simple-introduction-about-python-jit/",
  "image": "https://cdn.pixabay.com/photo/2023/02/04/07/50/flower-7766608_1280.jpg",
  "datePublished": "2024-01-03T18:30:00.000Z",
  "dateModified": "2025-07-13T19:25:45.919Z",
  "author": [
    {
      "@type": "Person",
      "name": "Manjusaka",
      "url": "https://github.com/Zheaoli"
    }
  ]
}</script><link rel="shortcut icon" href="https://avatars.githubusercontent.com/u/7054676?v=4"><link rel=canonical href=https://www.manjusaka.blog/posts/2024/01/03/a-simple-introduction-about-python-jit/index.html><link rel=preconnect href=//cdn.jsdelivr.net><link rel=preconnect href=//www.google-analytics.com crossorigin=""><link rel=preconnect href=//busuanzi.ibruce.info><link rel=stylesheet href=/css/index.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css media=print onload='this.media="all"'><script>(()=>{let t={set:(e,t,a)=>{a&&(a=Date.now()+864e5*a,localStorage.setItem(e,JSON.stringify({value:t,expiry:a})))},get:e=>{var t=localStorage.getItem(e);if(t){var{value:t,expiry:a}=JSON.parse(t);if(!(Date.now()>a))return t;localStorage.removeItem(e)}}},a=(window.btf={saveToLocal:t,getScript:(o,r={})=>new Promise((e,t)=>{let a=document.createElement("script");a.src=o,a.async=!0,Object.entries(r).forEach(([e,t])=>a.setAttribute(e,t)),a.onload=a.onreadystatechange=()=>{a.readyState&&!/loaded|complete/.test(a.readyState)||e()},a.onerror=t,document.head.appendChild(a)}),getCSS:(o,r)=>new Promise((e,t)=>{let a=document.createElement("link");a.rel="stylesheet",a.href=o,r&&(a.id=r),a.onload=a.onreadystatechange=()=>{a.readyState&&!/loaded|complete/.test(a.readyState)||e()},a.onerror=t,document.head.appendChild(a)}),addGlobalFn:(e,t,a=!1,o=window)=>{var r;e.startsWith("pjax")||((r=o.globalFn||{})[e]=r[e]||{},r[e][a||Object.keys(r[e]).length]=t,o.globalFn=r)}},()=>{document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")}),o=()=>{document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","ffffff")};btf.activateDarkMode=a,btf.activateLightMode=o;var r=t.get("theme"),n=window.matchMedia("(prefers-color-scheme: dark)"),d=window.matchMedia("(prefers-color-scheme: light)"),d=(void 0===r?((!d.matches&&(n.matches||(d=(new Date).getHours())<=6||18<=d)?a:o)(),n.addEventListener("change",()=>{void 0===t.get("theme")&&(e.matches?a:o)()})):("light"===r?o:a)(),t.get("aside-status"));void 0!==d&&document.documentElement.classList.toggle("hide-aside","hide"===d);/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})()</script><script async=async src="https://www.googletagmanager.com/gtag/js?id=UA-154407994-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-154407994-1"),btf.addGlobalFn("pjaxComplete",()=>{gtag("config","UA-154407994-1",{page_path:window.location.pathname})},"google_analytics")</script><script>let GLOBAL_CONFIG={root:"/",algolia:{appId:"DL1RURGHTB",indexName:"manjusaka.blog",hitsPerPage:6,languages:{input_placeholder:"Search",hits_empty:"No results found for: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localSearch:void 0,translate:{defaultEncoding:2,translateDelay:0,msgToTraditionalChinese:"繁",msgToSimplifiedChinese:"簡"},highlight:{plugin:"highlight.js",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:!1,highlightFullpage:!1,highlightMacStyle:!1},copy:{success:"Copy Successful",error:"Copy Failed",noSupport:"Browser Not Supported"},relativeDate:{homepage:!0,post:!0},runtime:"",dateSuffix:{just:"Just now",min:"minutes ago",hour:"hours ago",day:"days ago",month:"months ago"},copyright:{limitCount:100,languages:{author:"Author: Manjusaka",link:"Link: ",source:"Source: Manjusaka",info:"Copyright belongs to the author. For commercial use, please contact the author for authorization. For non-commercial use, please indicate the source."}},lightbox:"null",Snackbar:{chs_to_cht:"You have switched to Traditional Chinese",cht_to_chs:"You have switched to Simplified Chinese",day_to_night:"You have switched to Dark Mode",night_to_day:"You have switched to Light Mode",bgLight:"#59C173",bgDark:"#1f1f1f",position:"bottom-left"},infinitegrid:{js:"https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js",buttonText:"Load More"},isPhotoFigcaption:!0,islazyloadPlugin:!0,isAnchor:!0,percent:{toc:!0,rightside:!0},autoDarkmode:!0}</script><script id=config-diff>var GLOBAL_CONFIG_SITE={title:"简单聊聊 Python 3.13 的 JIT 方案",isHighlightShrink:!1,isToc:!0,pageType:"post"}</script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/hexo-butterfly-swiper@1.0.12/lib/swiper.min.css media=print onload='this.media="all"'><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/hexo-butterfly-swiper@1.0.12/lib/swiperstyle.css media=print onload='this.media="all"'><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/hexo-butterfly-tag-plugins-plus@1.0.18/lib/assets/font-awesome-animation.min.css media=defer onload='this.media="all"'><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/hexo-butterfly-tag-plugins-plus@1.0.18/lib/tag_plugins.css media=defer onload='this.media="all"'><script src=https://cdn.jsdelivr.net/npm/hexo-butterfly-tag-plugins-plus@1.0.18/lib/assets/carousel-touch.js></script><meta name=generator content="Hexo 7.3.0"><link rel=alternate href=/atom.xml title=Manjusaka type=application/atom+xml></head><body><div id=loading-box><div class=loading-left-bg></div><div class=loading-right-bg></div><div class=spinner-box><div class=configure-border-1><div class=configure-core></div></div><div class=configure-border-2><div class=configure-core></div></div><div class=loading-word>Loading...</div></div></div><script>(()=>{let e=document.getElementById("loading-box"),d=document.body;const o=()=>{d.style.overflow="",e.classList.add("loaded")},l=()=>{d.style.overflow="hidden",e.classList.remove("loaded")};l(),window.addEventListener("load",o)})()</script><div id=web_bg style="background-image:url('url(https://cdn.jsdelivr.net/gh/youngjuning/images@main/1680450445599.png)')"></div><div id=sidebar><div id=menu-mask></div><div id=sidebar-menus><div class="avatar-img text-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://avatars.githubusercontent.com/u/7054676?v=4" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt=avatar></div><div class="site-data text-center"><a href=/archives/ ><div class=headline>Articles</div><div class=length-num>104</div></a><a href=/tags/ ><div class=headline>Tags</div><div class=length-num>60</div></a><a href=/categories/ ><div class=headline>Categories</div><div class=length-num>41</div></a></div><div class=menus_items><div class=menus_item><a class=site-page href=/ ><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class=menus_item><span class="site-page group"><i class="fa-fw fa-fw fas fa-lines-leaning"></i><span> 文章</span><i class="fas fa-chevron-down"></i></span><ul class=menus_item_child><li><a class="site-page child" href=/categories/ ><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href=/tags/ ><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href=/archives/ ><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href=/random/ ><i class="fa-fw fas fa-random"></i><span> 随便逛逛</span></a></li></ul></div><div class=menus_item><a class=site-page href=/weekly/ ><i class="fa-fw fas fa-newspaper"></i><span> 周报</span></a></div><div class=menus_item><a class=site-page href=/leetcode/ ><i class="fa-fw fas fa-newspaper"></i><span> 刷题</span></a></div><div class=menus_item><span class="site-page group"><i class="fa-fw fas fa-heart"></i><span> 我的</span><i class="fas fa-chevron-down"></i></span><ul class=menus_item_child><li><a class="site-page child" href=/about/ ><i class="fa-fw fas fa-spa"></i><span> 关于</span></a></li><li><a class="site-page child" href=/weekly/ ><i class="fa-fw fas fa-newspaper"></i><span> 周报</span></a></li></ul></div></div></div></div><div class="post type-tags" id=body-wrap><header class=post-bg id=page-header style=background-image:url(https://cdn.pixabay.com/photo/2023/02/04/07/50/flower-7766608_1280.jpg)><nav id=nav><span id=blog-info><a class=nav-site-title href=/ ><img class=site-icon src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://avatars.githubusercontent.com/u/7054676?v=4# image" alt=Logo><span class=site-name>Manjusaka</span></a><a class=nav-page-title href=/ ><span class=site-name>简单聊聊 Python 3.13 的 JIT 方案</span></a></span><div id=menus><div id=search-button><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></span></div><div class=menus_items><div class=menus_item><a class=site-page href=/ ><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class=menus_item><span class="site-page group"><i class="fa-fw fa-fw fas fa-lines-leaning"></i><span> 文章</span><i class="fas fa-chevron-down"></i></span><ul class=menus_item_child><li><a class="site-page child" href=/categories/ ><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href=/tags/ ><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href=/archives/ ><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href=/random/ ><i class="fa-fw fas fa-random"></i><span> 随便逛逛</span></a></li></ul></div><div class=menus_item><a class=site-page href=/weekly/ ><i class="fa-fw fas fa-newspaper"></i><span> 周报</span></a></div><div class=menus_item><a class=site-page href=/leetcode/ ><i class="fa-fw fas fa-newspaper"></i><span> 刷题</span></a></div><div class=menus_item><span class="site-page group"><i class="fa-fw fas fa-heart"></i><span> 我的</span><i class="fas fa-chevron-down"></i></span><ul class=menus_item_child><li><a class="site-page child" href=/about/ ><i class="fa-fw fas fa-spa"></i><span> 关于</span></a></li><li><a class="site-page child" href=/weekly/ ><i class="fa-fw fas fa-newspaper"></i><span> 周报</span></a></li></ul></div></div><div id=toggle-menu><span class=site-page><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id=post-info><h1 class=post-title>简单聊聊 Python 3.13 的 JIT 方案<a class=post-edit-link href=https://github.com/Zheaoli/Zheaoli.github.io/edit/main/source/_posts/a-simple-introduction-about-python-jit.md rel="external nofollow noreferrer" title=Edit target=_blank><i class="fas fa-pencil-alt"></i></a></h1><div id=post-meta><div class=meta-firstline><span class=post-meta-date><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class=post-meta-label>Created</span><time datetime=2024-01-03T18:30:00.000Z title="Created 2024-01-04 02:30:00">2024-01-04</time></span><span class=post-meta-categories><span class=post-meta-separator>|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class=post-meta-categories href=/categories/%E7%BC%96%E7%A8%8B/ >编程</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class=post-meta-categories href=/categories/%E7%BC%96%E7%A8%8B/Python/ >Python</a></span></div><div class=meta-secondline><span class=post-meta-separator>|</span><span class=post-meta-wordcount><i class="far fa-file-word fa-fw post-meta-icon"></i><span class=post-meta-label>Word Count:</span><span class=word-count>5.1k</span><span class=post-meta-separator>|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class=post-meta-label>Reading Time:</span><span>25mins</span></span><span class=post-meta-separator>|</span><span class=post-meta-pv-cv id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class=post-meta-label>Post Views:</span><span id=busuanzi_value_page_pv><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class=layout id=content-inner><div id=post><article class="container post-content" id=article-container><div id=post-outdate-notice data="{&quot;limitDay&quot;:365,&quot;messagePrev&quot;:&quot;It has been&quot;,&quot;messageNext&quot;:&quot;days since the last update, the content of the article may be outdated.&quot;,&quot;postUpdate&quot;:&quot;2025-07-14 03:25:45&quot;}" hidden></div><p>Python 3.13 的 JIT 方案最终确定了，我觉得可以说又新又好。所以深夜水一篇水文，来聊聊这个 JIT 方案</p><p>这篇文章可能会有些枯燥，所以如果对此不感兴趣的同学可以直接 x 掉</p><span id=more></span><h2 id=基础知识><a href=#基础知识 class=headerlink title=基础知识></a>基础知识</h2><p>在聊 Python 3.13 具体的实现之前，我们需要来了解下它所采用的 JIT 方案的基础知识</p><p>JIT 本身的定义我相信阅读这篇文章的同学已经非常了解了，所以此处不再赘述。JIT 核心分为两大块</p><ol><li>代码的 profile，以确定热点路径，尽可能的减少 JIT 的 fallback</li><li>汇编代码的生成</li></ol><p>本文主要会聊代码的生成部分</p><p>在此之前，Python 生态里一个 JIT 的实现，Pyston/Pypy，他们所采取的方案其实是和 LuaJIT 的方式类似，开发者手写汇编来完成代码的特化，然后依赖 DynASM 执行相关的代码</p><p>这种方式主要的缺陷在于</p><ol><li>手写汇编带来的心智负担</li><li>对于平台的兼容性</li></ol><p>为了给大家一个直观的感受，我给出一个我之前写过的汇编的例子来作为演示</p><p>首先，我需要实现的功能很简单，用 C 来描述应该是这样的</p><figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre></td><td class=code><pre><span class=line><span class=type>int</span> <span class="title function_">main</span><span class=params>(<span class=type>int</span> argc, <span class=type>char</span> *argv[], <span class=type>char</span> * envp[])</span> &#123;</span><br><span class=line>    <span class=keyword>if</span> (argv &gt; <span class=number>0</span>) &#123;</span><br><span class=line>        <span class=keyword>return</span> execve(args[<span class=number>0</span>], args, envp);</span><br><span class=line>    &#125;</span><br><span class=line>    <span class=keyword>return</span> <span class=number>0</span>;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>因为一些尺寸极端敏感的场景，这份 C 代码没有办法直接 link libc，为了尽可能的压缩 binary size，我选择用汇编实现，以下是 X86_64 的 ASM</p><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br></pre></td><td class=code><pre><span class=line>.global _start</span><br><span class=line></span><br><span class=line>.section .text</span><br><span class=line>_start:</span><br><span class=line>    # Setup stack frame</span><br><span class=line>    movq %rsp, %rbp</span><br><span class=line></span><br><span class=line>    # Load argc</span><br><span class=line>    movq (%rbp), %r8       # %r8 now holds argc</span><br><span class=line></span><br><span class=line>    # Load argv</span><br><span class=line>    leaq 8(%rbp), %r9      # %r9 now points to argv[0]</span><br><span class=line></span><br><span class=line>    # Find envp by iterating through argv until NULL is found</span><br><span class=line>    movq %r9, %r10         # %r10 will be used to find envp</span><br><span class=line>find_envp:</span><br><span class=line>    movq (%r10), %rdi      # Load the current pointer in argv</span><br><span class=line>    cmpq $0, %rdi          # Compare it to NULL</span><br><span class=line>    je envp_found          # If NULL, we&#x27;ve found the end of argv</span><br><span class=line>    addq $8, %r10          # Otherwise, move to the next pointer in argv</span><br><span class=line>    jmp find_envp</span><br><span class=line></span><br><span class=line>envp_found:</span><br><span class=line>    addq $8, %r10          # Move one more step to point to the start of envp</span><br><span class=line></span><br><span class=line>    # Allocate space on the stack for the new argv array</span><br><span class=line>    subq $8, %rsp          # Space for NULL termination</span><br><span class=line>    subq %r8, %rsp</span><br><span class=line>    subq %r8, %rsp         # Space for argc pointers (including argv[0])</span><br><span class=line>    movq %rsp, %r11        # %r11 now points to the start of the new argv array</span><br><span class=line></span><br><span class=line>    # Copy argv pointers to the new array</span><br><span class=line>    movq $0, %rcx          # Counter</span><br><span class=line>copy_loop:</span><br><span class=line>    cmpq %rcx, %r8</span><br><span class=line>    je copy_done</span><br><span class=line>    movq (%r9, %rcx, 8), %rdi</span><br><span class=line>    movq %rdi, (%r11, %rcx, 8)</span><br><span class=line>    incq %rcx</span><br><span class=line>    jmp copy_loop</span><br><span class=line></span><br><span class=line>copy_done:</span><br><span class=line>    movq $0, (%r11, %rcx, 8)   # NULL-terminate the new argv array</span><br><span class=line></span><br><span class=line>    # Check if argc &gt; 0</span><br><span class=line>    cmpq $0, %r8</span><br><span class=line>    jle .Lexit</span><br><span class=line></span><br><span class=line>    # Execute execve syscall</span><br><span class=line>    movq $59, %rax          # syscall number for execve</span><br><span class=line>    movq (%r11), %rdi        # filename is argv[0]</span><br><span class=line>    movq %r11, %rsi         # New argv array</span><br><span class=line>    movq %r10, %rdx         # envp</span><br><span class=line>    syscall</span><br><span class=line></span><br><span class=line>.Lexit:</span><br><span class=line>    # Exit the program using the exit syscall</span><br><span class=line>    movq $60, %rax</span><br><span class=line>    xorq %rdi, %rdi</span><br><span class=line>    syscall</span><br></pre></td></tr></table></figure><p>同时，因为这个功能需要跨平台实现，所以我们需要同时实现 ARM64 的版本，以下是 ARM64 的 ASM</p><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br></pre></td><td class=code><pre><span class=line>.global _start</span><br><span class=line></span><br><span class=line>.section .text</span><br><span class=line>_start:</span><br><span class=line>    # Setup stack frame</span><br><span class=line>    mov x29, sp</span><br><span class=line></span><br><span class=line>    # Load argc</span><br><span class=line>    ldr x8, [x29]        # x8 now holds argc</span><br><span class=line></span><br><span class=line>    # Load argv</span><br><span class=line>    add x9, x29, #8      # x9 now points to argv[0]</span><br><span class=line></span><br><span class=line>    # Find envp by iterating through argv until NULL is found</span><br><span class=line>    mov x10, x9          # x10 will be used to find envp</span><br><span class=line>find_envp:</span><br><span class=line>    ldr x19, [x10]       # Load the current pointer in argv</span><br><span class=line>    cbz x19, envp_found  # If NULL, we&#x27;ve found the end of argv</span><br><span class=line>    add x10, x10, #8     # Otherwise, move to the next pointer in argv</span><br><span class=line>    b find_envp</span><br><span class=line></span><br><span class=line>envp_found:</span><br><span class=line>    add x10, x10, #8     # Move one more step to point to the start of envp</span><br><span class=line></span><br><span class=line>    # Allocate space on the stack for the new argv array</span><br><span class=line>    sub sp, sp, #8       # Space for NULL termination</span><br><span class=line>    sub sp, sp, x8, lsl #3</span><br><span class=line>    sub sp, sp, x8, lsl #3      # Space for argc pointers (including argv[0])</span><br><span class=line>    mov x11, sp          # x11 now points to the start of the new argv array</span><br><span class=line></span><br><span class=line>    # Copy argv pointers to the new array</span><br><span class=line>    mov x12, #0          # Counter</span><br><span class=line>copy_loop:</span><br><span class=line>    cmp x12, x8</span><br><span class=line>    b.eq copy_done</span><br><span class=line>    ldr x19, [x9, x12, lsl #3]</span><br><span class=line>    str x19, [x11, x12, lsl #3]</span><br><span class=line>    add x12, x12, #1</span><br><span class=line>    b copy_loop</span><br><span class=line></span><br><span class=line>copy_done:</span><br><span class=line>    mov x19, #0</span><br><span class=line>    str x19, [x11, x12, lsl #3]   # NULL-terminate the new argv array</span><br><span class=line></span><br><span class=line>    # Check if argc &gt; 0</span><br><span class=line>    cmp x8, #0</span><br><span class=line>    b.le .Lexit</span><br><span class=line></span><br><span class=line>    # Execute execve syscall</span><br><span class=line>    mov x8, #221         # syscall number for execve</span><br><span class=line>    ldr x0, [x11]        # filename is argv[0]</span><br><span class=line>    mov x1, x11          # New argv array</span><br><span class=line>    mov x2, x10          # envp</span><br><span class=line>    svc #0</span><br><span class=line></span><br><span class=line>.Lexit:</span><br><span class=line>    # Exit the program using the exit syscall</span><br><span class=line>    mov x8, #93</span><br><span class=line>    mov x0, #0</span><br><span class=line>    svc #0</span><br></pre></td></tr></table></figure><p>你能发现，X86_64 的寄存器和 ARM 生态完全不一样，这就导致了我们需要为不同的平台写不同的汇编代码，你再考虑下我们需要</p><ol><li>MIPS</li><li>RISC-V</li><li>PowerPC</li><li>…</li></ol><p>即便 DynASM 已经对跨平台做了一些抽象，但是直接手写汇编所带来的心智负担还是非常大的</p><p>所以，我们需要更现代化的方案，这就是今天要聊到 Copy And Patch。其核心在于利用已有编译器生成的汇编代码，然后对其进行 patch，来完成代码的特化</p><p>我们一点点来了解这个方案，首先我们从最基础的一个代码入手</p><p>假设我们现在有一个最基础的 C 代码</p><figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre></td><td class=code><pre><span class=line><span class=type>int</span> <span class="title function_">add</span><span class=params>(<span class=type>int</span> a, <span class=type>int</span> b)</span> &#123;</span><br><span class=line>    <span class=keyword>return</span> a + b;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>这个代码没有任何问题，我们可以直接用 gcc 来编译它，然后反汇编，看看它的汇编代码是什么样的</p><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br></pre></td><td class=code><pre><span class=line>0000000000000000 &lt;add&gt;:</span><br><span class=line>       0: 55                            pushq   %rbp</span><br><span class=line>       1: 48 89 e5                      movq    %rsp, %rbp</span><br><span class=line>       4: 89 7d fc                      movl    %edi, -0x4(%rbp)</span><br><span class=line>       7: 89 75 f8                      movl    %esi, -0x8(%rbp)</span><br><span class=line>       a: 8b 55 fc                      movl    -0x4(%rbp), %edx</span><br><span class=line>       d: 8b 45 f8                      movl    -0x8(%rbp), %eax</span><br><span class=line>      10: 01 d0                         addl    %edx, %eax</span><br><span class=line>      12: 5d                            popq    %rbp</span><br><span class=line>      13: c3                            retq</span><br></pre></td></tr></table></figure><p>最基础的汇编代码，没有问题。</p><p>那么我们现在有这样一个场景，我们提供两个函数</p><ol><li>load_left</li><li>load_right</li></ol><p>这个两个函数将用于加载我们左右两个操作数，然后我们的代码变成下面这样</p><figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre></td><td class=code><pre><span class=line><span class=type>int</span> <span class="title function_">load_left</span><span class=params>()</span>;</span><br><span class=line><span class=type>int</span> <span class="title function_">load_right</span><span class=params>()</span>;</span><br><span class=line><span class=type>int</span> <span class="title function_">add</span><span class=params>()</span> &#123;</span><br><span class=line>    <span class=keyword>return</span> load_left() + load_right();</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>我们开垦一下汇编</p><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br></pre></td><td class=code><pre><span class=line>0000000000000000 &lt;add&gt;:</span><br><span class=line>       0: 55                            pushq   %rbp</span><br><span class=line>       1: 48 89 e5                      movq    %rsp, %rbp</span><br><span class=line>       4: 53                            pushq   %rbx</span><br><span class=line>       5: 48 83 ec 08                   subq    $0x8, %rsp</span><br><span class=line>       9: b8 00 00 00 00                movl    $0x0, %eax</span><br><span class=line>       e: e8 00 00 00 00                callq   0x13 &lt;add+0x13&gt;</span><br><span class=line>                000000000000000f:  R_X86_64_PLT32       load_left-0x4</span><br><span class=line>      13: 89 c3                         movl    %eax, %ebx</span><br><span class=line>      15: b8 00 00 00 00                movl    $0x0, %eax</span><br><span class=line>      1a: e8 00 00 00 00                callq   0x1f &lt;add+0x1f&gt;</span><br><span class=line>                000000000000001b:  R_X86_64_PLT32       load_right-0x4</span><br><span class=line>      1f: 01 d8                         addl    %ebx, %eax</span><br><span class=line>      21: 48 8b 5d f8                   movq    -0x8(%rbp), %rbx</span><br><span class=line>      25: c9                            leave</span><br><span class=line>      26: c3                            retq</span><br></pre></td></tr></table></figure><p>我们关注到，汇编中有这样两行奇怪的东西</p><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre></td><td class=code><pre><span class=line> e: e8 00 00 00 00                callq   0x13 &lt;add+0x13&gt;</span><br><span class=line>          000000000000000f:  R_X86_64_PLT32       load_left-0x4</span><br><span class=line>1a: e8 00 00 00 00                callq   0x1f &lt;add+0x1f&gt;</span><br><span class=line>          000000000000001b:  R_X86_64_PLT32       load_right-0x4</span><br></pre></td></tr></table></figure><p>Bingo，熟悉一些基础的程序知识同学应该反应过来了，<code>e8</code> 指令（即 x86 下的 callq 指令）后面的 <code>00 00 00 00</code> 地址，将会在执行时，被 reloc 成为 <code>load_left</code> 和 <code>load_right</code> 的地址。</p><p>那么可能有些同学已经反应过来了，如果我们有办法将这段汇编代码中的 <code>e8 00 00 00 00</code> 替换成 <code>e8 xx xx xx xx</code>，那么我们就可以在这里 patch 上我们的代码了。这里是不是可以作为我们 JIT 的入口了呢？</p><p>当然，这里有一个问题，<code>e8</code> 后面的指令地址应该怎么样确定呢？</p><p>这里我们可以注意到，程序中有这样的部分 <code>000000000000000f: R_X86_64_PLT32 load_left-0x4</code>， 这个是一个 ELF 的 Relocation Entry，它的作用是告诉我们，<code>e8</code> 后面的地址，应该是 <code>load_left</code> 的地址，同时，我们也能知道重定向部分的起始 <code>0x0f</code>.</p><p>同样的类型还有很多，比如 <code>R_X86_64_PC32</code>，<code>R_X86_64_GOTPCREL</code> 等等，这些类型的 Relocation Entry 都可以帮助我们定位到我们需要 patch 的地址，以及帮助我们计算偏移</p><p>再举个例子</p><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre></td><td class=code><pre><span class=line>// 17f: 48 bf 00 00 00 00 00 00 00 00 movabsq $0x0, %rdi</span><br><span class=line>// 0000000000000181:  R_X86_64_64  .rodata.str1.1</span><br><span class=line>// 189: 48 be 00 00 00 00 00 00 00 00 movabsq $0x0, %rsi</span><br><span class=line>// 000000000000018b:  R_X86_64_64  .rodata.str1.1+0x16</span><br></pre></td></tr></table></figure><p>这里我们可以看到，<code>48 bf 00 00 00 00 00 00 00 00</code> 和 <code>48 be 00 00 00 00 00 00 00 00</code> 后面都有一个 <code>R_X86_64_64</code> 的 Relocation Entry，这个 Relocation Entry 告诉我们，这两个指令后面的地址，应该是 <code>.rodata.str1.1</code> 的地址，同时，我们也能知道重定向部分的起始 <code>0x181</code> 和 <code>0x18b</code>，这样我们就可以计算出偏移，然后 patch 上我们的代码了</p><p>那么这就是整个 copy and patch 的大概过程，我们可以利用编译器生成的汇编代码，然后通过 Relocation Entry 来定位我们需要 patch 的地址，然后 patch 上我们的代码。最终尽可能的简化我们的心智负担</p><h2 id=Python-3-13-的-JIT><a href=#Python-3-13-的-JIT class=headerlink title="Python 3.13 的 JIT"></a>Python 3.13 的 JIT</h2><p>Python 3.13 目前的 JIT 方案已经确定下来了，它的核心就是 Copy And Patch，现在我们整体来看一下</p><p>首先，Python 有一个 <code>Python/executor_cases.h</code> 文件，囊括了我们所有的字节码和对应的操作</p><p>比如</p><figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br></pre></td><td class=code><pre><span class=line><span class=keyword>case</span> _BINARY_OP_ADD_INT: &#123;</span><br><span class=line>    PyObject *right;</span><br><span class=line>    PyObject *left;</span><br><span class=line>    PyObject *res;</span><br><span class=line>    right = stack_pointer[<span class=number>-1</span>];</span><br><span class=line>    left = stack_pointer[<span class=number>-2</span>];</span><br><span class=line>    STAT_INC(BINARY_OP, hit);</span><br><span class=line>    res = _PyLong_Add((PyLongObject *)left, (PyLongObject *)right);</span><br><span class=line>    _Py_DECREF_SPECIALIZED(right, (destructor)PyObject_Free);</span><br><span class=line>    _Py_DECREF_SPECIALIZED(left, (destructor)PyObject_Free);</span><br><span class=line>    <span class=keyword>if</span> (res == <span class=literal>NULL</span>) <span class=keyword>goto</span> pop_2_error_tier_two;</span><br><span class=line>    stack_pointer[<span class=number>-2</span>] = res;</span><br><span class=line>    stack_pointer += <span class=number>-1</span>;</span><br><span class=line>    <span class=keyword>break</span>;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>然后我们新增加了一个 <code>tools/template.c</code> 文件，</p><figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br><span class=line>65</span><br><span class=line>66</span><br><span class=line>67</span><br><span class=line>68</span><br><span class=line>69</span><br><span class=line>70</span><br><span class=line>71</span><br><span class=line>72</span><br><span class=line>73</span><br><span class=line>74</span><br><span class=line>75</span><br><span class=line>76</span><br><span class=line>77</span><br><span class=line>78</span><br><span class=line>79</span><br><span class=line>80</span><br><span class=line>81</span><br><span class=line>82</span><br><span class=line>83</span><br><span class=line>84</span><br><span class=line>85</span><br><span class=line>86</span><br><span class=line>87</span><br><span class=line>88</span><br><span class=line>89</span><br><span class=line>90</span><br><span class=line>91</span><br><span class=line>92</span><br><span class=line>93</span><br><span class=line>94</span><br><span class=line>95</span><br><span class=line>96</span><br><span class=line>97</span><br><span class=line>98</span><br></pre></td><td class=code><pre><span class=line><span class=meta>#<span class=keyword>include</span> <span class=string>&quot;Python.h&quot;</span></span></span><br><span class=line></span><br><span class=line><span class=meta>#<span class=keyword>include</span> <span class=string>&quot;pycore_call.h&quot;</span></span></span><br><span class=line><span class=meta>#<span class=keyword>include</span> <span class=string>&quot;pycore_ceval.h&quot;</span></span></span><br><span class=line><span class=meta>#<span class=keyword>include</span> <span class=string>&quot;pycore_dict.h&quot;</span></span></span><br><span class=line><span class=meta>#<span class=keyword>include</span> <span class=string>&quot;pycore_emscripten_signal.h&quot;</span></span></span><br><span class=line><span class=meta>#<span class=keyword>include</span> <span class=string>&quot;pycore_intrinsics.h&quot;</span></span></span><br><span class=line><span class=meta>#<span class=keyword>include</span> <span class=string>&quot;pycore_jit.h&quot;</span></span></span><br><span class=line><span class=meta>#<span class=keyword>include</span> <span class=string>&quot;pycore_long.h&quot;</span></span></span><br><span class=line><span class=meta>#<span class=keyword>include</span> <span class=string>&quot;pycore_opcode_metadata.h&quot;</span></span></span><br><span class=line><span class=meta>#<span class=keyword>include</span> <span class=string>&quot;pycore_opcode_utils.h&quot;</span></span></span><br><span class=line><span class=meta>#<span class=keyword>include</span> <span class=string>&quot;pycore_range.h&quot;</span></span></span><br><span class=line><span class=meta>#<span class=keyword>include</span> <span class=string>&quot;pycore_setobject.h&quot;</span></span></span><br><span class=line><span class=meta>#<span class=keyword>include</span> <span class=string>&quot;pycore_sliceobject.h&quot;</span></span></span><br><span class=line></span><br><span class=line><span class=meta>#<span class=keyword>include</span> <span class=string>&quot;ceval_macros.h&quot;</span></span></span><br><span class=line></span><br><span class=line><span class=meta>#<span class=keyword>undef</span> CURRENT_OPARG</span></span><br><span class=line><span class=meta>#<span class=keyword>define</span> CURRENT_OPARG() (_oparg)</span></span><br><span class=line></span><br><span class=line><span class=meta>#<span class=keyword>undef</span> CURRENT_OPERAND</span></span><br><span class=line><span class=meta>#<span class=keyword>define</span> CURRENT_OPERAND() (_operand)</span></span><br><span class=line></span><br><span class=line><span class=meta>#<span class=keyword>undef</span> DEOPT_IF</span></span><br><span class=line><span class=meta>#<span class=keyword>define</span> DEOPT_IF(COND, INSTNAME) \</span></span><br><span class=line><span class=meta>    do &#123;                         \</span></span><br><span class=line><span class=meta>        <span class=keyword>if</span> ((COND)) &#123;            \</span></span><br><span class=line><span class=meta>            goto deoptimize;     \</span></span><br><span class=line><span class=meta>        &#125;                        \</span></span><br><span class=line><span class=meta>    &#125; while (0)</span></span><br><span class=line></span><br><span class=line><span class=meta>#<span class=keyword>undef</span> ENABLE_SPECIALIZATION</span></span><br><span class=line><span class=meta>#<span class=keyword>define</span> ENABLE_SPECIALIZATION (0)</span></span><br><span class=line></span><br><span class=line><span class=meta>#<span class=keyword>undef</span> GOTO_ERROR</span></span><br><span class=line><span class=meta>#<span class=keyword>define</span> GOTO_ERROR(LABEL)        \</span></span><br><span class=line><span class=meta>    do &#123;                         \</span></span><br><span class=line><span class=meta>        goto LABEL ## _tier_two; \</span></span><br><span class=line><span class=meta>    &#125; while (0)</span></span><br><span class=line></span><br><span class=line><span class=meta>#<span class=keyword>undef</span> LOAD_IP</span></span><br><span class=line><span class=meta>#<span class=keyword>define</span> LOAD_IP(UNUSED) \</span></span><br><span class=line><span class=meta>    do &#123;                \</span></span><br><span class=line><span class=meta>    &#125; while (0)</span></span><br><span class=line></span><br><span class=line><span class=meta>#<span class=keyword>define</span> PATCH_VALUE(TYPE, NAME, ALIAS)  \</span></span><br><span class=line><span class=meta>    extern void ALIAS;                  \</span></span><br><span class=line><span class=meta>    TYPE NAME = (TYPE)(uint64_t)&amp;ALIAS;</span></span><br><span class=line></span><br><span class=line><span class=meta>#<span class=keyword>define</span> PATCH_JUMP(ALIAS)                                    \</span></span><br><span class=line><span class=meta>    extern void ALIAS;                                       \</span></span><br><span class=line><span class=meta>    __attribute__((musttail))                                \</span></span><br><span class=line><span class=meta>    return ((jit_func)&amp;ALIAS)(frame, stack_pointer, tstate);</span></span><br><span class=line></span><br><span class=line>_Py_CODEUNIT *</span><br><span class=line>_JIT_ENTRY(_PyInterpreterFrame *frame, PyObject **stack_pointer, PyThreadState *tstate)</span><br><span class=line>&#123;</span><br><span class=line>    <span class=comment>// Locals that the instruction implementations expect to exist:</span></span><br><span class=line>    PATCH_VALUE(_PyUOpExecutorObject *, current_executor, _JIT_EXECUTOR)</span><br><span class=line>    <span class=type>int</span> oparg;</span><br><span class=line>    <span class=type>int</span> opcode = _JIT_OPCODE;</span><br><span class=line>    _PyUOpInstruction *next_uop;</span><br><span class=line>    <span class=comment>// Other stuff we need handy:</span></span><br><span class=line>    PATCH_VALUE(<span class=type>uint16_t</span>, _oparg, _JIT_OPARG)</span><br><span class=line>    PATCH_VALUE(<span class=type>uint64_t</span>, _operand, _JIT_OPERAND)</span><br><span class=line>    PATCH_VALUE(<span class=type>uint32_t</span>, _target, _JIT_TARGET)</span><br><span class=line>    <span class=comment>// The actual instruction definitions (only one will be used):</span></span><br><span class=line>    <span class=keyword>if</span> (opcode == _JUMP_TO_TOP) &#123;</span><br><span class=line>        CHECK_EVAL_BREAKER();</span><br><span class=line>        PATCH_JUMP(_JIT_TOP);</span><br><span class=line>    &#125;</span><br><span class=line>    <span class=keyword>switch</span> (opcode) &#123;</span><br><span class=line><span class=meta>#<span class=keyword>include</span> <span class=string>&quot;executor_cases.c.h&quot;</span></span></span><br><span class=line>        <span class=keyword>default</span>:</span><br><span class=line>            Py_UNREACHABLE();</span><br><span class=line>    &#125;</span><br><span class=line>    PATCH_JUMP(_JIT_CONTINUE);</span><br><span class=line>    <span class=comment>// Labels that the instruction implementations expect to exist:</span></span><br><span class=line>unbound_local_error_tier_two:</span><br><span class=line>    _PyEval_FormatExcCheckArg(</span><br><span class=line>        tstate, PyExc_UnboundLocalError, UNBOUNDLOCAL_ERROR_MSG,</span><br><span class=line>        PyTuple_GetItem(_PyFrame_GetCode(frame)-&gt;co_localsplusnames, oparg));</span><br><span class=line>    <span class=keyword>goto</span> error_tier_two;</span><br><span class=line>pop_4_error_tier_two:</span><br><span class=line>    STACK_SHRINK(<span class=number>1</span>);</span><br><span class=line>pop_3_error_tier_two:</span><br><span class=line>    STACK_SHRINK(<span class=number>1</span>);</span><br><span class=line>pop_2_error_tier_two:</span><br><span class=line>    STACK_SHRINK(<span class=number>1</span>);</span><br><span class=line>pop_1_error_tier_two:</span><br><span class=line>    STACK_SHRINK(<span class=number>1</span>);</span><br><span class=line>error_tier_two:</span><br><span class=line>    _PyFrame_SetStackPointer(frame, stack_pointer);</span><br><span class=line>    <span class=keyword>return</span> <span class=literal>NULL</span>;</span><br><span class=line>deoptimize:</span><br><span class=line>    _PyFrame_SetStackPointer(frame, stack_pointer);</span><br><span class=line>    <span class=keyword>return</span> _PyCode_CODE(_PyFrame_GetCode(frame)) + _target;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>其中，_JIT_OPCODE，由编译时传入，作为当前的 opcode，因为这是一个固定值，所以编译器在编译的时候，会 strip 掉其余的分支，只保留当前 opcode 的分支，某种意义上，核心的 switch 部分就编程这样了（以 _BINARY_OP_ADD_INT 为例）</p><figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br></pre></td><td class=code><pre><span class=line><span class=keyword>switch</span>(_BINARY_OP_ADD_INT) &#123;</span><br><span class=line>    <span class=keyword>case</span> _BINARY_OP_ADD_INT: &#123;</span><br><span class=line>        PyObject *right;</span><br><span class=line>        PyObject *left;</span><br><span class=line>        PyObject *res;</span><br><span class=line>        right = stack_pointer[<span class=number>-1</span>];</span><br><span class=line>        left = stack_pointer[<span class=number>-2</span>];</span><br><span class=line>        STAT_INC(BINARY_OP, hit);</span><br><span class=line>        res = _PyLong_Add((PyLongObject *)left, (PyLongObject *)right);</span><br><span class=line>        _Py_DECREF_SPECIALIZED(right, (destructor)PyObject_Free);</span><br><span class=line>        _Py_DECREF_SPECIALIZED(left, (destructor)PyObject_Free);</span><br><span class=line>        <span class=keyword>if</span> (res == <span class=literal>NULL</span>) <span class=keyword>goto</span> pop_2_error_tier_two;</span><br><span class=line>        stack_pointer[<span class=number>-2</span>] = res;</span><br><span class=line>        stack_pointer += <span class=number>-1</span>;</span><br><span class=line>        <span class=keyword>break</span>;</span><br><span class=line>    &#125;</span><br><span class=line>    <span class=keyword>default</span>:</span><br><span class=line>        Py_UNREACHABLE();</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>我们最终能得到这样的汇编</p><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br><span class=line>65</span><br><span class=line>66</span><br><span class=line>67</span><br><span class=line>68</span><br><span class=line>69</span><br><span class=line>70</span><br><span class=line>71</span><br><span class=line>72</span><br><span class=line>73</span><br><span class=line>74</span><br><span class=line>75</span><br><span class=line>76</span><br><span class=line>77</span><br><span class=line>78</span><br><span class=line>79</span><br><span class=line>80</span><br><span class=line>81</span><br><span class=line>82</span><br><span class=line>83</span><br><span class=line>84</span><br><span class=line>85</span><br><span class=line>86</span><br><span class=line>87</span><br><span class=line>88</span><br><span class=line>89</span><br><span class=line>90</span><br><span class=line>91</span><br><span class=line>92</span><br><span class=line>93</span><br></pre></td><td class=code><pre><span class=line>// 0: 55                            pushq   %rbp</span><br><span class=line>// 1: 41 57                         pushq   %r15</span><br><span class=line>// 3: 41 56                         pushq   %r14</span><br><span class=line>// 5: 41 55                         pushq   %r13</span><br><span class=line>// 7: 41 54                         pushq   %r12</span><br><span class=line>// 9: 53                            pushq   %rbx</span><br><span class=line>// a: 48 83 ec 18                   subq    $0x18, %rsp</span><br><span class=line>// e: 48 89 54 24 10                movq    %rdx, 0x10(%rsp)</span><br><span class=line>// 13: 49 89 f7                      movq    %rsi, %r15</span><br><span class=line>// 16: 48 89 7c 24 08                movq    %rdi, 0x8(%rsp)</span><br><span class=line>// 1b: 4c 8b 66 f0                   movq    -0x10(%rsi), %r12</span><br><span class=line>// 1f: 48 8b 6e f8                   movq    -0x8(%rsi), %rbp</span><br><span class=line>// 23: 49 be 00 00 00 00 00 00 00 00 movabsq $0x0, %r14</span><br><span class=line>// 0000000000000025:  R_X86_64_64  _Py_stats</span><br><span class=line>// 2d: 49 8b 06                      movq    (%r14), %rax</span><br><span class=line>// 30: 48 85 c0                      testq   %rax, %rax</span><br><span class=line>// 33: 74 07                         je      0x3c &lt;_JIT_ENTRY+0x3c&gt;</span><br><span class=line>// 35: 48 ff 80 88 a4 01 00          incq    0x1a488(%rax)</span><br><span class=line>// 3c: 48 b8 00 00 00 00 00 00 00 00 movabsq $0x0, %rax</span><br><span class=line>// 000000000000003e:  R_X86_64_64  _PyLong_Add</span><br><span class=line>// 46: 4c 89 e7                      movq    %r12, %rdi</span><br><span class=line>// 49: 48 89 ee                      movq    %rbp, %rsi</span><br><span class=line>// 4c: ff d0                         callq   *%rax</span><br><span class=line>// 4e: 49 89 c5                      movq    %rax, %r13</span><br><span class=line>// 51: f6 45 03 80                   testb   $-0x80, 0x3(%rbp)</span><br><span class=line>// 55: 48 b9 00 00 00 00 00 00 00 00 movabsq $0x0, %rcx</span><br><span class=line>// 0000000000000057:  R_X86_64_64  PyInterpreterState_Get</span><br><span class=line>// 5f: 75 24                         jne     0x85 &lt;_JIT_ENTRY+0x85&gt;</span><br><span class=line>// 61: 49 8b 06                      movq    (%r14), %rax</span><br><span class=line>// 64: 48 85 c0                      testq   %rax, %rax</span><br><span class=line>// 67: 74 07                         je      0x70 &lt;_JIT_ENTRY+0x70&gt;</span><br><span class=line>// 69: 48 ff 80 78 58 09 00          incq    0x95878(%rax)</span><br><span class=line>// 70: 48 89 cb                      movq    %rcx, %rbx</span><br><span class=line>// 73: ff d1                         callq   *%rcx</span><br><span class=line>// 75: 48 89 d9                      movq    %rbx, %rcx</span><br><span class=line>// 78: 48 ff 88 c8 15 04 00          decq    0x415c8(%rax)</span><br><span class=line>// 7f: 48 ff 4d 00                   decq    (%rbp)</span><br><span class=line>// 83: 74 37                         je      0xbc &lt;_JIT_ENTRY+0xbc&gt;</span><br><span class=line>// 85: 41 f6 44 24 03 80             testb   $-0x80, 0x3(%r12)</span><br><span class=line>// 8b: 75 49                         jne     0xd6 &lt;_JIT_ENTRY+0xd6&gt;</span><br><span class=line>// 8d: 49 8b 06                      movq    (%r14), %rax</span><br><span class=line>// 90: 48 85 c0                      testq   %rax, %rax</span><br><span class=line>// 93: 74 07                         je      0x9c &lt;_JIT_ENTRY+0x9c&gt;</span><br><span class=line>// 95: 48 ff 80 78 58 09 00          incq    0x95878(%rax)</span><br><span class=line>// 9c: ff d1                         callq   *%rcx</span><br><span class=line>// 9e: 48 ff 88 c8 15 04 00          decq    0x415c8(%rax)</span><br><span class=line>// a5: 49 ff 0c 24                   decq    (%r12)</span><br><span class=line>// a9: 75 2b                         jne     0xd6 &lt;_JIT_ENTRY+0xd6&gt;</span><br><span class=line>// ab: 48 b8 00 00 00 00 00 00 00 00 movabsq $0x0, %rax</span><br><span class=line>// 00000000000000ad:  R_X86_64_64  PyObject_Free</span><br><span class=line>// b5: 4c 89 e7                      movq    %r12, %rdi</span><br><span class=line>// b8: ff d0                         callq   *%rax</span><br><span class=line>// ba: eb 1a                         jmp     0xd6 &lt;_JIT_ENTRY+0xd6&gt;</span><br><span class=line>// bc: 48 b8 00 00 00 00 00 00 00 00 movabsq $0x0, %rax</span><br><span class=line>// 00000000000000be:  R_X86_64_64  PyObject_Free</span><br><span class=line>// c6: 48 89 ef                      movq    %rbp, %rdi</span><br><span class=line>// c9: ff d0                         callq   *%rax</span><br><span class=line>// cb: 48 89 d9                      movq    %rbx, %rcx</span><br><span class=line>// ce: 41 f6 44 24 03 80             testb   $-0x80, 0x3(%r12)</span><br><span class=line>// d4: 74 b7                         je      0x8d &lt;_JIT_ENTRY+0x8d&gt;</span><br><span class=line>// d6: 49 8d 47 f0                   leaq    -0x10(%r15), %rax</span><br><span class=line>// da: 4d 85 ed                      testq   %r13, %r13</span><br><span class=line>// dd: 74 2e                         je      0x10d &lt;_JIT_ENTRY+0x10d&gt;</span><br><span class=line>// df: 49 83 c7 f8                   addq    $-0x8, %r15</span><br><span class=line>// e3: 4c 89 28                      movq    %r13, (%rax)</span><br><span class=line>// e6: 48 b8 00 00 00 00 00 00 00 00 movabsq $0x0, %rax</span><br><span class=line>// 00000000000000e8:  R_X86_64_64  _JIT_CONTINUE</span><br><span class=line>// f0: 48 8b 7c 24 08                movq    0x8(%rsp), %rdi</span><br><span class=line>// f5: 4c 89 fe                      movq    %r15, %rsi</span><br><span class=line>// f8: 48 8b 54 24 10                movq    0x10(%rsp), %rdx</span><br><span class=line>// fd: 48 83 c4 18                   addq    $0x18, %rsp</span><br><span class=line>// 101: 5b                            popq    %rbx</span><br><span class=line>// 102: 41 5c                         popq    %r12</span><br><span class=line>// 104: 41 5d                         popq    %r13</span><br><span class=line>// 106: 41 5e                         popq    %r14</span><br><span class=line>// 108: 41 5f                         popq    %r15</span><br><span class=line>// 10a: 5d                            popq    %rbp</span><br><span class=line>// 10b: ff e0                         jmpq    *%rax</span><br><span class=line>// 10d: 48 8b 4c 24 08                movq    0x8(%rsp), %rcx</span><br><span class=line>// 112: 48 29 c8                      subq    %rcx, %rax</span><br><span class=line>// 115: 48 83 c0 b8                   addq    $-0x48, %rax</span><br><span class=line>// 119: 48 c1 e8 03                   shrq    $0x3, %rax</span><br><span class=line>// 11d: 89 41 40                      movl    %eax, 0x40(%rcx)</span><br><span class=line>// 120: 31 c0                         xorl    %eax, %eax</span><br><span class=line>// 122: 48 83 c4 18                   addq    $0x18, %rsp</span><br><span class=line>// 126: 5b                            popq    %rbx</span><br><span class=line>// 127: 41 5c                         popq    %r12</span><br><span class=line>// 129: 41 5d                         popq    %r13</span><br><span class=line>// 12b: 41 5e                         popq    %r14</span><br><span class=line>// 12d: 41 5f                         popq    %r15</span><br><span class=line>// 12f: 5d                            popq    %rbp</span><br><span class=line>// 130: c3                            retq</span><br><span class=line>// 131: </span><br></pre></td></tr></table></figure><p>OK，我们在编译器（目前 Python 选用的 LLVM 系列的工具链，编译器为 clang）开了 O3 编译后得到中间文件后，我们利用 <code>llvm-objdump</code> 和 <code>llvm-readobj</code> 来获取到我们需要的信息（这里其实也是一个非常棒的细节，因为我们要跨很多平台，要处理几种不同的二进制格式，比如 Linux 下 ELF，Windows 下 PE，MacOS 下 Mach-O，所以我们需要一个统一的工具来处理这些二进制格式，而 LLVM 的工具链就是这样的工具）我们能注意到，在上面的代码中，有这样一些重定向条目</p><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre></td><td class=code><pre><span class=line>// 0000000000000025:  R_X86_64_64  _Py_stats</span><br><span class=line>// 000000000000003e:  R_X86_64_64  _PyLong_Add</span><br><span class=line>// 0000000000000057:  R_X86_64_64  PyInterpreterState_Get</span><br><span class=line>// 00000000000000ad:  R_X86_64_64  PyObject_Free</span><br><span class=line>// 00000000000000be:  R_X86_64_64  PyObject_Free</span><br><span class=line>// 00000000000000e8:  R_X86_64_64  _JIT_CONTINUE</span><br></pre></td></tr></table></figure><p>然后我们就可以根据从工具链中获取到的信息，来定位到我们需要 patch 的地址，然后生成一些运行时 patch 的 flag，最终生成这样一份 C 代码</p><figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre></td><td class=code><pre><span class=line><span class=type>static</span> <span class=type>const</span> <span class=type>unsigned</span> <span class=type>char</span> _BINARY_OP_ADD_INT_code_body[<span class=number>306</span>] = &#123;<span class=number>0x55</span>, <span class=number>0x41</span>, <span class=number>0x57</span>, <span class=number>0x41</span>, <span class=number>0x56</span>, <span class=number>0x41</span>, <span class=number>0x55</span>, <span class=number>0x41</span>, <span class=number>0x54</span>, <span class=number>0x53</span>, <span class=number>0x48</span>, <span class=number>0x83</span>, <span class=number>0xec</span>, <span class=number>0x18</span>, <span class=number>0x48</span>, <span class=number>0x89</span>, <span class=number>0x54</span>, <span class=number>0x24</span>, <span class=number>0x10</span>, <span class=number>0x49</span>, <span class=number>0x89</span>, <span class=number>0xf7</span>, <span class=number>0x48</span>, <span class=number>0x89</span>, <span class=number>0x7c</span>, <span class=number>0x24</span>, <span class=number>0x08</span>, <span class=number>0x4c</span>, <span class=number>0x8b</span>, <span class=number>0x66</span>, <span class=number>0xf0</span>, <span class=number>0x48</span>, <span class=number>0x8b</span>, <span class=number>0x6e</span>, <span class=number>0xf8</span>, <span class=number>0x49</span>, <span class=number>0xbe</span>, <span class=number>0x00</span>, <span class=number>0x00</span>, <span class=number>0x00</span>, <span class=number>0x00</span>, <span class=number>0x00</span>, <span class=number>0x00</span>, <span class=number>0x00</span>, <span class=number>0x00</span>, <span class=number>0x49</span>, <span class=number>0x8b</span>, <span class=number>0x06</span>, <span class=number>0x48</span>, <span class=number>0x85</span>, <span class=number>0xc0</span>, <span class=number>0x74</span>, <span class=number>0x07</span>, <span class=number>0x48</span>, <span class=number>0xff</span>, <span class=number>0x80</span>, <span class=number>0x88</span>, <span class=number>0xa4</span>, <span class=number>0x01</span>, <span class=number>0x00</span>, <span class=number>0x48</span>, <span class=number>0xb8</span>, <span class=number>0x00</span>, <span class=number>0x00</span>, <span class=number>0x00</span>, <span class=number>0x00</span>, <span class=number>0x00</span>, <span class=number>0x00</span>, <span class=number>0x00</span>, <span class=number>0x00</span>, <span class=number>0x4c</span>, <span class=number>0x89</span>, <span class=number>0xe7</span>, <span class=number>0x48</span>, <span class=number>0x89</span>, <span class=number>0xee</span>, <span class=number>0xff</span>, <span class=number>0xd0</span>, <span class=number>0x49</span>, <span class=number>0x89</span>, <span class=number>0xc5</span>, <span class=number>0xf6</span>, <span class=number>0x45</span>, <span class=number>0x03</span>, <span class=number>0x80</span>, <span class=number>0x48</span>, <span class=number>0xb9</span>, <span class=number>0x00</span>, <span class=number>0x00</span>, <span class=number>0x00</span>, <span class=number>0x00</span>, <span class=number>0x00</span>, <span class=number>0x00</span>, <span class=number>0x00</span>, <span class=number>0x00</span>, <span class=number>0x75</span>, <span class=number>0x24</span>, <span class=number>0x49</span>, <span class=number>0x8b</span>, <span class=number>0x06</span>, <span class=number>0x48</span>, <span class=number>0x85</span>, <span class=number>0xc0</span>, <span class=number>0x74</span>, <span class=number>0x07</span>, <span class=number>0x48</span>, <span class=number>0xff</span>, <span class=number>0x80</span>, <span class=number>0x78</span>, <span class=number>0x58</span>, <span class=number>0x09</span>, <span class=number>0x00</span>, <span class=number>0x48</span>, <span class=number>0x89</span>, <span class=number>0xcb</span>, <span class=number>0xff</span>, <span class=number>0xd1</span>, <span class=number>0x48</span>, <span class=number>0x89</span>, <span class=number>0xd9</span>, <span class=number>0x48</span>, <span class=number>0xff</span>, <span class=number>0x88</span>, <span class=number>0xc8</span>, <span class=number>0x15</span>, <span class=number>0x04</span>, <span class=number>0x00</span>, <span class=number>0x48</span>, <span class=number>0xff</span>, <span class=number>0x4d</span>, <span class=number>0x00</span>, <span class=number>0x74</span>, <span class=number>0x37</span>, <span class=number>0x41</span>, <span class=number>0xf6</span>, <span class=number>0x44</span>, <span class=number>0x24</span>, <span class=number>0x03</span>, <span class=number>0x80</span>, <span class=number>0x75</span>, <span class=number>0x49</span>, <span class=number>0x49</span>, <span class=number>0x8b</span>, <span class=number>0x06</span>, <span class=number>0x48</span>, <span class=number>0x85</span>, <span class=number>0xc0</span>, <span class=number>0x74</span>, <span class=number>0x07</span>, <span class=number>0x48</span>, <span class=number>0xff</span>, <span class=number>0x80</span>, <span class=number>0x78</span>, <span class=number>0x58</span>, <span class=number>0x09</span>, <span class=number>0x00</span>, <span class=number>0xff</span>, <span class=number>0xd1</span>, <span class=number>0x48</span>, <span class=number>0xff</span>, <span class=number>0x88</span>, <span class=number>0xc8</span>, <span class=number>0x15</span>, <span class=number>0x04</span>, <span class=number>0x00</span>, <span class=number>0x49</span>, <span class=number>0xff</span>, <span class=number>0x0c</span>, <span class=number>0x24</span>, <span class=number>0x75</span>, <span class=number>0x2b</span>, <span class=number>0x48</span>, <span class=number>0xb8</span>, <span class=number>0x00</span>, <span class=number>0x00</span>, <span class=number>0x00</span>, <span class=number>0x00</span>, <span class=number>0x00</span>, <span class=number>0x00</span>, <span class=number>0x00</span>, <span class=number>0x00</span>, <span class=number>0x4c</span>, <span class=number>0x89</span>, <span class=number>0xe7</span>, <span class=number>0xff</span>, <span class=number>0xd0</span>, <span class=number>0xeb</span>, <span class=number>0x1a</span>, <span class=number>0x48</span>, <span class=number>0xb8</span>, <span class=number>0x00</span>, <span class=number>0x00</span>, <span class=number>0x00</span>, <span class=number>0x00</span>, <span class=number>0x00</span>, <span class=number>0x00</span>, <span class=number>0x00</span>, <span class=number>0x00</span>, <span class=number>0x48</span>, <span class=number>0x89</span>, <span class=number>0xef</span>, <span class=number>0xff</span>, <span class=number>0xd0</span>, <span class=number>0x48</span>, <span class=number>0x89</span>, <span class=number>0xd9</span>, <span class=number>0x41</span>, <span class=number>0xf6</span>, <span class=number>0x44</span>, <span class=number>0x24</span>, <span class=number>0x03</span>, <span class=number>0x80</span>, <span class=number>0x74</span>, <span class=number>0xb7</span>, <span class=number>0x49</span>, <span class=number>0x8d</span>, <span class=number>0x47</span>, <span class=number>0xf0</span>, <span class=number>0x4d</span>, <span class=number>0x85</span>, <span class=number>0xed</span>, <span class=number>0x74</span>, <span class=number>0x2e</span>, <span class=number>0x49</span>, <span class=number>0x83</span>, <span class=number>0xc7</span>, <span class=number>0xf8</span>, <span class=number>0x4c</span>, <span class=number>0x89</span>, <span class=number>0x28</span>, <span class=number>0x48</span>, <span class=number>0xb8</span>, <span class=number>0x00</span>, <span class=number>0x00</span>, <span class=number>0x00</span>, <span class=number>0x00</span>, <span class=number>0x00</span>, <span class=number>0x00</span>, <span class=number>0x00</span>, <span class=number>0x00</span>, <span class=number>0x48</span>, <span class=number>0x8b</span>, <span class=number>0x7c</span>, <span class=number>0x24</span>, <span class=number>0x08</span>, <span class=number>0x4c</span>, <span class=number>0x89</span>, <span class=number>0xfe</span>, <span class=number>0x48</span>, <span class=number>0x8b</span>, <span class=number>0x54</span>, <span class=number>0x24</span>, <span class=number>0x10</span>, <span class=number>0x48</span>, <span class=number>0x83</span>, <span class=number>0xc4</span>, <span class=number>0x18</span>, <span class=number>0x5b</span>, <span class=number>0x41</span>, <span class=number>0x5c</span>, <span class=number>0x41</span>, <span class=number>0x5d</span>, <span class=number>0x41</span>, <span class=number>0x5e</span>, <span class=number>0x41</span>, <span class=number>0x5f</span>, <span class=number>0x5d</span>, <span class=number>0xff</span>, <span class=number>0xe0</span>, <span class=number>0x48</span>, <span class=number>0x8b</span>, <span class=number>0x4c</span>, <span class=number>0x24</span>, <span class=number>0x08</span>, <span class=number>0x48</span>, <span class=number>0x29</span>, <span class=number>0xc8</span>, <span class=number>0x48</span>, <span class=number>0x83</span>, <span class=number>0xc0</span>, <span class=number>0xb8</span>, <span class=number>0x48</span>, <span class=number>0xc1</span>, <span class=number>0xe8</span>, <span class=number>0x03</span>, <span class=number>0x89</span>, <span class=number>0x41</span>, <span class=number>0x40</span>, <span class=number>0x31</span>, <span class=number>0xc0</span>, <span class=number>0x48</span>, <span class=number>0x83</span>, <span class=number>0xc4</span>, <span class=number>0x18</span>, <span class=number>0x5b</span>, <span class=number>0x41</span>, <span class=number>0x5c</span>, <span class=number>0x41</span>, <span class=number>0x5d</span>, <span class=number>0x41</span>, <span class=number>0x5e</span>, <span class=number>0x41</span>, <span class=number>0x5f</span>, <span class=number>0x5d</span>, <span class=number>0xc3</span>&#125;;</span><br><span class=line><span class=type>static</span> <span class=type>const</span> Hole _BINARY_OP_ADD_INT_code_holes[<span class=number>7</span>] = &#123;</span><br><span class=line>    &#123;<span class=number>0x25</span>, HoleKind_R_X86_64_64, HoleValue_ZERO, &amp;_Py_stats, <span class=number>0x0</span>&#125;,</span><br><span class=line>    &#123;<span class=number>0x3e</span>, HoleKind_R_X86_64_64, HoleValue_ZERO, &amp;_PyLong_Add, <span class=number>0x0</span>&#125;,</span><br><span class=line>    &#123;<span class=number>0x57</span>, HoleKind_R_X86_64_64, HoleValue_ZERO, &amp;PyInterpreterState_Get, <span class=number>0x0</span>&#125;,</span><br><span class=line>    &#123;<span class=number>0xad</span>, HoleKind_R_X86_64_64, HoleValue_ZERO, &amp;PyObject_Free, <span class=number>0x0</span>&#125;,</span><br><span class=line>    &#123;<span class=number>0xbe</span>, HoleKind_R_X86_64_64, HoleValue_ZERO, &amp;PyObject_Free, <span class=number>0x0</span>&#125;,</span><br><span class=line>    &#123;<span class=number>0xe8</span>, HoleKind_R_X86_64_64, HoleValue_CONTINUE, <span class=literal>NULL</span>, <span class=number>0x0</span>&#125;,</span><br><span class=line>&#125;;</span><br></pre></td></tr></table></figure><p>最终所有指令编译完成后，最终会生成 <code>jit_stencils.h</code> 文件，被我们其余 CPython 代码引用，编译进我们的二进制中</p><p>然后我们来看下，我们的 JIT 是如何工作的</p><figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br></pre></td><td class=code><pre><span class=line><span class=type>int</span></span><br><span class=line>_PyJIT_Compile(_PyUOpExecutorObject *executor)</span><br><span class=line>&#123;</span><br><span class=line>    <span class=comment>// Loop once to find the total compiled size:</span></span><br><span class=line>    <span class=type>size_t</span> code_size = <span class=number>0</span>;</span><br><span class=line>    <span class=type>size_t</span> data_size = <span class=number>0</span>;</span><br><span class=line>    <span class=keyword>for</span> (Py_ssize_t i = <span class=number>0</span>; i &lt; Py_SIZE(executor); i++) &#123;</span><br><span class=line>        _PyUOpInstruction *instruction = &amp;executor-&gt;trace[i];</span><br><span class=line>        <span class=type>const</span> StencilGroup *group = &amp;stencil_groups[instruction-&gt;opcode];</span><br><span class=line>        code_size += group-&gt;code.body_size;</span><br><span class=line>        data_size += group-&gt;data.body_size;</span><br><span class=line>    &#125;</span><br><span class=line>    <span class=comment>// Round up to the nearest page (code and data need separate pages):</span></span><br><span class=line>    <span class=type>size_t</span> page_size = get_page_size();</span><br><span class=line>    assert((page_size &amp; (page_size - <span class=number>1</span>)) == <span class=number>0</span>);</span><br><span class=line>    code_size += page_size - (code_size &amp; (page_size - <span class=number>1</span>));</span><br><span class=line>    data_size += page_size - (data_size &amp; (page_size - <span class=number>1</span>));</span><br><span class=line>    <span class=type>char</span> *memory = jit_alloc(code_size + data_size);</span><br><span class=line>    <span class=keyword>if</span> (memory == <span class=literal>NULL</span>) &#123;</span><br><span class=line>        <span class=keyword>goto</span> fail;</span><br><span class=line>    &#125;</span><br><span class=line>    <span class=comment>// Loop again to emit the code:</span></span><br><span class=line>    <span class=type>char</span> *code = memory;</span><br><span class=line>    <span class=type>char</span> *data = memory + code_size;</span><br><span class=line>    <span class=keyword>for</span> (Py_ssize_t i = <span class=number>0</span>; i &lt; Py_SIZE(executor); i++) &#123;</span><br><span class=line>        _PyUOpInstruction *instruction = &amp;executor-&gt;trace[i];</span><br><span class=line>        <span class=type>const</span> StencilGroup *group = &amp;stencil_groups[instruction-&gt;opcode];</span><br><span class=line>        <span class=comment>// Think of patches as a dictionary mapping HoleValue to uint64_t:</span></span><br><span class=line>        <span class=type>uint64_t</span> patches[] = GET_PATCHES();</span><br><span class=line>        patches[HoleValue_CODE] = (<span class=type>uint64_t</span>)code;</span><br><span class=line>        patches[HoleValue_CONTINUE] = (<span class=type>uint64_t</span>)code + group-&gt;code.body_size;</span><br><span class=line>        patches[HoleValue_DATA] = (<span class=type>uint64_t</span>)data;</span><br><span class=line>        patches[HoleValue_EXECUTOR] = (<span class=type>uint64_t</span>)executor;</span><br><span class=line>        patches[HoleValue_OPARG] = instruction-&gt;oparg;</span><br><span class=line>        patches[HoleValue_OPERAND] = instruction-&gt;operand;</span><br><span class=line>        patches[HoleValue_TARGET] = instruction-&gt;target;</span><br><span class=line>        patches[HoleValue_TOP] = (<span class=type>uint64_t</span>)memory;</span><br><span class=line>        patches[HoleValue_ZERO] = <span class=number>0</span>;</span><br><span class=line>        emit(group, patches);</span><br><span class=line>        code += group-&gt;code.body_size;</span><br><span class=line>        data += group-&gt;data.body_size;</span><br><span class=line>    &#125;</span><br><span class=line>    <span class=keyword>if</span> (mark_executable(memory, code_size) ||</span><br><span class=line>        mark_readable(memory + code_size, data_size))</span><br><span class=line>    &#123;</span><br><span class=line>        jit_free(memory, code_size + data_size);</span><br><span class=line>        <span class=keyword>goto</span> fail;</span><br><span class=line>    &#125;</span><br><span class=line>    executor-&gt;base.execute = execute;</span><br><span class=line>    executor-&gt;jit_code = memory;</span><br><span class=line>    executor-&gt;jit_size = code_size + data_size;</span><br><span class=line>    <span class=keyword>return</span> <span class=number>1</span>;</span><br><span class=line>fail:</span><br><span class=line>    <span class=keyword>return</span> PyErr_Occurred() ? <span class=number>-1</span> : <span class=number>0</span>;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>这一部分代码看似很复杂，实际上核心代码很简单，利用 <code>jit_alloc</code> 生成一块内存，然后利用 <code>emit</code> 将我们的汇编代码写入到这块内存中，然后利用 <code>mark_executable</code> 和 <code>mark_readable</code> 将这块内存标记为可执行和可读，最终将这块内存的地址赋值给我们的 executor，这样我们的 executor 就可以执行我们的 JIT 代码了</p><p>然后</p><figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre></td><td class=code><pre><span class=line>patches[HoleValue_CODE] = (<span class=type>uint64_t</span>)code;</span><br><span class=line>patches[HoleValue_CONTINUE] = (<span class=type>uint64_t</span>)code + group-&gt;code.body_size;</span><br><span class=line>patches[HoleValue_DATA] = (<span class=type>uint64_t</span>)data;</span><br><span class=line>patches[HoleValue_EXECUTOR] = (<span class=type>uint64_t</span>)executor;</span><br><span class=line>patches[HoleValue_OPARG] = instruction-&gt;oparg;</span><br><span class=line>patches[HoleValue_OPERAND] = instruction-&gt;operand;</span><br><span class=line>patches[HoleValue_TARGET] = instruction-&gt;target;</span><br><span class=line>patches[HoleValue_TOP] = (<span class=type>uint64_t</span>)memory;</span><br><span class=line>patches[HoleValue_ZERO] = <span class=number>0</span>;</span><br></pre></td></tr></table></figure><p>这一部分就是将我们提前预置的一些 flag 设定具体的值，以便后续的 patch</p><p>然后 patch 核心的部分，就是根据各平台的 LDD 规则来将我们动态的一些地址 patch 到 relocate 的位置</p><figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br><span class=line>65</span><br><span class=line>66</span><br><span class=line>67</span><br><span class=line>68</span><br><span class=line>69</span><br><span class=line>70</span><br><span class=line>71</span><br><span class=line>72</span><br><span class=line>73</span><br><span class=line>74</span><br><span class=line>75</span><br><span class=line>76</span><br><span class=line>77</span><br><span class=line>78</span><br><span class=line>79</span><br><span class=line>80</span><br><span class=line>81</span><br><span class=line>82</span><br><span class=line>83</span><br><span class=line>84</span><br><span class=line>85</span><br><span class=line>86</span><br><span class=line>87</span><br></pre></td><td class=code><pre><span class=line><span class=keyword>switch</span> (hole-&gt;kind) &#123;</span><br><span class=line>    <span class=keyword>case</span> HoleKind_IMAGE_REL_I386_DIR32:</span><br><span class=line>        <span class=comment>// 32-bit absolute address.</span></span><br><span class=line>        <span class=comment>// Check that we&#x27;re not out of range of 32 unsigned bits:</span></span><br><span class=line>        assert(value &lt; (<span class=number>1ULL</span> &lt;&lt; <span class=number>32</span>));</span><br><span class=line>        *loc32 = (<span class=type>uint32_t</span>)value;</span><br><span class=line>        <span class=keyword>return</span>;</span><br><span class=line>    <span class=keyword>case</span> HoleKind_ARM64_RELOC_UNSIGNED:</span><br><span class=line>    <span class=keyword>case</span> HoleKind_IMAGE_REL_AMD64_ADDR64:</span><br><span class=line>    <span class=keyword>case</span> HoleKind_R_AARCH64_ABS64:</span><br><span class=line>    <span class=keyword>case</span> HoleKind_X86_64_RELOC_UNSIGNED:</span><br><span class=line>    <span class=keyword>case</span> HoleKind_R_X86_64_64:</span><br><span class=line>        <span class=comment>// 64-bit absolute address.</span></span><br><span class=line>        *loc64 = value;</span><br><span class=line>        <span class=keyword>return</span>;</span><br><span class=line>    <span class=keyword>case</span> HoleKind_R_AARCH64_CALL26:</span><br><span class=line>    <span class=keyword>case</span> HoleKind_R_AARCH64_JUMP26:</span><br><span class=line>        <span class=comment>// 28-bit relative branch.</span></span><br><span class=line>        assert(IS_AARCH64_BRANCH(*loc32));</span><br><span class=line>        value -= (<span class=type>uint64_t</span>)location;</span><br><span class=line>        <span class=comment>// Check that we&#x27;re not out of range of 28 signed bits:</span></span><br><span class=line>        assert((<span class=type>int64_t</span>)value &gt;= -(<span class=number>1</span> &lt;&lt; <span class=number>27</span>));</span><br><span class=line>        assert((<span class=type>int64_t</span>)value &lt; (<span class=number>1</span> &lt;&lt; <span class=number>27</span>));</span><br><span class=line>        <span class=comment>// Since instructions are 4-byte aligned, only use 26 bits:</span></span><br><span class=line>        assert(get_bits(value, <span class=number>0</span>, <span class=number>2</span>) == <span class=number>0</span>);</span><br><span class=line>        set_bits(loc32, <span class=number>0</span>, <span class=number>26</span>, value, <span class=number>2</span>);</span><br><span class=line>        <span class=keyword>return</span>;</span><br><span class=line>    <span class=keyword>case</span> HoleKind_R_AARCH64_MOVW_UABS_G0_NC:</span><br><span class=line>        <span class=comment>// 16-bit low part of an absolute address.</span></span><br><span class=line>        assert(IS_AARCH64_MOV(*loc32));</span><br><span class=line>        <span class=comment>// Check the implicit shift (this is &quot;part 0 of 3&quot;):</span></span><br><span class=line>        assert(get_bits(*loc32, <span class=number>21</span>, <span class=number>2</span>) == <span class=number>0</span>);</span><br><span class=line>        set_bits(loc32, <span class=number>5</span>, <span class=number>16</span>, value, <span class=number>0</span>);</span><br><span class=line>        <span class=keyword>return</span>;</span><br><span class=line>    <span class=keyword>case</span> HoleKind_R_AARCH64_MOVW_UABS_G1_NC:</span><br><span class=line>        <span class=comment>// 16-bit middle-low part of an absolute address.</span></span><br><span class=line>        assert(IS_AARCH64_MOV(*loc32));</span><br><span class=line>        <span class=comment>// Check the implicit shift (this is &quot;part 1 of 3&quot;):</span></span><br><span class=line>        assert(get_bits(*loc32, <span class=number>21</span>, <span class=number>2</span>) == <span class=number>1</span>);</span><br><span class=line>        set_bits(loc32, <span class=number>5</span>, <span class=number>16</span>, value, <span class=number>16</span>);</span><br><span class=line>        <span class=keyword>return</span>;</span><br><span class=line>    <span class=keyword>case</span> HoleKind_R_AARCH64_MOVW_UABS_G2_NC:</span><br><span class=line>        <span class=comment>// 16-bit middle-high part of an absolute address.</span></span><br><span class=line>        assert(IS_AARCH64_MOV(*loc32));</span><br><span class=line>        <span class=comment>// Check the implicit shift (this is &quot;part 2 of 3&quot;):</span></span><br><span class=line>        assert(get_bits(*loc32, <span class=number>21</span>, <span class=number>2</span>) == <span class=number>2</span>);</span><br><span class=line>        set_bits(loc32, <span class=number>5</span>, <span class=number>16</span>, value, <span class=number>32</span>);</span><br><span class=line>        <span class=keyword>return</span>;</span><br><span class=line>    <span class=keyword>case</span> HoleKind_R_AARCH64_MOVW_UABS_G3:</span><br><span class=line>        <span class=comment>// 16-bit high part of an absolute address.</span></span><br><span class=line>        assert(IS_AARCH64_MOV(*loc32));</span><br><span class=line>        <span class=comment>// Check the implicit shift (this is &quot;part 3 of 3&quot;):</span></span><br><span class=line>        assert(get_bits(*loc32, <span class=number>21</span>, <span class=number>2</span>) == <span class=number>3</span>);</span><br><span class=line>        set_bits(loc32, <span class=number>5</span>, <span class=number>16</span>, value, <span class=number>48</span>);</span><br><span class=line>        <span class=keyword>return</span>;</span><br><span class=line>    <span class=keyword>case</span> HoleKind_ARM64_RELOC_GOT_LOAD_PAGE21:</span><br><span class=line>        <span class=comment>// 21-bit count of pages between this page and an absolute address&#x27;s</span></span><br><span class=line>        <span class=comment>// page... I know, I know, it&#x27;s weird. Pairs nicely with</span></span><br><span class=line>        <span class=comment>// ARM64_RELOC_GOT_LOAD_PAGEOFF12 (below).</span></span><br><span class=line>        assert(IS_AARCH64_ADRP(*loc32));</span><br><span class=line>        <span class=comment>// Number of pages between this page and the value&#x27;s page:</span></span><br><span class=line>        value = (value &gt;&gt; <span class=number>12</span>) - ((<span class=type>uint64_t</span>)location &gt;&gt; <span class=number>12</span>);</span><br><span class=line>        <span class=comment>// Check that we&#x27;re not out of range of 21 signed bits:</span></span><br><span class=line>        assert((<span class=type>int64_t</span>)value &gt;= -(<span class=number>1</span> &lt;&lt; <span class=number>20</span>));</span><br><span class=line>        assert((<span class=type>int64_t</span>)value &lt; (<span class=number>1</span> &lt;&lt; <span class=number>20</span>));</span><br><span class=line>        <span class=comment>// value[0:2] goes in loc[29:31]:</span></span><br><span class=line>        set_bits(loc32, <span class=number>29</span>, <span class=number>2</span>, value, <span class=number>0</span>);</span><br><span class=line>        <span class=comment>// value[2:21] goes in loc[5:26]:</span></span><br><span class=line>        set_bits(loc32, <span class=number>5</span>, <span class=number>19</span>, value, <span class=number>2</span>);</span><br><span class=line>        <span class=keyword>return</span>;</span><br><span class=line>    <span class=keyword>case</span> HoleKind_ARM64_RELOC_GOT_LOAD_PAGEOFF12:</span><br><span class=line>        <span class=comment>// 12-bit low part of an absolute address. Pairs nicely with</span></span><br><span class=line>        <span class=comment>// ARM64_RELOC_GOT_LOAD_PAGE21 (above).</span></span><br><span class=line>        assert(IS_AARCH64_LDR_OR_STR(*loc32) || IS_AARCH64_ADD_OR_SUB(*loc32));</span><br><span class=line>        <span class=comment>// There might be an implicit shift encoded in the instruction:</span></span><br><span class=line>        <span class=type>uint8_t</span> shift = <span class=number>0</span>;</span><br><span class=line>        <span class=keyword>if</span> (IS_AARCH64_LDR_OR_STR(*loc32)) &#123;</span><br><span class=line>            shift = (<span class=type>uint8_t</span>)get_bits(*loc32, <span class=number>30</span>, <span class=number>2</span>);</span><br><span class=line>            <span class=comment>// If both of these are set, the shift is supposed to be 4.</span></span><br><span class=line>            <span class=comment>// That&#x27;s pretty weird, and it&#x27;s never actually been observed...</span></span><br><span class=line>            assert(get_bits(*loc32, <span class=number>23</span>, <span class=number>1</span>) == <span class=number>0</span> || get_bits(*loc32, <span class=number>26</span>, <span class=number>1</span>) == <span class=number>0</span>);</span><br><span class=line>        &#125;</span><br><span class=line>        value = get_bits(value, <span class=number>0</span>, <span class=number>12</span>);</span><br><span class=line>        assert(get_bits(value, <span class=number>0</span>, shift) == <span class=number>0</span>);</span><br><span class=line>        set_bits(loc32, <span class=number>10</span>, <span class=number>12</span>, value, shift);</span><br><span class=line>        <span class=keyword>return</span>;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>整体上的思路就是差不多这样一些，剩下的就是一些 corner case 的处理，本文先不在展开。大家感兴趣的话，我单独开单篇再来聊一些</p><h2 id=总结><a href=#总结 class=headerlink title=总结></a>总结</h2><p>我们能发现 Python 3.13 JIT 方案的一个很大的特点是，尽可能的利用了 LLVM 生态的东西，编译器用 clang，编译参数开 -o3 获取最大的性能，二进制用具用 <code>llvm-objdump</code> 和 <code>llvm-readelf</code>，这样做相较于其余方案的好处非常非常的明显</p><ol><li>clang 的编译器优化能力非常强，能够生成非常高效的代码</li><li>能够利用 LLVM 生态的工具链，能够更好的处理跨平台的问题</li><li>避免了人工维护的困境，大部分的改动也能通过自动化的方式生成与集成，避免低级错误的诞生</li></ol><p>所以我说 Python 3.13 的 JIT 方案可谓是又新又好</p></article><div class=post-copyright><div class=post-copyright__author><span class=post-copyright-meta><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class=post-copyright-info><a href=https://github.com/Zheaoli rel="external nofollow noreferrer">Manjusaka</a></span></div><div class=post-copyright__type><span class=post-copyright-meta><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class=post-copyright-info><a href=https://www.manjusaka.blog/posts/2024/01/03/a-simple-introduction-about-python-jit/ >https://www.manjusaka.blog/posts/2024/01/03/a-simple-introduction-about-python-jit/</a></span></div><div class=post-copyright__notice><span class=post-copyright-meta><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class=post-copyright-info>All articles on this blog are licensed under <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ rel="external nofollow noreferrer">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class=tag_share><div class=post-meta__tag-list><a class=post-meta__tags href=/tags/%E7%BC%96%E7%A8%8B/ >编程</a><a class=post-meta__tags href=/tags/Linux/ >Linux</a><a class=post-meta__tags href=/tags/Python/ >Python</a><a class=post-meta__tags href=/tags/%E7%AC%94%E8%AE%B0/ >笔记</a><a class=post-meta__tags href=/tags/%E6%B0%B4%E6%96%87/ >水文</a></div><div class=post-share><div class=social-share data-image=https://cdn.pixabay.com/photo/2023/02/04/07/50/flower-7766608_1280.jpg data-sites=facebook,twitter,wechat,weibo,qq></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css media=print onload='this.media="all"'><script src=https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js defer=defer></script></div></div><div class=ads-wrap><ins class=adsbygoogle style=display:block;text-align:center data-ad-layout=in-article data-ad-format=fluid data-ad-client=ca-pub-7962287588031867 data-ad-slot=2542544532></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><nav class=pagination-post id=pagination><a class=pagination-related href=/posts/2023/12/29/per-aspera-ad-astra/ title="Per aspera, Ad astra"><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/04/07/38/cherry-blossoms-7766587_1280.jpg onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class=info><div class=info-1><div class=info-item-1>Previous</div><div class=info-item-2>Per aspera, Ad astra</div></div><div class=info-2><div class=info-item-1>外星人一定很奇怪，本星际云本地泡银河系猎户悬臂边缘的太阳系第三行星的人类，怎么又在开始为他们庆祝行星绕行一圈开始忙碌了呢？ 开篇如果要说要说今年最让我记忆犹新的瞬间，那么毫无疑问是今年8月，月初的某一天，我毫无征兆的突然情绪爆发，冲到窗口边打开窗户，试图从十八楼一跃而下。不过可能我没法有游戏里的主角这一样的光环，落地，转身，拍拍屁股走人。可能只是在繁华的街道上徒留一地碎肉。 所以，妹子不知道为啥发觉了我的异常，在我一只脚迈出窗外的时候，死命将我拉了回来。我从没想过她的力气会那么大，会那样的无畏的拉着我。 所以我有些闲暇坐在这，写下这篇文章。 生活从试图跳楼往前回溯，是连续几周的同一个噩梦，梦回到了自己被强奸的现场，每一次都是同样的真实。可能我想我的一些坚守的防线在不知不觉中被打破了吧。 如果说2023的关键词第一个是爱，那么第二个应该就是 tough 了 无数的噩梦，自我的怀疑，各种不如意的琐事，最喜爱的演员的离世，最惨的时候两周去了六次急诊缝了5针，打了三针，这一些 tough...</div></div></div></a><a class=pagination-related href=/posts/2024/02/10/CVE-2024-21626/ title="简单聊聊 CVE-2024-21626"><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/04/07/50/daisy-7766609_1280.jpg onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="info text-right"><div class=info-1><div class=info-item-1>Next</div><div class=info-item-2>简单聊聊 CVE-2024-21626</div></div><div class=info-2><div class=info-item-1>本来这篇文章应该在初一凌晨发的，但是拖延癌晚期，所以到现在才发，得反思下了 背景众所周知，容器逃逸并不是什么令人稀奇的问题了（不被逃逸的容器才是稀奇），2月初，runc 社区正式公布了一个船新的逃逸 CVE，参见 https://github.com/opencontainers/runc/security/advisories/GHSA-xr7r-f8xq-vfvv，版本横跨 1.0 到 1.1.11 这个 CVE 的核心特性在于“可以通过镜像分发的方式，成本很低的进行逃逸” 我们先来复现一下这个问题 我自己的环境是这样 看这篇博客的同学可以参考下面方式进行环境准备， 按照自己的发行版确保安装了，Docker, libseccomp, golang 按照下面方式进行环境安装 1234567891011git clone https://github.com/opencontainers/runcgit checkout v1.1.0-rc.1makesudo rm -rf $(which runc)sudo make installsudo systemctl...</div></div></div></a></nav><div class=relatedPosts><div class=headline><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class=relatedPosts-list><a class=pagination-related href=/posts/2025/04/26/3-14-is-one-of-the-best-python-version/ title="Python 3.14: Python 世界的一大步"><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/06/01/14/superb-fairywren-7770904_1280.jpg alt=cover><div class="info text-center"><div class=info-1><div class=info-item-1><i class="far fa-calendar-alt fa-fw"></i> 2025-04-26</div><div class=info-item-2>Python 3.14: Python 世界的一大步</div></div><div class=info-2><div class=info-item-1>Python 3.14 目前主要的一些主要的特性其实已经固定了，在我看来，Python 3.14 是一个未来很多年的一个核心版本。因为其确定了是时代的 Python调试生态的基准，这篇文章将会来聊聊这个 Python 世界中的史诗级改进 正文在我们日常调试 Python 代码的时候，我们经常会遇到这样一个问题，我们需要采样当前的 Python Runtime 的状态，进而进一步调试我们的 Python 进程 常见的手段莫过于两种 通过 eBPF + UProbe 等手段来触发 通过 process_vm_readv 等 Syscall 来直接整块读取内存 无论这两种方式都有一个核心的问题，我们怎么样来解析内存中的数据？ 用 https://github.com/jschwinger233/perf-examples/blob/main/cpython310_backtrace/bpf.c...</div></div></div></a><a class=pagination-related href=/posts/2025/07/02/tail-call-in-3-14-interpreter/ title="Python 3.14 的进一步性能进化: Tail Call Interpreter"><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/04/07/38/cherry-blossoms-7766587_1280.jpg alt=cover><div class="info text-center"><div class=info-1><div class=info-item-1><i class="far fa-calendar-alt fa-fw"></i> 2025-07-02</div><div class=info-item-2>Python 3.14 的进一步性能进化: Tail Call Interpreter</div></div><div class=info-2><div class=info-item-1>最近做安全做的我头晕脑胀，来点轻松的换换脑子，让自己放松下 Python 3.14 正式引入了一个新的机制叫作 Tail Call Interpreter（Made by Ken Jin），这无疑又是一个奠定未来基础的重大工作 正文在聊 Python 3.14 的 Tail Call Interpreter 之前，我们先要来聊 C 语言中最基本的语法 switch-case 12345678910switch (x) &#123; case 1: // do something break; case 2: // do something else break; default: // do default thing&#125; 对于这样的代码我们最终的汇编会是什么样的呢？可能大家第一反应是先 cmp 然后 je ，不等式秒了，我们编译一个版本来看看 对于这样一段代码 12345678void small_switch(int x) &#123; switch(x) &#123; ...</div></div></div></a><a class=pagination-related href=/posts/2023/10/29/the-most-important-thing-in-python-3-12/ title="Python 3.12：一个被人忽略的史诗级版本"><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/01/14/19/50/flower-7718952_1280.jpg alt=cover><div class="info text-center"><div class=info-1><div class=info-item-1><i class="far fa-calendar-alt fa-fw"></i> 2023-10-30</div><div class=info-item-2>Python 3.12：一个被人忽略的史诗级版本</div></div><div class=info-2><div class=info-item-1>Python 3.12 已经发布了一段时间，所以写篇水文来聊一聊这个常常被人忽略的史诗级版本。 正文Python 3.12 绝对是一个史诗级版本，在我心目中，它对于 Python 的意义，大于 “async/await” 的 Python 3.5 和 “Type Hint” 的 Python 3.6 对于 Python 的意义。 或者我们可以这么说在未来数年的时间里，Python 后续的很多意义重大的变更，其都能上溯到 Python 3.12。 理解我这一个观点，我们来说一下 Python 的几大痛点： Python 的可调试性，可观测性问题。历史上 Python 中做 Cost 的消耗极大，同时没有足够的手段可以从旁路去观察 Python 的运行时行为 Python GIL 问题，这个老生长谈了，不多说 Python 的 C API/ABI 问题，之前暴露的 C API/ABI 通常和 CPython VM 实现细节耦合，导致跨版本兼容性会是一个问题 而这样一些问题，Python 3.12 上都有了极大的进步 PEP 669， GH-96143 极大提升了 Python...</div></div></div></a><a class=pagination-related href=/posts/2023/10/05/the-perf-feature-python-312/ title="聊聊 Python 3.12 中 perf 的原生支持"><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/07/14/45/snow-7774312_1280.jpg alt=cover><div class="info text-center"><div class=info-1><div class=info-item-1><i class="far fa-calendar-alt fa-fw"></i> 2023-10-05</div><div class=info-item-2>聊聊 Python 3.12 中 perf 的原生支持</div></div><div class=info-2><div class=info-item-1>好久没写 Python 相关的文章了，但是 Python 3.12 perf 原生支持的这个特性非常的棒，思路又新又好了属于是，所以写篇水文来聊聊这个特性 正文先聊聊 Python 的栈帧在聊今天的正式内容之前我们需要理解 Python 在内存中的布局 对于传统的 native application 而言，大家对于其内存布局应该是比较熟悉的，这里以 x86-64 的一张图来说明其栈帧结构 但是对于 CPython 来说，其 Native Code 执行的只是 VM 一层的代码。其在 VM 内单独抽象了一套类似 native 的栈帧结构。 其核心结构如下 1234567891011121314151617181920212223242526272829303132333435363738struct _frame &#123; PyObject_HEAD PyFrameObject *f_back; /* previous frame, or NULL */ struct _PyInterpreterFrame *f_frame; /*...</div></div></div></a><a class=pagination-related href=/posts/2024/02/10/CVE-2024-21626/ title="简单聊聊 CVE-2024-21626"><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/04/07/50/daisy-7766609_1280.jpg alt=cover><div class="info text-center"><div class=info-1><div class=info-item-1><i class="far fa-calendar-alt fa-fw"></i> 2024-02-11</div><div class=info-item-2>简单聊聊 CVE-2024-21626</div></div><div class=info-2><div class=info-item-1>本来这篇文章应该在初一凌晨发的，但是拖延癌晚期，所以到现在才发，得反思下了 背景众所周知，容器逃逸并不是什么令人稀奇的问题了（不被逃逸的容器才是稀奇），2月初，runc 社区正式公布了一个船新的逃逸 CVE，参见 https://github.com/opencontainers/runc/security/advisories/GHSA-xr7r-f8xq-vfvv，版本横跨 1.0 到 1.1.11 这个 CVE 的核心特性在于“可以通过镜像分发的方式，成本很低的进行逃逸” 我们先来复现一下这个问题 我自己的环境是这样 看这篇博客的同学可以参考下面方式进行环境准备， 按照自己的发行版确保安装了，Docker, libseccomp, golang 按照下面方式进行环境安装 1234567891011git clone https://github.com/opencontainers/runcgit checkout v1.1.0-rc.1makesudo rm -rf $(which runc)sudo make installsudo systemctl...</div></div></div></a><a class=pagination-related href=/posts/2021/11/22/a-litte-introduction-about-nohdr-filed-in-skbuff/ title="聊聊 sk_buff 中一个冷门字段: nohdr"><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/01/30/19/40/gulls-7756481_1280.jpg alt=cover><div class="info text-center"><div class=info-1><div class=info-item-1><i class="far fa-calendar-alt fa-fw"></i> 2021-11-22</div><div class=info-item-2>聊聊 sk_buff 中一个冷门字段: nohdr</div></div><div class=info-2><div class=info-item-1>今天遇到一个很有意思的问题，“nohdr 字段到底有什么用”，在这里写个水文简单记录一下 正文前情提要首先来说，不管介绍再冷门的字段，既然涉及到 SKBUFF ，那么就得先来对 sk_buff 做个简单的介绍 简而言之，sk_buff 是 Linux 网络子系统的核心数据结构，从链路层到我们最终对数据包的操作，背后都离不开 sk_buff sk_buff 要完全讲解基本就相当于把 Linux 网络系统完全讲解了，所以讲完是不可能讲完的，这辈子都不可能的！ 简单聊几个关键，可能会帮助大家理解我们本文提到的冷门字段 nohdr 的关键字段吧 首先来讲，最重要的三个字段：data ，mac 和 nh ，分别代表着当前 sk_buff 的数据区的起始地址，L2 header 的起始地址，L3 Header 的起始地址。用一个图方便大家理解 看了图的同学可能会有点明白了，实际上在内核里，也是一层一层的通过指针偏移，不断的添加新的 header 来处理网络请求。和我们直觉相符。可能有同学会问，我既然知道 L3 Header 的起始地址，IP 之类的 L3 协议的 header...</div></div></div></a></div></div><hr class=custom-hr><div id=post-comment><div class=comment-head><div class=comment-headline><i class="fas fa-comments fa-fw"></i><span> Comments</span></div></div><div class=comment-wrap><div><div id=disqus_thread></div></div></div></div></div><div class=aside-content id=aside-content><div class="card-widget card-info text-center"><div class=avatar-img><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://avatars.githubusercontent.com/u/7054676?v=4" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt=avatar></div><div class=author-info-name>Manjusaka</div><div class=author-info-description>热忱之心不可磨灭</div><div class=site-data><a href=/archives/ ><div class=headline>Articles</div><div class=length-num>104</div></a><a href=/tags/ ><div class=headline>Tags</div><div class=length-num>60</div></a><a href=/categories/ ><div class=headline>Categories</div><div class=length-num>41</div></a></div><a id=card-info-btn href=https://github.com/Zheaoli rel="external nofollow noreferrer"><i class="fab fa-github"></i><span>Follow Me</span></a><div class=card-info-social-icons><a class=social-icon href=https://github.com/ZheaoLi rel="external nofollow noreferrer" target=_blank title=Github><i class="fab fa-github"></i></a><a class=social-icon href=mailto:me@manjusaka.me rel="external nofollow noreferrer" target=_blank title=Email><i class="fas fa-envelope"></i></a><a class=social-icon href=https://twitter.com/Manjusaka_Lee rel="external nofollow noreferrer" target=_blank title=推特><i class="fab fa-twitter"></i></a><a class=social-icon href=/atom.xml target=_blank title=RSS><i class="fa-solid fa-feed"></i></a></div></div><div class="card-widget card-announcement"><div class=item-headline><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class=announcement_content>This is my Blog</div></div><div class=sticky_layout><div class=card-widget id=card-toc><div class=item-headline><i class="fas fa-stream"></i><span>Contents</span><span class=toc-percentage></span></div><div class="toc-content is-expand"><ol class=toc><li class="toc-item toc-level-2"><a class=toc-link href=#%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86><span class=toc-number>1.</span> <span class=toc-text>基础知识</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#Python-3-13-%E7%9A%84-JIT><span class=toc-number>2.</span> <span class=toc-text>Python 3.13 的 JIT</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E6%80%BB%E7%BB%93><span class=toc-number>3.</span> <span class=toc-text>总结</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class=item-headline><i class="fas fa-history"></i><span>Recent Posts</span></div><div class=aside-list><div class=aside-list-item><a class=thumbnail href=/posts/2025/07/02/tail-call-in-3-14-interpreter-en/ title="Further Performance Evolution in Python 3.14: Tail Call Interpreter"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/01/14/19/50/flower-7718952_1280.jpg onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Further Performance Evolution in Python 3.14: Tail Call Interpreter"></a><div class=content><a class=title href=/posts/2025/07/02/tail-call-in-3-14-interpreter-en/ title="Further Performance Evolution in Python 3.14: Tail Call Interpreter">Further Performance Evolution in Python 3.14: Tail Call Interpreter</a><time datetime=2025-07-02T15:49:00.000Z title="Created 2025-07-02 23:49:00">2025-07-02</time></div></div><div class=aside-list-item><a class=thumbnail href=/posts/2025/07/02/tail-call-in-3-14-interpreter/ title="Python 3.14 的进一步性能进化: Tail Call Interpreter"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/04/07/38/cherry-blossoms-7766587_1280.jpg onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Python 3.14 的进一步性能进化: Tail Call Interpreter"></a><div class=content><a class=title href=/posts/2025/07/02/tail-call-in-3-14-interpreter/ title="Python 3.14 的进一步性能进化: Tail Call Interpreter">Python 3.14 的进一步性能进化: Tail Call Interpreter</a><time datetime=2025-07-02T15:49:00.000Z title="Created 2025-07-02 23:49:00">2025-07-02</time></div></div><div class=aside-list-item><a class=thumbnail href=/posts/2025/04/26/3-14-is-one-of-the-best-python-version/ title="Python 3.14: Python 世界的一大步"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/06/01/14/superb-fairywren-7770904_1280.jpg onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Python 3.14: Python 世界的一大步"></a><div class=content><a class=title href=/posts/2025/04/26/3-14-is-one-of-the-best-python-version/ title="Python 3.14: Python 世界的一大步">Python 3.14: Python 世界的一大步</a><time datetime=2025-04-26T14:49:00.000Z title="Created 2025-04-26 22:49:00">2025-04-26</time></div></div><div class=aside-list-item><a class=thumbnail href=/posts/2025/03/23/a-simple-introduction-about-load-balance-algorithm/ title=简单聊聊常见的负载均衡算法><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=/images/pixai-1860500966642493859-3.png onerror='this.onerror=null,this.src="/img/404.jpg"' alt=简单聊聊常见的负载均衡算法></a><div class=content><a class=title href=/posts/2025/03/23/a-simple-introduction-about-load-balance-algorithm/ title=简单聊聊常见的负载均衡算法>简单聊聊常见的负载均衡算法</a><time datetime=2025-03-23T12:00:00.000Z title="Created 2025-03-23 20:00:00">2025-03-23</time></div></div><div class=aside-list-item><a class=thumbnail href=/posts/2025/02/03/a-little-thought-about-translation-about-yuru-camp/ title=简单吐槽一下摇曳露营的台配><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/04/07/50/flower-7766608_1280.jpg onerror='this.onerror=null,this.src="/img/404.jpg"' alt=简单吐槽一下摇曳露营的台配></a><div class=content><a class=title href=/posts/2025/02/03/a-little-thought-about-translation-about-yuru-camp/ title=简单吐槽一下摇曳露营的台配>简单吐槽一下摇曳露营的台配</a><time datetime=2025-02-03T18:00:00.000Z title="Created 2025-02-04 02:00:00">2025-02-04</time></div></div></div></div><div class="card-widget ads-wrap"><ins class=adsbygoogle style=display:block data-ad-client=ca-pub-7962287588031867 data-ad-slot=1257383027 data-ad-format=auto data-full-width-responsive=true></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div></div></div></main><footer id=footer><div id=footer-wrap><div class=copyright>&copy;2020 - 2025 By Manjusaka</div><div class=framework-info><span>Framework </span><a href=https://hexo.io rel="external nofollow noreferrer">Hexo 7.3.0</a><span class=footer-separator>|</span><span>Theme </span><a href=https://github.com/jerryc127/hexo-theme-butterfly rel="external nofollow noreferrer">Butterfly 5.3.5</a></div></div></footer></div><div id=rightside><div id=rightside-config-hide></div><div id=rightside-config-show><button id=darkmode type=button title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id=translateLink type=button title="Toggle Between Traditional and Simplified Chinese">简</button><button id=readmode type=button title="Reading Mode"><i class="fas fa-book-open"></i></button><button id=go-up type=button title="Back to Top"><span class=scroll-percent></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src=https://www.manjusaka.blog/js/utils.js></script><script src=https://www.manjusaka.blog/js/main.js></script><script src=https://www.manjusaka.blog/js/tw_cn.js></script><script src=https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js></script><script src=https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js></script><div class=js-pjax><script>(()=>{var e=()=>{var e;0!==(e=document.querySelectorAll("pre > code.mermaid")).length&&e.forEach(e=>{var t=document.createElement("pre"),d=(t.className="mermaid-src",t.hidden=!0,t.textContent=e.textContent,document.createElement("div"));d.className="mermaid-wrap",d.appendChild(t),e.parentNode.replaceWith(d)});let t=document.querySelectorAll("#article-container .mermaid-wrap");0!==t.length&&(e=()=>(e=>{window.loadMermaid=!0;document.documentElement.getAttribute("data-theme");e.forEach((e,t)=>{let d=e.firstElementChild;e=`%%{init:{ 'theme':'default'}}%%
`+d.textContent,t=mermaid.render("mermaid-"+t,e);let n=e=>{d.insertAdjacentHTML("afterend",e)};"string"==typeof t?n(t):t.then(({svg:e})=>n(e))})})(t),btf.addGlobalFn("themeChange",e,"mermaid"),window.loadMermaid?e():btf.getScript("https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js").then(e))};btf.addGlobalFn("encrypt",e,"mermaid"),window.pjax?e():document.addEventListener("DOMContentLoaded",e)})()</script><script>(()=>{let o="shuoshuo"===GLOBAL_CONFIG_SITE.pageType,s=t=>{window.DISQUS&&window.DISQUS.reset({reload:!0,config:t})};var t=(t,i)=>{o&&(window.shuoshuoComment.destroyDisqus=()=>{t.children.length&&(t.innerHTML="",t.classList.add("no-comment"))}),window.disqus_identifier=o?i:"/posts/2024/01/03/a-simple-introduction-about-python-jit/",window.disqus_url=o?location.origin+i:"https://www.manjusaka.blog/posts/2024/01/03/a-simple-introduction-about-python-jit/";function e(){this.page.url=disqus_url,this.page.identifier=disqus_identifier,this.page.title="简单聊聊 Python 3.13 的 JIT 方案"}window.DISQUS?s(e):((i=document.createElement("script")).src="https://manjusakablog.disqus.com/embed.js",i.setAttribute("data-timestamp",+new Date),document.head.appendChild(i)),btf.addGlobalFn("themeChange",()=>s(e),"disqus")};o?window.shuoshuoComment={loadComment:t}:t()})()</script></div><script defer=defer id=fluttering_ribbon mobile=false src=https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js></script><script src=https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!0,POWERMODE.mobile=!1,document.body.addEventListener("input",POWERMODE)</script><script async data-pjax src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><div id=algolia-search><div class=search-dialog><nav class=search-nav><span class=search-dialog-title>Search</span><button class=search-close-button><i class="fas fa-times"></i></button></nav><div class=search-wrap><div id=algolia-search-input></div><hr><div id=algolia-search-results><div id=algolia-hits></div><div id=algolia-pagination></div><div id=algolia-info><div class=algolia-stats></div><div class=algolia-poweredBy></div></div></div></div></div><div id=search-mask></div><script src=https://cdn.jsdelivr.net/npm/algoliasearch/dist/lite/builds/browser.umd.min.js></script><script src=https://cdn.jsdelivr.net/npm/instantsearch.js/dist/instantsearch.production.min.js></script><script src=https://www.manjusaka.blog/js/search/algolia.js></script></div></div><script data-pjax>function butterfly_swiper_injector_config(){var s=document.getElementById("recent-posts");console.log("已挂载butterfly_swiper"),s.insertAdjacentHTML("afterbegin",'<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="/posts/2024/12/31/at-the-end-of-2024/" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.pixabay.com/photo/2023/01/30/19/40/gulls-7756481_1280.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2024-12-31</span><a class="blog-slider__title" href="/posts/2024/12/31/at-the-end-of-2024/" alt="">本当の僕らをありがとう</a><div class="blog-slider__text">再怎么看我也不知道怎么描述它的啦！</div><a class="blog-slider__button" href="/posts/2024/12/31/at-the-end-of-2024/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="/posts/2024/02/20/a-simple-discussion-about-the-ultraman/" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.pixabay.com/photo/2023/02/06/16/46/sea-7772372_1280.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2024-02-20</span><a class="blog-slider__title" href="/posts/2024/02/20/a-simple-discussion-about-the-ultraman/" alt="">简单聊聊奥特曼中很有趣的细节</a><div class="blog-slider__text">ヒーロが必要なんだよ，金城君。ヒーローが必要なんだ！</div><a class="blog-slider__button" href="/posts/2024/02/20/a-simple-discussion-about-the-ultraman/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="/posts/2023/12/29/per-aspera-ad-astra/" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.pixabay.com/photo/2023/02/04/07/38/cherry-blossoms-7766587_1280.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-12-29</span><a class="blog-slider__title" href="/posts/2023/12/29/per-aspera-ad-astra/" alt="">Per aspera, Ad astra</a><div class="blog-slider__text">再怎么看我也不知道怎么描述它的啦！</div><a class="blog-slider__button" href="/posts/2023/12/29/per-aspera-ad-astra/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="/posts/2023/10/24/open-source-is-simple-than-you-think/" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.pixabay.com/photo/2023/02/04/07/38/cherry-blossoms-7766588_1280.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-10-24</span><a class="blog-slider__title" href="/posts/2023/10/24/open-source-is-simple-than-you-think/" alt="">开源可能没你想的那么难</a><div class="blog-slider__text">再怎么看我也不知道怎么描述它的啦！</div><a class="blog-slider__button" href="/posts/2023/10/24/open-source-is-simple-than-you-think/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="/posts/2023/06/25/love-and-hope-is-all-we-need/" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://github.com/Zheaoli/yuque-py/assets/7054676/ea9460a2-e351-4b73-9f82-7aef6cd20c33" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-06-25</span><a class="blog-slider__title" href="/posts/2023/06/25/love-and-hope-is-all-we-need/" alt="">聊聊公益和助学</a><div class="blog-slider__text">很多时候，帮助人不需要那么多理由</div><a class="blog-slider__button" href="/posts/2023/06/25/love-and-hope-is-all-we-need/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="/posts/2023/12/28/how-do-I-build-homelab-part2/" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.pixabay.com/photo/2023/01/30/19/40/gulls-7756481_1280.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-12-28</span><a class="blog-slider__title" href="/posts/2023/12/28/how-do-I-build-homelab-part2/" alt="">家庭 Homelab 升级计划: v2</a><div class="blog-slider__text">人生嘛，Homelab 图个乐子</div><a class="blog-slider__button" href="/posts/2023/12/28/how-do-I-build-homelab-part2/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="/posts/2023/06/19/why-do-I-love-ultraman/" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://user-images.githubusercontent.com/7054676/228287041-c86e7928-0da8-4097-b7ff-e575faa8cf8c.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-06-19</span><a class="blog-slider__title" href="/posts/2023/06/19/why-do-I-love-ultraman/" alt="">为什么奥特曼是我的信仰</a><div class="blog-slider__text">優しさを失わないでくれ。弱い者を労り互いに助け合い。</div><a class="blog-slider__button" href="/posts/2023/06/19/why-do-I-love-ultraman/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="/posts/2023/06/16/how-do-I-build-homelab/" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.pixabay.com/photo/2023/02/06/01/14/superb-fairywren-7770904_1280.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-06-16</span><a class="blog-slider__title" href="/posts/2023/06/16/how-do-I-build-homelab/" alt="">家庭 Homelab 升级计划</a><div class="blog-slider__text">人生嘛，Homelab 图个乐子</div><a class="blog-slider__button" href="/posts/2023/06/16/how-do-I-build-homelab/" alt="">详情   </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>')}for(var elist="undefined".split(","),cpage=location.pathname,epage="all",flag=0,i=0;i<elist.length;i++)cpage.includes(elist[i])&&flag++;("all"===epage&&0==flag||epage===cpage)&&butterfly_swiper_injector_config()</script><script defer=defer src=https://cdn.jsdelivr.net/npm/hexo-butterfly-swiper@1.0.12/lib/swiper.min.js></script><script defer=defer data-pjax src=https://cdn.jsdelivr.net/npm/hexo-butterfly-swiper@1.0.12/lib/swiper_init.js></script><script async src=//at.alicdn.com/t/font_2032782_8d5kxvn09md.js></script></body></html>