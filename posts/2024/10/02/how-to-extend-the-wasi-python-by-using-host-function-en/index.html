<!DOCTYPE html><html lang=en data-theme=auto><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><title>How to Run CPython for WASI Using WASMTIME and Extend It with Python-Implemented Host Functions? | Manjusaka</title><meta name=author content=Manjusaka><meta name=copyright content=Manjusaka><meta name=format-detection content="telephone=no"><meta name=theme-color content=ffffff><meta name=description content="During the National Day holiday, I worked on a project to use wasmtime to execute CPython virtual machine compiled into WASM&#x2F;WASI bytecode, and extend it with Host Functions implemented in Python on t"><meta property=og:type content=article><meta property=og:title content="How to Run CPython for WASI Using WASMTIME and Extend It with Python-Implemented Host Functions?"><meta property=og:url content=https://www.manjusaka.blog/posts/2024/10/02/how-to-extend-the-wasi-python-by-using-host-function-en/index.html><meta property=og:site_name content=Manjusaka><meta property=og:description content="During the National Day holiday, I worked on a project to use wasmtime to execute CPython virtual machine compiled into WASM&#x2F;WASI bytecode, and extend it with Host Functions implemented in Python on t"><meta property=og:locale content=en_US><meta property=og:image content=https://cdn.pixabay.com/photo/2023/01/14/19/50/flower-7718952_1280.jpg><meta property=article:published_time content=2024-10-02T13:00:00.000Z><meta property=article:modified_time content=2024-10-13T19:06:19.898Z><meta property=article:author content=Manjusaka><meta property=article:tag content=CPython><meta property=article:tag content=Programming><meta property=article:tag content=Notes><meta property=article:tag content=WASI><meta property=article:tag content=WASM><meta property=article:tag content=Blog><meta name=twitter:card content=summary><meta name=twitter:image content="https://avatars.githubusercontent.com/u/7054676?v=4"><meta name=twitter:creator content=@Manjusaka_Lee><meta name=twitter:site content=https://twitter.com/Manjusaka_Lee><link rel="shortcut icon" href="https://avatars.githubusercontent.com/u/7054676?v=4"><link rel=canonical href=https://www.manjusaka.blog/posts/2024/10/02/how-to-extend-the-wasi-python-by-using-host-function-en/index.html><link rel=preconnect href=//cdn.jsdelivr.net><link rel=preconnect href=//www.google-analytics.com crossorigin=""><link rel=preconnect href=//busuanzi.ibruce.info><link rel=stylesheet href=/css/index.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css media=print onload='this.media="all"'><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css media=print onload='this.media="all"'><script async=async src="https://www.googletagmanager.com/gtag/js?id=UA-154407994-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-154407994-1")</script><script>let GLOBAL_CONFIG={root:"/",algolia:{appId:"DL1RURGHTB",indexName:"manjusaka.blog",hits:{per_page:6},languages:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}.",hits_stats:"${hits} results found in ${time} ms"}},localSearch:void 0,translate:{defaultEncoding:2,translateDelay:0,msgToTraditionalChinese:"繁",msgToSimplifiedChinese:"簡"},noticeOutdate:{limitDay:365,position:"top",messagePrev:"It has been",messageNext:"days since the last update, the content of the article may be outdated."},highlight:{plugin:"highlight.js",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:400},copy:{success:"Copy Successful",error:"Copy Error",noSupport:"Browser Not Supported"},relativeDate:{homepage:!0,post:!0},runtime:"days",dateSuffix:{just:"Just now",min:"minutes ago",hour:"hours ago",day:"days ago",month:"months ago"},copyright:{limitCount:100,languages:{author:"Author: Manjusaka",link:"Link: ",source:"Source: Manjusaka",info:"Copyright is owned by the author. For commercial reprints, please contact the author for authorization. For non-commercial reprints, please indicate the source."}},lightbox:"fancybox",Snackbar:{chs_to_cht:"You have switched to Traditional Chinese",cht_to_chs:"You have switched to Simplified Chinese",day_to_night:"You have switched to Dark Mode",night_to_day:"You have switched to Light Mode",bgLight:"#59C173",bgDark:"#1f1f1f",position:"bottom-left"},infinitegrid:{js:"https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js",buttonText:"Load More"},isPhotoFigcaption:!0,islazyload:!0,isAnchor:!0,percent:{toc:!0,rightside:!0},autoDarkmode:!0}</script><script id=config-diff>var GLOBAL_CONFIG_SITE={title:"How to Run CPython for WASI Using WASMTIME and Extend It with Python-Implemented Host Functions?",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2024-10-14 03:06:19"}</script><script>(e=>{e.saveToLocal={set:(e,t,a)=>{var o;0!==a&&(o=Date.now(),localStorage.setItem(e,JSON.stringify({value:t,expiry:o+864e5*a})))},get:e=>{var t=localStorage.getItem(e);if(t){t=JSON.parse(t);if(!(Date.now()>t.expiry))return t.value;localStorage.removeItem(e)}}},e.getScript=(o,d={})=>new Promise((t,e)=>{let a=document.createElement("script");a.src=o,a.async=!0,a.onerror=e,a.onload=a.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},Object.keys(d).forEach(e=>{a.setAttribute(e,d[e])}),document.head.appendChild(a)}),e.getCSS=(o,d=!1)=>new Promise((t,e)=>{let a=document.createElement("link");a.rel="stylesheet",a.href=o,d&&(a.id=d),a.onerror=e,a.onload=a.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},document.head.appendChild(a)}),e.activateDarkMode=()=>{document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},e.activateLightMode=()=>{document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","ffffff")};var e=saveToLocal.get("theme"),t=window.matchMedia("(prefers-color-scheme: dark)").matches,a=window.matchMedia("(prefers-color-scheme: light)").matches,o=window.matchMedia("(prefers-color-scheme: no-preference)").matches,d=!t&&!a&&!o,t=(void 0===e?(a?activateLightMode():t?activateDarkMode():(o||d)&&((a=(new Date).getHours())<=6||18<=a?activateDarkMode:activateLightMode)(),window.matchMedia("(prefers-color-scheme: dark)").addListener(e=>{void 0===saveToLocal.get("theme")&&(e.matches?activateDarkMode:activateLightMode)()})):("light"===e?activateLightMode:activateDarkMode)(),saveToLocal.get("aside-status"));void 0!==t&&("hide"===t?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})(window)</script><link rel=stylesheet href=https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.css media=print onload='this.media="all"'><link rel=stylesheet href=https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiperstyle.css media=print onload='this.media="all"'><link rel=stylesheet href=https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css media=defer onload='this.media="all"'><link rel=stylesheet href=https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css media=defer onload='this.media="all"'><script src=https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js></script><meta name=generator content="Hexo 6.3.0"><link rel=alternate href=/atom.xml title=Manjusaka type=application/atom+xml></head><body><div id=loading-box><div class=loading-left-bg></div><div class=loading-right-bg></div><div class=spinner-box><div class=configure-border-1><div class=configure-core></div></div><div class=configure-border-2><div class=configure-core></div></div><div class=loading-word>Loading...</div></div></div><script>(()=>{let d=document.getElementById("loading-box"),e=document.body,o={endLoading:()=>{e.style.overflow="",d.classList.add("loaded")},initLoading:()=>{e.style.overflow="hidden",d.classList.remove("loaded")}};o.initLoading(),window.addEventListener("load",()=>{o.endLoading()})})()</script><div id=web_bg></div><div id=sidebar><div id=menu-mask></div><div id=sidebar-menus><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://avatars.githubusercontent.com/u/7054676?v=4" onerror='onerror=null,src="/img/friend_404.gif"' alt=avatar></div><div class="sidebar-site-data site-data is-center"><a href=/archives/ ><div class=headline>Articles</div><div class=length-num>95</div></a><a href=/tags/ ><div class=headline>Tags</div><div class=length-num>58</div></a><a href=/categories/ ><div class=headline>Categories</div><div class=length-num>38</div></a></div><hr class=custom-hr><div class=menus_items><div class=menus_item><a class=site-page href=/ ><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class=menus_item><a class="site-page group" href=javascript:void(0); rel="external nofollow noreferrer"><i class="fa-fw fa-fw fas fa-lines-leaning"></i><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class=menus_item_child><li><a class="site-page child" href=/categories/ ><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href=/tags/ ><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href=/archives/ ><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href=/random/ ><i class="fa-fw fas fa-random"></i><span> 随便逛逛</span></a></li></ul></div><div class=menus_item><a class=site-page href=/weekly/ ><i class="fa-fw fas fa-newspaper"></i><span> 周报</span></a></div><div class=menus_item><a class=site-page href=/leetcode/ ><i class="fa-fw fas fa-newspaper"></i><span> 刷题</span></a></div><div class=menus_item><a class="site-page group" href=javascript:void(0); rel="external nofollow noreferrer"><i class="fa-fw fas fa-heart"></i><span> 我的</span><i class="fas fa-chevron-down"></i></a><ul class=menus_item_child><li><a class="site-page child" href=/about/ ><i class="fa-fw fas fa-spa"></i><span> 关于</span></a></li><li><a class="site-page child" href=/weekly/ ><i class="fa-fw fas fa-newspaper"></i><span> 周报</span></a></li></ul></div></div></div></div><div class=post id=body-wrap><header class=post-bg id=page-header style=background-image:url(https://cdn.pixabay.com/photo/2023/01/14/19/50/flower-7718952_1280.jpg)><nav id=nav><span id=blog-info><a href=/ title=Manjusaka><img class=site-icon src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://avatars.githubusercontent.com/u/7054676?v=4# image"><span class=site-name>Manjusaka</span></a></span><div id=menus><div id=search-button><a class="site-page social-icon search" href=javascript:void(0); rel="external nofollow noreferrer"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class=menus_items><div class=menus_item><a class=site-page href=/ ><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class=menus_item><a class="site-page group" href=javascript:void(0); rel="external nofollow noreferrer"><i class="fa-fw fa-fw fas fa-lines-leaning"></i><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class=menus_item_child><li><a class="site-page child" href=/categories/ ><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href=/tags/ ><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href=/archives/ ><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href=/random/ ><i class="fa-fw fas fa-random"></i><span> 随便逛逛</span></a></li></ul></div><div class=menus_item><a class=site-page href=/weekly/ ><i class="fa-fw fas fa-newspaper"></i><span> 周报</span></a></div><div class=menus_item><a class=site-page href=/leetcode/ ><i class="fa-fw fas fa-newspaper"></i><span> 刷题</span></a></div><div class=menus_item><a class="site-page group" href=javascript:void(0); rel="external nofollow noreferrer"><i class="fa-fw fas fa-heart"></i><span> 我的</span><i class="fas fa-chevron-down"></i></a><ul class=menus_item_child><li><a class="site-page child" href=/about/ ><i class="fa-fw fas fa-spa"></i><span> 关于</span></a></li><li><a class="site-page child" href=/weekly/ ><i class="fa-fw fas fa-newspaper"></i><span> 周报</span></a></li></ul></div></div><div id=toggle-menu><a class=site-page href=javascript:void(0); rel="external nofollow noreferrer"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id=post-info><h1 class=post-title>How to Run CPython for WASI Using WASMTIME and Extend It with Python-Implemented Host Functions?<a class=post-edit-link href=https://github.com/Zheaoli/Zheaoli.github.io/edit/main/source/_posts/how-to-extend-the-wasi-python-by-using-host-function-en.md rel="external nofollow noreferrer" title="Edited on" target=_blank><i class="fas fa-pencil-alt"></i></a></h1><div id=post-meta><div class=meta-firstline><span class=post-meta-date><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class=post-meta-label>Created</span><time datetime=2024-10-02T13:00:00.000Z title="Created 2024-10-02 21:00:00">2024-10-02</time></span><span class=post-meta-categories><span class=post-meta-separator>|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class=post-meta-categories href=/categories/Programming/ >Programming</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class=post-meta-categories href=/categories/Programming/CPython/ >CPython</a></span></div><div class=meta-secondline><span class=post-meta-separator>|</span><span class=post-meta-wordcount><i class="far fa-file-word fa-fw post-meta-icon"></i><span class=post-meta-label>Word Count:</span><span class=word-count>2.2k</span><span class=post-meta-separator>|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class=post-meta-label>Reading Time:</span><span>13mins</span></span><span class=post-meta-separator>|</span><span class=post-meta-pv-cv id="" data-flag-title="How to Run CPython for WASI Using WASMTIME and Extend It with Python-Implemented Host Functions?"><i class="far fa-eye fa-fw post-meta-icon"></i><span class=post-meta-label>Post Views:</span><span id=busuanzi_value_page_pv><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class=layout id=content-inner><div id=post><article class=post-content id=article-container><p>During the National Day holiday, I worked on a project to use wasmtime to execute CPython virtual machine compiled into WASM/WASI bytecode, and extend it with Host Functions implemented in Python on the host side.</p><p>I’d like to clarify again that this is just a personal project I wanted to work on, without any validation in production environments, just for fun (XDDD</p><span id=more></span><h2 id=Main-Content><a href=#Main-Content class=headerlink title="Main Content"></a>Main Content</h2><p>First, let’s briefly introduce WASM/WASI. Here, I’ll directly quote an AI-generated brief summary:</p><blockquote><p>WebAssembly (WASM) is a low-level programming language that can run in modern web browsers. It provides near-native performance.<br>WebAssembly System Interface (WASI) is a standard extension of WASM that allows WASM programs to run outside the browser and access system resources.<br>These two technologies aim to improve Web application performance and make WASM available in more environments.</p></blockquote><p>The core advantages of the WASM/WASI technology route are:</p><ol><li>Cross-platform compatibility</li><li>Multi-language support through static compilation</li><li>Security brought by Native Sandbox</li></ol><p>Therefore, WASM/WASI is not only widely used in browsers but is also gradually expanding to the server-side. Scenarios such as Serverless Compute, Database UDF, and Gateway Plugin are gradually being rolled out.</p><p>While reviewing CPython code recently, I suddenly had an idea: what if I use WASM/WASI Runtime to run CPython, and then extend it with Host Functions implemented in Python on the host side? This seems to be helpful for scenarios like data PaaS that allows users to upload custom code. Of course, the main reason is that this idea seems quite interesting.</p><p>Before we continue, let’s thank one person, Brett Cannon, who almost single-handedly completed the support for CPython WASM/WASI. Say thank you to Brett Cannon with me!</p><p>The overall WASM/WASI evolution route of CPython is as follows:</p><ol><li>As early as November 2021, WASM was supported through emscripten, see BPO-40280<a href=#refer-anchor-1><sup>1</sup></a></li><li>It became an officially supported Tier3 platform in June 2023 (or earlier?)</li><li>It became an officially supported Tier2 platform in March 2024, see GH-116314<a href=#refer-anchor-2><sup>2</sup></a></li><li>Starting from Python 3.13, the traditional emscripten method of WASM/WASI support will be abandoned</li></ol><p>OK, let’s start by compiling CPython into WASM/WASI bytecode. You need to set up your environment in advance and make sure WASI-SDK is installed. To save time, I directly use the official devcontainer for all operations.</p><p>After setting up the devcontainer with vscode, we can compile by executing <code>python3 Tools/wasm/wasi.py build -- --config-cache --with-pydebug</code>. To save time, I removed the part in wasi.py that pre-compiles CPython:</p><figure class="highlight python"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre></td><td class=code><pre><span class=line><span class=keyword>def</span> <span class="title function_">build_all</span>(<span class=params>context</span>):</span><br><span class=line>    <span class=string>&quot;&quot;&quot;Build everything.&quot;&quot;&quot;</span></span><br><span class=line>    steps = [</span><br><span class=line>            <span class=comment>#configure_build_python,</span></span><br><span class=line>            <span class=comment>#make_build_python,</span></span><br><span class=line>            configure_wasi_python,</span><br><span class=line>            make_wasi_python</span><br><span class=line>        ]</span><br></pre></td></tr></table></figure><p>After compilation, we can run our CPython using <code>cross-build/wasm32-wasi/python.sh</code>. This is actually a wrapper for the WASMTIME command:</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line><span class=meta>#!/bin/sh</span></span><br><span class=line><span class=built_in>exec</span> /usr/local/bin/wasmtime run --wasm max-wasm-stack=16777216 --wasi preview2 --<span class=built_in>dir</span> /workspaces/cpython-wasi::/ --<span class=built_in>env</span> PYTHONPATH=/cross-build/wasm32-wasi/build/lib.wasi-wasm32-3.14-pydebug /workspaces/cpython-wasi/cross-build/wasm32-wasi/python.wasm <span class=string>&quot;<span class=variable>$@</span>&quot;</span></span><br></pre></td></tr></table></figure><p>We can see that the officially recommended WASM/WASI Runtime is wasmtime, so we’ll use wasmtime for our next steps.</p><p>Since we want to use Host Functions to extend this process later, we’ll rewrite the bash part. Initially, I used wasmtime’s Python binding, and the code looked roughly like this:</p><figure class="highlight python"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br></pre></td><td class=code><pre><span class=line><span class=keyword>from</span> wasmtime <span class=keyword>import</span> Linker, Engine, Store, WasiConfig, Module, FuncType, ValType, _bindings, Config</span><br><span class=line><span class=keyword>import</span> sys</span><br><span class=line></span><br><span class=line><span class=keyword>def</span> <span class="title function_">test_wasi</span>():</span><br><span class=line>    linker = Linker(Engine())</span><br><span class=line>    linker.define_wasi()</span><br><span class=line>    <span class=keyword>with</span> <span class=built_in>open</span>(<span class=string>&quot;/workspaces/cpython-wasi/cross-build/wasm32-wasi/python.wasm&quot;</span>, <span class=string>&quot;rb&quot;</span>) <span class=keyword>as</span> file:</span><br><span class=line>        module = Module(linker.engine, file.read())</span><br><span class=line>    <span class=keyword>def</span> <span class="title function_">foor_bar</span>(<span class=params>a, b</span>):</span><br><span class=line>        <span class=keyword>return</span> a + b</span><br><span class=line>    linker.define_func(<span class=string>&quot;demo&quot;</span>, <span class=string>&quot;demo&quot;</span>, FuncType([ValType.i32(),ValType.i32()],[ValType.i32()]), foor_bar)</span><br><span class=line>    store = Store(linker.engine)</span><br><span class=line>    config = Config()</span><br><span class=line>    _bindings.wasmtime_config_max_wasm_stack_set(config.ptr(), <span class=number>16777216</span>)</span><br><span class=line>    wasi_config = WasiConfig()</span><br><span class=line>    <span class=comment># wasi_config.stdin_file = sys.stdin.fileno()</span></span><br><span class=line>    <span class=comment># wasi_config.stdout_file = sys.stdout.fileno()</span></span><br><span class=line>    <span class=comment># wasi_config.stderr_file = sys.stderr.fileno()</span></span><br><span class=line>    wasi_config.env = [[<span class=string>&quot;PYTHONPATH&quot;</span>, <span class=string>&quot;/cross-build/wasm32-wasi/build/lib.wasi-wasm32-3.14-pydebug&quot;</span>]]</span><br><span class=line>    wasi_config.inherit_stdout()</span><br><span class=line>    wasi_config.inherit_stderr()</span><br><span class=line>    wasi_config.inherit_stdin()</span><br><span class=line>    wasi_config.preopen_dir(<span class=string>&quot;/workspaces/cpython-wasi&quot;</span>,<span class=string>&quot;/&quot;</span>)</span><br><span class=line>    store.set_wasi(wasi_config)</span><br><span class=line></span><br><span class=line>    instance=linker.instantiate(store, module)</span><br><span class=line>    instance.exports(store)[<span class=string>&quot;_start&quot;</span>](store)</span><br><span class=line></span><br><span class=line>test_wasi()</span><br></pre></td></tr></table></figure><p>Since wasmtime’s Python binding is a direct ctype wrapper, many config options are not exposed in the public API (such as using wasmtime_config_max_wasm_stack_set to handle WASM’s stack), which leads to many operations requiring the use of unexposed private APIs. This is too tricky, so I chose to reimplement this set of operations using Rust:</p><figure class="highlight rust"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br></pre></td><td class=code><pre><span class=line><span class=keyword>use</span> wasmtime::*;</span><br><span class=line><span class=keyword>use</span> wasmtime_wasi::preview1::&#123;<span class=keyword>self</span>&#125;;</span><br><span class=line><span class=keyword>use</span> wasmtime_wasi::WasiCtxBuilder;</span><br><span class=line><span class=keyword>fn</span> <span class="title function_">main</span>() &#123;</span><br><span class=line>    <span class=keyword>let</span> <span class=keyword>mut </span><span class=variable>config</span> = Config::<span class="title function_ invoke__">new</span>();</span><br><span class=line>    config.<span class="title function_ invoke__">max_wasm_stack</span>(<span class=number>16777216</span>);</span><br><span class=line>    <span class=keyword>match</span> Engine::<span class="title function_ invoke__">new</span>(&amp;config) &#123;</span><br><span class=line>        <span class="title function_ invoke__">Ok</span>(engine) =&gt; &#123;</span><br><span class=line>            <span class=keyword>let</span> <span class=keyword>mut </span><span class=variable>linker</span> = Linker::<span class="title function_ invoke__">new</span>(&amp;engine);</span><br><span class=line>            preview1::<span class="title function_ invoke__">add_to_linker_sync</span>(&amp;<span class=keyword>mut</span> linker, |t| t).<span class="title function_ invoke__">unwrap</span>();</span><br><span class=line>            linker.<span class="title function_ invoke__">allow_unknown_exports</span>(<span class=literal>true</span>);</span><br><span class=line>            <span class=keyword>let</span> <span class=keyword>mut </span><span class=variable>builder</span> = WasiCtxBuilder::<span class="title function_ invoke__">new</span>();</span><br><span class=line>            builder.<span class="title function_ invoke__">inherit_stdio</span>();</span><br><span class=line>            builder.<span class="title function_ invoke__">env</span>(</span><br><span class=line>                <span class=string>&quot;PYTHONPATH&quot;</span>,</span><br><span class=line>                <span class=string>&quot;/cross-build/wasm32-wasi/build/lib.wasi-wasm32-3.14-pydebug&quot;</span>,</span><br><span class=line>            );</span><br><span class=line>            builder</span><br><span class=line>                .<span class="title function_ invoke__">preopened_dir</span>(</span><br><span class=line>                    <span class=string>&quot;/workspaces/cpython-wasi&quot;</span>,</span><br><span class=line>                    <span class=string>&quot;/&quot;</span>,</span><br><span class=line>                    wasmtime_wasi::DirPerms::<span class="title function_ invoke__">all</span>(),</span><br><span class=line>                    wasmtime_wasi::FilePerms::<span class="title function_ invoke__">all</span>(),</span><br><span class=line>                )</span><br><span class=line>                .<span class="title function_ invoke__">unwrap</span>();</span><br><span class=line>            builder.<span class="title function_ invoke__">args</span>(&amp;[<span class=string>&quot;--&quot;</span>, <span class=string>&quot;--version&quot;</span>]);</span><br><span class=line>            <span class=keyword>let</span> <span class=variable>wasi_ctx</span> = builder.<span class="title function_ invoke__">build_p1</span>();</span><br><span class=line>            <span class=keyword>let</span> <span class=keyword>mut </span><span class=variable>store</span> = Store::<span class="title function_ invoke__">new</span>(&amp;engine, wasi_ctx);</span><br><span class=line>            <span class=keyword>let</span> <span class=variable>module</span> = Module::<span class="title function_ invoke__">from_file</span>(</span><br><span class=line>                &amp;engine,</span><br><span class=line>                <span class=string>&quot;/workspaces/cpython-wasi/cross-build/wasm32-wasi/python.wasm&quot;</span>,</span><br><span class=line>            )</span><br><span class=line>            .<span class="title function_ invoke__">unwrap</span>();</span><br><span class=line>            <span class=keyword>let</span> <span class=variable>instance</span> = linker.<span class="title function_ invoke__">instantiate</span>(&amp;<span class=keyword>mut</span> store, &amp;module).<span class="title function_ invoke__">unwrap</span>();</span><br><span class=line>            <span class=keyword>let</span> <span class=variable>run</span> = instance</span><br><span class=line>                .get_typed_func::&lt;(), ()&gt;(&amp;<span class=keyword>mut</span> store, <span class=string>&quot;_start&quot;</span>)</span><br><span class=line>                .<span class="title function_ invoke__">unwrap</span>();</span><br><span class=line>            run.<span class="title function_ invoke__">call</span>(&amp;<span class=keyword>mut</span> store, ()).<span class="title function_ invoke__">unwrap</span>();</span><br><span class=line>            <span class=keyword>return</span>;</span><br><span class=line>        &#125;</span><br><span class=line>        <span class="title function_ invoke__">Err</span>(e) =&gt; &#123;</span><br><span class=line>            <span class=built_in>println!</span>(<span class=string>&quot;Error creating engine: &#123;:?&#125;&quot;</span>, e);</span><br><span class=line>            <span class=keyword>return</span>;</span><br><span class=line>        &#125;</span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>Then we execute the code, success!</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre></td><td class=code><pre><span class=line>[root@267e91be24fd wasmtime-demo]# cargo run --release</span><br><span class=line>   Compiling wasmtime-demo v0.1.0 (/workspaces/wasmtime-demo)</span><br><span class=line>    Finished `release` profile [optimized] target(s) <span class=keyword>in</span> 1.81s</span><br><span class=line>     Running `target/release/wasmtime-demo`</span><br><span class=line>Python 3.14.0a0</span><br></pre></td></tr></table></figure><p>Now let’s extend our CPython. First, note that since dlopen is not supported in WASM/WASI for CPython, we need to modify the Python core itself.</p><p>First, we add a new file in Python’s Modules directory, named <code>demo.c</code>, with the following content:</p><figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br></pre></td><td class=code><pre><span class=line><span class=meta>#<span class=keyword>include</span> <span class=string>&lt;Python.h&gt;</span></span></span><br><span class=line></span><br><span class=line><span class=keyword>extern</span> <span class=type>int</span> <span class="title function_">demo</span><span class=params>(<span class=type>int</span> a, <span class=type>int</span> b)</span> &#123;</span><br><span class=line>	<span class=keyword>return</span> a + b;</span><br><span class=line>&#125;</span><br><span class=line><span class=type>static</span> PyObject *</span><br><span class=line><span class="title function_">foo_bar</span><span class=params>(PyObject *self, PyObject *args)</span></span><br><span class=line>&#123;</span><br><span class=line>	Py_INCREF(PyExc_TypeError);</span><br><span class=line>	<span class=keyword>return</span> PyLong_FromLong((<span class=type>long</span>) demo(<span class=number>1</span>, <span class=number>2</span>));</span><br><span class=line>&#125;</span><br><span class=line></span><br><span class=line><span class=type>static</span> PyMethodDef foomethods[] = &#123;</span><br><span class=line>	&#123;<span class=string>&quot;bar&quot;</span>, foo_bar, METH_VARARGS, <span class=string>&quot;&quot;</span>&#125;,</span><br><span class=line>	&#123;<span class=literal>NULL</span>, <span class=literal>NULL</span>, <span class=number>0</span>, <span class=literal>NULL</span>&#125;,</span><br><span class=line>&#125;;</span><br><span class=line></span><br><span class=line><span class=type>static</span> PyModuleDef foomodule = &#123;</span><br><span class=line>	PyModuleDef_HEAD_INIT,</span><br><span class=line>	.m_name = <span class=string>&quot;demo&quot;</span>,</span><br><span class=line>	.m_doc = <span class=string>&quot;foo test module&quot;</span>,</span><br><span class=line>	.m_size = <span class=number>-1</span>,</span><br><span class=line>	.m_methods = foomethods,</span><br><span class=line>&#125;;</span><br><span class=line></span><br><span class=line>PyMODINIT_FUNC</span><br><span class=line><span class="title function_">PyInit_demo</span><span class=params>(<span class=type>void</span>)</span></span><br><span class=line>&#123;</span><br><span class=line>	<span class=keyword>return</span> PyModule_Create(&amp;foomodule);</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>Then we add a line in <code>Modules/Setup.bootstrap.in</code>:</p><figure class="highlight text"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>demo demo.c</span><br></pre></td></tr></table></figure><p>Next, we re-execute the command <code>python3 Tools/wasm/wasi.py build -- --config-cache --with-pydebug</code> to generate new WASM/WASI bytecode. Then we change the args part in our previous Rust code to <code>[&quot;--&quot;, &quot;-c&quot;, &quot;import demo; print(demo.bar())&quot;]</code>, and re-execute the code, success!</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre></td><td class=code><pre><span class=line>[root@267e91be24fd wasmtime-demo]# cargo run --release</span><br><span class=line>   Compiling wasmtime-demo v0.1.0 (/workspaces/wasmtime-demo)</span><br><span class=line>    Finished `release` profile [optimized] target(s) <span class=keyword>in</span> 1.73s</span><br><span class=line>     Running `target/release/wasmtime-demo`</span><br><span class=line>3</span><br></pre></td></tr></table></figure><p>Now, we have an extension module, demo.c, but the problem is that the core <code>demo</code> function in our current demo.c is hardcoded. So we need to handle this.</p><p>Typically, in regular practice, we can separate the implementation and definition of functions to facilitate dynamic linking. WASM/WASI is similar, but requires additional handling:</p><figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre></td><td class=code><pre><span class=line><span class=keyword>extern</span> <span class=type>int</span> <span class="title function_">demo</span><span class=params>(<span class=type>int</span> a, <span class=type>int</span> b)</span> __<span class="title function_">attribute__</span><span class=params>((</span></span><br><span class=line><span class=params>    __import_module__(<span class=string>&quot;demo&quot;</span>),</span></span><br><span class=line><span class=params>    __import_name__(<span class=string>&quot;demo&quot;</span>),</span></span><br><span class=line><span class=params>))</span>;</span><br></pre></td></tr></table></figure><p>Here, we use extended macro definitions to tell the compiler at compile time that the demo function is imported from the demo module. This way, we can extend it in subsequent Host Functions according to the convention.</p><p>Then we need to modify CPython’s compilation script, adding <code>-Wextra -Wl,--allow-undefined</code> to the compilation parameters.</p><p>Next, re-execute <code>python3 Tools/wasm/wasi.py build -- --config-cache --with-pydebug</code> to generate new WASM/WASI bytecode. At this point, we can first execute <code>python.sh</code>, and we’ll get an error:</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre></td><td class=code><pre><span class=line>Error: failed to run main module `/workspaces/cpython-wasi/cross-build/wasm32-wasi/python.wasm`</span><br><span class=line></span><br><span class=line>Caused by:</span><br><span class=line>    0: failed to instantiate <span class=string>&quot;/workspaces/cpython-wasi/cross-build/wasm32-wasi/python.wasm&quot;</span></span><br><span class=line>    1: unknown import: `demo::demo` has not been defined</span><br></pre></td></tr></table></figure><p>This is as expected.</p><p>So now let’s reprocess our Rust code:</p><figure class="highlight rust"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br></pre></td><td class=code><pre><span class=line><span class=keyword>use</span> wasmtime::*;</span><br><span class=line><span class=keyword>use</span> wasmtime_wasi::preview1::&#123;<span class=keyword>self</span>&#125;;</span><br><span class=line><span class=keyword>use</span> wasmtime_wasi::WasiCtxBuilder;</span><br><span class=line><span class=keyword>fn</span> <span class="title function_">main</span>() &#123;</span><br><span class=line>    <span class=keyword>let</span> <span class=keyword>mut </span><span class=variable>config</span> = Config::<span class="title function_ invoke__">new</span>();</span><br><span class=line>    config.<span class="title function_ invoke__">max_wasm_stack</span>(<span class=number>16777216</span>);</span><br><span class=line>    <span class=keyword>match</span> Engine::<span class="title function_ invoke__">new</span>(&amp;config) &#123;</span><br><span class=line>        <span class="title function_ invoke__">Ok</span>(engine) =&gt; &#123;</span><br><span class=line>            <span class=keyword>let</span> <span class=keyword>mut </span><span class=variable>linker</span> = Linker::<span class="title function_ invoke__">new</span>(&amp;engine);</span><br><span class=line>            preview1::<span class="title function_ invoke__">add_to_linker_sync</span>(&amp;<span class=keyword>mut</span> linker, |t| t).<span class="title function_ invoke__">unwrap</span>();</span><br><span class=line>            linker</span><br><span class=line>                .<span class="title function_ invoke__">func_wrap</span>(<span class=string>&quot;demo&quot;</span>, <span class=string>&quot;demo&quot;</span>, |a: <span class=type>i32</span>, b: <span class=type>i32</span>| &#123;</span><br><span class=line>                    (a+b)*<span class=number>10</span></span><br><span class=line>                &#125;)</span><br><span class=line>                .<span class="title function_ invoke__">unwrap</span>();</span><br><span class=line>            linker.<span class="title function_ invoke__">allow_unknown_exports</span>(<span class=literal>true</span>);</span><br><span class=line>            <span class=keyword>let</span> <span class=keyword>mut </span><span class=variable>builder</span> = WasiCtxBuilder::<span class="title function_ invoke__">new</span>();</span><br><span class=line>            builder.<span class="title function_ invoke__">inherit_stdio</span>();</span><br><span class=line>            builder.<span class="title function_ invoke__">env</span>(</span><br><span class=line>                <span class=string>&quot;PYTHONPATH&quot;</span>,</span><br><span class=line>                <span class=string>&quot;/cross-build/wasm32-wasi/build/lib.wasi-wasm32-3.14-pydebug&quot;</span>,</span><br><span class=line>            );</span><br><span class=line>            builder</span><br><span class=line>                .<span class="title function_ invoke__">preopened_dir</span>(</span><br><span class=line>                    <span class=string>&quot;/workspaces/cpython-wasi&quot;</span>,</span><br><span class=line>                    <span class=string>&quot;/&quot;</span>,</span><br><span class=line>                    wasmtime_wasi::DirPerms::<span class="title function_ invoke__">all</span>(),</span><br><span class=line>                    wasmtime_wasi::FilePerms::<span class="title function_ invoke__">all</span>(),</span><br><span class=line>                )</span><br><span class=line>                .<span class="title function_ invoke__">unwrap</span>();</span><br><span class=line>            builder.<span class="title function_ invoke__">args</span>(&amp;[<span class=string>&quot;--&quot;</span>, <span class=string>&quot;-c&quot;</span>, <span class=string>&quot;import demo; print(demo.bar())&quot;</span>]);</span><br><span class=line>            <span class=keyword>let</span> <span class=variable>wasi_ctx</span> = builder.<span class="title function_ invoke__">build_p1</span>();</span><br><span class=line>            <span class=keyword>let</span> <span class=keyword>mut </span><span class=variable>store</span> = Store::<span class="title function_ invoke__">new</span>(&amp;engine, wasi_ctx);</span><br><span class=line>            <span class=keyword>let</span> <span class=variable>module</span> = Module::<span class="title function_ invoke__">from_file</span>(</span><br><span class=line>                &amp;engine,</span><br><span class=line>                <span class=string>&quot;/workspaces/cpython-wasi/cross-build/wasm32-wasi/python.wasm&quot;</span>,</span><br><span class=line>            )</span><br><span class=line>            .<span class="title function_ invoke__">unwrap</span>();</span><br><span class=line>            <span class=keyword>let</span> <span class=variable>instance</span> = linker.<span class="title function_ invoke__">instantiate</span>(&amp;<span class=keyword>mut</span> store, &amp;module).<span class="title function_ invoke__">unwrap</span>();</span><br><span class=line>            <span class=keyword>let</span> <span class=variable>run</span> = instance</span><br><span class=line>                .get_typed_func::&lt;(), ()&gt;(&amp;<span class=keyword>mut</span> store, <span class=string>&quot;_start&quot;</span>)</span><br><span class=line>                .<span class="title function_ invoke__">unwrap</span>();</span><br><span class=line>            run.<span class="title function_ invoke__">call</span>(&amp;<span class=keyword>mut</span> store, ()).<span class="title function_ invoke__">unwrap</span>();</span><br><span class=line>            <span class=keyword>return</span>;</span><br><span class=line>        &#125;</span><br><span class=line>        <span class="title function_ invoke__">Err</span>(e) =&gt; &#123;</span><br><span class=line>            <span class=built_in>println!</span>(<span class=string>&quot;Error creating engine: &#123;:?&#125;&quot;</span>, e);</span><br><span class=line>            <span class=keyword>return</span>;</span><br><span class=line>        &#125;</span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>Execute it, and we get the result:</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre></td><td class=code><pre><span class=line>[root@267e91be24fd wasmtime-demo]# cargo run --release</span><br><span class=line>   Compiling wasmtime-demo v0.1.0 (/workspaces/wasmtime-demo)</span><br><span class=line>    Finished `release` profile [optimized] target(s) <span class=keyword>in</span> 1.79s</span><br><span class=line>     Running `target/release/wasmtime-demo`</span><br><span class=line>30</span><br></pre></td></tr></table></figure><p>As expected.</p><p>Alright, now we support Host Functions, and we can modify our logic arbitrarily while adhering to the function signature. But do you remember the title of this article? We want to execute Python-implemented Host Functions. Hmm, although it’s a bit roundabout, it’s not impossible. Let’s directly bring out PyO3 and modify our Rust code as follows:</p><figure class="highlight rust"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br><span class=line>65</span><br><span class=line>66</span><br><span class=line>67</span><br><span class=line>68</span><br><span class=line>69</span><br></pre></td><td class=code><pre><span class=line><span class=keyword>use</span> pyo3::prelude::*;</span><br><span class=line><span class=keyword>use</span> pyo3::types::PyTuple;</span><br><span class=line><span class=keyword>use</span> wasmtime::*;</span><br><span class=line><span class=keyword>use</span> wasmtime_wasi::preview1::&#123;<span class=keyword>self</span>&#125;;</span><br><span class=line><span class=keyword>use</span> wasmtime_wasi::WasiCtxBuilder;</span><br><span class=line><span class=keyword>fn</span> <span class="title function_">main</span>() &#123;</span><br><span class=line>    <span class=keyword>let</span> <span class=keyword>mut </span><span class=variable>config</span> = Config::<span class="title function_ invoke__">new</span>();</span><br><span class=line>    config.<span class="title function_ invoke__">max_wasm_stack</span>(<span class=number>16777216</span>);</span><br><span class=line>    <span class=keyword>match</span> Engine::<span class="title function_ invoke__">new</span>(&amp;config) &#123;</span><br><span class=line>        <span class="title function_ invoke__">Ok</span>(engine) =&gt; &#123;</span><br><span class=line>            <span class=keyword>let</span> <span class=keyword>mut </span><span class=variable>linker</span> = Linker::<span class="title function_ invoke__">new</span>(&amp;engine);</span><br><span class=line>            preview1::<span class="title function_ invoke__">add_to_linker_sync</span>(&amp;<span class=keyword>mut</span> linker, |t| t).<span class="title function_ invoke__">unwrap</span>();</span><br><span class=line>            linker</span><br><span class=line>                .<span class="title function_ invoke__">func_wrap</span>(<span class=string>&quot;demo&quot;</span>, <span class=string>&quot;demo&quot;</span>, |a: <span class=type>i32</span>, b: <span class=type>i32</span>| &#123;</span><br><span class=line>                    Python::<span class="title function_ invoke__">with_gil</span>(|py| &#123;</span><br><span class=line>                        <span class=keyword>let</span> <span class=variable>fun</span>: Py&lt;PyAny&gt; = PyModule::<span class="title function_ invoke__">from_code_bound</span>(</span><br><span class=line>                            py,</span><br><span class=line>                            <span class=string>&quot;def example(*args, **kwargs):</span></span><br><span class=line><span class=string>                                return (args[0] + args[1])*11&quot;</span>,</span><br><span class=line>                            <span class=string>&quot;&quot;</span>,</span><br><span class=line>                            <span class=string>&quot;&quot;</span>,</span><br><span class=line>                        )</span><br><span class=line>                        .<span class="title function_ invoke__">unwrap</span>()</span><br><span class=line>                        .<span class="title function_ invoke__">getattr</span>(<span class=string>&quot;example&quot;</span>)</span><br><span class=line>                        .<span class="title function_ invoke__">unwrap</span>()</span><br><span class=line>                        .<span class="title function_ invoke__">into</span>();</span><br><span class=line>                        <span class=keyword>let</span> <span class=variable>args</span> = PyTuple::<span class="title function_ invoke__">new_bound</span>(py, &amp;[a, b]);</span><br><span class=line>                        <span class=comment>// cast following to int</span></span><br><span class=line></span><br><span class=line>                        fun.<span class="title function_ invoke__">call1</span>(py, args).<span class="title function_ invoke__">unwrap</span>().extract::&lt;<span class=type>i32</span>&gt;(py).<span class="title function_ invoke__">unwrap</span>()</span><br><span class=line>                    &#125;)</span><br><span class=line>                &#125;)</span><br><span class=line>                .<span class="title function_ invoke__">unwrap</span>();</span><br><span class=line>            linker.<span class="title function_ invoke__">allow_unknown_exports</span>(<span class=literal>true</span>);</span><br><span class=line>            <span class=keyword>let</span> <span class=keyword>mut </span><span class=variable>builder</span> = WasiCtxBuilder::<span class="title function_ invoke__">new</span>();</span><br><span class=line>            builder.<span class="title function_ invoke__">inherit_stdio</span>();</span><br><span class=line>            builder.<span class="title function_ invoke__">env</span>(</span><br><span class=line>                <span class=string>&quot;PYTHONPATH&quot;</span>,</span><br><span class=line>                <span class=string>&quot;/cross-build/wasm32-wasi/build/lib.wasi-wasm32-3.14-pydebug&quot;</span>,</span><br><span class=line>            );</span><br><span class=line>            builder</span><br><span class=line>                .<span class="title function_ invoke__">preopened_dir</span>(</span><br><span class=line>                    <span class=string>&quot;/workspaces/cpython-wasi&quot;</span>,</span><br><span class=line>                    <span class=string>&quot;/&quot;</span>,</span><br><span class=line>                    wasmtime_wasi::DirPerms::<span class="title function_ invoke__">all</span>(),</span><br><span class=line>                    wasmtime_wasi::FilePerms::<span class="title function_ invoke__">all</span>(),</span><br><span class=line>                )</span><br><span class=line>                .<span class="title function_ invoke__">unwrap</span>();</span><br><span class=line>            builder.<span class="title function_ invoke__">args</span>(&amp;[<span class=string>&quot;--&quot;</span>, <span class=string>&quot;-c&quot;</span>, <span class=string>&quot;import demo; print(demo.bar())&quot;</span>]);</span><br><span class=line>            <span class=keyword>let</span> <span class=variable>wasi_ctx</span> = builder.<span class="title function_ invoke__">build_p1</span>();</span><br><span class=line>            <span class=keyword>let</span> <span class=keyword>mut </span><span class=variable>store</span> = Store::<span class="title function_ invoke__">new</span>(&amp;engine, wasi_ctx);</span><br><span class=line>            <span class=keyword>let</span> <span class=variable>module</span> = Module::<span class="title function_ invoke__">from_file</span>(</span><br><span class=line>                &amp;engine,</span><br><span class=line>                <span class=string>&quot;/workspaces/cpython-wasi/cross-build/wasm32-wasi/python.wasm&quot;</span>,</span><br><span class=line>            )</span><br><span class=line>            .<span class="title function_ invoke__">unwrap</span>();</span><br><span class=line>            <span class=keyword>let</span> <span class=variable>instance</span> = linker.<span class="title function_ invoke__">instantiate</span>(&amp;<span class=keyword>mut</span> store, &amp;module).<span class="title function_ invoke__">unwrap</span>();</span><br><span class=line>            <span class=keyword>let</span> <span class=variable>run</span> = instance</span><br><span class=line>                .get_typed_func::&lt;(), ()&gt;(&amp;<span class=keyword>mut</span> store, <span class=string>&quot;_start&quot;</span>)</span><br><span class=line>                .<span class="title function_ invoke__">unwrap</span>();</span><br><span class=line>            run.<span class="title function_ invoke__">call</span>(&amp;<span class=keyword>mut</span> store, ()).<span class="title function_ invoke__">unwrap</span>();</span><br><span class=line>            <span class=keyword>return</span>;</span><br><span class=line>        &#125;</span><br><span class=line>        <span class="title function_ invoke__">Err</span>(e) =&gt; &#123;</span><br><span class=line>            <span class=built_in>println!</span>(<span class=string>&quot;Error creating engine: &#123;:?&#125;&quot;</span>, e);</span><br><span class=line>            <span class=keyword>return</span>;</span><br><span class=line>        &#125;</span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>Then execute it, and we get the result:</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre></td><td class=code><pre><span class=line>[root@267e91be24fd wasmtime-demo]# cargo run --release</span><br><span class=line>   Compiling wasmtime-demo v0.1.0 (/workspaces/wasmtime-demo)</span><br><span class=line>    Finished `release` profile [optimized] target(s) <span class=keyword>in</span> 1.75s</span><br><span class=line>     Running `target/release/wasmtime-demo`</span><br><span class=line>33</span><br></pre></td></tr></table></figure><p>OK, we succeeded!</p><h2 id=Summary><a href=#Summary class=headerlink title=Summary></a>Summary</h2><p>This article is actually a Proof of Concept (PoC) for a technical route, verifying the possibility of combining Python and WASI in specific situations. However, it also exposes some problems:</p><ol><li>The lack of dlopen support requires modifying the CPython runtime code itself. However, according to information provided in Brett Cannon’s blog, someone has hacked this part of the code to provide support. It feels like we can follow up on this later.</li><li>The wasmtime Python binding is really difficult to use. We could consider wrapping it once based on PyO3.</li><li>Using Rust to handle wasmtime and PyO3 to call Python code currently has the problem that Python VM objects cannot be shared across threads. We might need to encapsulate a set of channels similar to Golang based on Rust to reuse the virtual machine and pass data.</li></ol><p>However, overall, this PoC is still very interesting. I hope friends can also have fun playing with it.</p><h2 id=References><a href=#References class=headerlink title=References></a>References</h2><div id=refer-anchor-1></div><ul><li>[1]. <a target=_blank rel="noopener external nofollow noreferrer" href=https://bugs.python.org/issue40280>https://bugs.python.org/issue40280</a></li></ul><div id=refer-anchor-2></div><ul><li>[2]. <a target=_blank rel="noopener external nofollow noreferrer" href=https://github.com/python/cpython/issues/116314>https://github.com/python/cpython/issues/116314</a></li></ul></article><div class=post-copyright><div class=post-copyright__author><span class=post-copyright-meta><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class=post-copyright-info><a target=_blank rel="noopener external nofollow noreferrer" href=https://github.com/Zheaoli>Manjusaka</a></span></div><div class=post-copyright__type><span class=post-copyright-meta><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class=post-copyright-info><a href=https://www.manjusaka.blog/posts/2024/10/02/how-to-extend-the-wasi-python-by-using-host-function-en/ >https://www.manjusaka.blog/posts/2024/10/02/how-to-extend-the-wasi-python-by-using-host-function-en/</a></span></div><div class=post-copyright__notice><span class=post-copyright-meta><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class=post-copyright-info>All articles in this blog are licensed under <a target=_blank rel="noopener external nofollow noreferrer" href=https://creativecommons.org/licenses/by-nc-sa/4.0/ >CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class=tag_share><div class=post-meta__tag-list><a class=post-meta__tags href=/tags/CPython/ >CPython</a><a class=post-meta__tags href=/tags/Programming/ >Programming</a><a class=post-meta__tags href=/tags/Notes/ >Notes</a><a class=post-meta__tags href=/tags/WASI/ >WASI</a><a class=post-meta__tags href=/tags/WASM/ >WASM</a><a class=post-meta__tags href=/tags/Blog/ >Blog</a></div><div class=post_share><div class=social-share data-image=https://cdn.pixabay.com/photo/2023/01/14/19/50/flower-7718952_1280.jpg data-sites=facebook,twitter,wechat,weibo,qq></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css media=print onload='this.media="all"'><script src=https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js defer=defer></script></div></div><div class=ads-wrap><ins class=adsbygoogle style=display:block;text-align:center data-ad-layout=in-article data-ad-format=fluid data-ad-client=ca-pub-7962287588031867 data-ad-slot=2542544532></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><nav class=pagination-post id=pagination><div class="prev-post pull-left"><a href=/posts/2024/10/02/how-to-extend-the-wasi-python-by-using-host-function-cn/ title="如何使用 WASMTIME 来运行 CPython for WASI，然后利用 Python 实现的 HostFunction 来扩展它？"><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/07/14/45/snow-7774312_1280.jpg onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class=pagination-info><div class=label>Previous</div><div class=prev_info>如何使用 WASMTIME 来运行 CPython for WASI，然后利用 Python 实现的 HostFunction 来扩展它？</div></div></a></div><div class="next-post pull-right"><a href=/posts/2024/09/18/a-live-debug-ecapture-gh-604/ title="Debug 日志：eCapture GH-604"><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/04/07/38/cherry-blossoms-7766587_1280.jpg onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class=pagination-info><div class=label>Next</div><div class=next_info>Debug 日志：eCapture GH-604</div></div></a></div></nav><div class=relatedPosts><div class=headline><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class=relatedPosts-list><div><a href=/posts/2024/08/19/benchmark-for-python-web-framework-2024-part1-en/ title="In 2024, Gevent or asyncio? Part 1"><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/06/16/46/sea-7772372_1280.jpg alt=cover><div class="content is-center"><div class=date><i class="far fa-calendar-alt fa-fw"></i> 2024-08-20</div><div class=title>In 2024, Gevent or asyncio? Part 1</div></div></a></div><div><a href=/posts/2024/10/02/how-to-extend-the-wasi-python-by-using-host-function-cn/ title="如何使用 WASMTIME 来运行 CPython for WASI，然后利用 Python 实现的 HostFunction 来扩展它？"><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/07/14/45/snow-7774312_1280.jpg alt=cover><div class="content is-center"><div class=date><i class="far fa-calendar-alt fa-fw"></i> 2024-10-02</div><div class=title>如何使用 WASMTIME 来运行 CPython for WASI，然后利用 Python 实现的 HostFunction 来扩展它？</div></div></a></div><div><a href=/posts/2024/06/19/a-live-debug-gh120437/ title="Debug 日志：CPython GH-120437"><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/06/16/46/sea-7772372_1280.jpg alt=cover><div class="content is-center"><div class=date><i class="far fa-calendar-alt fa-fw"></i> 2024-06-20</div><div class=title>Debug 日志：CPython GH-120437</div></div></a></div><div><a href=/posts/2024/07/16/a-live-debug-gh121528/ title="Debug 日志：CPython GH-121528"><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/04/07/38/cherry-blossoms-7766588_1280.jpg alt=cover><div class="content is-center"><div class=date><i class="far fa-calendar-alt fa-fw"></i> 2024-07-17</div><div class=title>Debug 日志：CPython GH-121528</div></div></a></div><div><a href=/posts/2024/08/19/benchmark-for-python-web-framework-2024-part1-cn/ title="2024 年了，是 Gevent 还是选择 asyncio Part 1？"><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/04/07/38/cherry-blossoms-7766587_1280.jpg alt=cover><div class="content is-center"><div class=date><i class="far fa-calendar-alt fa-fw"></i> 2024-08-20</div><div class=title>2024 年了，是 Gevent 还是选择 asyncio Part 1？</div></div></a></div></div></div><hr class=custom-hr><div id=post-comment><div class=comment-head><div class=comment-headline><i class="fas fa-comments fa-fw"></i><span> Comment</span></div></div><div class=comment-wrap><div><div id=disqus_thread></div></div></div></div></div><div class=aside-content id=aside-content><div class="card-widget card-info"><div class=is-center><div class=avatar-img><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://avatars.githubusercontent.com/u/7054676?v=4" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt=avatar></div><div class=author-info__name>Manjusaka</div><div class=author-info__description>热忱之心不可磨灭</div></div><div class="card-info-data site-data is-center"><a href=/archives/ ><div class=headline>Articles</div><div class=length-num>95</div></a><a href=/tags/ ><div class=headline>Tags</div><div class=length-num>58</div></a><a href=/categories/ ><div class=headline>Categories</div><div class=length-num>38</div></a></div><a id=card-info-btn target=_blank rel="noopener external nofollow noreferrer" href=https://github.com/Zheaoli><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class=social-icon href=https://github.com/ZheaoLi rel="external nofollow noreferrer" target=_blank title=Github><i class="fab fa-github"></i></a><a class=social-icon href=mailto:me@manjusaka.me rel="external nofollow noreferrer" target=_blank title=Email><i class="fas fa-envelope"></i></a><a class=social-icon href=https://twitter.com/Manjusaka_Lee rel="external nofollow noreferrer" target=_blank title=推特><i class="fab fa-twitter"></i></a><a class=social-icon href=/atom.xml target=_blank title=RSS><i class="fa-solid fa-feed"></i></a></div></div><div class="card-widget card-announcement"><div class=item-headline><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class=announcement_content>This is my Blog</div></div><div class=sticky_layout><div class=card-widget id=card-toc><div class=item-headline><i class="fas fa-stream"></i><span>Contents</span><span class=toc-percentage></span></div><div class="toc-content is-expand"><ol class=toc><li class="toc-item toc-level-2"><a class=toc-link href=#Main-Content><span class=toc-number>1.</span> <span class=toc-text>Main Content</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#Summary><span class=toc-number>2.</span> <span class=toc-text>Summary</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#References><span class=toc-number>3.</span> <span class=toc-text>References</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class=item-headline><i class="fas fa-history"></i><span>Recent Post</span></div><div class=aside-list><div class=aside-list-item><a class=thumbnail href=/posts/2024/10/02/how-to-extend-the-wasi-python-by-using-host-function-cn/ title="如何使用 WASMTIME 来运行 CPython for WASI，然后利用 Python 实现的 HostFunction 来扩展它？"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/07/14/45/snow-7774312_1280.jpg onerror='this.onerror=null,this.src="/img/404.jpg"' alt="如何使用 WASMTIME 来运行 CPython for WASI，然后利用 Python 实现的 HostFunction 来扩展它？"></a><div class=content><a class=title href=/posts/2024/10/02/how-to-extend-the-wasi-python-by-using-host-function-cn/ title="如何使用 WASMTIME 来运行 CPython for WASI，然后利用 Python 实现的 HostFunction 来扩展它？">如何使用 WASMTIME 来运行 CPython for WASI，然后利用 Python 实现的 HostFunction 来扩展它？</a><time datetime=2024-10-02T13:00:00.000Z title="Created 2024-10-02 21:00:00">2024-10-02</time></div></div><div class=aside-list-item><a class=thumbnail href=/posts/2024/10/02/how-to-extend-the-wasi-python-by-using-host-function-en/ title="How to Run CPython for WASI Using WASMTIME and Extend It with Python-Implemented Host Functions?"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/01/14/19/50/flower-7718952_1280.jpg onerror='this.onerror=null,this.src="/img/404.jpg"' alt="How to Run CPython for WASI Using WASMTIME and Extend It with Python-Implemented Host Functions?"></a><div class=content><a class=title href=/posts/2024/10/02/how-to-extend-the-wasi-python-by-using-host-function-en/ title="How to Run CPython for WASI Using WASMTIME and Extend It with Python-Implemented Host Functions?">How to Run CPython for WASI Using WASMTIME and Extend It with Python-Implemented Host Functions?</a><time datetime=2024-10-02T13:00:00.000Z title="Created 2024-10-02 21:00:00">2024-10-02</time></div></div><div class=aside-list-item><a class=thumbnail href=/posts/2024/09/18/a-live-debug-ecapture-gh-604/ title="Debug 日志：eCapture GH-604"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/04/07/38/cherry-blossoms-7766587_1280.jpg onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Debug 日志：eCapture GH-604"></a><div class=content><a class=title href=/posts/2024/09/18/a-live-debug-ecapture-gh-604/ title="Debug 日志：eCapture GH-604">Debug 日志：eCapture GH-604</a><time datetime=2024-09-18T14:00:00.000Z title="Created 2024-09-18 22:00:00">2024-09-18</time></div></div><div class=aside-list-item><a class=thumbnail href=/posts/2024/08/19/benchmark-for-python-web-framework-2024-part1-cn/ title="2024 年了，是 Gevent 还是选择 asyncio Part 1？"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/04/07/38/cherry-blossoms-7766587_1280.jpg onerror='this.onerror=null,this.src="/img/404.jpg"' alt="2024 年了，是 Gevent 还是选择 asyncio Part 1？"></a><div class=content><a class=title href=/posts/2024/08/19/benchmark-for-python-web-framework-2024-part1-cn/ title="2024 年了，是 Gevent 还是选择 asyncio Part 1？">2024 年了，是 Gevent 还是选择 asyncio Part 1？</a><time datetime=2024-08-19T17:00:00.000Z title="Created 2024-08-20 01:00:00">2024-08-20</time></div></div><div class=aside-list-item><a class=thumbnail href=/posts/2024/08/19/benchmark-for-python-web-framework-2024-part1-en/ title="In 2024, Gevent or asyncio? Part 1"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/06/16/46/sea-7772372_1280.jpg onerror='this.onerror=null,this.src="/img/404.jpg"' alt="In 2024, Gevent or asyncio? Part 1"></a><div class=content><a class=title href=/posts/2024/08/19/benchmark-for-python-web-framework-2024-part1-en/ title="In 2024, Gevent or asyncio? Part 1">In 2024, Gevent or asyncio? Part 1</a><time datetime=2024-08-19T17:00:00.000Z title="Created 2024-08-20 01:00:00">2024-08-20</time></div></div></div></div><div class="card-widget ads-wrap"><ins class=adsbygoogle style=display:block data-ad-client=ca-pub-7962287588031867 data-ad-slot=1257383027 data-ad-format=auto data-full-width-responsive=true></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div></div></div></main><footer id=footer style="background:0 0"><div id=footer-wrap><div class=copyright>&copy;2020 - 2024 By Manjusaka</div><div class=framework-info><span>Framework </span><a target=_blank rel="noopener external nofollow noreferrer" href=https://hexo.io>Hexo</a><span class=footer-separator>|</span><span>Theme </span><a target=_blank rel="noopener external nofollow noreferrer" href=https://github.com/jerryc127/hexo-theme-butterfly>Butterfly</a></div></div></footer></div><div id=rightside><div id=rightside-config-hide></div><div id=rightside-config-show><button id=darkmode type=button title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id=translateLink type=button title="Toggle Between Traditional Chinese And Simplified Chinese">简</button><button id=readmode type=button title="Read Mode"><i class="fas fa-book-open"></i></button><button id=go-up type=button title="Back To Top"><span class=scroll-percent></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src=https://www.manjusaka.blog/js/utils.js></script><script src=https://www.manjusaka.blog/js/main.js></script><script src=https://www.manjusaka.blog/js/tw_cn.js></script><script src=https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js></script><script src=https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js></script><script src=https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js></script><script>function panguFn(){"object"==typeof pangu?pangu.autoSpacingPage():getScript("https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js").then(()=>{pangu.autoSpacingPage()})}function panguInit(){panguFn()}document.addEventListener("DOMContentLoaded",panguInit)</script><div class=js-pjax><script>(()=>{let t=document.querySelectorAll("#article-container .mermaid-wrap");if(0!==t.length){let e=()=>{window.loadMermaid=!0;let r="dark"===document.documentElement.getAttribute("data-theme")?"dark":"default";Array.from(t).forEach((e,t)=>{let d=e.firstElementChild;e="%%{init:{ 'theme':'"+r+"'}}%%\n"+d.textContent;let n=mermaid.render("mermaid-"+t,e);"string"==typeof n?(t=n,d.insertAdjacentHTML("afterend",t)):n.then(({svg:e})=>{d.insertAdjacentHTML("afterend",e)})})};var d=()=>{window.loadMermaid?e():getScript("https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js").then(e)};btf.addGlobalFn("themeChange",e,"mermaid"),window.pjax?d():document.addEventListener("DOMContentLoaded",d)}})()</script><script>(()=>{function t(){this.page.url="https://www.manjusaka.blog/posts/2024/10/02/how-to-extend-the-wasi-python-by-using-host-function-en/",this.page.identifier="/posts/2024/10/02/how-to-extend-the-wasi-python-by-using-host-function-en/",this.page.title="How to Run CPython for WASI Using WASMTIME and Extend It with Python-Implemented Host Functions?"}let e=()=>{window.DISQUS&&window.DISQUS.reset({reload:!0,config:t})};btf.addGlobalFn("themeChange",e,"disqus");var n=()=>{var t;window.DISQUS?e():((t=document.createElement("script")).src="https://manjusakablog.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),document.head.appendChild(t))};n()})()</script></div><script defer=defer id=fluttering_ribbon mobile=false src=https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js></script><script src=https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!0,POWERMODE.mobile=!1,document.body.addEventListener("input",POWERMODE)</script><script async data-pjax src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><div id=algolia-search><div class=search-dialog><nav class=search-nav><span class=search-dialog-title>Search</span><button class=search-close-button><i class="fas fa-times"></i></button></nav><div class=search-wrap><div id=algolia-search-input></div><hr><div id=algolia-search-results><div id=algolia-hits></div><div id=algolia-pagination></div><div id=algolia-info><div class=algolia-stats></div><div class=algolia-poweredBy></div></div></div></div></div><div id=search-mask></div><script src=https://cdn.jsdelivr.net/npm/algoliasearch/dist/algoliasearch-lite.umd.min.js></script><script src=https://cdn.jsdelivr.net/npm/instantsearch.js/dist/instantsearch.production.min.js></script><script src=https://www.manjusaka.blog/js/search/algolia.js></script></div></div><script data-pjax>function butterfly_swiper_injector_config(){var s=document.getElementById("recent-posts");console.log("已挂载butterfly_swiper"),s.insertAdjacentHTML("afterbegin",'<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="/posts/2024/02/20/a-simple-discussion-about-the-ultraman/" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.pixabay.com/photo/2023/02/06/16/46/sea-7772372_1280.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2024-02-20</span><a class="blog-slider__title" href="/posts/2024/02/20/a-simple-discussion-about-the-ultraman/" alt="">简单聊聊奥特曼中很有趣的细节</a><div class="blog-slider__text">ヒーロが必要なんだよ，金城君。ヒーローが必要なんだ！</div><a class="blog-slider__button" href="/posts/2024/02/20/a-simple-discussion-about-the-ultraman/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="/posts/2023/12/29/per-aspera-ad-astra/" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.pixabay.com/photo/2023/01/30/19/40/gulls-7756481_1280.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-12-29</span><a class="blog-slider__title" href="/posts/2023/12/29/per-aspera-ad-astra/" alt="">Per aspera, Ad astra</a><div class="blog-slider__text">再怎么看我也不知道怎么描述它的啦！</div><a class="blog-slider__button" href="/posts/2023/12/29/per-aspera-ad-astra/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="/posts/2023/10/24/open-source-is-simple-than-you-think/" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.pixabay.com/photo/2023/02/04/07/50/daisy-7766609_1280.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-10-24</span><a class="blog-slider__title" href="/posts/2023/10/24/open-source-is-simple-than-you-think/" alt="">开源可能没你想的那么难</a><div class="blog-slider__text">再怎么看我也不知道怎么描述它的啦！</div><a class="blog-slider__button" href="/posts/2023/10/24/open-source-is-simple-than-you-think/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="/posts/2023/06/25/love-and-hope-is-all-we-need/" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://github.com/Zheaoli/yuque-py/assets/7054676/ea9460a2-e351-4b73-9f82-7aef6cd20c33" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-06-25</span><a class="blog-slider__title" href="/posts/2023/06/25/love-and-hope-is-all-we-need/" alt="">聊聊公益和助学</a><div class="blog-slider__text">很多时候，帮助人不需要那么多理由</div><a class="blog-slider__button" href="/posts/2023/06/25/love-and-hope-is-all-we-need/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="/posts/2023/12/28/how-do-I-build-homelab-part2/" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.pixabay.com/photo/2023/02/06/16/46/sea-7772372_1280.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-12-28</span><a class="blog-slider__title" href="/posts/2023/12/28/how-do-I-build-homelab-part2/" alt="">家庭 Homelab 升级计划: v2</a><div class="blog-slider__text">人生嘛，Homelab 图个乐子</div><a class="blog-slider__button" href="/posts/2023/12/28/how-do-I-build-homelab-part2/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="/posts/2023/06/19/why-do-I-love-ultraman/" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://user-images.githubusercontent.com/7054676/228287041-c86e7928-0da8-4097-b7ff-e575faa8cf8c.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-06-19</span><a class="blog-slider__title" href="/posts/2023/06/19/why-do-I-love-ultraman/" alt="">为什么奥特曼是我的信仰</a><div class="blog-slider__text">優しさを失わないでくれ。弱い者を労り互いに助け合い。</div><a class="blog-slider__button" href="/posts/2023/06/19/why-do-I-love-ultraman/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="/posts/2023/06/16/how-do-I-build-homelab/" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.pixabay.com/photo/2023/02/08/15/10/sculpture-7776861_1280.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-06-16</span><a class="blog-slider__title" href="/posts/2023/06/16/how-do-I-build-homelab/" alt="">家庭 Homelab 升级计划</a><div class="blog-slider__text">人生嘛，Homelab 图个乐子</div><a class="blog-slider__button" href="/posts/2023/06/16/how-do-I-build-homelab/" alt="">详情   </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>')}for(var elist="undefined".split(","),cpage=location.pathname,epage="all",flag=0,i=0;i<elist.length;i++)cpage.includes(elist[i])&&flag++;("all"===epage&&0==flag||epage===cpage)&&butterfly_swiper_injector_config()</script><script defer=defer src=https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.js></script><script defer=defer data-pjax src=https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper_init.js></script><script async src=//at.alicdn.com/t/font_2032782_8d5kxvn09md.js></script></body></html>