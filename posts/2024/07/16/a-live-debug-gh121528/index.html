<!DOCTYPE html><html lang=en data-theme=auto><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><title>Debug 日志：CPython GH-121528 | Manjusaka</title><meta name=author content=Manjusaka><meta name=copyright content=Manjusaka><meta name=format-detection content="telephone=no"><meta name=theme-color content=ffffff><meta name=description content="Debug 日志系列第二篇，CPython 的 GH-121528，也是很有趣的调试和讨论过程，写出来希望帮助大家 太长不看的版：Python 3.13 Beta 版本中，因为 PEP 683 的实现+周边的改动，导致低版本下编译的一些扩展无法在 Python 3.13 中运行"><meta property=og:type content=article><meta property=og:title content="Debug 日志：CPython GH-121528"><meta property=og:url content=https://www.manjusaka.blog/posts/2024/07/16/a-live-debug-gh121528/index.html><meta property=og:site_name content=Manjusaka><meta property=og:description content="Debug 日志系列第二篇，CPython 的 GH-121528，也是很有趣的调试和讨论过程，写出来希望帮助大家 太长不看的版：Python 3.13 Beta 版本中，因为 PEP 683 的实现+周边的改动，导致低版本下编译的一些扩展无法在 Python 3.13 中运行"><meta property=og:locale content=en_US><meta property=og:image content=https://cdn.pixabay.com/photo/2023/02/07/14/45/snow-7774312_1280.jpg><meta property=article:published_time content=2024-07-16T18:20:00.000Z><meta property=article:modified_time content=2024-08-11T18:29:07.818Z><meta property=article:author content=Manjusaka><meta property=article:tag content=编程><meta property=article:tag content=笔记><meta property=article:tag content=水文><meta property=article:tag content=CPython><meta name=twitter:card content=summary><meta name=twitter:image content="https://avatars.githubusercontent.com/u/7054676?v=4"><meta name=twitter:creator content=@Manjusaka_Lee><meta name=twitter:site content=https://twitter.com/Manjusaka_Lee><link rel="shortcut icon" href="https://avatars.githubusercontent.com/u/7054676?v=4"><link rel=canonical href=https://www.manjusaka.blog/posts/2024/07/16/a-live-debug-gh121528/index.html><link rel=preconnect href=//cdn.jsdelivr.net><link rel=preconnect href=//www.google-analytics.com crossorigin=""><link rel=preconnect href=//busuanzi.ibruce.info><link rel=stylesheet href=/css/index.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css media=print onload='this.media="all"'><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css media=print onload='this.media="all"'><script async=async src="https://www.googletagmanager.com/gtag/js?id=UA-154407994-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-154407994-1")</script><script>let GLOBAL_CONFIG={root:"/",algolia:{appId:"DL1RURGHTB",indexName:"manjusaka.blog",hits:{per_page:6},languages:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}.",hits_stats:"${hits} results found in ${time} ms"}},localSearch:void 0,translate:{defaultEncoding:2,translateDelay:0,msgToTraditionalChinese:"繁",msgToSimplifiedChinese:"簡"},noticeOutdate:{limitDay:365,position:"top",messagePrev:"It has been",messageNext:"days since the last update, the content of the article may be outdated."},highlight:{plugin:"highlight.js",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:400},copy:{success:"Copy Successful",error:"Copy Error",noSupport:"Browser Not Supported"},relativeDate:{homepage:!0,post:!0},runtime:"days",dateSuffix:{just:"Just now",min:"minutes ago",hour:"hours ago",day:"days ago",month:"months ago"},copyright:{limitCount:100,languages:{author:"Author: Manjusaka",link:"Link: ",source:"Source: Manjusaka",info:"Copyright is owned by the author. For commercial reprints, please contact the author for authorization. For non-commercial reprints, please indicate the source."}},lightbox:"fancybox",Snackbar:{chs_to_cht:"You have switched to Traditional Chinese",cht_to_chs:"You have switched to Simplified Chinese",day_to_night:"You have switched to Dark Mode",night_to_day:"You have switched to Light Mode",bgLight:"#59C173",bgDark:"#1f1f1f",position:"bottom-left"},infinitegrid:{js:"https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js",buttonText:"Load More"},isPhotoFigcaption:!0,islazyload:!0,isAnchor:!0,percent:{toc:!0,rightside:!0},autoDarkmode:!0}</script><script id=config-diff>var GLOBAL_CONFIG_SITE={title:"Debug 日志：CPython GH-121528",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2024-08-12 02:29:07"}</script><script>(e=>{e.saveToLocal={set:(e,t,a)=>{var o;0!==a&&(o=Date.now(),localStorage.setItem(e,JSON.stringify({value:t,expiry:o+864e5*a})))},get:e=>{var t=localStorage.getItem(e);if(t){t=JSON.parse(t);if(!(Date.now()>t.expiry))return t.value;localStorage.removeItem(e)}}},e.getScript=(o,d={})=>new Promise((t,e)=>{let a=document.createElement("script");a.src=o,a.async=!0,a.onerror=e,a.onload=a.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},Object.keys(d).forEach(e=>{a.setAttribute(e,d[e])}),document.head.appendChild(a)}),e.getCSS=(o,d=!1)=>new Promise((t,e)=>{let a=document.createElement("link");a.rel="stylesheet",a.href=o,d&&(a.id=d),a.onerror=e,a.onload=a.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},document.head.appendChild(a)}),e.activateDarkMode=()=>{document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},e.activateLightMode=()=>{document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","ffffff")};var e=saveToLocal.get("theme"),t=window.matchMedia("(prefers-color-scheme: dark)").matches,a=window.matchMedia("(prefers-color-scheme: light)").matches,o=window.matchMedia("(prefers-color-scheme: no-preference)").matches,d=!t&&!a&&!o,t=(void 0===e?(a?activateLightMode():t?activateDarkMode():(o||d)&&((a=(new Date).getHours())<=6||18<=a?activateDarkMode:activateLightMode)(),window.matchMedia("(prefers-color-scheme: dark)").addListener(e=>{void 0===saveToLocal.get("theme")&&(e.matches?activateDarkMode:activateLightMode)()})):("light"===e?activateLightMode:activateDarkMode)(),saveToLocal.get("aside-status"));void 0!==t&&("hide"===t?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})(window)</script><link rel=stylesheet href=https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.css media=print onload='this.media="all"'><link rel=stylesheet href=https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiperstyle.css media=print onload='this.media="all"'><link rel=stylesheet href=https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css media=defer onload='this.media="all"'><link rel=stylesheet href=https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css media=defer onload='this.media="all"'><script src=https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js></script><meta name=generator content="Hexo 6.3.0"><link rel=alternate href=/atom.xml title=Manjusaka type=application/atom+xml></head><body><div id=loading-box><div class=loading-left-bg></div><div class=loading-right-bg></div><div class=spinner-box><div class=configure-border-1><div class=configure-core></div></div><div class=configure-border-2><div class=configure-core></div></div><div class=loading-word>Loading...</div></div></div><script>(()=>{let d=document.getElementById("loading-box"),e=document.body,o={endLoading:()=>{e.style.overflow="",d.classList.add("loaded")},initLoading:()=>{e.style.overflow="hidden",d.classList.remove("loaded")}};o.initLoading(),window.addEventListener("load",()=>{o.endLoading()})})()</script><div id=web_bg></div><div id=sidebar><div id=menu-mask></div><div id=sidebar-menus><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://avatars.githubusercontent.com/u/7054676?v=4" onerror='onerror=null,src="/img/friend_404.gif"' alt=avatar></div><div class="sidebar-site-data site-data is-center"><a href=/archives/ ><div class=headline>Articles</div><div class=length-num>90</div></a><a href=/tags/ ><div class=headline>Tags</div><div class=length-num>52</div></a><a href=/categories/ ><div class=headline>Categories</div><div class=length-num>36</div></a></div><hr class=custom-hr><div class=menus_items><div class=menus_item><a class=site-page href=/ ><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class=menus_item><a class="site-page group" href=javascript:void(0); rel="external nofollow noreferrer"><i class="fa-fw fa-fw fas fa-lines-leaning"></i><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class=menus_item_child><li><a class="site-page child" href=/categories/ ><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href=/tags/ ><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href=/archives/ ><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href=/random/ ><i class="fa-fw fas fa-random"></i><span> 随便逛逛</span></a></li></ul></div><div class=menus_item><a class=site-page href=/weekly/ ><i class="fa-fw fas fa-newspaper"></i><span> 周报</span></a></div><div class=menus_item><a class=site-page href=/leetcode/ ><i class="fa-fw fas fa-newspaper"></i><span> 刷题</span></a></div><div class=menus_item><a class="site-page group" href=javascript:void(0); rel="external nofollow noreferrer"><i class="fa-fw fas fa-heart"></i><span> 我的</span><i class="fas fa-chevron-down"></i></a><ul class=menus_item_child><li><a class="site-page child" href=/about/ ><i class="fa-fw fas fa-spa"></i><span> 关于</span></a></li><li><a class="site-page child" href=/weekly/ ><i class="fa-fw fas fa-newspaper"></i><span> 周报</span></a></li></ul></div></div></div></div><div class=post id=body-wrap><header class=post-bg id=page-header style=background-image:url(https://cdn.pixabay.com/photo/2023/02/07/14/45/snow-7774312_1280.jpg)><nav id=nav><span id=blog-info><a href=/ title=Manjusaka><img class=site-icon src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://avatars.githubusercontent.com/u/7054676?v=4# image"><span class=site-name>Manjusaka</span></a></span><div id=menus><div id=search-button><a class="site-page social-icon search" href=javascript:void(0); rel="external nofollow noreferrer"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class=menus_items><div class=menus_item><a class=site-page href=/ ><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class=menus_item><a class="site-page group" href=javascript:void(0); rel="external nofollow noreferrer"><i class="fa-fw fa-fw fas fa-lines-leaning"></i><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class=menus_item_child><li><a class="site-page child" href=/categories/ ><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href=/tags/ ><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href=/archives/ ><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href=/random/ ><i class="fa-fw fas fa-random"></i><span> 随便逛逛</span></a></li></ul></div><div class=menus_item><a class=site-page href=/weekly/ ><i class="fa-fw fas fa-newspaper"></i><span> 周报</span></a></div><div class=menus_item><a class=site-page href=/leetcode/ ><i class="fa-fw fas fa-newspaper"></i><span> 刷题</span></a></div><div class=menus_item><a class="site-page group" href=javascript:void(0); rel="external nofollow noreferrer"><i class="fa-fw fas fa-heart"></i><span> 我的</span><i class="fas fa-chevron-down"></i></a><ul class=menus_item_child><li><a class="site-page child" href=/about/ ><i class="fa-fw fas fa-spa"></i><span> 关于</span></a></li><li><a class="site-page child" href=/weekly/ ><i class="fa-fw fas fa-newspaper"></i><span> 周报</span></a></li></ul></div></div><div id=toggle-menu><a class=site-page href=javascript:void(0); rel="external nofollow noreferrer"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id=post-info><h1 class=post-title>Debug 日志：CPython GH-121528<a class=post-edit-link href=https://github.com/Zheaoli/Zheaoli.github.io/edit/main/source/_posts/a-live-debug-gh121528.md rel="external nofollow noreferrer" title="Edited on" target=_blank><i class="fas fa-pencil-alt"></i></a></h1><div id=post-meta><div class=meta-firstline><span class=post-meta-date><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class=post-meta-label>Created</span><time datetime=2024-07-16T18:20:00.000Z title="Created 2024-07-17 02:20:00">2024-07-17</time></span><span class=post-meta-categories><span class=post-meta-separator>|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class=post-meta-categories href=/categories/%E7%BC%96%E7%A8%8B/ >编程</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class=post-meta-categories href=/categories/%E7%BC%96%E7%A8%8B/CPython/ >CPython</a></span></div><div class=meta-secondline><span class=post-meta-separator>|</span><span class=post-meta-wordcount><i class="far fa-file-word fa-fw post-meta-icon"></i><span class=post-meta-label>Word Count:</span><span class=word-count>2.1k</span><span class=post-meta-separator>|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class=post-meta-label>Reading Time:</span><span>9mins</span></span><span class=post-meta-separator>|</span><span class=post-meta-pv-cv id="" data-flag-title="Debug 日志：CPython GH-121528"><i class="far fa-eye fa-fw post-meta-icon"></i><span class=post-meta-label>Post Views:</span><span id=busuanzi_value_page_pv><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class=layout id=content-inner><div id=post><article class=post-content id=article-container><p>Debug 日志系列第二篇，CPython 的 GH-121528，也是很有趣的调试和讨论过程，写出来希望帮助大家</p><p>太长不看的版：Python 3.13 Beta 版本中，因为 PEP 683 的实现+周边的改动，导致低版本下编译的一些扩展无法在 Python 3.13 中运行</p><span id=more></span><h2 id=开篇><a href=#开篇 class=headerlink title=开篇></a>开篇</h2><p>7月9日的时候，PyO3 社区提出了一个 Bug , 编号为 GH-121528<a href=#reference1><sup>1</sup></a>。这个 Bug 可以做这样的表示</p><p>假设我们有一个 C 扩展文件</p><figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br></pre></td><td class=code><pre><span class=line><span class=meta>#<span class=keyword>include</span> <span class=string>&lt;Python.h&gt;</span></span></span><br><span class=line></span><br><span class=line><span class=type>static</span> PyObject *</span><br><span class=line><span class="title function_">foo_bar</span><span class=params>(PyObject *self, PyObject *args)</span></span><br><span class=line>&#123;</span><br><span class=line>	Py_INCREF(PyExc_TypeError);</span><br><span class=line>	PyErr_SetString(PyExc_TypeError, <span class=string>&quot;foo&quot;</span>);</span><br><span class=line>	<span class=keyword>return</span> <span class=literal>NULL</span>;</span><br><span class=line>&#125;</span><br><span class=line></span><br><span class=line><span class=type>static</span> PyMethodDef foomethods[] = &#123;</span><br><span class=line>	&#123;<span class=string>&quot;bar&quot;</span>, foo_bar, METH_VARARGS, <span class=string>&quot;&quot;</span>&#125;,</span><br><span class=line>	&#123;<span class=literal>NULL</span>, <span class=literal>NULL</span>, <span class=number>0</span>, <span class=literal>NULL</span>&#125;,</span><br><span class=line>&#125;;</span><br><span class=line></span><br><span class=line><span class=type>static</span> PyModuleDef foomodule = &#123;</span><br><span class=line>	PyModuleDef_HEAD_INIT,</span><br><span class=line>	.m_name = <span class=string>&quot;foo&quot;</span>,</span><br><span class=line>	.m_doc = <span class=string>&quot;foo test module&quot;</span>,</span><br><span class=line>	.m_size = <span class=number>-1</span>,</span><br><span class=line>	.m_methods = foomethods,</span><br><span class=line>&#125;;</span><br><span class=line></span><br><span class=line>PyMODINIT_FUNC</span><br><span class=line><span class="title function_">PyInit_foo</span><span class=params>(<span class=type>void</span>)</span></span><br><span class=line>&#123;</span><br><span class=line>	<span class=keyword>return</span> PyModule_Create(&amp;foomodule);</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>然后假设我们有这样的 <code>setup.py</code> 文件</p><figure class="highlight python"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre></td><td class=code><pre><span class=line><span class=keyword>from</span> setuptools <span class=keyword>import</span> setup, Extension</span><br><span class=line></span><br><span class=line>setup(name=<span class=string>&#x27;foo&#x27;</span>,</span><br><span class=line>      version=<span class=string>&#x27;0&#x27;</span>,</span><br><span class=line>      ext_modules=[</span><br><span class=line>          Extension(<span class=string>&#x27;foo&#x27;</span>, [<span class=string>&#x27;foo.c&#x27;</span>], py_limited_api=<span class=string>&#x27;cp38&#x27;</span>),</span><br><span class=line>      ])</span><br></pre></td></tr></table></figure><p>OK， 基于 Limited API (aka Stable ABI) 编译，社区发现，如果在 &lt;= 3.11 的版本中编译的扩展，在 Python 3.13 以及最新主分支中加载扩展，那么会出现问题</p><p>我们来看下堆栈</p><figure class="highlight text"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br></pre></td><td class=code><pre><span class=line>Process 10157 stopped</span><br><span class=line>* thread #1, queue = &#x27;com.apple.main-thread&#x27;, stop reason = hit program assert</span><br><span class=line>    frame #4: 0x000000010034043c python.exe`_PyType_AllocNoTrack.cold.2 [inlined] _PyObject_Init(op=&lt;unavailable&gt;, typeobj=&lt;unavailable&gt;) at pycore_object.h:269:5 [opt]</span><br><span class=line>   266  &#123;</span><br><span class=line>   267      assert(op != NULL);</span><br><span class=line>   268      Py_SET_TYPE(op, typeobj);</span><br><span class=line>-&gt; 269      assert(_PyType_HasFeature(typeobj, Py_TPFLAGS_HEAPTYPE) || _Py_IsImmortal(typeobj));</span><br><span class=line>   270      Py_INCREF(typeobj);</span><br><span class=line>   271      _Py_NewReference(op);</span><br><span class=line>   272  &#125;</span><br><span class=line>Target 0: (python.exe) stopped.</span><br><span class=line>warning: python.exe was compiled with optimization - stepping may behave oddly; variables may not be available.</span><br><span class=line>(lldb) bt</span><br><span class=line>* thread #1, queue = &#x27;com.apple.main-thread&#x27;, stop reason = hit program assert</span><br><span class=line>    frame #0: 0x0000000190ec75e0 libsystem_kernel.dylib`__pthread_kill + 8</span><br><span class=line>    frame #1: 0x0000000190efff70 libsystem_pthread.dylib`pthread_kill + 288</span><br><span class=line>    frame #2: 0x0000000190e0c908 libsystem_c.dylib`abort + 128</span><br><span class=line>    frame #3: 0x0000000190e0bc1c libsystem_c.dylib`__assert_rtn + 284</span><br><span class=line>  * frame #4: 0x000000010034043c python.exe`_PyType_AllocNoTrack.cold.2 [inlined] _PyObject_Init(op=&lt;unavailable&gt;, typeobj=&lt;unavailable&gt;) at pycore_object.h:269:5 [opt]</span><br><span class=line>    frame #5: 0x000000010034041c python.exe`_PyType_AllocNoTrack.cold.2 at typeobject.c:2224:9 [opt]</span><br><span class=line>    frame #6: 0x00000001001299a8 python.exe`_PyType_AllocNoTrack [inlined] _PyObject_Init(op=0x0000000100b0eba0, typeobj=0x000000010054db80) at pycore_object.h:269:5 [opt]</span><br><span class=line>    frame #7: 0x00000001001299a4 python.exe`_PyType_AllocNoTrack(type=0x000000010054db80, nitems=0) at typeobject.c:2224:9 [opt]</span><br><span class=line>    frame #8: 0x00000001001297bc python.exe`PyType_GenericAlloc(type=0x000000010054db80, nitems=&lt;unavailable&gt;) at typeobject.c:2238:21 [opt]</span><br><span class=line>    frame #9: 0x00000001000a7638 python.exe`BaseException_vectorcall(type_obj=0x000000010054db80, args=0x000000016fdfd500, nargsf=9223372036854775809, kwnames=&lt;unavailable&gt;) at exceptions.c:92:37 [opt]</span><br><span class=line>    frame #10: 0x0000000100093220 python.exe`_PyObject_VectorcallTstate(tstate=0x00000001005e6370, callable=0x000000010054db80, args=0x000000016fdfd500, nargsf=9223372036854775809, kwnames=0x0000000000000000) at pycore_call.h:167:11 [opt]</span><br><span class=line>    frame #11: 0x00000001000942bc python.exe`PyObject_CallOneArg(func=&lt;unavailable&gt;, arg=&lt;unavailable&gt;) at call.c:395:12 [opt]</span><br><span class=line>    frame #12: 0x0000000100214d2c python.exe`_PyErr_CreateException(exception_type=0x000000010054db80, value=&lt;unavailable&gt;) at errors.c:44:15 [opt]</span><br><span class=line>    frame #13: 0x0000000100215160 python.exe`_PyErr_SetObject(tstate=0x00000001005e6370, exception=0x000000010054db80, value=0x0000000100c41530) at errors.c:184:33 [opt]</span><br><span class=line>    frame #14: 0x0000000100214ed0 python.exe`PyErr_SetString [inlined] _PyErr_SetString(tstate=0x00000001005e6370, exception=&lt;unavailable&gt;, string=&lt;unavailable&gt;) at errors.c:291:9 [opt]</span><br><span class=line>    frame #15: 0x0000000100214eb0 python.exe`PyErr_SetString(exception=0x000000010054db80, string=&lt;unavailable&gt;) at errors.c:300:5 [opt]</span><br><span class=line>    frame #16: 0x000000010099bf30 foo.abi3.so`foo_bar(self=&lt;unavailable&gt;, args=&lt;unavailable&gt;) at foo.c:7:2 [opt]</span><br></pre></td></tr></table></figure><p>OK ，看到问题的部分的代码是这样</p><figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre></td><td class=code><pre><span class=line><span class=type>static</span> <span class=keyword>inline</span> <span class=type>void</span></span><br><span class=line>_PyObject_Init(PyObject *op, PyTypeObject *typeobj)</span><br><span class=line>&#123;</span><br><span class=line>    assert(op != <span class=literal>NULL</span>);</span><br><span class=line>    Py_SET_TYPE(op, typeobj);</span><br><span class=line>    assert(_PyType_HasFeature(typeobj, Py_TPFLAGS_HEAPTYPE) || _Py_IsImmortal(typeobj));</span><br><span class=line>    Py_INCREF(typeobj);</span><br><span class=line>    _Py_NewReference(op);</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>我们能看到是在处理 <code>PyExc_TypeError</code> 对象的时候， 进入到了 <code>_PyObject_Init</code> 函数，这里有一个逻辑是判定对象是否是在堆上或者是 Immortal 对象</p><p>我们 Bisect 确认了下，这个变更是在 GH-116115<a href=#reference2><sup>2</sup></a> 中引入的，原本的逻辑是这样的</p><figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre></td><td class=code><pre><span class=line><span class=type>static</span> <span class=keyword>inline</span> <span class=type>void</span></span><br><span class=line>_PyObject_Init(PyObject *op, PyTypeObject *typeobj)</span><br><span class=line>&#123;</span><br><span class=line>    assert(op != <span class=literal>NULL</span>);</span><br><span class=line>    Py_SET_TYPE(op, typeobj);</span><br><span class=line>    <span class=keyword>if</span> (_PyType_HasFeature(typeobj, Py_TPFLAGS_HEAPTYPE)) &#123;</span><br><span class=line>        Py_INCREF(typeobj);</span><br><span class=line>    &#125;</span><br><span class=line>    Py_INCREF(typeobj);</span><br><span class=line>    _Py_NewReference(op);</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>这里我们需要先去看下 <code>PyExc_TypeError</code> 的定义</p><figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br></pre></td><td class=code><pre><span class=line><span class=meta>#<span class=keyword>define</span> PyObject_HEAD_INIT(type)    \</span></span><br><span class=line><span class=meta>    &#123;                               \</span></span><br><span class=line><span class=meta>        &#123; _Py_IMMORTAL_REFCNT &#125;,    \</span></span><br><span class=line><span class=meta>        (type)                      \</span></span><br><span class=line><span class=meta>    &#125;,</span></span><br><span class=line></span><br><span class=line><span class=meta>#<span class=keyword>define</span> PyVarObject_HEAD_INIT(type, size) \</span></span><br><span class=line><span class=meta>    &#123;                                     \</span></span><br><span class=line><span class=meta>        PyObject_HEAD_INIT(type)          \</span></span><br><span class=line><span class=meta>        (size)                            \</span></span><br><span class=line><span class=meta>    &#125;,</span></span><br><span class=line></span><br><span class=line></span><br><span class=line><span class=type>static</span> PyTypeObject _PyExc_ ## EXCNAME = &#123; \</span><br><span class=line>    PyVarObject_HEAD_INIT(<span class=literal>NULL</span>, <span class=number>0</span>) \</span><br><span class=line>    # EXCNAME, \</span><br><span class=line>    <span class=keyword>sizeof</span>(Py ## EXCSTORE ## Object), <span class=number>0</span>, \</span><br><span class=line>    (destructor)EXCSTORE ## _dealloc, <span class=number>0</span>, <span class=number>0</span>, <span class=number>0</span>, <span class=number>0</span>, <span class=number>0</span>, <span class=number>0</span>, <span class=number>0</span>, <span class=number>0</span>, <span class=number>0</span>, <span class=number>0</span>, \</span><br><span class=line>    (reprfunc)EXCSTR, <span class=number>0</span>, <span class=number>0</span>, <span class=number>0</span>, \</span><br><span class=line>    Py_TPFLAGS_DEFAULT | Py_TPFLAGS_BASETYPE | Py_TPFLAGS_HAVE_GC, \</span><br><span class=line>    PyDoc_STR(EXCDOC), (traverseproc)EXCSTORE ## _traverse, \</span><br><span class=line>    (inquiry)EXCSTORE ## _clear, <span class=number>0</span>, <span class=number>0</span>, <span class=number>0</span>, <span class=number>0</span>, EXCMETHODS, \</span><br><span class=line>    EXCMEMBERS, EXCGETSET, &amp;_ ## EXCBASE, \</span><br><span class=line>    <span class=number>0</span>, <span class=number>0</span>, <span class=number>0</span>, offsetof(Py ## EXCSTORE ## Object, dict), \</span><br><span class=line>    (initproc)EXCSTORE ## _init, <span class=number>0</span>, EXCNEW,\</span><br><span class=line>&#125;; \</span><br><span class=line>PyObject *PyExc_ ## EXCNAME = (PyObject *)&amp;_PyExc_ ## EXCNAME</span><br><span class=line></span><br><span class=line>SimpleExtendsException(PyExc_Exception, TypeError,</span><br><span class=line>                       <span class=string>&quot;Inappropriate argument type.&quot;</span>);</span><br></pre></td></tr></table></figure><p>这里我们能看到（注意 <code>_Py_IMMORTAL_REFCNT</code> 和 <code>Py_TPFLAGS_DEFAULT | Py_TPFLAGS_BASETYPE | Py_TPFLAGS_HAVE_GC</code>），<code>PyExc_TypeError</code> 是一个非堆上 Immortal 对象，在 GH-116115<a href=#reference2><sup>2</sup></a> 之前，我们走到 false 的分支，而在之后，理论上讲 <code>_PyType_HasFeature(typeobj, Py_TPFLAGS_HEAPTYPE) || _Py_IsImmortal(typeobj)</code> 应该是一个为 true 的表达式，不应该会 assert failed 才对。那么为什么呢</p><p>我们在这里断点一下看一下表达式的值，结果我们惊讶的发现，<code>_Py_IsImmortal(typeobj)</code> 也为 false ，为啥捏？</p><p>我们先来看一下 <code>_Py_IsImmortal(typeobj)</code> 的实现</p><figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre></td><td class=code><pre><span class=line><span class=type>static</span> <span class=keyword>inline</span> Py_ALWAYS_INLINE <span class=type>int</span> _Py_IsImmortal(PyObject *op)</span><br><span class=line>&#123;</span><br><span class=line></span><br><span class=line>    <span class=keyword>return</span> (op-&gt;ob_refcnt == _Py_IMMORTAL_REFCNT);</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>这里我们能看到，<code>_Py_IsImmortal</code> 的实现是判断对象的引用计数是否等于 <code>_Py_IMMORTAL_REFCNT</code> ，奇怪，我们之前看到的 <code>PyExc_TypeError</code> 的定义里其 Reference Count 是 <code>_Py_IMMORTAL_REFCNT</code>， 难道 reference count 发生了什么变化？这个时候我们需要注意到，在 PyErr_SetString 之前我们调用了 <code>Py_INCREF</code>，我们来验证下</p><p>我们在 foo_bar 函数中加入断点，我们发现，在执行 <code>Py_INCREF</code> 后，我们我们的引用技术 +1 ，从而导致了 <code>_Py_IsImmortal</code> 的判断为 false</p><p>那么这里新的问题又来了，为什么我们在 &gt;= 3.12 的版本上编译的插件，在后续执行正常呢？这种奇怪的问题我们就先来看下汇编</p><p>在 3.11 下编译的产物</p><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br></pre></td><td class=code><pre><span class=line>0000000000001120 &lt;foo_bar&gt;:</span><br><span class=line>    1120:	48 83 ec 08          	sub    $0x8,%rsp</span><br><span class=line>    1124:	48 8b 05 9d 2e 00 00 	mov    0x2e9d(%rip),%rax        # 3fc8 &lt;PyExc_TypeError@Base&gt;</span><br><span class=line>    112b:	48 8d 35 ce 0e 00 00 	lea    0xece(%rip),%rsi        # 2000 &lt;_fini+0xe9c&gt;</span><br><span class=line>    1132:	48 8b 38             	mov    (%rax),%rdi</span><br><span class=line>    1135:	48 83 07 01          	addq   $0x1,(%rdi)</span><br><span class=line>    1139:	e8 f2 fe ff ff       	call   1030 &lt;PyErr_SetString@plt&gt;</span><br><span class=line>    113e:	31 c0                	xor    %eax,%eax</span><br><span class=line>    1140:	48 83 c4 08          	add    $0x8,%rsp</span><br><span class=line>    1144:	c3                   	ret</span><br><span class=line>    1145:	66 66 2e 0f 1f 84 00 	data16 cs nopw 0x0(%rax,%rax,1)</span><br><span class=line>    114c:	00 00 00 00</span><br></pre></td></tr></table></figure><p>在 3.13 下编译的产物</p><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br></pre></td><td class=code><pre><span class=line>0000000000001120 &lt;foo_bar&gt;:</span><br><span class=line>    1120:	48 83 ec 08          	sub    $0x8,%rsp</span><br><span class=line>    1124:	48 8b 05 9d 2e 00 00 	mov    0x2e9d(%rip),%rax        # 3fc8 &lt;PyExc_TypeError@Base&gt;</span><br><span class=line>    112b:	48 8b 38             	mov    (%rax),%rdi</span><br><span class=line>    112e:	8b 07                	mov    (%rdi),%eax</span><br><span class=line>    1130:	83 c0 01             	add    $0x1,%eax</span><br><span class=line>    1133:	74 02                	je     1137 &lt;foo_bar+0x17&gt;</span><br><span class=line>    1135:	89 07                	mov    %eax,(%rdi)</span><br><span class=line>    1137:	48 8d 35 c2 0e 00 00 	lea    0xec2(%rip),%rsi        # 2000 &lt;_fini+0xe9c&gt;</span><br><span class=line>    113e:	e8 ed fe ff ff       	call   1030 &lt;PyErr_SetString@plt&gt;</span><br><span class=line>    1143:	31 c0                	xor    %eax,%eax</span><br><span class=line>    1145:	48 83 c4 08          	add    $0x8,%rsp</span><br><span class=line>    1149:	c3                   	ret</span><br><span class=line>    114a:	66 0f 1f 44 00 00    	nopw   0x0(%rax,%rax,1)</span><br></pre></td></tr></table></figure><p>我们能发现我们在 <code>call 1030 &lt;PyErr_SetString@plt&gt;</code> 这条指令前的汇编完全不一样，我们这里能归纳出两点</p><ol><li>PyErr_SetString 调用的地址是在运行时动态解析的</li><li>而 <code>Py_INCREF</code> 则处理成不同逻辑的汇编了</li></ol><p>这种情况只有两种可能</p><ol><li><code>Py_INCREF</code> 是一组宏定义</li><li><code>Py_INCREF</code> 是被 inline 处理了</li></ol><p>我们来看下 <code>Py_INCREF</code> 的定义</p><figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line><span class=type>static</span> <span class=keyword>inline</span> Py_ALWAYS_INLINE <span class=type>void</span> <span class="title function_">Py_INCREF</span><span class=params>(PyObject *op)</span>;</span><br></pre></td></tr></table></figure><p>果然是第二种情况，那么这种情况就意味着 <code>Py_INCREF</code> 的实现在 3.13 和 3.11 中是不一样的，我们来看下代码</p><p>3.13</p><figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre></td><td class=code><pre><span class=line><span class=type>static</span> <span class=keyword>inline</span> Py_ALWAYS_INLINE <span class=type>void</span> <span class="title function_">Py_INCREF</span><span class=params>(PyObject *op)</span></span><br><span class=line>&#123;</span><br><span class=line>    <span class=keyword>if</span> (_Py_IsImmortal(op)) &#123;</span><br><span class=line>        <span class=keyword>return</span>;</span><br><span class=line>    &#125;</span><br><span class=line>    op-&gt;ob_refcnt++;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>3.11</p><figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre></td><td class=code><pre><span class=line><span class=type>static</span> <span class=keyword>inline</span> <span class=type>void</span> <span class="title function_">Py_INCREF</span><span class=params>(PyObject *op)</span></span><br><span class=line>&#123;</span><br><span class=line></span><br><span class=line>    op-&gt;ob_refcnt++;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>果然，在 3.13 中我们对于 immortal 对象的引用计数不再增加，而 3.11 不会做检查直接增加，这会使 immortal 对象的引用计数不再是 <code>_Py_IMMORTAL_REFCNT</code>，从而导致了我们的问题</p><p>这个问题那么其实说白了可以这样总结，在 PEP 683 Immortal 对象的实现中，我们将 immortal 的状态和引用技术 mix up 了，导致我们部分 ABI 在低版本 inline 后在高版本中有错误的逻辑。同时我们在 GH-116115<a href=#reference2><sup>2</sup></a> 中收窄了对于对象检测的严谨性，从而导致出现了兼容的问题</p><p>这个问题其实修复起来也很容易，目前我和另外一个 Python 核心开发者各自采用了一种处理方式</p><ol><li>我是选择将 assert 的部分 revert 到之前的 if condition 检查，这样可以保证对象的兼容性，改动也比较小。缺陷就是算是 case by case 的解决</li><li>另外一位核心开发者解决的方式是将 immortal 的检查范围放大（大小于某个区间即可认为是 immortal 对象），这样的好处是可以扩展，而缺陷就是可能让 immortal 对象的实现复杂度进一步提升</li></ol><p>不过说白了归根到底还是 PEP 683 实现的时候状态混合了，估计后续还有不少问题</p><h2 id=总结><a href=#总结 class=headerlink title=总结></a>总结</h2><p>这个 case 其实也是个查起来不难，修复不难的问题。但是后面牵扯的东西太多了，很多有趣的讨论可以点进 issue 去看看</p><h2 id=Reference><a href=#Reference class=headerlink title=Reference></a>Reference</h2><div id=reference1></div><ol><li><a target=_blank rel="noopener external nofollow noreferrer" href=https://github.com/python/cpython/issues/121528>https://github.com/python/cpython/issues/121528</a></li></ol><div id=reference2></div><ol><li><a target=_blank rel="noopener external nofollow noreferrer" href=https://github.com/python/cpython/pull/116115>https://github.com/python/cpython/pull/116115</a></li></ol></article><div class=post-copyright><div class=post-copyright__author><span class=post-copyright-meta><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class=post-copyright-info><a target=_blank rel="noopener external nofollow noreferrer" href=https://github.com/Zheaoli>Manjusaka</a></span></div><div class=post-copyright__type><span class=post-copyright-meta><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class=post-copyright-info><a href=https://www.manjusaka.blog/posts/2024/07/16/a-live-debug-gh121528/ >https://www.manjusaka.blog/posts/2024/07/16/a-live-debug-gh121528/</a></span></div><div class=post-copyright__notice><span class=post-copyright-meta><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class=post-copyright-info>All articles in this blog are licensed under <a target=_blank rel="noopener external nofollow noreferrer" href=https://creativecommons.org/licenses/by-nc-sa/4.0/ >CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class=tag_share><div class=post-meta__tag-list><a class=post-meta__tags href=/tags/%E7%BC%96%E7%A8%8B/ >编程</a><a class=post-meta__tags href=/tags/%E7%AC%94%E8%AE%B0/ >笔记</a><a class=post-meta__tags href=/tags/%E6%B0%B4%E6%96%87/ >水文</a><a class=post-meta__tags href=/tags/CPython/ >CPython</a></div><div class=post_share><div class=social-share data-image=https://cdn.pixabay.com/photo/2023/02/07/14/45/snow-7774312_1280.jpg data-sites=facebook,twitter,wechat,weibo,qq></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css media=print onload='this.media="all"'><script src=https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js defer=defer></script></div></div><div class=ads-wrap><ins class=adsbygoogle style=display:block;text-align:center data-ad-layout=in-article data-ad-format=fluid data-ad-client=ca-pub-7962287588031867 data-ad-slot=2542544532></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><nav class=pagination-post id=pagination><div class="next-post pull-full"><a href=/posts/2024/06/19/a-live-debug-gh120437/ title="Debug 日志：CPython GH-120437"><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/06/01/14/superb-fairywren-7770904_1280.jpg onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class=pagination-info><div class=label>Next</div><div class=next_info>Debug 日志：CPython GH-120437</div></div></a></div></nav><div class=relatedPosts><div class=headline><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class=relatedPosts-list><div><a href=/posts/2024/06/19/a-live-debug-gh120437/ title="Debug 日志：CPython GH-120437"><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/06/01/14/superb-fairywren-7770904_1280.jpg alt=cover><div class="content is-center"><div class=date><i class="far fa-calendar-alt fa-fw"></i> 2024-06-20</div><div class=title>Debug 日志：CPython GH-120437</div></div></a></div><div><a href=/posts/2024/02/10/CVE-2024-21626/ title="简单聊聊 CVE-2024-21626"><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/06/01/14/superb-fairywren-7770904_1280.jpg alt=cover><div class="content is-center"><div class=date><i class="far fa-calendar-alt fa-fw"></i> 2024-02-11</div><div class=title>简单聊聊 CVE-2024-21626</div></div></a></div><div><a href=/posts/2021/11/22/a-litte-introduction-about-nohdr-filed-in-skbuff/ title="聊聊 sk_buff 中一个冷门字段: nohdr"><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/01/30/19/40/gulls-7756481_1280.jpg alt=cover><div class="content is-center"><div class=date><i class="far fa-calendar-alt fa-fw"></i> 2021-11-22</div><div class=title>聊聊 sk_buff 中一个冷门字段: nohdr</div></div></a></div><div><a href=/posts/2023/08/26/a-little-bit-design-about-cpu-burst-in-k8s/ title="关于 CPU Burst 在 K8s 中的一些设计想法"><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/04/07/38/cherry-blossoms-7766588_1280.jpg alt=cover><div class="content is-center"><div class=date><i class="far fa-calendar-alt fa-fw"></i> 2023-08-27</div><div class=title>关于 CPU Burst 在 K8s 中的一些设计想法</div></div></a></div><div><a href=/posts/2023/08/22/a-little-bit-idea-about-unwind/ title=关于用户态栈回溯（Unwind）的一些杂记和想法><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/06/01/14/superb-fairywren-7770904_1280.jpg alt=cover><div class="content is-center"><div class=date><i class="far fa-calendar-alt fa-fw"></i> 2023-08-23</div><div class=title>关于用户态栈回溯（Unwind）的一些杂记和想法</div></div></a></div><div><a href=/posts/2021/08/24/a-little-problem-about-posix-node-js-execsync/ title="关于 Node.js 中 execSync 的一点问题"><img class=cover src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/01/14/19/50/flower-7718952_1280.jpg alt=cover><div class="content is-center"><div class=date><i class="far fa-calendar-alt fa-fw"></i> 2021-08-24</div><div class=title>关于 Node.js 中 execSync 的一点问题</div></div></a></div></div></div><hr class=custom-hr><div id=post-comment><div class=comment-head><div class=comment-headline><i class="fas fa-comments fa-fw"></i><span> Comment</span></div></div><div class=comment-wrap><div><div id=disqus_thread></div></div></div></div></div><div class=aside-content id=aside-content><div class="card-widget card-info"><div class=is-center><div class=avatar-img><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://avatars.githubusercontent.com/u/7054676?v=4" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt=avatar></div><div class=author-info__name>Manjusaka</div><div class=author-info__description>热忱之心不可磨灭</div></div><div class="card-info-data site-data is-center"><a href=/archives/ ><div class=headline>Articles</div><div class=length-num>90</div></a><a href=/tags/ ><div class=headline>Tags</div><div class=length-num>52</div></a><a href=/categories/ ><div class=headline>Categories</div><div class=length-num>36</div></a></div><a id=card-info-btn target=_blank rel="noopener external nofollow noreferrer" href=https://github.com/Zheaoli><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class=social-icon href=https://github.com/ZheaoLi rel="external nofollow noreferrer" target=_blank title=Github><i class="fab fa-github"></i></a><a class=social-icon href=mailto:me@manjusaka.me rel="external nofollow noreferrer" target=_blank title=Email><i class="fas fa-envelope"></i></a><a class=social-icon href=https://twitter.com/Manjusaka_Lee rel="external nofollow noreferrer" target=_blank title=推特><i class="fab fa-twitter"></i></a><a class=social-icon href=/atom.xml target=_blank title=RSS><i class="fa-solid fa-feed"></i></a></div></div><div class="card-widget card-announcement"><div class=item-headline><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class=announcement_content>This is my Blog</div></div><div class=sticky_layout><div class=card-widget id=card-toc><div class=item-headline><i class="fas fa-stream"></i><span>Contents</span><span class=toc-percentage></span></div><div class="toc-content is-expand"><ol class=toc><li class="toc-item toc-level-2"><a class=toc-link href=#%E5%BC%80%E7%AF%87><span class=toc-number>1.</span> <span class=toc-text>开篇</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E6%80%BB%E7%BB%93><span class=toc-number>2.</span> <span class=toc-text>总结</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#Reference><span class=toc-number>3.</span> <span class=toc-text>Reference</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class=item-headline><i class="fas fa-history"></i><span>Recent Post</span></div><div class=aside-list><div class=aside-list-item><a class=thumbnail href=/posts/2024/07/16/a-live-debug-gh121528/ title="Debug 日志：CPython GH-121528"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/07/14/45/snow-7774312_1280.jpg onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Debug 日志：CPython GH-121528"></a><div class=content><a class=title href=/posts/2024/07/16/a-live-debug-gh121528/ title="Debug 日志：CPython GH-121528">Debug 日志：CPython GH-121528</a><time datetime=2024-07-16T18:20:00.000Z title="Created 2024-07-17 02:20:00">2024-07-17</time></div></div><div class=aside-list-item><a class=thumbnail href=/posts/2024/06/19/a-live-debug-gh120437/ title="Debug 日志：CPython GH-120437"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/06/01/14/superb-fairywren-7770904_1280.jpg onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Debug 日志：CPython GH-120437"></a><div class=content><a class=title href=/posts/2024/06/19/a-live-debug-gh120437/ title="Debug 日志：CPython GH-120437">Debug 日志：CPython GH-120437</a><time datetime=2024-06-19T19:40:00.000Z title="Created 2024-06-20 03:40:00">2024-06-20</time></div></div><div class=aside-list-item><a class=thumbnail href=/posts/2024/05/24/a-tour-to-make-a-nes-simulator-nametable-caculate/ title="实现 NES 中的一些笔记：nametable 的 mirror 计算"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/01/14/19/50/flower-7718952_1280.jpg onerror='this.onerror=null,this.src="/img/404.jpg"' alt="实现 NES 中的一些笔记：nametable 的 mirror 计算"></a><div class=content><a class=title href=/posts/2024/05/24/a-tour-to-make-a-nes-simulator-nametable-caculate/ title="实现 NES 中的一些笔记：nametable 的 mirror 计算">实现 NES 中的一些笔记：nametable 的 mirror 计算</a><time datetime=2024-05-24T17:00:00.000Z title="Created 2024-05-25 01:00:00">2024-05-25</time></div></div><div class=aside-list-item><a class=thumbnail href=/posts/2024/05/11/where-are-my-package/ title="SRE 日志：我的包去哪了？"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/06/01/14/superb-fairywren-7770904_1280.jpg onerror='this.onerror=null,this.src="/img/404.jpg"' alt="SRE 日志：我的包去哪了？"></a><div class=content><a class=title href=/posts/2024/05/11/where-are-my-package/ title="SRE 日志：我的包去哪了？">SRE 日志：我的包去哪了？</a><time datetime=2024-05-11T17:00:00.000Z title="Created 2024-05-12 01:00:00">2024-05-12</time></div></div><div class=aside-list-item><a class=thumbnail href=/posts/2024/02/20/a-simple-discussion-about-the-ultraman/ title=简单聊聊奥特曼中很有趣的细节><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=https://cdn.pixabay.com/photo/2023/02/04/07/38/cherry-blossoms-7766587_1280.jpg onerror='this.onerror=null,this.src="/img/404.jpg"' alt=简单聊聊奥特曼中很有趣的细节></a><div class=content><a class=title href=/posts/2024/02/20/a-simple-discussion-about-the-ultraman/ title=简单聊聊奥特曼中很有趣的细节>简单聊聊奥特曼中很有趣的细节</a><time datetime=2024-02-20T09:00:00.000Z title="Created 2024-02-20 17:00:00">2024-02-20</time></div></div></div></div><div class="card-widget ads-wrap"><ins class=adsbygoogle style=display:block data-ad-client=ca-pub-7962287588031867 data-ad-slot=1257383027 data-ad-format=auto data-full-width-responsive=true></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div></div></div></main><footer id=footer style="background:0 0"><div id=footer-wrap><div class=copyright>&copy;2020 - 2024 By Manjusaka</div><div class=framework-info><span>Framework </span><a target=_blank rel="noopener external nofollow noreferrer" href=https://hexo.io>Hexo</a><span class=footer-separator>|</span><span>Theme </span><a target=_blank rel="noopener external nofollow noreferrer" href=https://github.com/jerryc127/hexo-theme-butterfly>Butterfly</a></div></div></footer></div><div id=rightside><div id=rightside-config-hide></div><div id=rightside-config-show><button id=darkmode type=button title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id=translateLink type=button title="Toggle Between Traditional Chinese And Simplified Chinese">简</button><button id=readmode type=button title="Read Mode"><i class="fas fa-book-open"></i></button><button id=go-up type=button title="Back To Top"><span class=scroll-percent></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src=https://www.manjusaka.blog/js/utils.js></script><script src=https://www.manjusaka.blog/js/main.js></script><script src=https://www.manjusaka.blog/js/tw_cn.js></script><script src=https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js></script><script src=https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js></script><script src=https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js></script><script>function panguFn(){"object"==typeof pangu?pangu.autoSpacingPage():getScript("https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js").then(()=>{pangu.autoSpacingPage()})}function panguInit(){panguFn()}document.addEventListener("DOMContentLoaded",panguInit)</script><div class=js-pjax><script>(()=>{let t=document.querySelectorAll("#article-container .mermaid-wrap");if(0!==t.length){let e=()=>{window.loadMermaid=!0;let r="dark"===document.documentElement.getAttribute("data-theme")?"dark":"default";Array.from(t).forEach((e,t)=>{let d=e.firstElementChild;e="%%{init:{ 'theme':'"+r+"'}}%%\n"+d.textContent;let n=mermaid.render("mermaid-"+t,e);"string"==typeof n?(t=n,d.insertAdjacentHTML("afterend",t)):n.then(({svg:e})=>{d.insertAdjacentHTML("afterend",e)})})};var d=()=>{window.loadMermaid?e():getScript("https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js").then(e)};btf.addGlobalFn("themeChange",e,"mermaid"),window.pjax?d():document.addEventListener("DOMContentLoaded",d)}})()</script><script>(()=>{function e(){this.page.url="https://www.manjusaka.blog/posts/2024/07/16/a-live-debug-gh121528/",this.page.identifier="/posts/2024/07/16/a-live-debug-gh121528/",this.page.title="Debug 日志：CPython GH-121528"}let t=()=>{window.DISQUS&&window.DISQUS.reset({reload:!0,config:e})};btf.addGlobalFn("themeChange",t,"disqus");var a=()=>{var e;window.DISQUS?t():((e=document.createElement("script")).src="https://manjusakablog.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),document.head.appendChild(e))};a()})()</script></div><script defer=defer id=fluttering_ribbon mobile=false src=https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js></script><script src=https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js></script><script>POWERMODE.colorful=!0,POWERMODE.mobile=!(POWERMODE.shake=!0),document.body.addEventListener("input",POWERMODE)</script><script async data-pjax src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><div id=algolia-search><div class=search-dialog><nav class=search-nav><span class=search-dialog-title>Search</span><button class=search-close-button><i class="fas fa-times"></i></button></nav><div class=search-wrap><div id=algolia-search-input></div><hr><div id=algolia-search-results><div id=algolia-hits></div><div id=algolia-pagination></div><div id=algolia-info><div class=algolia-stats></div><div class=algolia-poweredBy></div></div></div></div></div><div id=search-mask></div><script src=https://cdn.jsdelivr.net/npm/algoliasearch/dist/algoliasearch-lite.umd.min.js></script><script src=https://cdn.jsdelivr.net/npm/instantsearch.js/dist/instantsearch.production.min.js></script><script src=https://www.manjusaka.blog/js/search/algolia.js></script></div></div><script data-pjax>function butterfly_swiper_injector_config(){var s=document.getElementById("recent-posts");console.log("已挂载butterfly_swiper"),s.insertAdjacentHTML("afterbegin",'<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="/posts/2024/02/20/a-simple-discussion-about-the-ultraman/" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.pixabay.com/photo/2023/02/04/07/38/cherry-blossoms-7766587_1280.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2024-02-20</span><a class="blog-slider__title" href="/posts/2024/02/20/a-simple-discussion-about-the-ultraman/" alt="">简单聊聊奥特曼中很有趣的细节</a><div class="blog-slider__text">ヒーロが必要なんだよ，金城君。ヒーローが必要なんだ！</div><a class="blog-slider__button" href="/posts/2024/02/20/a-simple-discussion-about-the-ultraman/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="/posts/2023/12/29/per-aspera-ad-astra/" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.pixabay.com/photo/2023/02/04/07/38/cherry-blossoms-7766588_1280.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-12-29</span><a class="blog-slider__title" href="/posts/2023/12/29/per-aspera-ad-astra/" alt="">Per aspera, Ad astra</a><div class="blog-slider__text">再怎么看我也不知道怎么描述它的啦！</div><a class="blog-slider__button" href="/posts/2023/12/29/per-aspera-ad-astra/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="/posts/2023/10/24/open-source-is-simple-than-you-think/" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.pixabay.com/photo/2023/02/04/07/38/cherry-blossoms-7766587_1280.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-10-24</span><a class="blog-slider__title" href="/posts/2023/10/24/open-source-is-simple-than-you-think/" alt="">开源可能没你想的那么难</a><div class="blog-slider__text">再怎么看我也不知道怎么描述它的啦！</div><a class="blog-slider__button" href="/posts/2023/10/24/open-source-is-simple-than-you-think/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="/posts/2023/06/25/love-and-hope-is-all-we-need/" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://github.com/Zheaoli/yuque-py/assets/7054676/ea9460a2-e351-4b73-9f82-7aef6cd20c33" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-06-25</span><a class="blog-slider__title" href="/posts/2023/06/25/love-and-hope-is-all-we-need/" alt="">聊聊公益和助学</a><div class="blog-slider__text">很多时候，帮助人不需要那么多理由</div><a class="blog-slider__button" href="/posts/2023/06/25/love-and-hope-is-all-we-need/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="/posts/2023/12/28/how-do-I-build-homelab-part2/" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.pixabay.com/photo/2023/01/14/19/50/flower-7718952_1280.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-12-28</span><a class="blog-slider__title" href="/posts/2023/12/28/how-do-I-build-homelab-part2/" alt="">家庭 Homelab 升级计划: v2</a><div class="blog-slider__text">人生嘛，Homelab 图个乐子</div><a class="blog-slider__button" href="/posts/2023/12/28/how-do-I-build-homelab-part2/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="/posts/2023/06/19/why-do-I-love-ultraman/" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://user-images.githubusercontent.com/7054676/228287041-c86e7928-0da8-4097-b7ff-e575faa8cf8c.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-06-19</span><a class="blog-slider__title" href="/posts/2023/06/19/why-do-I-love-ultraman/" alt="">为什么奥特曼是我的信仰</a><div class="blog-slider__text">優しさを失わないでくれ。弱い者を労り互いに助け合い。</div><a class="blog-slider__button" href="/posts/2023/06/19/why-do-I-love-ultraman/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="/posts/2023/06/16/how-do-I-build-homelab/" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.pixabay.com/photo/2023/02/04/07/38/cherry-blossoms-7766588_1280.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-06-16</span><a class="blog-slider__title" href="/posts/2023/06/16/how-do-I-build-homelab/" alt="">家庭 Homelab 升级计划</a><div class="blog-slider__text">人生嘛，Homelab 图个乐子</div><a class="blog-slider__button" href="/posts/2023/06/16/how-do-I-build-homelab/" alt="">详情   </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>')}for(var elist="undefined".split(","),cpage=location.pathname,epage="all",flag=0,i=0;i<elist.length;i++)cpage.includes(elist[i])&&flag++;("all"===epage&&0==flag||epage===cpage)&&butterfly_swiper_injector_config()</script><script defer=defer src=https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.js></script><script defer=defer data-pjax src=https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper_init.js></script><script async src=//at.alicdn.com/t/font_2032782_8d5kxvn09md.js></script></body></html>