---
title: Saka 馬鹿
type: tags
date: 2024-01-05 02:30:00
tags: [编程,随笔,人生]
categories: [编程,随笔]
toc: true
---

这篇博客是我在刷题群内的 2025 年的第一次分享整理的演讲稿。主要是完整复盘了过去几年里我犯下的两个比较典型的低级错误。

希望大家能看的开心

<!--more-->

## 正文

首先来看一下我们抽象后的架构

![架构](https://i.imgur.com/4nVkyxt.png)

很平平常规的一个架构。而我犯的两次相对低级的错误分别是在数据的入口和数据落点上。OK 那么我们分别来看一下我犯下的错误

首先要分享的是我搞出的一个核心数据库删除的事故。在介绍事故现场之前，我将先介绍下下当时我们整体资源管理的结构

1. 我们基于 Terraform 管理资源
2. 熟悉 Terraform 的同学都知道，Terraform 很重要的一点就是需要一个介质来存储当前 infra 的 state，这样能让后续的操作基于状态来实现 diff
3. 我们当时的 state 是存储在 local fs ，state 文件跟随着 Git Repo 一起变更
4. 我们基于目录划分不同业务需要的 AWS Infra 所对应的 Terraform 描述
5. 关键设施没有开启删除保护

![目录结构](https://i.imgur.com/3WQ1eSg.png)

OK，我们继续往前讲，我们来激活一下事故现场的回忆

1. 事故当天，需要给一个新的业务需要一个 AWS Aurora 实例
2. 我直接复制了一个目录，然后重命名为新业务名
3. 删除一些不必要的 TF 声明后，我就直接开始 terraform apply 了
4. 因为将之前的 TF State 文件迁移到了新目录，同时修改了 TF 声明。Terraform 会判定需要删除以往的资源。在 apply 阶段的 destory 提示被我忽略
5. 于是数据库没了.jpg

让我们先快进到事故的处理

1. 在接到报警发现异常后，先第一时间中断 Terraform 执行并同步所有关联同事。
2. 将所有关联服务流量 cutoff 并同步客服团队
3. 基于已有快照重建数据库
4. 恢复业务流量

非常刺激的一次经历。反思的部分我们放在后面。我们快进到第二次事故。CDN 变更事故。还是和之前一样先介绍一下大致的背景

1. 我们的 CDN 因为处于成本，和架构统一的考虑